<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø­Ø³Ù†</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        #map { height: 100vh; width: 100%; }
        .controlButton {
            background-color: rgba(30, 144, 255, 0.8);
            border: none;
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 5px 0;
            transition: background-color 0.3s ease;
            width: 100%;
            font-size: 14px;
        }
        .controlButton:hover {
            background-color: rgb(49, 255, 30);
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .iconButton {
  width: 40px;
  height: 40px;
  border: none;
  cursor: pointer;
  background: none;
  margin: 5px;
  z-index: 2;
  border-radius: 50%; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø²Ø± Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ø±ÙŠ ÙˆØ±Ù‚ÙŠÙ‚ */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
#ordersPanel {
  position: absolute;
  top: 60px;
  right: 10px;
  width: 300px;
  max-height: 70vh;
  background-color: rgba(255, 255, 255, 0.95);
  border: 1px solid #ccc;
  border-radius: 8px;
  overflow-y: auto;
  padding: 10px;
  display: none;
  z-index: 10;
}
.orderItem {
  border-bottom: 1px solid #ddd;
  padding: 8px;
  margin-bottom: 5px;
}
.orderItem p {
  margin: 5px 0;
}
.orderItem button {
  background-color: #28a745;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  color: white;
  cursor: pointer;
}

/* Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ÙˆØ³Ø§Ø¦Ø· CSS Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ¨ */
@media (max-width: 600px) {
  #ordersPanel {
    width: 90%;
    right: 5%;
  }
}

        .icon {
            font-size: 20px;
            color: #ff5722;
            transition: color 0.3s;
        }
        .icon:hover {
            color: #e64a19;
        }
        #locateButtonContainer {
            position: absolute;
            bottom: 20px; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
            right: 20px; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
            z-index: 2;
        }
        #locateButton {
            background-color: rgba(30, 144, 255, 0.8);
            border: none;
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 14px;
        }
        #locateButton:hover {
            background-color: rgb(49, 255, 30);
        }
        #etaPanel p {
    display: inline-block;
    margin: 0 10px;
    font-size: 16px;
}


#etaPanel,
#countdownPanel {
    display: none;
}


.mapboxgl-ctrl-geocoder {
  width: 200px !important;  
  height: 35px !important;  
  border-radius: 5px;        
  font-size: 14px;           
  display: flex;             
  align-items: center;       
  justify-content: center;   
  position: relative; /* ØªØ£ÙƒØ¯ Ù…Ù† Ø¶Ø¨Ø· Ø§Ù„Ù…ÙˆØ¶Ø¹ */
  z-index: 10; /* ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« ÙÙˆÙ‚ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø®Ø±Ù‰ */
}

/* Ø¬Ø¹Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
.mapboxgl-ctrl-geocoder .suggestions {
  position: absolute !important;
  z-index: 9999 !important; /* Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆÙ‚ Ø£ÙŠ Ø¹Ù†ØµØ± Ø¢Ø®Ø± */
  background-color: white; /* Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙˆØ¶ÙˆØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
  border: 1px solid #ccc;
  border-radius: 5px;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}
.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon {
  display: none !important; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª (X ÙˆØ§Ù„Ø¯Ø§Ø¦Ø±Ø©) */
}



    </style>
</head>
<body>
    <h1 id="title" style="display: none;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø­Ø³Ù†</h1>
    <div id="map"></div>

<!-- Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ -->
<div id="jobDetailsPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; border-radius:10px; padding:20px; z-index:3;">
    <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„</h2>
    <p id="jobDescription"></p>
    <p id="userPhone"></p>
    <!-- Ø¹Ù†ØµØ± Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© -->
    <img id="jobImage" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„" style="max-width:100%; height:auto; display:none;">
    <p id="jobLocation"></p>
    <p id="jobDuration"></p>
    <p id="jobBudget"></p>
    <p id="jobDistance"></p>
    <p id="estimatedArrivalTime"></p>
    <button id="acceptJobButton">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
    <button onclick="document.getElementById('jobDetailsPopup').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<!-- Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div id="cancelJobContainer" style="display:none; position: fixed; bottom: 20px; left: 20px; z-index: 1000;">
    <button id="cancelJobButton" class="controlButton" style="background-color: #d9534f;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
</div>


    


<div class="controls">
    <!-- Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Ø´Ø§Ø±Ø© Ø¥Ø´Ø¹Ø§Ø± -->
    <button id="toggleOrdersButton" class="controlButton">
      Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª <span id="ordersBadge"></span>
    </button>
    <button id="toggleWeather" class="iconButton">
      <i class="fas fa-cloud-sun icon"></i>
    </button>
    <select id="styleSelector" class="controlButton">
      <option value="streets">Ø´ÙˆØ§Ø±Ø¹</option>
      <option value="satellite">Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©</option>
      <option value="outdoors">Ø®Ø§Ø±Ø¬ÙŠØ©</option>
      <option value="hybrid" selected>Ù‡Ø§ÙŠØ¨Ø±Ø¯</option>
      <option value="dark">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</option>
      <option value="light">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­</option>
    </select>
    <button id="requestWater" class="controlButton">Ø·Ù„Ø¨ Ù…Ø§Ø¡</button>
    <div id="weatherInfo"></div>
    <div id="workerInfo"></div>
  </div>
  
  <!-- Ø¥Ø¶Ø§ÙØ© Ù„ÙˆØ­Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© -->
  <div id="ordersPanel">
    <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
  </div>
  




    <div id="locateButtonContainer">
        <button id="locateButton">ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    </div>

<!-- Ø­Ø§ÙˆÙŠØ© Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ETA ØªØ¨Ù‚Ù‰ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ -->
<div id="etaPanel" style="position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); background: white; padding: 10px; border-radius: 5px; z-index: 4;">
    <p id="etaDisplay"></p>
</div>

<!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ØªØ¸Ù‡Ø± ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø¨Ø­Ø¬Ù… Ø®Ø· Ø£ØµØºØ± -->
<div id="countdownPanel" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #fff; padding: 5px 8px; border-radius: 5px; z-index: 4; font-size: 12px;">
    <p id="countdownTimer"></p>
</div>

    
    

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± -->
    <div id="confirmationPopup" style="display:none; position:fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 3;">
        <h2>ØªØ­Ø°ÙŠØ±</h2>
        <p>Ø³ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ ØªÙ‚Ù ÙÙŠÙ‡ Ø­Ø§Ù„ÙŠØ§. Ù‡Ù„ Ø£Ù†Øª Ù…ÙˆØ§ÙÙ‚ØŸ</p>
        <button id="confirmYes">Ù†Ø¹Ù…</button>
        <button id="confirmNo">Ù„Ø§</button>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
    <div id="inputPopup" style="display:none; position:fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 3;">
        <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h2>
        <label for="nameInput">Ø§Ø³Ù…:</label>
        <input type="text" id="nameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…">
        <label for="phoneInput">Ø±Ù‚Ù… Ù‡Ø§ØªÙ:</label>
        <input type="text" id="phoneInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <button id="submitInfo">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <button id="cancelInput">Ø¥Ù„ØºØ§Ø¡</button>
    </div>



    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø±Ù‘Ù -->
    <div id="loginPopup" style="display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0px 4px 6px rgba(0,0,0,0.3); z-index: 10;">
        <h3>Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ù„Ø¨Ø¯Ø¡</h3>
        <input type="text" id="workerLoginId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„" style="margin-bottom: 10px; width: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        <button id="loginWorkerButton" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ù…Ø§Ù„ -->
<div id="directRequestPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 10;">
    <h2 id="directRequestTitle">Ø·Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±: Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
    <p id="directRequestMessage">Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†ØŸ</p>
    <button id="acceptDirectRequest">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
    <button id="rejectDirectRequest">Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</button>
</div>





<!-- Ù…ÙƒØªØ¨Ø§Øª Firebase App Ùˆ Messaging -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://js.pusher.com/beams/1.0/push-notifications-cdn.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Ù…ÙƒØªØ¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<script src="https://unpkg.com/@turf/turf"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>

<script>

    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase Ùˆ Pusher Beams
if (typeof firebase === 'undefined' || typeof PusherPushNotifications === 'undefined') {
    console.error('ğŸš¨ğŸ’­ 123  ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase ÙˆPusher Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§.');
} else {
    console.log('âœ…ğŸ’­ 124 ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
if (!firebase || !PusherPushNotifications) {
    console.error('ğŸš¨ 149 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase Ø£Ùˆ Pusher Beams.');
}
}
    document.addEventListener('DOMContentLoaded', function() {
           // ØªÙ‡ÙŠØ¦Ø© Firebase Auth
           const auth = firebase.auth();
        
        // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.getElementById('loginPopup').style.display = 'flex';













// ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Pusher Beams
if (typeof PusherPushNotifications === 'undefined') {
    console.error('ğŸš¨ğŸ’­ 137 Pusher Beams Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙÙŠ HTML.');
} else {
    console.log('âœ…ğŸ’­ 141 Pusher Beams ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­.');
}

function initBeams() {
    console.log("ğŸš€ 142 DOMContentLoaded ØªÙ… ØªÙ†ÙÙŠØ°Ù‡ Ø¨Ù†Ø¬Ø§Ø­.");
    
    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Beams Client
    const beamsClient = new PusherPushNotifications.Client({
    instanceId: '2a17d881-b1a6-4a38-8cd4-de1ab8212f67',
  });
    
    console.log("ğŸ“ 140 Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Beams.");
    
    navigator.serviceWorker.register('http://localhost:20000/service-worker.js')
        .then((registration) => {
            console.log("ğŸ“ 143 ØªÙ… ØªØ³Ø¬ÙŠÙ„ Service Worker Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Beams:", registration);
            return beamsClient.start({ serviceWorkerRegistration: registration });
        })
        .then(() => {
            console.log('ğŸ› ï¸ 136 ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ start() Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªÙ†ÙÙŠØ° addDeviceInterest.');
            beamsClient.addDeviceInterest('debug-new-orderss')
  .then(() => console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ debug-new-orderss'))
  .catch(err => console.error('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²:', err));
        })
        .then(() => {
            console.log('âœ…ğŸ’­ 125 Pusher Beams Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
        })
        .catch((err) => {
            console.error('ğŸš¨ 127 Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', err);
            alert(`âš ï¸ 150 Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Service Worker: ${err.message}`);
console.error('ğŸš¨ 151 ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:', err);
        });
    
    beamsClient.onNotificationOpened = (payload) => {
        alert(`Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…Ù† Pusher Beams: ${payload.notification.body}`);
    };
}

// ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙˆØ¯ Ø³ÙˆØ§Ø¡ Ø­Ø¯Ø« DOMContentLoaded Ø£Ù… Ù„Ø§
if (document.readyState === 'loading') {
    document.addEventListener("DOMContentLoaded", initBeams);
} else {
    initBeams();
}

console.log("âœ…ğŸ’­ 126 Pusher Beams ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­.");

if (typeof PusherPushNotifications === 'undefined') {
    console.error('ğŸš¨ 134 Ù…ÙƒØªØ¨Ø© Pusher Beams ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¶Ù…ÙŠÙ†Ù‡Ø§ ÙÙŠ Ø§Ù„ØµÙØ­Ø©.');
} else {
    console.log('âœ… 135 Ù…ÙƒØªØ¨Ø© Pusher Beams ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­.');
}

// ØªØ³Ø¬ÙŠÙ„ Service Worker Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø°Ù„Ùƒ Ù…Ø·Ù„ÙˆØ¨Ù‹Ø§ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©)
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('http://localhost:20000/service-worker.js')
    .then(registration => {
        console.log('âœ…ğŸ˜˜ğŸ’• 128 Service Worker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­:', registration.scope);
    })
    .catch(error => {
        console.error('ğŸš¨ 129 ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:', error);
    });
} else {
    console.warn('âš ï¸ 130  Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Service Worker.');
}

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Pusher Beams
function sendPusherNotification(interest, message, title = "Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯") {
    fetch(`https://${pusherInstanceId}.pushnotifications.pusher.com/publish_api/v1/instances/${pusherInstanceId}/publishes`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${pusherAuthorization}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            interests: [interest],
            fcm: {
                notification: {
                    title: title,
                    body: message
                }
            }
        })
    })
    .then(response => response.json())
    .then(data => console.log("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­:", data))
    .catch(error => console.error("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", error));
}
// Ø±Ø¨Ø· Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ø¦Ù† window Ù„Ø¬Ø¹Ù„Ù‡Ø§ Ù…ØªØ§Ø­Ø© Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù…
window.sendPusherNotification = sendPusherNotification;












         // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ inputPopup Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ù„ØºØ§Ø¡"
         document.getElementById('cancelInput').addEventListener('click', () => {
            document.getElementById('nameInput').value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù…
            document.getElementById('phoneInput').value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ
            document.getElementById('inputPopup').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
        });



// Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù‘Ù
function hideLoginPopup() {
    document.getElementById('loginPopup').style.display = 'none';
}
});
    

function showRoute(workerLocation, jobLocation) {
    const directionsRequest = `https://api.mapbox.com/directions/v5/mapbox/driving/${workerLocation.lng},${workerLocation.lat};${jobLocation.lng},${jobLocation.lat}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`;
    console.log('30 Ø·Ù„Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª:', directionsRequest);

    fetch(directionsRequest)
        .then(response => response.json())
        .then(data => {
            const route = data.routes[0].geometry;
            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø± ÙÙŠ Ù…ØªØºÙŠØ± Ø¹Ø§Ù…
            window.currentRouteData = {
                type: 'Feature',
                geometry: route
            };

            // Ø§Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
            if (map.getSource('route')) {
                console.log('31 ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ¯Ø± route:', map.getSource('route'));
                map.getSource('route').setData(window.currentRouteData);
            } else {
                map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: {
                        type: 'geojson',
                        data: window.currentRouteData
                    },
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#3887be', 'line-width': 5 }
                });
            }
        })
        .catch(console.error);
}



function updateWorkerLocation(workerId, newLocation) {
    const workerLocationRef = database.ref(`workers/${workerId}/location`);
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ø§Ù…Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… workerRef
    database.ref(`workers/${workerId}`).once('value').then((snapshot) => {
        const workerData = snapshot.val();
        const currentLocation = workerData && workerData.location;
        
        if (!currentLocation || currentLocation.lat !== newLocation.lat || currentLocation.lng !== newLocation.lng) {
            workerLocationRef.set(newLocation)
            .then(() => console.log("âœ… 148 ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Firebase:", newLocation))
            .catch((error) => console.error("âŒ 153 Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Firebase:", error));
        } else {
            console.log("ğŸ”„ 88 Ù„Ù… ÙŠØªØºÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªØ­Ø¯ÙŠØ« Firebase.");
        }
    }).catch((error) => {
        console.error("âŒ 89 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Firebase:", error);
    });
}


// [Ø§Ù„Ø³Ø·Ø± 180] ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… GPS Ù„ØªØ­Ø³ÙŠÙ† Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©






let isMapReady = false; // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©.
console.log("âš™ï¸ 56 ØªÙ… ØªØ¹Ø±ÙŠÙ isMapReady ÙˆÙ‚ÙŠÙ…ØªÙ‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ:", isMapReady);

/**
 * Ø¯Ø§Ù„Ø© ØªØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….
 * @returns {boolean} Ù‡Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ØŸ
 */
let mapReadyLogged = false; // Ù…ØªØºÙŠØ± Ù„ØªØ¹Ù‚Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©

function isMapReadyToUse() {
    if (typeof map === 'undefined') {
        console.error("ğŸš¨ 60 [Ø®Ø·Ø£] Ø§Ù„ÙƒØ§Ø¦Ù† 'map' ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù Ø¨Ø¹Ø¯. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦ØªÙ‡.");
        initializeMap(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
        return false;
    }

    if (!(map instanceof mapboxgl.Map)) {
        console.error("ğŸš¨ 61 [Ø®Ø·Ø£] Ø§Ù„ÙƒØ§Ø¦Ù† 'map' Ù„ÙŠØ³ Ù…Ø«ÙŠÙ„Ø§Ù‹ Ù„Ù€ Mapbox. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦ØªÙ‡.");
        initializeMap(); // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        return false;
    }

    if (!map.isStyleLoaded()) {
        console.warn("âš ï¸ 62 [ØªØ­Ø°ÙŠØ±] Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯.");
        return false;
    }

 
    if (typeof isMapReady === 'undefined' || !isMapReady) {
        console.warn("âš ï¸ 63 [ØªØ­Ø°ÙŠØ±] Ø­Ø§Ù„Ø© isMapReady ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø© Ø£Ùˆ ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");
        return false;
    }

    if (!mapReadyLogged) {
        console.log("âœ… 114 [Ù†Ø¬Ø§Ø­] Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„! ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§.");
        mapReadyLogged = true; // Ù…Ù†Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    }


    return true;
}


// Ø¯Ø§Ù„Ø© ØªÙ†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ù†Ù…Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
function waitUntilMapReady() {
    return new Promise((resolve, reject) => {
        if (map && map.isStyleLoaded()) {
            console.log("â„¹ï¸: 176 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
            resolve();
        } else {
            // Ø§Ù†ØªØ¸Ø§Ø± Ø­Ø¯Ø« ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· (ÙŠØ¹Ù…Ù„ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
            map.once('style.load', () => {
                console.log("â„¹ï¸: 177 ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· â€“ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ø§Ù„Ø¢Ù†.");
                resolve();
            });
            // ØªØ¹ÙŠÙŠÙ† Ù…Ù‡Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± (Ù…Ø«Ù„Ø§Ù‹ 15 Ø«Ø§Ù†ÙŠØ©)
            setTimeout(() => {
                if (!map.isStyleLoaded()) {
                    console.error("ğŸš¨:178  Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·.");
                    reject(new Error(" 179 Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·."));
                }
            }, 15000);
        }
    });
}


let map; // ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„.
console.log("âš™ï¸ 57 ØªÙ… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± map ÙˆÙ‡Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹:", map);

let isMapInitialized = false; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.
console.log("âš™ï¸ 58 ØªÙ… ØªØ¹Ø±ÙŠÙ isMapInitialized ÙˆÙ‚ÙŠÙ…ØªÙ‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ:", isMapInitialized);


/**
 * Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
 * @returns {boolean} Ù‡Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
 */







// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Ø¨Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØµØ­ÙŠØ­Ø©
const firebaseConfig = {
    apiKey: "AIzaSyAQ2FQL0DvbPx4YnJrrAmal2o-yaH_KP_s",
    authDomain: "adlo-44d1b.firebaseapp.com",
    databaseURL: "https://adlo-44d1b-default-rtdb.firebaseio.com",
    projectId: "adlo-44d1b",
    storageBucket: "adlo-44d1b.firebasestorage.app",
    messagingSenderId: "96260637269",
    appId: "1:96260637269:web:e3bc37ab2b41038c254adc",
    measurementId: "G-R0SGBWC3CJ"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    console.log("âœ… 94 Firebase ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­.");
} else {
    console.warn("âš ï¸ 95 Firebase ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ù„Ù† ÙŠØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
}



function focusOnWorkerLocation(workerId) {
  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ…Ø±ÙŠØ± Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„ 547
  if (!workerId) {
    console.error("ğŸš¨ 190 Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„.");
    return;
  }
  console.log(`ğŸ” 191 Ø¨Ø¯Ø¡ ØªÙ†ÙÙŠØ° focusOnWorkerLocation Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}`);

  // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Firebase
  database.ref(`workers/${workerId}/location`).once('value')
    .then((snapshot) => {
      const location = snapshot.val();
      console.log("ğŸ“¡ 193 ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase:", location);

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØµØ­ØªÙ‡Ø§
      if (location && location.lat && location.lng) {
        console.log(`ğŸ“ 194 Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„: ${location.lng}, ${location.lat}`);

        // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªÙƒÙˆÙ† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
        waitUntilMapReady().then(() => {
  console.log(`ğŸ—ºï¸ Ø³ÙŠØªÙ… ØªØ±ÙƒÙŠØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId}`);
  map.flyTo({
    center: [location.lng, location.lat],
    zoom: 15,
    speed: 0.8,       // ØªØ¨Ø§Ø·Ø¤ Ø§Ù„Ø­Ø±ÙƒØ© Ù„Ù†Ø¹ÙˆÙ…Ø© Ø£ÙØ¶Ù„
    curve: 1.8,       // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ù†Ø­Ù†Ø§Ø¡ Ù„Ù…Ù†Ø­Ù†Ù‰ Ø£ÙƒØ«Ø± Ø³Ù„Ø§Ø³Ø©
    easing: function(t) { return t; }  // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªØ£Ø«ÙŠØ± ØªØ®ÙÙŠÙ Ù…Ø®ØªÙ„Ù
  });
}).catch(err => {
  console.error("ğŸš¨ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", err);
});

      } else {
        console.error(`ğŸš¨ 199 Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId} ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.`);
      }
    })
    .catch((error) => {
      console.error(`ğŸš¨ 200 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId}:`, error);
    });
}





// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù…ÙˆÙ‚Ø¹ÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙŠØºØ© Haversine (ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ø³Ø·Ø± 265)
function calculateDistance(loc1, loc2) {
    if (!loc1 || !loc2) {
        console.error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©");
        return 0;
    }
    const lat1 = parseFloat(loc1.lat);
    const lng1 = parseFloat(loc1.lng);
    const lat2 = parseFloat(loc2.lat);
    const lng2 = parseFloat(loc2.lng);
    const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c;
    console.log(`Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹ÙŠÙ†: ${distance.toFixed(2)} ÙƒÙ…`);
    return distance;
}


// Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© getWorkerDistance Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆÙ…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨
function getWorkerDistance() {
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª currentWorkerLocation Ùˆ jobLocation Ù…Ø¹Ø±Ù‘ÙØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
    if (typeof currentWorkerLocation === 'undefined' || typeof jobLocation === 'undefined') {
        console.error("Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©");
        return 0;
    }
    return calculateDistance(currentWorkerLocation, jobLocation);
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ù„ØºØ§Ø¡
function showCancelConfirmation(callback) {
    const confirmation = confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ");
    if (confirmation) {
        callback(); // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¥Ø°Ø§ ÙˆØ§ÙÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    } else {
        console.log("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
    }
}



function calculateETA(workerLocation, jobLocation, callback) {
    const directionsRequest = `https://api.mapbox.com/directions/v5/mapbox/driving/${workerLocation.lng},${workerLocation.lat};${jobLocation.lng},${jobLocation.lat}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`;
    fetch(directionsRequest)
        .then(response => response.json())
        .then(data => {
            if (!data.routes || !data.routes[0]) {
                console.error("Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù…Ù† API");
                return;
            }
            const durationInSeconds = data.routes[0].duration;
            const distanceInMeters = data.routes[0].distance;
            console.log("ØªÙ… Ø­Ø³Ø§Ø¨ ETA Ø¨Ù†Ø¬Ø§Ø­", { duration: durationInSeconds, distance: distanceInMeters });
            callback(null, { duration: durationInSeconds, distance: distanceInMeters, route: data.routes[0].geometry });
        })
        .catch(err => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù„Ø­Ø³Ø§Ø¨ ETA:", err);
            callback(err);
        });
}

function updateETADisplay(duration, distance, targetElement) {
    const minutes = Math.round(duration / 60);
    const kilometers = (distance / 1000).toFixed(2);
    targetElement.innerText = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±: ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© | Ø§Ù„Ù…Ø³Ø§ÙØ©: ${kilometers} ÙƒÙ…`;
    console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±", { minutes, kilometers });
}


function startRealTimeETATracking(workerLocation, jobLocation) {
    const etaDisplay = document.getElementById('etaDisplay');
    if (!etaDisplay) {
        console.error("Ø¹Ù†ØµØ± etaDisplay ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Ø¯ÙŠØ« ETA");
        return;
    }
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ù…Ø¤Ø´Ø± Ø³Ø§Ø¨Ù‚
    orderCanceled = false;
    if (window.etaIntervalId) {
        clearInterval(window.etaIntervalId);
        window.etaIntervalId = null;
    }
    
    const intervalId = setInterval(() => {
        console.log("Ù‚ÙŠÙ…Ø© orderCanceled:", orderCanceled);
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…Ù„ØºÙ‰ØŒ ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª ÙˆØ¹Ø¯Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«
        if (orderCanceled) {
            clearInterval(intervalId);
            console.log("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ ETA Ù„Ø£Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…Ù„ØºÙ‰.");
            return;
        }
        calculateETA(workerLocation, jobLocation, (err, data) => {
            if (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ ETA:", err);
                return;
            }
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ ETA
            updateETADisplay(data.duration, data.distance, etaDisplay);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆÙ…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨
            const distance = calculateDistance(workerLocation, jobLocation);
            if (distance <= 0.5 && window.fullPhone) {
                document.getElementById('userPhone').innerText = `Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${window.fullPhone}`;
            }
        });
    }, 5000); // Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
    console.log("ØªÙ… Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ ETA ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ");
    return intervalId;
}


// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
function formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours} Ø³Ø§Ø¹Ø© ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© ${seconds} Ø«Ø§Ù†ÙŠØ©`;
}

function startCountdown(duration, targetElement, onComplete) {
    if (!targetElement) {
        console.error("âš ï¸ Ø¹Ù†ØµØ± 'countdownTimer' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©.");
        return;
    }
    let remaining = duration;
    targetElement.innerText = formatTime(remaining);
    const countdownInterval = setInterval(() => {
        remaining -= 1000;
        if (remaining <= 0) {
            clearInterval(countdownInterval);
            targetElement.innerText = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª";
            console.log("ØªÙ… Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­");
            onComplete();  // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
        } else {
            targetElement.innerText = formatTime(remaining);
        }
    }, 1000);
    console.log("ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ");
    // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙŠ Ù…ØªØºÙŠØ± Ø¹Ø§Ù…
    window.countdownIntervalId = countdownInterval;
    return countdownInterval;
}






// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Messaging Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙ‚Ø·
const messaging = firebase.messaging();

// ØªØ¹Ø±ÙŠÙ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„
function sendPusherNotificationByWorker(workerId, message) {
    fetch('http://localhost:7000/send-notification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ workerId, message })
    })
    .then((response) => response.json())
    .then((data) => console.log(' 188 ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­:', data))
    .catch((error) => console.error(' 189 ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', error));
}






    
    // Ù…Ø±Ø¬Ø¹ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø­ÙŠØ« Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„
    const database = firebase.database();
    const workersRef = database.ref('workers');




// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… Ø¨Ø¯ÙˆÙ† ÙØ­Øµ Ù…Ø³Ø¨Ù‚
let workerId = null;

// Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function initializeWorkerSession(workerId) {
    // ØªØ£ÙƒÙŠØ¯ Ø£Ù† workerId (Ø£Ùˆ currentWorkerId) ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
    console.log("âœ… currentWorkerId:", workerId);
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„
    window.workerRef = database.ref(`workers/${workerId}`);
    window.workerReviewsRef = workerRef.child('reviews');

    console.log("âœ… workerRef:", workerRef.toString());
    console.log("âœ… workerReviewsRef:", workerReviewsRef.toString());
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙŠ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±Ù
    updateLocationWithGPS(workerId);
    focusOnWorkerLocation(workerId);

    // ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
    workerRef.child('currentRequest').on('value', (snapshot) => {
        const requestData = snapshot.val();
        if (requestData) {
            console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}: ${requestData.status}`);
        } else {
            console.log(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§ Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}`);
        }
    });
}




// Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„
let currentWorkerId = null; // ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠÙ‘Ø± Ø¹Ø§Ù… Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„
let currentWorkerName = null; // ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠÙ‘Ø± Ø¹Ø§Ù… Ù„ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„
let activeRequestExists = false; // Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ø¹Ø§Ù…Ù„ Ø·Ù„Ø¨ Ù†Ø´Ø· Ø¨Ø§Ù„ÙØ¹Ù„

function loginWorker() {
    const inputId = document.getElementById('workerLoginId').value;

    if (!inputId) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„.");
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¹Ø±Ù Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¯Ø§Ø®Ù„ "workers"
    database.ref(`workers/${inputId}`).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const workerData = snapshot.val();
                console.log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${workerData.name}`);
                
                // ØªØ¹ÙŠÙŠÙ† currentWorkerId Ùˆ currentWorkerName Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                currentWorkerId = inputId;
                currentWorkerName = workerData.name; // Ø¥Ø¶Ø§ÙØ© ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„

                // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                document.getElementById('loginPopup').style.display = 'none';
                
                // ØªÙ‡ÙŠØ¦Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ù„
                initializeWorkerSession(currentWorkerId);
            } else {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¹Ø±Ù Ø¯Ø§Ø®Ù„ "availableWorkerIds"
                database.ref(`availableWorkerIds/${inputId}`).once('value')
                    .then((availableSnapshot) => {
                        if (availableSnapshot.exists() && availableSnapshot.val().used === false) {
                            console.log(`ğŸ”„ ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ${inputId} ÙˆØ¥Ù†Ø´Ø§Ø¤Ù‡ ÙÙŠ workers.`);
                            
                            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ÙÙŠ availableWorkerIds Ø¥Ù„Ù‰ "Ù…Ø³ØªØ®Ø¯Ù…"
                            database.ref(`availableWorkerIds/${inputId}`).update({ used: true, usedAt: new Date().toISOString() });
                            
                            const workerName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:");
                            if (!workerName) {
                                alert("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù.");
                                return;
                            }
                            
                            // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ "workers"
                            database.ref(`workers/${inputId}`).set({
                                name: workerName,
                                assignedAt: new Date().toISOString(),
                                location: { lng: 0, lat: 0 } // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§
                            }).then(() => {
                                console.log(`âœ… ØªÙ… ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ${inputId} Ù„Ù„Ø¹Ø§Ù…Ù„: ${workerName}`);
                                
                                // ØªØ¹ÙŠÙŠÙ† currentWorkerId Ùˆ currentWorkerName Ø¨Ø¹Ø¯ Ø§Ù„ØªØ®ØµÙŠØµ
                                currentWorkerId = inputId;
                                currentWorkerName = workerName; // ØªØ¹ÙŠÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„
                                
                                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ®ØµÙŠØµ
                                document.getElementById('loginPopup').style.display = 'none';
                                initializeWorkerSession(currentWorkerId);
                            });
                        } else {
                            console.warn("âš ï¸ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                            alert("Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± ØµØ§Ù„Ø­ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚.");
                        }
                    })
                    .catch((error) => console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† availableWorkerIds:", error));
            }
        })
        .catch((error) => console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error));
}








// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« activeWorkers Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
function updateActiveWorkerLocation(workerId, location) {
    try {
        const activeWorkerRef = database.ref('activeWorkers/' + workerId);
        activeWorkerRef.set({
            location: location,
            active: true
        });
    } catch (error) {
        console.error("Ø®Ø·Ø£ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« activeWorkers:", error);
    }
}

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… GPS (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªØ´Ù…Ù„ ØªØ­Ø¯ÙŠØ« activeWorkers)
function updateLocationWithGPS(workerId) {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const initialLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
            };
            console.log("âœ… 90 Pre-cached location:", initialLocation);
            updateWorkerLocation(workerId, initialLocation);
            updateActiveWorkerLocation(workerId, initialLocation);
        }, (error) => {
            console.error("ğŸš¨ 91 Error pre-fetching location:", error);
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
        
        navigator.geolocation.watchPosition((position) => {
    const newLocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude,
    };
    console.log("ğŸ“¡ 93 Updating location with watchPosition:", newLocation);
    window.currentWorkerLocation = newLocation;
    updateWorkerLocation(workerId, newLocation);
    updateActiveWorkerLocation(workerId, newLocation);
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ÙØ­Øµ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØªØ­Ø¯ÙŠØ« Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    checkDistanceAndToggleCancelButton();
}, (error) => {
    console.error("ğŸš¨ 197 Error during continuous location tracking:", error);
}, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });

    } else {
        console.error("ğŸš¨ 198 Geolocation is not supported in this browser.");
    }
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
let initialLoadDone = false;
const workerRequestsRef = database.ref('workRequests').orderByChild('workerId').equalTo(workerId);

// Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù†Ø³ØªØ®Ø¯Ù… once Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
workerRequestsRef.once('value', snapshot => {
    // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù†Ø¶Ø¨Ø· Ø§Ù„Ø¹Ù„Ù… Ø¥Ù„Ù‰ true
    initialLoadDone = true;
});

// Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ Ù†Ø¶ÙŠÙ Ù…Ø³ØªÙ…Ø¹ child_added
workerRequestsRef.on('child_added', snapshot => {
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù†ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø­Ø¯Ø«
    if (!initialLoadDone) return;
    
    const requestData = snapshot.val();
    console.log('Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…ÙˆØ¬Ù‡ Ù„Ùƒ:', requestData);
    alert('Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯: ' + requestData.workType);
});



function checkDistanceAndToggleCancelButton() {
    // ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨ Ù†Ø´Ø· (orderActive) ÙˆÙ„Ù… ÙŠÙÙ„ØºÙ Ø¨Ø¹Ø¯
    if (!currentRequestId || !orderActive) return;
    firebase.database().ref(`workRequests/${currentRequestId}`).once('value')
        .then(snapshot => {
            const request = snapshot.val();
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…Ù„ØºÙ‰ Ø£Ùˆ Ù„Ù… ÙŠØ¹Ø¯ ÙÙŠ Ø­Ø§Ù„Ø© "pending" ÙÙ„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            if (!request || request.status !== 'pending') {
                document.getElementById('cancelJobContainer').style.display = 'none';
                console.log("ğŸ”’ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ø¥Ù„ØºØ§Ø¡ØŒ Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡.");
                return;
            }
            if (request && request.location) {
                const distance = calculateDistance(currentWorkerLocation, request.location);
                console.log(`Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆØ§Ù„Ø·Ù„Ø¨: ${distance.toFixed(2)} ÙƒÙ…`);
                if (distance <= 0.5) {
                    document.getElementById('cancelJobContainer').style.display = 'none';
                    console.log('â±ï¸ Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù„Ø£Ù† Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ Ø£Ù‚Ù„ Ù…Ù† 500 Ù…ØªØ±.');
                } else {
                    document.getElementById('cancelJobContainer').style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©:', error);
        });
}



document.addEventListener("DOMContentLoaded", () => {
    // ØªØ£ÙƒÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
    const loginButton = document.getElementById('loginWorkerButton');
    if (!loginButton) {
        console.error("ğŸš¨ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DOM. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.");
        return;
    }
    // Ø±Ø¨Ø· Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
    loginButton.addEventListener('click', loginWorker);

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ÙŠØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰ (Ù…Ø«Ù„ acceptJobButton, locateButton, styleSelector)
    const acceptJobButton = document.getElementById('acceptJobButton');
    const locateButton = document.getElementById('locateButton');
    const styleSelector = document.getElementById('styleSelector');

    if (!acceptJobButton || !locateButton || !styleSelector) {
        console.error("ğŸš¨ Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ DOM. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.");
        return;
    }
});



// Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ø²Ø± "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨" Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ø§Ù…Ù„
// ØªØ¹Ø±ÙŠÙ Ù…ÙØ§ØªÙŠØ­ Pusher Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
const pusherInstanceId = "2a17d881-b1a6-4a38-8cd4-de1ab8212f67";
const pusherAuthorization = "94B66644D08CBCEDEEBE73156329B8DF8F82064EC4B9D16750B88454146530FB";

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
function resetJobUI() {
    // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
    document.getElementById('jobDetailsPopup').style.display = 'none';
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
    document.getElementById('cancelJobContainer').style.display = 'none';
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ø±ÙÙ‡ Ù…Ø­ÙÙˆØ¸ ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
    if (window.countdownIntervalId) {
        clearInterval(window.countdownIntervalId);
        window.countdownIntervalId = null;
        console.log("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ.");
    }
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù†ÙØ³Ù‡
    const countdownTimer = document.getElementById('countdownTimer');
    if (countdownTimer) {
        countdownTimer.innerText = '';
    }
    document.getElementById('countdownPanel').style.display = 'none';  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¹Ø±Ø¶ ETA Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù†ÙØ³Ù‡
    const etaDisplay = document.getElementById('etaDisplay');
    if (etaDisplay) {
        etaDisplay.innerText = '';
    }
    document.getElementById('etaPanel').style.display = 'none';  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    
    // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    localStorage.removeItem('orderStatus');
    localStorage.removeItem('currentRequestId');
}






document.getElementById('cancelJobButton').addEventListener('click', function() {
    const distance = getWorkerDistance();
    if (distance < 0.5) { 
        alert("Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¢Ù†.");
        console.error("Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù‚ØªØ±Ø§Ø¨ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹");
        return;
    } else {
        if (!confirm("ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø·Ù„Ø¨ Ù„Ù† ÙŠÙÙ„ØºÙ‰ Ø¥Ø°Ø§ Ø£ØµØ¨Ø­Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹ (Ø£Ù‚Ù„ Ù…Ù† 500 Ù…ØªØ±) Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) {
            console.log("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
            return;
        }
    }
    
    showCancelConfirmation(function() {
        const requestRef = firebase.database().ref(`workRequests/${currentRequestId}`);
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø°ÙŠ Ø£Ù„ØºÙ‰ Ø§Ù„Ø·Ù„Ø¨
        requestRef.update({ 
            status: 'pending',
            canceledBy: currentWorkerId  
        })
        .then(() => {
            // ØªØ³Ø¬ÙŠÙ„ Ø³Ø¬Ù„ ØªØ§Ø±ÙŠØ®ÙŠ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¥Ù„ØºØ§Ø¡ Ù…Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ currentWorkerName ØºÙŠØ± Ù…Ø¹Ø±Ù
            const historyRef = requestRef.child('orderHistory');
            historyRef.push({
                 type: 'canceled',
                 workerId: currentWorkerId,
                 workerName: currentWorkerName ? currentWorkerName : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
                 timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨. ÙŠÙ…ÙƒÙ†Ùƒ Ù‚Ø¨ÙˆÙ„Ù‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            orderCanceled = true;
            orderActive = false;
            activeRequestExists = false;
            currentRequestId = null;
            localStorage.removeItem('orderStatus');
            localStorage.removeItem('currentRequestId');
            sendPusherNotification(window.selectedWorkerId, 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø§Ù…Ù„.');
            console.log("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Firebase Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø°ÙŠ Ø£Ù„ØºÙ‰ Ø§Ù„Ø·Ù„Ø¨.");
            if (map.getLayer('route')) {
                map.removeLayer('route');
                map.removeSource('route');
                console.log("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù…Ø³Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
            }
            if (window.etaIntervalId) {
                clearInterval(window.etaIntervalId);
                window.etaIntervalId = null;
                console.log("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ ETA.");
            }
            if (window.countdownIntervalId) {
                clearInterval(window.countdownIntervalId);
                window.countdownIntervalId = null;
                console.log("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ.");
            }
            resetJobUI();
        })
        .catch((err) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:", err);
        });
    });
});






 

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„
        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
        function showJobDetails(jobData) {
    // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„
    document.getElementById('jobDescription').innerText = `ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„: ${jobData.description || jobData.workType}`;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø«Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹
    const fullPhone = jobData.phone || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
    window.fullPhone = fullPhone;
    let maskedPhone = fullPhone;
    if (fullPhone !== "ØºÙŠØ± Ù…ØªÙˆÙØ±" && fullPhone.length > 5) {
       maskedPhone = fullPhone.substr(0, 5) + "*****";
    }
    document.getElementById('userPhone').innerText = `Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${maskedPhone} (Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨ 500 Ù…ØªØ±)`;
    
    if (jobData.imageUrl) {
        const jobImage = document.getElementById('jobImage');
        jobImage.src = jobData.imageUrl;
        jobImage.style.display = 'block';
    } else {
        document.getElementById('jobImage').style.display = 'none';
    }
    
    document.getElementById('jobLocation').innerText = jobData.region 
        ? `Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${jobData.region}` 
        : `Ø§Ù„Ù…ÙˆÙ‚Ø¹: (${jobData.location.lat}, ${jobData.location.lng})`;
    
    document.getElementById('jobDuration').innerText = `Ø§Ù„Ù…Ø¯Ø©: ${jobData.time}`;
    document.getElementById('jobBudget').innerText = `Ø§Ù„Ù…Ø¨Ù„Øº: ${jobData.budget}`;
    
    window.jobLocation = jobData.location;
    
    if (typeof currentWorkerLocation === 'undefined') {
        console.error("currentWorkerLocation ØºÙŠØ± Ù…Ø¹Ø±Ù Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©");
    } else {
        const distance = calculateDistance(currentWorkerLocation, jobData.location);
        const distanceElem = document.getElementById('jobDistance');
        if (distanceElem) {
            distanceElem.innerText = `Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distance.toFixed(2)} ÙƒÙ…`;
        }
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø­Ø³Ø§Ø¨ ETA ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        calculateETA(currentWorkerLocation, jobData.location, (err, data) => {
            if (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ ETA Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„", err);
                return;
            }
            const etaElem = document.getElementById('estimatedArrivalTime');
            if (etaElem) {
                const minutes = Math.round(data.duration / 60);
                etaElem.innerText = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±: ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            }
        });
    }
    
    // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¸Ù‡Ø± Ø²Ø± "Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨" Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
    const acceptBtn = document.getElementById('acceptJobButton');
    if (jobData.status !== 'pending') {
        acceptBtn.style.display = 'inline-block';
        acceptBtn.textContent = 'ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨';
        acceptBtn.style.backgroundColor = 'red';
        acceptBtn.disabled = true;
    } else {
        acceptBtn.style.display = 'inline-block';
        acceptBtn.textContent = 'Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨';
        acceptBtn.style.backgroundColor = 'green';
        acceptBtn.disabled = false;
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„
    document.getElementById('jobDetailsPopup').style.display = 'block';
    
    // **Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯**: Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§ÙˆÙŠØ§Øª ETA ÙˆØ§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ù†Ø´Ø·
    document.getElementById('etaPanel').style.display = 'block';
    document.getElementById('countdownPanel').style.display = 'block';
}






    // Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ø²Ø± "Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨"
    document.getElementById('rejectDirectRequest').addEventListener('click', function() {
        console.log("ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨");
        // Ù…Ø«Ø§Ù„ Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firebase Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¶
        firebase.database().ref('workRequests/' + currentRequestId).update({
            status: 'rejected'
        }).then(function() {
            console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ rejected ÙÙŠ Firebase");
        }).catch(function(error) {
            console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:", error);
        });
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¶
        document.getElementById('directRequestPopup').style.display = 'none';
        alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨.");
    });






// Ù…Ø³ØªÙ…Ø¹ Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
const savedRequests = []; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§

function processSavedRequests() {
    try {
        console.log("âš¡ 37 Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...");

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
        if (typeof map === 'undefined' || !(map instanceof mapboxgl.Map)) {
    console.error("ğŸš¨ 115 Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ù‡ÙŠØ£ Ø£Ùˆ ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦ØªÙ‡.");
    initializeMap(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    return;
}

// [Ø§Ù„Ø³Ø·Ø± 35-42] Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… waitUntilMapReady()
waitUntilMapReady()
    .then(() => {
        // Ù‡Ù†Ø§ ØªÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ÙŠØªØ§Ø¨Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        // Ù…Ø«Ù„Ø§Ù‹: processSavedRequests();
    })
    .catch((err) => {
        console.warn("âš ï¸ 36: Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙŠØ³Øª Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©. Ø³ÙŠØªÙ… ØªØ£Ø¬ÙŠÙ„Ù‡Ø§.", err);
        return;
    });




        console.log("âš¡ 79 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©. Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...");

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        while (savedRequests.length > 0) {
            const request = savedRequests.shift();

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
            if (!request || !request.requestData || !request.requestId) {
                console.error("ğŸš¨ 41 Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ø·Ù„Ø¨:", request);
if (!request) {
    console.error("ğŸš¨ 155 Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Firebase.");
}      continue; // ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­
            }

            const { requestData, requestId } = request;
            console.log(`âš™ï¸ 42 Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸: ${requestId}`);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
            if (requestData.status === 'pending') {
                try {
                    console.log(`âŒ› 33 ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ø·Ù„Ø¨ ${requestId}.`);
                    startRequestTimeout(requestId, 10); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
                    showJobDetails(requestData); // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
                } catch (error) {
                    console.error(`ğŸš¨ 34 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}:`, error);
                }
            } else {
                console.warn(`âš ï¸ 35 Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù„ÙŠØ³ ÙÙŠ Ø­Ø§Ù„Ø© 'pending'.`);
            }
        }

        console.log("âœ… 74 ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­.");
    } catch (error) {
        console.error("ğŸš¨ 75 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:", error);
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©
function saveRequestForLater(requestData, requestId) {
    if (!requestData || !requestId) {
        console.error("ğŸš¨ 80 Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨:", { requestData, requestId });
        return;
    }
    console.log(`ğŸ“‹ 81 ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§:`, requestData);
    savedRequests.push({ requestData, requestId });
}






// ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
const requestRef = database.ref('workRequests');
requestRef.on('child_added', (snapshot) => {
    const requestData = snapshot.val();
    const requestId = snapshot.key;

    // Ø¥Ø¶Ø§ÙØ©: ØªØ¹ÙŠÙŠÙ† currentRequestId Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    currentRequestId = requestId;
    console.log("âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† currentRequestId Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", currentRequestId);

    // ***** Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ù†Ø´Ø· Ù…Ø³Ø¨Ù‚Ø§Ù‹ *****
    if (activeRequestExists) {
        console.log("âš ï¸ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù„Ø¯ÙŠÙ‡ Ø·Ù„Ø¨ Ù†Ø´Ø· Ø¨Ø§Ù„ÙØ¹Ù„. ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯.");
        // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ ØªØ­Ø¯ÙŠØ« Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ø¥Ù† Ø±ØºØ¨Øª (Ù…Ø«Ù„Ø§Ù‹ ØªØ­Ø¯ÙŠØ« innerHTML)
        return;
    }
    // *****************************************************

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
    if (!requestData || !requestId) {
        console.error("ğŸš¨ 38 Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", { requestData, requestId });
        return;
    }
    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…ØªÙˆÙØ±
    if (!window.currentWorkerLocation) {
        console.error("ğŸš¨ 210 Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ØºÙŠØ± Ù…ØªÙˆÙØ±.");
        return;
    }
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙ…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨
    const distance = calculateDistance(window.currentWorkerLocation, requestData.location);
    console.log(` 211 Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆØ§Ù„Ø·Ù„Ø¨ ${requestId}: ${distance.toFixed(2)} ÙƒÙ…`);
    // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø³Ø§ÙØ© Ø£ÙƒØ¨Ø± Ù…Ù† 15 ÙƒÙ…ØŒ Ù„Ø§ ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨
    if (distance > 15) {
        console.warn(`âš ï¸ Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ù†Ø·Ø§Ù‚ Ø§Ù„Ù€ 15 ÙƒÙ…ØŒ Ù„Ù† ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡.`);
        return;
    }
    // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªÙƒÙˆÙ† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨
    waitUntilMapReady()
        .then(() => {
            console.log(`ğŸ‰ 40 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}.`);
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø­Ø§Ù„Ø© "pending"
            if (requestData.status === 'pending') {
                try {
                    console.log(`âš™ï¸ 44 Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}.`);
                    startRequestTimeout(requestId, 10); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
                    showJobDetails(requestData); // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
                } catch (error) {
                    console.error(`ğŸš¨ 72 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}:`, error);
                }
            } else {
                console.warn(`âš ï¸ 73 Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù„ÙŠØ³ ÙÙŠ Ø­Ø§Ù„Ø© 'pending'.`);
            }
        })
        .catch((err) => {
            console.warn(`âš ï¸ 39: Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙŠØ³Øª Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯. Ø³ÙŠØªÙ… ØªØ£Ø¬ÙŠÙ„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨ ${requestId}.`, err);
            saveRequestForLater(requestData, requestId);
            return;
        });
});








// Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·
let retryCount = 0; // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
const maxRetries = 3; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª

function checkMapStyleLoaded() {
    if (!map) {
        console.error("ğŸš¨ 82 Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ù‡ÙŠØ£. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦ØªÙ‡ Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ checkMapStyleLoaded.");
        return;
    }

    if (map.isStyleLoaded()) {
    isMapReady = true;
    console.log("ğŸ‰ 157 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©.");
    processSavedRequests(); // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
} else if (retryCount < maxRetries) {
    retryCount++;
    console.warn(`âš ï¸ 48 Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ù‚Ù… ${retryCount}: Ø§Ù„Ù†Ù…Ø· Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© (${retryCount}/${maxRetries}).`);
    setTimeout(() => {
        checkMapStyleLoaded(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
    }, 2000); // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ£Ø®ÙŠØ± Ø¥Ù„Ù‰ Ø«Ø§Ù†ÙŠØªÙŠÙ†
} else {
    console.error("ğŸš¨ 49 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§ØªØµØ§Ù„ Ø§Ù„Ø´Ø¨ÙƒØ©.");
    alert("âš ï¸ 86 Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·. Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
console.error("ğŸš¨ 156 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø´Ø¨ÙƒØ©.");
}

}













// ÙƒØ§Ø¦Ù† Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚Øª Ù„ÙƒÙ„ Ø·Ù„Ø¨
const timeoutIntervals = {};

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ù…Ù‡Ù„Ø© Ø²Ù…Ù†ÙŠØ© Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function startRequestTimeout(requestId, timeoutMinutes = 10) {
    const timeoutTime = Date.now() + timeoutMinutes * 60 * 1000;
    const requestRef = database.ref(`workRequests/${requestId}`);

    // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙŠ ÙƒØ§Ø¦Ù† timeoutIntervals Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… requestId ÙƒÙ…ÙØªØ§Ø­
    timeoutIntervals[requestId] = setInterval(() => {
        requestRef.once('value').then((snapshot) => {
            const requestData = snapshot.val();
            console.log(`[Timeout Checker] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId} ÙÙŠ ${new Date().toLocaleTimeString()}: ${requestData.status}`);
            // Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· Ù„Ø¹Ø¯Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† acceptedBy Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
            if (Date.now() > timeoutTime && requestData.status === 'pending' && !requestData.acceptedBy) {
                requestRef.update({ status: 'timeout' });
                clearInterval(timeoutIntervals[requestId]);
                console.log(`Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ù‚Ø¨ÙˆÙ„Ù‡ ÙˆØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„ØªÙ‡ Ø¥Ù„Ù‰ timeout.`);
            }
        });
    }, 10000);
}

// Ø¯Ø§Ù„Ø© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function acceptRequest(requestId, workerId, workerName) {
    const requestRef = database.ref(`workRequests/${requestId}`);
    return requestRef.once('value')
        .then(snapshot => {
            const request = snapshot.val();
            if (!request) {
                alert('âŒ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.');
                console.error(`âŒ ÙØ´Ù„ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ${requestId}.`);
                return Promise.reject('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            }
            if (request.status !== 'pending') {
                alert('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø£Ù†Ù‡ Ù„Ù… ÙŠØ¹Ø¯ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±.');
                console.error(`âŒ Ø±ÙØ¶ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ${requestId}: Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ${request.status}`);
                return Promise.reject('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ù‚Ø¨ÙˆÙ„');
            }
            return requestRef.update({
                status: 'accepted',
                acceptedBy: workerId
            });
        })
        .then(() => {
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠÙØ¶Ø§Ù Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ø¯ÙˆÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
            const activityRef = database.ref(`workRequests/${requestId}/orderHistory`);
            activityRef.push({
                type: 'accepted',
                workerId: workerId,
                workerName: workerName,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            alert('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.');
            console.log(`ğŸ“¢ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù…Ù† Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId} ÙÙŠ ${new Date().toLocaleTimeString()}`);
            if (window.markers && window.markers[requestId]) {
                window.markers[requestId].setColor('yellow');
                console.log(`ğŸ¨ ØªÙ… ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ù„Ù„Ø·Ù„Ø¨ ${requestId} Ø¥Ù„Ù‰ Ø£ØµÙØ±.`);
            }
            if (window.timeoutIntervals && window.timeoutIntervals[requestId]) {
                clearInterval(window.timeoutIntervals[requestId]);
                console.log(`â³ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù…Ø¤Ù‚Øª Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„.`);
                delete window.timeoutIntervals[requestId];
            }
            requestRef.onDisconnect().update({
                status: 'pending',
                note: 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§ØªØµØ§Ù„ Ø§Ù„Ø¹Ø§Ù…Ù„'
            })
            .then(() => {
                console.log("âœ… onDisconnect ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡ Ù„Ù„Ø·Ù„Ø¨:", requestId);
            })
            .catch((error) => {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹ÙŠÙŠÙ† onDisconnect Ù„Ù„Ø·Ù„Ø¨:", requestId, error);
            });
            startWorkerHeartbeat(workerId);

            // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
orderCanceled = false;
orderActive = true;
localStorage.setItem('orderStatus', 'accepted'); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨

// Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø§Øª ETA ÙˆØ§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
document.getElementById('etaPanel').style.display = 'block';
document.getElementById('countdownPanel').style.display = 'block';

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¹Ø§Ù…Ù„ ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù‡Ù†Ø§Ù„Ùƒ Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹
if (typeof updateLocationWithGPS === 'function' && currentWorkerId) {
    updateLocationWithGPS(currentWorkerId); // Ø³ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« currentWorkerLocation
}

// ØªØ­Ø¯ÙŠØ« jobLocation Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (ÙŠÙØªØ±Ø¶ Ø£Ù† requestData ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
if (requestData && requestData.location) {
    jobLocation = requestData.location;
} else {
    console.error("Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.");
}

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù…ØªÙˆÙØ±Ø© Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ ETA
console.log('currentWorkerLocation:', currentWorkerLocation);
console.log('jobLocation:', jobLocation);

if (currentWorkerLocation && jobLocation) {
    // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ ETA Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    window.etaIntervalId = startRealTimeETATracking(currentWorkerLocation, jobLocation);
} else {
    console.error("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ ETAØ› ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹.");
}

        })
        .catch(error => {
            console.error(`âŒ Ù„Ù… ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ${requestId}:`, error);
        });
}













    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function addWorker(workerId, workerName, lng, lat) {
      workersRef.child(workerId).set({
        name: workerName,
        location: {
          lng: lng,
          lat: lat
        }
      });
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ®ØµÙŠØµ Ù…Ø¹Ø±Ù‘Ù Ù„Ø¹Ø§Ù…Ù„ Ù…Ø¹ÙŠÙ†
    function assignWorkerId(workerName, lng, lat) {
    database.ref('availableWorkerIds').orderByChild('used').equalTo(false).limitToFirst(1).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const workerId = Object.keys(snapshot.val())[0]; // Ø£ÙˆÙ„ Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…

                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø¥Ù„Ù‰ "Ù…Ø³ØªØ®Ø¯Ù…"
                database.ref(`availableWorkerIds/${workerId}`).update({ used: true });

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                database.ref(`workers/${workerId}`).set({
                    name: workerName,
                    assignedAt: new Date().toISOString(),
                    location: { lng: lng, lat: lat }
                });

                console.log(`ØªÙ… ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ${workerId} Ù„Ù„Ø¹Ø§Ù…Ù„: ${workerName}`);
            } else {
                console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù‘ÙØ§Øª Ù…ØªØ§Ø­Ø©.");
            }
        })
        .catch((error) => console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:", error));
}

// Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„
// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
// ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„



// Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
function toggleOrdersPanel() {
  const panel = document.getElementById("ordersPanel");
  if (panel.style.display === "none" || panel.style.display === "") {
    panel.style.display = "block";
    console.log("Orders panel shown.");
    fetchPendingOrders();
  } else {
    panel.style.display = "none";
    console.log("Orders panel hidden.");
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù…Ù† Firebase ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø©
function fetchPendingOrders() {
  const ordersPanel = document.getElementById("ordersPanel");
  ordersPanel.innerHTML = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…
  firebase.database().ref("workRequests")
    .orderByChild("status").equalTo("pending")
    .once("value", function(snapshot) {
      if (!snapshot.exists()) {
        ordersPanel.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>";
        console.log("No pending orders found.");
        updateOrdersBadge(0);
        return;
      }
      let orders = [];
      snapshot.forEach(function(childSnapshot) {
        const order = childSnapshot.val();
        order.orderId = childSnapshot.key;
        orders.push(order);
      });
      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
      orders.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
      orders.forEach(function(order) {
        const orderItem = document.createElement("div");
        orderItem.className = "orderItem";
        orderItem.innerHTML = `
          <p><strong>ÙˆÙ‚Øª Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…:</strong> ${order.timestamp || "ØºÙŠØ± Ù…ØªÙˆÙØ±"}</p>
          <p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„:</strong> ${order.workType || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</p>
          <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${order.status === "pending" ? "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±" : order.status}</p>
          <button onclick="acceptOrder('${order.orderId}')">Ù‚Ø¨ÙˆÙ„</button>
        `;
        ordersPanel.appendChild(orderItem);
      });
      updateOrdersBadge(orders.length);
    }, function(error) {
      console.error("Error fetching pending orders:", error);
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø²Ø± "Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª"
function updateOrdersBadge(count) {
  const badge = document.getElementById("ordersBadge");
  badge.textContent = count > 0 ? count : "";
}

// Ø¯Ø§Ù„Ø© Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡ ÙÙŠ Firebase
function acceptOrder(orderId) {
  firebase.database().ref("workRequests/" + orderId).update({ status: "accepted" })
    .then(function() {
      alert("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨");
      console.log("Order " + orderId + " accepted.");
      fetchPendingOrders(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„
    })
    .catch(function(error) {
      console.error("Error accepting order:", error);
    });
}

// Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener("click", function(event) {
  const panel = document.getElementById("ordersPanel");
  const toggleButton = document.getElementById("toggleOrdersButton");
  if (panel.style.display === "block" && !panel.contains(event.target) && !toggleButton.contains(event.target)) {
    panel.style.display = "none";
    console.log("Orders panel hidden due to outside click.");
  }
});

// Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª" Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
document.getElementById("toggleOrdersButton").addEventListener("click", function(event) {
  event.stopPropagation(); // Ù…Ù†Ø¹ ÙˆØµÙˆÙ„ Ø§Ù„Ø­Ø¯Ø« Ø¥Ù„Ù‰ document
  toggleOrdersPanel();
});





function sendNotificationToNearbyWorkers(requestData, userLocation) {
    const radius = 15;  // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± Ø¥Ù„Ù‰ 15 ÙƒÙ…
    console.log("ØªÙ… Ø¶Ø¨Ø· Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± Ø¹Ù„Ù‰:", radius, "ÙƒÙ…");
    // Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ ÙÙŠ Firebase
    const workersRef = database.ref('workers');
    workersRef.once('value', (snapshot) => {
        snapshot.forEach((workerSnapshot) => {
            const worker = workerSnapshot.val();
            if (!worker || !worker.location) {
                console.error("ğŸš¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ§Ù„Ø­:", workerSnapshot.key);
                return;
            }
            const distance = calculateDistance(userLocation, worker.location);
            console.log(`Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerSnapshot.key}: ${distance.toFixed(2)} ÙƒÙ…`);
            console.log("Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ÙØ±Ø³Ù„:", userLocation, "ÙˆÙ…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„:", worker.location);
    
            if (distance <= radius) {
                console.log(`ğŸ“¢ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerSnapshot.key} Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ ÙˆØ³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±.`);
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Pusher Beams
                sendPusherNotification(workerSnapshot.key, `Ø·Ù„Ø¨ ${requestData.workType} ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ.`, "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­!");
            } else {
                console.warn(`âš ï¸ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerSnapshot.key} Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù€ 15 ÙƒÙ….`);
            }
        });
    });
}







if (!window.activeListeners) {
    window.activeListeners = {}; // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒØ§Ø¦Ù† Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
}


function startTracking(workerId) {
    const workerLocationRef = database.ref(`workers/${workerId}/location`);
    if (window.activeListeners[workerId]) {
        console.warn(`âš ï¸ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId} Ù…Ø¶Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„.`);
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¬Ø¹ Ø®Ø§Øµ Ù„ÙƒÙ„ Ø¹Ø§Ù…Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… workerId
    const currentWorkerRef = database.ref(`workers/${workerId}`);
    currentWorkerRef.on('value', (snapshot) => {
        const data = snapshot.val();
        const location = data && data.location;
        if (location && location.lat && location.lng) {
            console.log(`ğŸ¤·â€â™‚ï¸ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId}:`, location);
            waitUntilMapReady()
                .then(() => {
                    updateWorkerMarker(location, workerId);
                })
                .catch((err) => {
                    console.error("âš ï¸ 2: Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø© Ø£Ùˆ Ø§Ù„Ù†Ù…Ø· ØºÙŠØ± Ù…Ø­Ù…Ù„.", err);
                });
        } else {
            console.error(`ğŸš¨ 83 Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId} ØºÙŠØ± ØµØ­ÙŠØ­Ø©:`, location);
        }
    });
    
    window.activeListeners[workerId] = true;
}










    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙƒÙ„ Ø¹Ø§Ù…Ù„
    function updateWorkerMarker(location, workerId) {
    waitUntilMapReady()
        .then(() => {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (!window.workerMarkers) {
                window.workerMarkers = {};
            }
            try {
                // Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                if (!window.workerMarkers[workerId]) {
                    window.workerMarkers[workerId] = new mapboxgl.Marker({ color: 'green' })
    .setLngLat([location.lng, location.lat])
    .addTo(map);

                    console.log(`âœ”ï¸ 17 ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}.`);
                } else {
                    window.workerMarkers[workerId].setLngLat([location.lng, location.lat]);
                    console.log(`âœ”ï¸ 15 ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}.`);
                }
            } catch (error) {
                console.error(`ğŸš¨ 16 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}:`, error);
            }
        })
        .catch((err) => {
            console.error("âš ï¸ 18 Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù… ØªØ¬Ù‡Ø² Ø¨Ø¹Ø¯:", err);
        });
}







// Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙÙØªØ±Ø¶ Ø£Ù† Ø¯Ø§Ù„Ø© loginWorker Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ initializeWorkerSession


    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Mapbox
    if (typeof mapboxgl === 'undefined') {
        console.error("Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Mapbox Ø¨Ù†Ø¬Ø§Ø­.");
    } else {
        console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Mapbox Ø¨Ù†Ø¬Ø§Ø­:", mapboxgl);
    }

        // Ù…ÙØªØ§Ø­ Mapbox
        const mapboxToken = "pk.eyJ1IjoiY2hvb3NlbWUiLCJhIjoiY20wZnVpemI2MHpreTJqcjR4ZThuam9pYyJ9.F1CjHrnJ7m-VwM_LHt0Q9Q";
        mapboxgl.accessToken = mapboxToken;

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø©
        const styles = {
    streets: 'mapbox://styles/mapbox/streets-v11',
    satellite: 'mapbox://styles/mapbox/satellite-v9',
    outdoors: 'mapbox://styles/mapbox/outdoors-v11',
    hybrid: 'mapbox://styles/mapbox/satellite-streets-v11',
    dark: 'mapbox://styles/mapbox/dark-v10',
    light: 'mapbox://styles/mapbox/light-v10'
};





        function initializeMap() {
    console.log("ğŸ”„ 110 Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©...");

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¯ ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
        if (typeof map !== 'undefined' && map instanceof mapboxgl.Map) {
            console.warn("âš ï¸ 117 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„. Ù„Ù† ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§.");
            return;
        }

        // ØªÙØ±ÙŠØº Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.innerHTML = '';
        } else {
            console.error("ğŸš¨ 118 Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± 'map'. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ DOM.");
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù† "Ø§Ù„ÙØ¶Ø§Ø¡"
map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/satellite-streets-v11',
  center: [0, 0],  // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ù…Ø±ÙƒØ² Ø§Ù„Ø£Ø±Ø¶
  zoom: 0.8,       // Ø±Ø¤ÙŠØ© Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ù…Ù† Ø§Ù„ÙØ¶Ø§Ø¡ Ø§Ù„Ø¨Ø¹ÙŠØ¯
  projection: 'globe',
  maxBounds: [[-180, -85], [180, 85]], // Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©
  interactive: true, // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù„Ù…Ø³ÙŠ
  attributionControl: false // Ø¥Ø²Ø§Ù„Ø© Ø´Ø¹Ø§Ø± Mapbox Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
});

// ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¬Ø¹Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø¹ Ø£Ø®Ù
map.on('style.load', () => {
  map.setFog({
    range: [1, 8],  // ØªÙ‚Ù„ÙŠÙ„ Ù…Ø¯Ù‰ Ø§Ù„Ø¶Ø¨Ø§Ø¨ Ø­ØªÙ‰ ÙŠØ¸Ù‡Ø± Ø§Ù„ÙØ¶Ø§Ø¡ Ø¨ÙˆØ¶ÙˆØ­
    color: 'rgba(10, 10, 25, 0.5)', // Ø¬Ø¹Ù„ Ù„ÙˆÙ† Ø§Ù„ØºÙ„Ø§Ù Ø§Ù„Ø¬ÙˆÙŠ Ø¯Ø§ÙƒÙ†Ù‹Ø§ Ø£ÙƒØ«Ø± Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„ÙØ¶Ø§Ø¡
  });
});

// ØªÙ†ÙÙŠØ° ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­Ø±Ùƒ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø±Ø¤ÙŠØ© Ø§Ù„Ø£Ø±Ø¶ Ù…Ù† Ø§Ù„ÙØ¶Ø§Ø¡
map.on('load', () => {
  waitUntilMapReady().then(() => {
    setTimeout(() => {
      map.flyTo({
        center: [13.1913, 32.8872], // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø·Ø±Ø§Ø¨Ù„Ø³
        zoom: window.innerWidth < 768 ? 9 : 12, // ØªÙ‚Ø±ÙŠØ¨ Ø£Ù‚Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ
        pitch: window.innerWidth < 768 ? 30 : 60, // Ø²Ø§ÙˆÙŠØ© Ù…ÙŠÙ„ Ø£Ù‚Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
        bearing: 45, // Ø¯ÙˆØ±Ø§Ù† Ù„Ø·ÙŠÙ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ©
        speed: 0.3, // Ø­Ø±ÙƒØ© Ø¨Ø·ÙŠØ¦Ø© Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
        curve: 2.2, // Ù…Ù†Ø­Ù†Ù‰ Ø³Ù„Ø³ Ù„Ù„Ø­Ø±ÙƒØ©
        easing: t => t * t // Ø­Ø±ÙƒØ© ØªØ®ÙÙŠÙ ØªØ¯Ø±ÙŠØ¬ÙŠØ©
      });
    }, 2000); // ØªØ£Ø®ÙŠØ± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ 2.5 Ø«Ø§Ù†ÙŠØ© Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø±Ø¤ÙŠØ© Ø§Ù„Ø£Ø±Ø¶ Ù…Ù† Ø§Ù„ÙØ¶Ø§Ø¡
  });
});

// ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù„Ù…Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
if (window.innerWidth < 768) {
  map.touchZoomRotate.enable(); // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØ¯ÙˆÙŠØ± Ø¨Ø§Ù„Ù„Ù…Ø³
  map.doubleClickZoom.disable(); // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¨Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
}




// ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
map.on('style.load', () => {
    map.setFog({}); // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶Ø¨Ø§Ø¨ Ù„ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©
});


        let retryCount = 0; // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
        const maxRetries = 3; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª

        function handleMapLoad() {
            console.log('32 ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… handleMapLoad.');

            if (map.isStyleLoaded()) {
                isMapReady = true;
                console.log("ğŸ‰ 3 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© ÙˆØ§Ù„Ù†Ù…Ø· Ù…Ø­Ù…Ù„. ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª.");
                addMarkersToMap();
            } else if (retryCount < maxRetries) {
                console.warn(`âš ï¸ 4 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© (${retryCount + 1}/${maxRetries}) Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù...`);
                retryCount++;
                setTimeout(handleMapLoad, 5000);
            } else {
                console.error("ğŸš¨ 23 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ†ÙØ§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª.");
                alert("âš ï¸ 24 Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
            }
        }

        map.on('load', () => {
            console.log("âš¡109 ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ map.on('load').");

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± isMapReady
            if (typeof isMapReady === 'undefined') {
                console.error("ğŸš¨ 76 Ø§Ù„Ù…ØªØºÙŠØ± isMapReady ØºÙŠØ± Ù…Ù‡ÙŠØ£ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
                return;
            }

            if (map.isStyleLoaded()) {
                isMapReady = true;
                isMapInitialized = true;
                console.log("ğŸ‰ 47 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© ÙˆØ§Ù„Ù†Ù…Ø· Ù…Ø­Ù…Ù„.");
               
         // Ù‡Ù†Ø§ Ù†Ø¶ÙŠÙ console.log Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        console.log("âœ… 158 isMapReady:", isMapReady, "isMapInitialized:", isMapInitialized);

                processSavedRequests();
            } else {
                console.warn("âš ï¸ 59 Ø§Ù„Ù†Ù…Ø· Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
                handleMapLoad();
            }

            console.log("âš™ï¸ 78 Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...");
        });

        map.on('error', (e) => {
            console.error("ğŸš¨ 112 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", e);
        });

    } catch (error) {
        console.error("ğŸš¨ 113 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", error);
    }
}







function ensureMapInitialized() {
    if (!isMapInitialized) {
        console.log("ğŸ”„ 82 Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©...");
        initializeMap();
        isMapInitialized = true;
    } else {
        console.log("âœ… 83 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
    }
}



// ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø©Ù‹
let orderActive = false;  // ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
let orderCanceled = false; // ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨

document.addEventListener('DOMContentLoaded', () => {

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ localStorage ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§
    const storedStatus = localStorage.getItem('orderStatus');
    const storedRequestId = localStorage.getItem('currentRequestId');
    if (storedStatus && storedRequestId && storedStatus === 'canceled_by_worker') {
        // Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØªØ¬Ù†Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«
        orderCanceled = true;
        orderActive = false;
        document.getElementById('cancelJobContainer').style.display = 'none';
        console.log("ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ.");
    }
    
    console.log("âœ”ï¸ 120 ØªÙ… ØªØ­Ù…ÙŠÙ„ DOM Ø¨Ù†Ø¬Ø§Ø­. Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...");

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Firebase Ùˆ Mapbox
    if (typeof firebase === 'undefined' || typeof mapboxgl === 'undefined') {
        console.error("ğŸš¨ 165 Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Firebase Ø£Ùˆ Mapbox. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·.");
        return;
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„
    if (!isMapInitialized) {
        console.log("ğŸ”„ 168 Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©...");
        initializeMap();
        isMapInitialized = true;
    } else {
        console.log("âœ… 169 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
    }

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    const acceptJobButton = document.getElementById('acceptJobButton');
    const locateButton = document.getElementById('locateButton');
    const styleSelector = document.getElementById('styleSelector');
    const loginButton = document.getElementById('loginWorkerButton');

    if (!acceptJobButton || !locateButton || !styleSelector || !loginButton) {
        console.error("ğŸš¨ 170 Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ DOM. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.");
        return;
    }

    styleSelector.addEventListener('change', function () {
        const selectedStyle = this.value;
        if (styles[selectedStyle]) {
            map.setStyle(styles[selectedStyle]);
            console.log(`âœ”ï¸ 171 ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø· Ø¥Ù„Ù‰: ${selectedStyle}`);
        } else {
            console.error(`âš ï¸ 172 Ø§Ù„Ù†Ù…Ø· "${selectedStyle}" ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.`);
        }
    });

    loginButton.addEventListener('click', () => {
        const workerId = document.getElementById('workerLoginId').value;
        if (workerId) {
            console.log(`ğŸ”µ 173 Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¹Ø§Ù…Ù„: ${workerId}`);
            loginWorker(workerId);
        } else {
            console.warn('âš ï¸ 174 ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„.');
            alert('âš ï¸ 175 ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„.');
        }
    });
});













if (!isMapInitialized) {
    console.log(" 146 ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©.");
    initializeMap();
    isMapInitialized = true;
} else {
    console.log(" 147 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
}





function addMarkersToMap() {
    const requestsRef = database.ref('workRequests');
    requestsRef.on('child_added', (data) => {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
        waitUntilMapReady()
            .then(() => {
                // Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            })
            .catch((err) => {
                console.error("âš ï¸ 19: Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø£Ùˆ Ø§Ù„Ù†Ù…Ø· ØºÙŠØ± Ù…Ø­Ù…Ù„. Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø©.", err);
                return;
            });
        
        const request = data.val();
        if (request && request.location && request.location.lng && request.location.lat) {
            try {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ø¨Ø¯ÙˆÙ† ØªØ¹ÙŠÙŠÙ† Popup Ø§ÙØªØ±Ø§Ø¶ÙŠ
                const marker = new mapboxgl.Marker({ color: 'green' })
    .setLngLat([request.location.lng, request.location.lat])
    .addTo(map);

                
                // NEW CODE: ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø§Ø±ÙƒØ± ÙÙŠ ÙƒØ§Ø¦Ù† Ø¹Ø§Ù… Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹
                if (!window.requestMarkers) {
                    window.requestMarkers = {};
                }
                window.requestMarkers[data.key] = marker;
                
                // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø¨Ø­ÙŠØ« ÙŠØ¹ÙŠØ¯ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ù† Firebase
                marker.getElement().addEventListener('click', () => {
                    currentRequestId = data.key;
                    firebase.database().ref('workRequests/' + data.key).once('value')
                    .then((snapshot) => {
                        const updatedRequest = snapshot.val();
                        console.log("ØªÙ… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:", updatedRequest);
                        showJobDetails(updatedRequest);
                    })
                    .catch((error) => {
                        console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨:", error);
                        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨.");
                    });
                });
                
                console.log(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ ${data.key} Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.`);
            } catch (error) {
                console.error("ğŸš¨ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", error);
            }
        } else {
            console.warn("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ­ÙŠØ­:", data.key);
        }
    });
}



// NEW CODE: Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ø¹Ù†Ø¯ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Firebase
database.ref('workRequests').on('child_removed', (snapshot) => {
    const removedRequestId = snapshot.key;
    console.log(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ ${removedRequestId} Ù…Ù† Firebase.`);
    if (window.requestMarkers && window.requestMarkers[removedRequestId]) {
        window.requestMarkers[removedRequestId].remove();
        delete window.requestMarkers[removedRequestId];
        console.log(`ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø·Ù„Ø¨ ${removedRequestId} Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©.`);
    } else {
        console.warn(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø·Ù„Ø¨ ${removedRequestId} Ù„Ø¥Ø²Ø§Ù„ØªÙ‡.`);
    }
});




// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨Ø­Ø«
const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    language: "ar",
    marker: true,
    mapboxgl: mapboxgl
});

if (typeof map === 'undefined') {
    console.error("Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ initializeMap Ø£ÙˆÙ„Ø§Ù‹.");
} else {
    map.addControl(geocoder);
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
const locateControl = new mapboxgl.GeolocateControl({
    positionOptions: {
        enableHighAccuracy: true
    },
    trackUserLocation: true,
    showUserHeading: true,
    fitBoundsOptions: {
        maxZoom: 18
    }
});

// Ù…ØªØºÙŠØ± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ²
let autoCenterEnabled = false;

// Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ" Ù†ÙØ¹Ù‘Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ²
const locateBtn = document.getElementById('locateButton');
if (!locateBtn) {
    console.error(" ğŸ”» 201 Ø¹Ù†ØµØ± locateButton ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
} else {
    locateBtn.addEventListener('click', () => {
        autoCenterEnabled = true; // ØªÙØ¹ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ² Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
        locateControl.trigger();
        console.log(" ğŸ”» 202 ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ ÙˆØªÙØ¹ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ².");
    });
}


// Ø¹Ù†Ø¯ Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§ØŒ Ù†ÙˆÙ‚Ù Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
map.on('dragstart', () => {
    if (autoCenterEnabled) {
        console.log(" ğŸ”»203 ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ² ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø³Ø¨Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§.");
    }
    autoCenterEnabled = false;
});

locateControl.on('geolocate', (e) => {
    console.log(" ğŸ”» ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ", e.coords);
    if (autoCenterEnabled) {
        map.flyTo({
            center: [e.coords.longitude, e.coords.latitude],
            zoom: 18,
            speed: 0.8,       // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø³Ø±Ø¹Ø© Ù„Ù†Ø¹ÙˆÙ…Ø© Ø£ÙØ¶Ù„
            curve: 1.5,       // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ù†Ø­Ù†Ø§Ø¡ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø­Ø±ÙƒØ©
            easing: function(t) { return t; }  // Ø¯Ø§Ù„Ø© ØªØ®ÙÙŠÙ Ø¨Ø³ÙŠØ·Ø© ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
        });
    } else {
        console.log(" ğŸ”» Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ² Ù…Ø¹Ø·Ù„Ø©Ø› Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ­ÙƒÙ… ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø±Ø¶.");
    }
});


// Ø¹Ù†Ø¯ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† locateControlØŒ Ù†ÙØ¹ÙŠØ¯ Ø§Ù„ØªÙ…Ø±ÙƒØ² ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† autoCenterEnabled true
locateControl.on('geolocate', (e) => {
    console.log("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ", e.coords);
    if (autoCenterEnabled) {
        map.flyTo({
            center: [e.coords.longitude, e.coords.latitude],
            zoom: 18,
            speed: 0.8,
            curve: 1.5,
            easing: function(t) { return t; }
        });
    } else {
        console.log("Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ² Ù…Ø¹Ø·Ù„Ø©Ø› Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ­ÙƒÙ… ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø±Ø¶.");
    }
});


map.on('load', () => {
    console.log(" 28 ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ø¬Ø§Ø­.", { style: map.getStyle(), center: map.getCenter() });

    if (map && typeof map.isStyleLoaded === 'function' && map.isStyleLoaded()) {
        console.log("ğŸ‰ 29 Ù…Ø´ÙƒÙ„Ø© isStyleLoaded ØªÙ… Ø­Ù„Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„! Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ù…Ù„.");
        map.flyTo({ center: [13.1913, 32.8872], zoom: 10, speed: 0.2 });
        if (isMapReady) {
            addMarkersToMap(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©
        }
    } else {
        console.error("âš ï¸ 5 Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø£Ùˆ Ø§Ù„Ù†Ù…Ø· Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡.");
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
    map.addControl(locateControl);
});

// NEW CODE: Ù…Ø³ØªÙ…Ø¹ Ù„ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù†Ø¯ Ø­Ø¯ÙˆØ« ØªØºÙŠÙŠØ±
database.ref('workRequests').on('child_changed', (snapshot) => {
    const updatedData = snapshot.val();
    const requestKey = snapshot.key;
    console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ${requestKey}:`, updatedData);
    // ÙÙŠ Ø­Ø§Ù„Ø© ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙ†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø§ÙØ°Ø© Ù…Ø¨Ø§Ø´Ø±Ø©
    // Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù…ØªØºÙŠØ± global ÙŠØ­ØªÙØ¸ Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
    // Ù…Ø«Ø§Ù„: Ø¥Ø°Ø§ ÙƒØ§Ù† currentRequestId ÙŠØ³Ø§ÙˆÙŠ requestKeyØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø§ÙØ°Ø©:
    if (currentRequestId === requestKey) {
        showJobDetails(updatedData);
    }
});






// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù†Ù…Ø§Ø·
document.getElementById('styleSelector').addEventListener('change', function () {
    const selectedStyle = this.value;
    if (styles[selectedStyle]) {
        if (map.isStyleLoaded()) {
            map.setStyle(styles[selectedStyle]);
            console.log(`âœ”ï¸ 11 ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø· Ø¥Ù„Ù‰: ${selectedStyle}`);
        } else {
            console.warn(`âš ï¸ 12 Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡.`);
        }
    } else {
        console.error(`âš ï¸ 87 Ø§Ù„Ù†Ù…Ø· "${selectedStyle}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.`);
    }
});



// Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯
map.on('style.load', () => {
    if (window.currentRouteData) {
        if (!map.getSource('route')) {
            map.addLayer({
                id: 'route',
                type: 'line',
                source: {
                    type: 'geojson',
                    data: window.currentRouteData
                },
                layout: { 'line-join': 'round', 'line-cap': 'round' },
                paint: { 'line-color': '#3887be', 'line-width': 5 }
            });
            console.log("âœ”ï¸ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø·.");
        }
    }
});


// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙØ­Ø¯Ø¯ ÙÙŠ Ù…ÙƒØ§Ù† Ù…Ù†Ø§Ø³Ø¨ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ØŒ Ù…Ø«Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù)
// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
var currentRequestId = null;

// Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
const acceptJobButton = document.getElementById('acceptJobButton');

if (acceptJobButton) {
    acceptJobButton.addEventListener('click', async () => {
        // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) {
            console.log("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
            return;
        }

        console.log("Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨...");

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if (!currentRequestId) {
            console.error("Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ù†Ø´Ø·.");
            return;
        }
        if (!currentWorkerId) {
            console.error("Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„ ØºÙŠØ± Ù…ØªÙˆÙØ±. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
            alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨.");
            return;
        }
        if (activeRequestExists) {
            console.log("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø³Ø§Ø¨Ù‚ Ø¨Ø§Ù„ÙØ¹Ù„. Ù„Ù† ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.");
            alert("Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.");
            return;
        }

        // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
        acceptJobButton.disabled = true;
        console.log("ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬.");

        try {
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„ØªÙ‡
            const snapshot = await firebase.database().ref('workRequests/' + currentRequestId).once('value');
            const request = snapshot.val();

            if (!request) {
                console.error("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                alert("âŒ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
                acceptJobButton.disabled = false;
                return;
            }

            if (request.status !== 'pending') {
                alert("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø£Ù†Ù‡ Ù„Ù… ÙŠØ¹Ø¯ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±.");
                console.error("Ø±ÙØ¶ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨: Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© " + request.status);
                acceptJobButton.disabled = false;
                return;
            }

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firebase
            await firebase.database().ref('workRequests/' + currentRequestId).update({
                status: 'accepted',
                acceptedBy: currentWorkerId
            });

            alert("âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.");
            console.log(`ğŸ“¢ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ${currentRequestId} Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¹Ø§Ù…Ù„ ${currentWorkerId}`);

            activeRequestExists = true;

            // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
            document.getElementById('jobDetailsPopup').style.display = 'none';

            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
            if (currentWorkerLocation && jobLocation) {
                if (typeof showRoute === "function") {
                    showRoute(currentWorkerLocation, jobLocation);
                    console.log("ğŸš— ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© showRoute Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ÙˆØ§Ù„Ù…Ø³Ø§ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
                } else {
                    console.error("âš ï¸ ÙˆØ¸ÙŠÙØ© showRoute ØºÙŠØ± Ù…Ø¹Ø±ÙØ©.");
                }

                startRealTimeETATracking(currentWorkerLocation, jobLocation);
            } else {
                console.error("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø¹Ø§Ù…Ù„ Ø£Ùˆ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.");
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
            const distance = getWorkerDistance();
            if (distance >= 0.5) {
                document.getElementById('cancelJobContainer').style.display = 'block';
                console.log("ğŸ“ ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø£Ù† Ø§Ù„Ù…Ø³Ø§ÙØ©:", distance.toFixed(2), "ÙƒÙ…");
            } else {
                document.getElementById('cancelJobContainer').style.display = 'none';
                alert("âš ï¸ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù† ÙŠÙÙ„ØºÙ‰ Ø¥Ø°Ø§ Ø£ØµØ¨Ø­ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù‚Ø±ÙŠØ¨Ù‹Ø§ (Ø£Ù‚Ù„ Ù…Ù† 500 Ù…ØªØ±) Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
                console.log("ğŸš¨ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ù‹Ø§ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨. Ø§Ù„Ù…Ø³Ø§ÙØ©:", distance.toFixed(2), "ÙƒÙ…");
            }

            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙ†ÙØ° Ø®Ù„Ø§Ù„ Ù…Ø¯Ø© Ù…Ø¹ÙŠÙ†Ø©
            const countdownElement = document.getElementById('countdownTimer');
            if (countdownElement) {
                startCountdown(3 * 60 * 60 * 1000, countdownElement, () => {
                    cancelRequestDueToTimeout(currentRequestId);
                });
            } else {
                console.error("âš ï¸ Ø¹Ù†ØµØ± 'countdownTimer' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©.");
            }

        } catch (error) {
            console.error("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨:", error);
            alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            acceptJobButton.disabled = false;
        }
    });
} else {
    console.error("ğŸš¨ Ø§Ù„Ø²Ø± 'acceptJobButton' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DOM.");
}












// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… ØªØ¹Ø±ÙŠÙ map
if (typeof map !== 'undefined' && map instanceof mapboxgl.Map) {
    map.on('load', () => {
        console.log("âš¡50 ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ map.on('load').");
        checkMapStyleLoaded();
    });
} else {
    console.error("ğŸš¨ 51 Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ù‡ÙŠØ£ Ø£Ùˆ ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù.");
}


        // ØªØ£ÙƒÙŠØ¯ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        document.getElementById('confirmYes').addEventListener('click', () => {
            const userLocation = map.getCenter();
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            new mapboxgl.Marker({ color: 'green' })
    .setLngLat(userLocation)
    .addTo(map);

            // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
            document.getElementById('inputPopup').style.display = 'block';
            document.getElementById('confirmationPopup').style.display = 'none';
        });

        // Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        document.getElementById('confirmNo').addEventListener('click', () => {
            document.getElementById('confirmationPopup').style.display = 'none';
        });

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ø¥Ù„Ù‰ Firebase
        document.getElementById('submitInfo').addEventListener('click', () => {
            const name = document.getElementById('nameInput').value;
            const phone = document.getElementById('phoneInput').value;
            if (name && phone) {
                const markerData = {
                    name: name,
                    phone: phone,
                    location: {
                        lng: map.getCenter().lng,
                        lat: map.getCenter().lat
                    }
                };
                const markersRef = database.ref('markers');
                markersRef.push(markerData)
                    .then(() => {
                        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­.');
                        document.getElementById('inputPopup').style.display = 'none';
                        document.getElementById('nameInput').value = '';
                        document.getElementById('phoneInput').value = '';
                    })
                    .catch((error) => {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
                    });
            } else {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
            }
        });

        // Ø¥Ù„ØºØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        document.getElementById('cancelInput').addEventListener('click', () => {
            document.getElementById('inputPopup').style.display = 'none';
        });


        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¹Ù…Ø§Ù„
        document.getElementById('requestWater').addEventListener('click', () => {
            const workerInfo = document.getElementById('workerInfo');
            workerInfo.innerText = 'Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† Ù‡Ù†Ø§...';
            workerInfo.style.display = workerInfo.style.display === 'block' ? 'none' : 'block';
        });


        function cancelRequestDueToTimeout(requestId, workerId, workerName) {
    const requestRef = database.ref(`workRequests/${requestId}`);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± Ø¹Ø§Ù…Ù„ Ø£Ù„ØºÙ‰ Ø§Ù„Ø·Ù„Ø¨
    requestRef.update({
        status: 'cancelled',
        canceledBy: workerId // Ù„Ø§ ÙŠØ²Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ÙŠØ­ØªÙØ¸ Ø¨Ø¢Ø®Ø± Ø¹Ø§Ù…Ù„ Ø£Ù„ØºÙ‰ Ø§Ù„Ø·Ù„Ø¨
    })
    .then(() => {
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª
        const activityRef = database.ref(`workRequests/${requestId}/orderHistory`);
        activityRef.push({
            type: 'timeout',
            workerId: workerId,
            workerName: workerName,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        console.log(`ğŸš« ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ø¨Ø³Ø¨Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù† Ù‚Ø¨Ù„ ${workerName} (${workerId}).`);
        alert("â³ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„ÙˆØµÙˆÙ„ØŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨.");

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©
        orderCanceled = true;
        orderActive = false;
        clearInterval(window.etaIntervalId);
    })
    .catch((error) => {
        console.error(`âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ${requestId}:`, error);
    });
}









        



  </script>

</body>
</html>
