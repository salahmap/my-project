<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุทุจูู ุงูุฎุฑูุทุฉ ุงููุญุณู</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        #map { height: 100vh; width: 100%; }
        .controlButton {
            background-color: rgba(30, 144, 255, 0.8);
            border: none;
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 5px 0;
            transition: background-color 0.3s ease;
            width: 100%;
            font-size: 14px;
        }
        .controlButton:hover {
            background-color: rgb(49, 255, 30);
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .iconButton {
  width: 40px;
  height: 40px;
  border: none;
  cursor: pointer;
  background: none;
  margin: 5px;
  z-index: 2;
  border-radius: 50%; /* ูุถูุงู ุธููุฑ ุงูุฒุฑ ุจุดูู ุฏุงุฆุฑู ูุฑููู */
}

/* ุชูุณูู ููุญุฉ ุงูุทูุจุงุช ูุน ุชุฃุซูุฑ ุงูุชูุงูู */
#ordersPanel {
  position: absolute;
  top: 60px;
  right: 10px;
  width: 300px;
  max-height: 70vh;
  background-color: rgba(255, 255, 255, 0.95);
  border: 1px solid #ccc;
  border-radius: 8px;
  overflow-y: auto;
  padding: 10px;
  display: none;
  z-index: 10;
  transition: transform 0.3s ease, opacity 0.3s ease;
  transform: translateX(100%);
  opacity: 0;
}

/* ๐ฅ ุงููุฆุฉ ุงูุชู ุณุชูุถุงู ุนูุฏ ุฅุธูุงุฑ ุงูููุญุฉ */
#ordersPanel.show {
  display: block;
  transform: translateX(0);
  opacity: 1;
}


.orderItem {
  border-bottom: 1px solid #ddd;
  padding: 8px;
  margin-bottom: 5px;
}
.orderItem p {
  margin: 5px 0;
}
.orderItem button {
  background-color: #28a745;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  color: white;
  cursor: pointer;
}

/* ูุซุงู ุนูู ูุณุงุฆุท CSS ูุถูุงู ุงูุชุตููู ุงููุชุฌุงูุจ */
@media (max-width: 600px) {
  #ordersPanel {
    width: 90%;
    right: 5%;
  }
}

        .icon {
            font-size: 20px;
            color: #ff5722;
            transition: color 0.3s;
        }
        .icon:hover {
            color: #e64a19;
        }
        #locateButtonContainer {
            position: absolute;
            bottom: 20px; /* ูุณุงูุฉ ูู ุงูุฃุณูู */
            right: 20px; /* ูุณุงูุฉ ูู ุงููููู */
            z-index: 2;
        }
        #locateButton {
            background-color: rgba(30, 144, 255, 0.8);
            border: none;
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 14px;
        }
        #locateButton:hover {
            background-color: rgb(49, 255, 30);
        }
        #etaPanel p {
    display: inline-block;
    margin: 0 10px;
    font-size: 16px;
}


#etaPanel,
#countdownPanel {
    display: none;
}


.mapboxgl-ctrl-geocoder {
  width: 200px !important;  
  height: 35px !important;  
  border-radius: 5px;        
  font-size: 14px;           
  display: flex;             
  align-items: center;       
  justify-content: center;   
  position: relative; /* ุชุฃูุฏ ูู ุถุจุท ุงูููุถุน */
  z-index: 10; /* ุชุฃูุฏ ูู ุฃู ูุฑุจุน ุงูุจุญุซ ููู ุงูุนูุงุตุฑ ุงูุฃุฎุฑู */
}

/* ุฌุนู ูุงุฆูุฉ ุงูุจุญุซ ุชุธูุฑ ููู ุฌููุน ุงูุนูุงุตุฑ */
.mapboxgl-ctrl-geocoder .suggestions {
  position: absolute !important;
  z-index: 9999 !important; /* ุฑูุน ุงููุงุฆูุฉ ููู ุฃู ุนูุตุฑ ุขุฎุฑ */
  background-color: white; /* ุงูุญูุงุธ ุนูู ูุถูุญ ุงููุงุฆูุฉ */
  border: 1px solid #ccc;
  border-radius: 5px;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}
.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon {
  display: none !important; /* ุฅุฎูุงุก ุงูุฃููููุงุช (X ูุงูุฏุงุฆุฑุฉ) */
}



    </style>
</head>
<body>
    <h1 id="title" style="display: none;">ุชุทุจูู ุงูุฎุฑูุทุฉ ุงููุญุณู</h1>
    <div id="map"></div>

<!-- ูุงูุฐุฉ ุชูุงุตูู ุงูุนูู ุงููุญุฏุซุฉ ูุน ุญุฏูุฏ ูุงุถุญุฉ -->
<div id="jobDetailsPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
 background:white; border-radius:10px; padding:20px; z-index:1100; 
 border: 3px solid #000000; /* ุญุฏ ุฃุฒุฑู ูุงุถุญ */
 box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2); /* ุธู ุฎููู ูุฅุจุฑุงุฒ ุงููุงูุฐุฉ */">
    
    
    <h2>ุชูุงุตูู ุงูุนูู</h2>
    <!-- ูุงูุฐุฉ ุนุฑุถ ุงูุตูุฑุฉ (Modal) ูุน ุฃุฒุฑุงุฑ ุงูุชููู -->
<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:9999;">
    <button id="prevBtn" style="position:absolute; left:20px; background:transparent; border:none; font-size:2em; color:#fff; cursor:pointer;">&#10094;</button>
    <img id="modalImage" src="" alt="ุนุฑุถ ุงูุตูุฑุฉ" style="max-width:90%; max-height:90%; border: 5px solid #fff; border-radius:5px;">
    <button id="nextBtn" style="position:absolute; right:20px; background:transparent; border:none; font-size:2em; color:#fff; cursor:pointer;">&#10095;</button>
  </div>
    <p id="jobDescription"></p>
    <p id="userPhone"></p>

    <!-- ุนูุตุฑ ุนุฑุถ ุงูุตูุฑุฉ -->
    <div id="jobImagesContainer" style="max-width: 100%; overflow-x: auto; white-space: nowrap; padding: 10px;">
        <!-- ูู ุตูุฑุฉ ุชููู ุจุญุฌู ููุงุณุจ ูุชุธูุฑ ูู ุตู ูุงุญุฏ -->
        <img src="image1.jpg" alt="ุตูุฑุฉ ุงูุนูู" style="width: 18%; height: auto; margin-right: 2%;">
        <img src="image2.jpg" alt="ุตูุฑุฉ ุงูุนูู" style="width: 18%; height: auto; margin-right: 2%;">
        <img src="image3.jpg" alt="ุตูุฑุฉ ุงูุนูู" style="width: 18%; height: auto; margin-right: 2%;">
        <img src="image4.jpg" alt="ุตูุฑุฉ ุงูุนูู" style="width: 18%; height: auto; margin-right: 2%;">
        <img src="image5.jpg" alt="ุตูุฑุฉ ุงูุนูู" style="width: 18%; height: auto; margin-right: 2%;">
        <!-- ุฅุฐุง ูุงู ููุงู ุฃูุซุฑ ูู 5 ุตูุฑุ ุณุชุธูุฑ ูุน ุฅููุงููุฉ ุงูุชูุฑูุฑ -->
      </div>
      
    <p id="jobLocation"></p>
    <p id="jobDuration"></p>
    <p id="jobBudget"></p>
    <p id="jobDistance"></p>
    <p id="estimatedArrivalTime"></p>

    <!-- ุฅุถุงูุฉ ููุงุญุธุงุช ูุงูุฉ -->
    <div id="jobNotes" style="margin-top: 10px; padding: 10px; border-top: 1px solid #ccc; font-size: 14px; color: #555;">
        <p><strong>ููุงุญุธุงุช ูุงูุฉ:</strong></p>
        <p>- ูุชู ุชุณุฌูู ุฌููุน ุฅุฌุฑุงุกุงุช ุงููุจูู ูุงูุฑูุถ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.</p>
        <p>- ุนูุฏ ุงูุงูุชุฑุงุจ ุฅูู ุฃูู ูู 500 ูุชุฑ ูู ูููุน ุงูุทูุจุ ูู ุชุชููู ูู ุฅูุบุงุก ุงูุทูุจ.</p>
        <p>- ุฅุฐุง ูู ูุฑุฏ ุงูุนููู ุนูุฏ ุงูุงุชุตุงูุ ูุฑุฌู ุฅุฑุณุงู ุฑุณุงูุฉ ูุตูุฉ ุฅูู ุงูุดุฑูุฉ ุชุชุถูู ุงุณู ูุฑูู ุงููุณุชุฎุฏูุ ุฃู ุฅุจูุงุบ ุงููุฑุน ุนูุฏ ุงูุญุถูุฑ ุจููุงูุฉ ุงูุดูุฑ.</p>
        <p>ููุชุฒู ุจุงูุฌูุฏุฉ ูุงูุงุญุชุฑุงููุฉ ูุถูุงู ุณูุฑ ุงูุนูู ุจููุงุกุฉ.</p>
    </div>

    <!-- ูุณู ุฌุฏูุฏ ูุนุฑุถ ุฎุฑูุทุฉ ูุตุบุฑุฉ -->
    <div id="miniMap" style="width:100%; height:auto; margin-top:10px;"></div>

    <button id="acceptJobButton">ูุจูู ุงูุทูุจ</button>
    <button class="controlButton negotiateButton" 
    data-request-id="${currentRequestId}" 
    onclick="openNegotiationForm(this.dataset.requestId)">
ุชูุงูุถ
    <button onclick="document.getElementById('jobDetailsPopup').style.display='none'">ุฅุบูุงู</button>
</div>

<div id="negotiationPopup" style="display:none; position: fixed; top:50%; left:50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; z-index: 1100;">
    <h2>ุนุฑุถ ุชูุงูุถู</h2>
    <label for="proposedPrice">ุงูุณุนุฑ ุงูููุชุฑุญ:</label>
    <input type="number" id="proposedPrice" placeholder="ุฃุฏุฎู ุงูุณุนุฑ">
    <label for="negotiationMessage">ุฑุณุงูุฉ (ุจุฏูู ุจูุงูุงุช ุชูุงุตู ูุจุงุดุฑุฉ):</label>
    <textarea id="negotiationMessage" placeholder="ุฃุฏุฎู ุฑุณุงูุชู"></textarea>
    <button onclick="submitNegotiation()">ุฅุฑุณุงู ุงูุนุฑุถ</button>
    <button onclick="closeNegotiationForm()">ุฅูุบุงุก</button>
</div>

<!-- ูุงูุฐุฉ ุนุฑุถ ุงูุนุฑุถ ุงููุถุงุฏ ูู ููู ุงูุนูุงู ุจุนุฏ ุงูุชุนุฏูู -->
<div id="counterOfferDisplayPopup" style="display:none; position: fixed; top:50%; left:50%; transform: translate(-50%, -50%); background:white; padding:20px; border-radius:10px; z-index:1100;">
    <h2>ุงูุนุฑุถ ุงููุถุงุฏ ุงูุฐู ูุฏูู ุงููุณุชุฎุฏู</h2>
    <!-- ุนูุตุฑ ุนุฑุถ ูุตู ุงูุทูุจ -->
    <p id="orderDescriptionWorker">ูุตู ุงูุทูุจ: </p>
    <p>ุงูุณุนุฑ ุงูููุชุฑุญ: <span id="counterFinalPrice"></span></p>
    <p>ุงูุฑุณุงูุฉ: <span id="counterFinalMessage"></span></p>
    <button onclick="acceptCounterOffer()">ูุจูู ุงูุนุฑุถ</button>
    <button onclick="rejectCounterOffer()">ุฑูุถ ุงูุนุฑุถ</button>
</div>



  

<!-- ุฒุฑ ุฅูุบุงุก ุงูุทูุจ ุงูุขู ููุฌูุฏ ุนูู ุงูุดุงุดุฉ ุงูุฑุฆูุณูุฉ -->
<div id="cancelJobContainer" style="display:none; position: fixed; bottom: 20px; left: 20px; z-index: 1000;">
    <button id="cancelJobButton" class="controlButton" style="background-color: #d9534f;">ุฅูุบุงุก ุงูุทูุจ</button>
    
</div>


    


<div class="controls">
    <!-- ุฒุฑ ุนุฑุถ ุงูุทูุจุงุช ูุน ุดุงุฑุฉ ุฅุดุนุงุฑ -->
    <button id="toggleOrdersButton" class="controlButton">
      ุนุฑุถ ุงูุทูุจุงุช <span id="ordersBadge"></span>
    </button>
    <button id="toggleWeather" class="iconButton">
      <i class="fas fa-cloud-sun icon"></i>
    </button>
    <select id="styleSelector" class="controlButton">
      <option value="streets">ุดูุงุฑุน</option>
      <option value="satellite">ุงูุฃููุงุฑ ุงูุตูุงุนูุฉ</option>
      <option value="outdoors">ุฎุงุฑุฌูุฉ</option>
      <option value="hybrid" selected>ูุงูุจุฑุฏ</option>
      <option value="dark">ุงููุถุน ุงููููู</option>
      <option value="light">ุงููุถุน ุงููุงุชุญ</option>
    </select>
    <button id="requestWater" class="controlButton">ุทูุจ ูุงุก</button>
    <div id="weatherInfo"></div>
    <div id="workerInfo"></div>
  </div>
  
<!-- ููุญุฉ ุนุฑุถ ุงูุทูุจุงุช -->
<div id="ordersPanel" style="position: absolute; top: 10px; right: 10px; width: 300px; height: 400px; z-index: 1000; border: 1px solid #ccc; border-radius: 5px; background: #fff; overflow: hidden;">
    <!-- ุฑุฃุณ ุงููุงูุฐุฉ -->
    <div class="ordersHeader" style="height: 60px; padding: 10px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; background: #fff;">
      <div>
        <input type="text" id="orderSearch" placeholder="ุงุจุญุซ ุนู ุทูุจ..." style="width:60%; padding:5px; border:1px solid #ccc; border-radius:5px;" />
        <select id="orderSort" style="width:35%; padding:5px; border:1px solid #ccc; border-radius:5px;">
          <option value="timestamp">ุงูุฃุญุฏุซ ุฃููุงู</option>
          <option value="distance">ุงูุฃูุฑุจ</option>
          <option value="status">ุญุณุจ ุงูุญุงูุฉ</option>
        </select>
      </div>
      <span id="closeOrdersPanel" onclick="toggleOrdersPanel()" style="cursor:pointer; font-size: 20px; color: #d9534f;">
        <i class="fas fa-times"></i>
      </span>
    </div>
    <!-- ููุทูุฉ ุงูุทูุจุงุช -->
    <div id="ordersList" style="height: calc(100% - 60px); overflow-y: auto; padding: 10px;">
      <!-- ูุญุชูู ูุงุฆูุฉ ุงูุทูุจุงุช -->
    </div>
  </div>
  


  
  
  
  




    <div id="locateButtonContainer">
        <button id="locateButton">ุชุญุฏูุฏ ูููุนู</button>
    </div>

<!-- ุญุงููุฉ ุนุฑุถ ูุนูููุงุช ETA ุชุจูู ูู ุงูุฃุณูู -->
<div id="etaPanel" style="position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); background: white; padding: 10px; border-radius: 5px; z-index: 4;">
    <p id="etaDisplay"></p>
</div>

<!-- ุญุงููุฉ ุงูุนุฏ ุงูุชูุงุฒูู ุชุธูุฑ ูู ุฃุนูู ุงูุตูุญุฉ ุจุญุฌู ุฎุท ุฃุตุบุฑ -->
<div id="countdownPanel" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #fff; padding: 5px 8px; border-radius: 5px; z-index: 4; font-size: 12px;">
    <p id="countdownTimer"></p>
</div>

    
    

    <!-- ูุงูุฐุฉ ุงูุชุญุฐูุฑ -->
    <div id="confirmationPopup" style="display:none; position:fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 3;">
        <h2>ุชุญุฐูุฑ</h2>
        <p>ุณูุชู ูุถุน ุงูุนูุงูุฉ ูู ุงูููุงู ุงูุฐู ุชูู ููู ุญุงููุง. ูู ุฃูุช ููุงููุ</p>
        <button id="confirmYes">ูุนู</button>
        <button id="confirmNo">ูุง</button>
    </div>

    <!-- ูุงูุฐุฉ ุฅุฏุฎุงู ุงูุงุณู ูุฑูู ุงููุงุชู -->
    <div id="inputPopup" style="display:none; position:fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 3;">
        <h2>ุฅุถุงูุฉ ูุนูููุงุช</h2>
        <label for="nameInput">ุงุณู:</label>
        <input type="text" id="nameInput" placeholder="ุฃุฏุฎู ุงูุงุณู">
        <label for="phoneInput">ุฑูู ูุงุชู:</label>
        <input type="text" id="phoneInput" placeholder="ุฃุฏุฎู ุฑูู ุงููุงุชู">
        <button id="submitInfo">ุงูุชุงูู</button>
        <button id="cancelInput">ุฅูุบุงุก</button>
    </div>



    <!-- ุชุณุฌูู ุงูุฏุฎูู ุจุงุณุชุฎุฏุงู ุงููุนุฑูู -->
    <div id="loginPopup" style="display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0px 4px 6px rgba(0,0,0,0.3); z-index: 10;">
        <h3>ุฃุฏุฎู ุงููุนุฑูู ุงูุฎุงุต ุจู ููุจุฏุก</h3>
        <input type="text" id="workerLoginId" placeholder="ุฃุฏุฎู ูุนุฑูู ุงูุนุงูู" style="margin-bottom: 10px; width: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        <button id="loginWorkerButton" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">ุชุณุฌูู ุงูุฏุฎูู</button>
    </div>
</div>

<!-- ูุงูุฐุฉ ุงูุทูุจ ุงููุจุงุดุฑ ููุนูุงู -->
<div id="directRequestPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 10;">
    <h2 id="directRequestTitle">ุทูุจ ูุจุงุดุฑ: ูุฏูู ุทูุจ ุฌุฏูุฏ</h2>
    <p id="directRequestMessage">ูู ุชุฑุบุจ ูู ูุจูู ุงูุทูุจ ุงูุขูุ</p>
    <button id="acceptDirectRequest">ูุจูู ุงูุทูุจ</button>
    <button id="rejectDirectRequest">ุฑูุถ ุงูุทูุจ</button>
</div>

<!-- ููุทูุฉ ุฅุดุนุงุฑ ููุนุงูู -->
<div id="workerNotification" style="display:none; position:fixed; top:20px; right:20px; background:#FFC107; padding:10px 20px; border-radius:5px; z-index:1000; font-weight:bold;"></div>





<!-- ููุชุจุงุช Firebase App ู Messaging -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://js.pusher.com/beams/1.0/push-notifications-cdn.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- ููุชุจุงุช ุฅุถุงููุฉ -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<script src="https://unpkg.com/@turf/turf"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>

<script>

    
    // ุงูุชุญูู ูู ุชุญููู ููุชุจุงุช Firebase ู Pusher Beams
if (typeof firebase === 'undefined' || typeof PusherPushNotifications === 'undefined') {
    console.error('๐จ๐ญ 123  ุชุฃูุฏ ูู ุชุญููู ููุชุจุงุช Firebase ูPusher ูุจู ุงุณุชุฎุฏุงููุง.');
} else {
    console.log('โ๐ญ 124 ุชู ุชุญููู ุงูููุชุจุงุช ุจูุฌุงุญ.');
if (!firebase || !PusherPushNotifications) {
    console.error('๐จ 149 ูุดู ุชุญููู ููุชุจุงุช Firebase ุฃู Pusher Beams.');
}
}
    document.addEventListener('DOMContentLoaded', function() {
           // ุชููุฆุฉ Firebase Auth
           const auth = firebase.auth();
        
        // ุนุฑุถ ูุงูุฐุฉ ุชุณุฌูู ุงูุฏุฎูู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    document.getElementById('loginPopup').style.display = 'flex';













// ุชุญูู ูู ุชุญููู ููุชุจุฉ Pusher Beams
if (typeof PusherPushNotifications === 'undefined') {
    console.error('๐จ๐ญ 137 Pusher Beams ูู ูุชู ุชุญููู ุงูููุชุจุฉ. ุชุฃูุฏ ูู ุชุถููู ุงูููุชุจุฉ ูู HTML.');
} else {
    console.log('โ๐ญ 141 Pusher Beams ุชู ุชุญููู ุงูููุชุจุฉ ุจูุฌุงุญ.');
}

function initBeams() {
    console.log("๐ 142 DOMContentLoaded ุชู ุชูููุฐู ุจูุฌุงุญ.");
    
    // ุฅูุดุงุก ูุงุฆู Beams Client
    const beamsClient = new PusherPushNotifications.Client({
    instanceId: '2a17d881-b1a6-4a38-8cd4-de1ab8212f67',
  });
    
    console.log("๐ 140 ูุจู ุชุณุฌูู Service Worker ุงูุฎุงุต ุจู Beams.");
    
    navigator.serviceWorker.register('http://localhost:20000/service-worker.js')
        .then((registration) => {
            console.log("๐ 143 ุชู ุชุณุฌูู Service Worker ุงูุฎุงุต ุจู Beams:", registration);
            return beamsClient.start({ serviceWorkerRegistration: registration });
        })
        .then(() => {
            console.log('๐๏ธ 136 ุชู ุงุณุชุฏุนุงุก start() ุจูุฌุงุญุ ูุชู ุงูุขู ุชูููุฐ addDeviceInterest.');
            beamsClient.addDeviceInterest('debug-new-orderss')
  .then(() => console.log('ุชู ุชุณุฌูู ุงูุฌูุงุฒ ููุงุดุชุฑุงู ูู debug-new-orderss'))
  .catch(err => console.error('ูุดู ุชุณุฌูู ุงูุฌูุงุฒ:', err));
        })
        .then(() => {
            console.log('โ๐ญ 125 Pusher Beams ุฌุงูุฒ ูุงุณุชูุจุงู ุฅุดุนุงุฑุงุช ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ');
        })
        .catch((err) => {
            console.error('๐จ 127 ุฎุทุฃ ูู ุงูุชุณุฌูู:', err);
            alert(`โ๏ธ 150 ุฎุทุฃ ูู ุชุณุฌูู Service Worker: ${err.message}`);
console.error('๐จ 151 ูุดู ุชุณุฌูู Service Worker:', err);
        });
    
    beamsClient.onNotificationOpened = (payload) => {
        alert(`ุฅุดุนุงุฑ ุฌุฏูุฏ ูู Pusher Beams: ${payload.notification.body}`);
    };
}

// ุชุฃูุฏ ูู ุชูููุฐ ุงูููุฏ ุณูุงุก ุญุฏุซ DOMContentLoaded ุฃู ูุง
if (document.readyState === 'loading') {
    document.addEventListener("DOMContentLoaded", initBeams);
} else {
    initBeams();
}

console.log("โ๐ญ 126 Pusher Beams ุชู ุชุญููู ุงูููุชุจุฉ ุจูุฌุงุญ.");

if (typeof PusherPushNotifications === 'undefined') {
    console.error('๐จ 134 ููุชุจุฉ Pusher Beams ุบูุฑ ูุญููุฉุ ุชุฃูุฏ ูู ุชุถููููุง ูู ุงูุตูุญุฉ.');
} else {
    console.log('โ 135 ููุชุจุฉ Pusher Beams ุชู ุชุญููููุง ุจูุฌุงุญ.');
}

// ุชุณุฌูู Service Worker ูุฑุฉ ูุงุญุฏุฉ (ุฅุฐุง ูู ููู ุฐูู ูุทููุจูุง ุฃูุซุฑ ูู ูุฑุฉ)
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('http://localhost:20000/service-worker.js')
    .then(registration => {
        console.log('โ๐๐ 128 Service Worker ูุณุฌู ุจูุฌุงุญ:', registration.scope);
    })
    .catch(error => {
        console.error('๐จ 129 ูุดู ุชุณุฌูู Service Worker:', error);
    });
} else {
    console.warn('โ๏ธ 130  ุงููุชุตูุญ ูุง ูุฏุนู Service Worker.');
}

// ุฏุงูุฉ ุฅุฑุณุงู ุฅุดุนุงุฑ ุจุงุณุชุฎุฏุงู Pusher Beams
function sendPusherNotification(interest, message, title = "ุฅุดุนุงุฑ ุฌุฏูุฏ") {
    fetch(`https://${pusherInstanceId}.pushnotifications.pusher.com/publish_api/v1/instances/${pusherInstanceId}/publishes`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${pusherAuthorization}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            interests: [interest],
            fcm: {
                notification: {
                    title: title,
                    body: message
                }
            }
        })
    })
    .then(response => response.json())
    .then(data => console.log("ุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ุจูุฌุงุญ:", data))
    .catch(error => console.error("ูุดู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ:", error));
}
// ุฑุจุท ุงูุฏุงูุฉ ุจุงููุงุฆู window ูุฌุนููุง ูุชุงุญุฉ ุจุดูู ุนุงู
window.sendPusherNotification = sendPusherNotification;












         // ุฏุงูุฉ ูุฅุนุงุฏุฉ ุชุนููู ุงูุญููู ูู inputPopup ุนูุฏ ุงูููุฑ ุนูู ุฒุฑ "ุฅูุบุงุก"
         document.getElementById('cancelInput').addEventListener('click', () => {
            document.getElementById('nameInput').value = ''; // ุฅุนุงุฏุฉ ุชุนููู ุญูู ุงูุงุณู
            document.getElementById('phoneInput').value = ''; // ุฅุนุงุฏุฉ ุชุนููู ุญูู ุงููุงุชู
            document.getElementById('inputPopup').style.display = 'none'; // ุฅุฎูุงุก ุงููุงูุฐุฉ
        });



// ุฅุฎูุงุก ูุงูุฐุฉ ุชุณุฌูู ุงูุฏุฎูู ุจุนุฏ ุงูุชุญูู ูู ุงููุนุฑูู
function hideLoginPopup() {
    document.getElementById('loginPopup').style.display = 'none';
}
});
    

function showRoute(workerLocation, jobLocation) {
    const directionsRequest = `https://api.mapbox.com/directions/v5/mapbox/driving/${workerLocation.lng},${workerLocation.lat};${jobLocation.lng},${jobLocation.lat}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`;
    console.log('30 ุทูุจ ุงูุงุชุฌุงูุงุช:', directionsRequest);

    fetch(directionsRequest)
        .then(response => response.json())
        .then(data => {
            const route = data.routes[0].geometry;
            // ุญูุธ ุจูุงูุงุช ุงููุณุงุฑ ูู ูุชุบูุฑ ุนุงู
            window.currentRouteData = {
                type: 'Feature',
                geometry: route
            };

            // ุงุณุชุฎุฏู ุจูุงูุงุช ุงููุณุงุฑ ูู ุงููุชุบูุฑ ุงูุนุงู
            if (map.getSource('route')) {
                console.log('31 ุชู ุงูุนุซูุฑ ุนูู ุงููุตุฏุฑ route:', map.getSource('route'));
                map.getSource('route').setData(window.currentRouteData);
            } else {
                map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: {
                        type: 'geojson',
                        data: window.currentRouteData
                    },
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#3887be', 'line-width': 5 }
                });
            }
        })
        .catch(console.error);
}

// ุฏุงูุฉ ุฑูุถ ุงูุนุฑุถ ุงููุถุงุฏ: ุชููู ุจุฅุฎูุงุก ุงููุงูุฐุฉ
function rejectCounterOffer() {
    document.getElementById("counterOfferDisplayPopup").style.display = "none";
}

// ุฏุงูุฉ ูุจูู ุงูุนุฑุถ ุงููุถุงุฏ: ุชููู ุจูุญุงูุงุฉ ุงูุถุบุท ุนูู ุฒุฑ ูุจูู ุงูุทูุจ ุงูููุฌูุฏ ูู ูุงูุฐุฉ "ุชูุงุตูู ุงูุนูู"
function acceptCounterOffer() {
    // ูุญุงูู ุงูุญุตูู ุนูู ุฒุฑ ูุจูู ุงูุทูุจ ูู ูุงูุฐุฉ ุชูุงุตูู ุงูุนูู
    var acceptButton = document.getElementById("acceptJobButton");
    if (acceptButton) {
        acceptButton.click();  // ูุญุงูุงุฉ ุงูุถุบุท ุนูู ุงูุฒุฑ
    } else {
        alert("ุฒุฑ ูุจูู ุงูุทูุจ ุบูุฑ ููุฌูุฏ.");
    }
    // ุจุนุฏ ูุจูู ุงูุนุฑุถุ ูููููุง ุฅุฎูุงุก ูุงูุฐุฉ ุงูุนุฑุถ ุงููุถุงุฏ
    document.getElementById("counterOfferDisplayPopup").style.display = "none";
}


function updateWorkerLocation(workerId, newLocation) {
    const workerLocationRef = database.ref(`workers/${workerId}/location`);
    
    // ุงุณุชุฎุฏุงู ุงููุฑุฌุน ุงููุจุงุดุฑ ููุนุงูู ุจุฏูุงู ูู ุงููุชุบูุฑ ุงูุนุงู workerRef
    database.ref(`workers/${workerId}`).once('value').then((snapshot) => {
        const workerData = snapshot.val();
        const currentLocation = workerData && workerData.location;
        
        if (!currentLocation || currentLocation.lat !== newLocation.lat || currentLocation.lng !== newLocation.lng) {
            workerLocationRef.set(newLocation)
            .then(() => console.log("โ 148 ุชู ุชุญุฏูุซ ุงููููุน ูู Firebase:", newLocation))
            .catch((error) => console.error("โ 153 ุฎุทุฃ ูู ุชุญุฏูุซ ุงููููุน ูู Firebase:", error));
        } else {
            console.log("๐ 88 ูู ูุชุบูุฑ ุงููููุนุ ูุง ุญุงุฌุฉ ูุชุญุฏูุซ Firebase.");
        }
    }).catch((error) => {
        console.error("โ 89 ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ุงููููุน ูู Firebase:", error);
    });
}


// [ุงูุณุทุฑ 180] ุชุนุฏูู ุฏุงูุฉ ุชุญุฏูุซ ุงููููุน ุจุงุณุชุฎุฏุงู GPS ูุชุญุณูู ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ






let isMapReady = false; // ุชุนุฑูู ุงููุชุบูุฑ ูุชุชุจุน ุฌุงูุฒูุฉ ุงูุฎุฑูุทุฉ.
console.log("โ๏ธ 56 ุชู ุชุนุฑูู isMapReady ููููุชู ุงูุญุงููุฉ ูู:", isMapReady);

/**
 * ุฏุงูุฉ ุชุชุญูู ูู ุฌุงูุฒูุฉ ุงูุฎุฑูุทุฉ ููุงุณุชุฎุฏุงู.
 * @returns {boolean} ูู ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงูุ
 */
let mapReadyLogged = false; // ูุชุบูุฑ ูุชุนูุจ ุชุณุฌูู ุงูุฌุงูุฒูุฉ

function isMapReadyToUse() {
    if (typeof map === 'undefined') {
        console.error("๐จ 60 [ุฎุทุฃ] ุงููุงุฆู 'map' ุบูุฑ ูุนุฑูู ุจุนุฏ. ุณูุชู ุฅุนุงุฏุฉ ุชููุฆุชู.");
        initializeMap(); // ุฅุนุงุฏุฉ ุงูุชููุฆุฉ ุนูุฏ ุงูุญุงุฌุฉ
        return false;
    }

    if (!(map instanceof mapboxgl.Map)) {
        console.error("๐จ 61 [ุฎุทุฃ] ุงููุงุฆู 'map' ููุณ ูุซููุงู ูู Mapbox. ุณูุชู ุฅุนุงุฏุฉ ุชููุฆุชู.");
        initializeMap(); // ุฅุตูุงุญ ุงูุชููุฆุฉ
        return false;
    }

    if (!map.isStyleLoaded()) {
        console.warn("โ๏ธ 62 [ุชุญุฐูุฑ] ุงูููุท ุงูุฎุงุต ุจุงูุฎุฑูุทุฉ ูู ูุชู ุชุญูููู ุจุงููุงูู ุจุนุฏ.");
        return false;
    }

 
    if (typeof isMapReady === 'undefined' || !isMapReady) {
        console.warn("โ๏ธ 63 [ุชุญุฐูุฑ] ุญุงูุฉ isMapReady ุบูุฑ ูููุฃุฉ ุฃู ุบูุฑ ุฌุงูุฒุฉ.");
        return false;
    }

    if (!mapReadyLogged) {
        console.log("โ 114 [ูุฌุงุญ] ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ ุจุงููุงูู! ูููู ุงูุขู ุชูููุฐ ุงูุนูููุงุช ุงููุฑุชุจุทุฉ ุจูุง.");
        mapReadyLogged = true; // ููุน ุชุณุฌูู ุงูุฑุณุงูุฉ ูุฑุฉ ุฃุฎุฑู
    }


    return true;
}


// ุฏุงูุฉ ุชูุชุธุฑ ุชุญููู ููุท ุงูุฎุฑูุทุฉ ูุจู ุงููุชุงุจุนุฉ
function waitUntilMapReady() {
    return new Promise((resolve, reject) => {
        if (map && map.isStyleLoaded()) {
            console.log("โน๏ธ: 176 ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ ุจุงููุนู.");
            resolve();
        } else {
            // ุงูุชุธุงุฑ ุญุฏุซ ุชุญููู ุงูููุท (ูุนูู ููุฑุฉ ูุงุญุฏุฉ)
            map.once('style.load', () => {
                console.log("โน๏ธ: 177 ุชู ุชุญููู ุงูููุท โ ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ ุงูุขู.");
                resolve();
            });
            // ุชุนููู ูููุฉ ุงูุชุธุงุฑ (ูุซูุงู 15 ุซุงููุฉ)
            setTimeout(() => {
                if (!map.isStyleLoaded()) {
                    console.error("๐จ:178  ุงูุชูู ููุช ุงูุงูุชุธุงุฑ ูุชุญููู ุงูููุท.");
                    reject(new Error(" 179 ุงูุชูู ููุช ุงูุงูุชุธุงุฑ ูุชุญููู ุงูููุท."));
                }
            }, 15000);
        }
    });
}


let map; // ุชุนุฑูู ูุชุบูุฑ ุงูุฎุฑูุทุฉ ุฅุฐุง ูู ููู ููุฌูุฏูุง ุจุงููุนู.
console.log("โ๏ธ 57 ุชู ุชุนุฑูู ุงููุชุบูุฑ map ููู ุญุงููุงู:", map);

let isMapInitialized = false; // ูุชุบูุฑ ูุชุชุจุน ุญุงูุฉ ุชุญููู ุงูุฎุฑูุทุฉ.
console.log("โ๏ธ 58 ุชู ุชุนุฑูู isMapInitialized ููููุชู ุงูุญุงููุฉ ูู:", isMapInitialized);


/**
 * ุฏุงูุฉ ุงูุชุญูู ูู ุฌุงูุฒูุฉ ุงูุฎุฑูุทุฉ
 * @returns {boolean} ูู ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู
 */







// ุฅุนุฏุงุฏ Firebase ุจุงูููุงุชูุญ ุงูุตุญูุญุฉ
const firebaseConfig = {
    apiKey: "AIzaSyAQ2FQL0DvbPx4YnJrrAmal2o-yaH_KP_s",
    authDomain: "adlo-44d1b.firebaseapp.com",
    databaseURL: "https://adlo-44d1b-default-rtdb.firebaseio.com",
    projectId: "adlo-44d1b",
    storageBucket: "adlo-44d1b.firebasestorage.app",
    messagingSenderId: "96260637269",
    appId: "1:96260637269:web:e3bc37ab2b41038c254adc",
    measurementId: "G-R0SGBWC3CJ"
};

// ุชููุฆุฉ Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    console.log("โ 94 Firebase ุชู ุชููุฆุชู ุจูุฌุงุญ.");
} else {
    console.warn("โ๏ธ 95 Firebase ุชู ุชููุฆุชู ูุณุจููุงุ ูู ูุชู ุงูุชููุฆุฉ ูุฑุฉ ุฃุฎุฑู.");
}



function focusOnWorkerLocation(workerId) {
  // ุงูุชุฃูุฏ ูู ุชูุฑูุฑ ูุนุฑูู ุงูุนุงูู 547
  if (!workerId) {
    console.error("๐จ 190 ูู ูุชู ุชูุฑูุฑ ูุนุฑูู ุงูุนุงูู.");
    return;
  }
  console.log(`๐ 191 ุจุฏุก ุชูููุฐ focusOnWorkerLocation ููุนุงูู ${workerId}`);

  // ุงุณุชุฑุฌุงุน ุจูุงูุงุช ุงููููุน ูู Firebase
  database.ref(`workers/${workerId}/location`).once('value')
    .then((snapshot) => {
      const location = snapshot.val();
      console.log("๐ก 193 ุชู ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช ูู Firebase:", location);

      // ุงูุชุญูู ูู ูุฌูุฏ ุจูุงูุงุช ุงููููุน ูุตุญุชูุง
      if (location && location.lat && location.lng) {
        console.log(`๐ 194 ูููุน ุงูุนุงูู: ${location.lng}, ${location.lat}`);

        // ุงูุงูุชุธุงุฑ ุญุชู ุชููู ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู
        waitUntilMapReady().then(() => {
  console.log(`๐บ๏ธ ุณูุชู ุชุฑููุฒ ุงูุฎุฑูุทุฉ ุนูู ูููุน ุงูุนุงูู ${workerId}`);
  map.flyTo({
    center: [location.lng, location.lat],
    zoom: 15,
    speed: 0.8,       // ุชุจุงุทุค ุงูุญุฑูุฉ ููุนููุฉ ุฃูุถู
    curve: 1.8,       // ุฒูุงุฏุฉ ุงูุงูุญูุงุก ูููุญูู ุฃูุซุฑ ุณูุงุณุฉ
    easing: function(t) { return t; }  // ููููู ุชุนุฏูู ูุฐู ุงูุฏุงูุฉ ูุชุฃุซูุฑ ุชุฎููู ูุฎุชูู
  });
}).catch(err => {
  console.error("๐จ ุฎุทุฃ ุฃุซูุงุก ุงูุชุธุงุฑ ุฌุงูุฒูุฉ ุงูุฎุฑูุทุฉ:", err);
});

      } else {
        console.error(`๐จ 199 ุจูุงูุงุช ูููุน ุงูุนุงูู ${workerId} ุบูุฑ ูุชููุฑุฉ ุฃู ุบูุฑ ุตุญูุญุฉ.`);
      }
    })
    .catch((error) => {
      console.error(`๐จ 200 ุฎุทุฃ ุฃุซูุงุก ุฌูุจ ูููุน ุงูุนุงูู ${workerId}:`, error);
    });
}





// ุฏุงูุฉ ูุญุณุงุจ ุงููุณุงูุฉ ุจูู ูููุนูู ุจุงุณุชุฎุฏุงู ุตูุบุฉ Haversine (ุชู ุฅุถุงูุชูุง ูู ุงูุณุทุฑ 265)
function calculateDistance(loc1, loc2) {
    if (!loc1 || !loc2) {
        console.error("ุจูุงูุงุช ุงููููุน ุบูุฑ ูุชููุฑุฉ ูุญุณุงุจ ุงููุณุงูุฉ");
        return 0;
    }
    const lat1 = parseFloat(loc1.lat);
    const lng1 = parseFloat(loc1.lng);
    const lat2 = parseFloat(loc2.lat);
    const lng2 = parseFloat(loc2.lng);
    const R = 6371; // ูุตู ูุทุฑ ุงูุฃุฑุถ ุจุงููููููุชุฑุงุช
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c;
    console.log(`ุงููุณุงูุฉ ุงููุญุณูุจุฉ ุจูู ุงููููุนูู: ${distance.toFixed(2)} ูู`);
    return distance;
}






// โ ุฏุงูุฉ ููุชุญูู ูู ุญุงูุฉ ุงูุทูุจ ูุชุญุฏูุซูุง ุฅุฐุง ุงูุชุฑุจ ุงูุนุงูู ูู ูููุน ุงูุนูู
function checkAndUpdateOrderStatus() {
    console.log("๐ข 215 ุงุณุชุฏุนุงุก checkAndUpdateOrderStatus() โ"); // ูุฐู ุงูุณุทุฑ ูุธูุฑ ูู ูู ูุฑุฉ ุชุนูู ูููุง ุงูุฏุงูุฉ

    if (!currentRequestId) {
        console.warn("โ๏ธ 218 ูุง ููุฌุฏ ุทูุจ ูุดุท ุญุงูููุง ูุชุญุฏูุซ ุญุงูุชู.");
        return;
    }
    
    firebase.database().ref(`workRequests/${currentRequestId}`).once("value")
        .then(snapshot => {
            const order = snapshot.val();
            if (!order || !order.location) {
                console.error("๐จ 213 ุจูุงูุงุช ุงูุทูุจ ุบูุฑ ูุชููุฑุฉ ุฃู ุบูุฑ ุตุญูุญุฉ.");
                return;
            }

            // ุงูุชุฃูุฏ ูู ุฃู ุงูุทูุจ ูู ุญุงูุฉ "accepted"
            if (order.status === "accepted") {
                if (!window.currentWorkerLocation) {
                    console.error("๐จ 214 ูููุน ุงูุนุงูู ุบูุฑ ูุชุงุญ ุจุนุฏุ ูู ูุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ.");
                    return;
                }
                
                const distance = calculateDistance(window.currentWorkerLocation, order.location);
                console.log(`๐ก ุงููุณุงูุฉ ุงูุญุงููุฉ ุฅูู ูููุน ุงูุทูุจ: ${distance.toFixed(2)} ูู`);

                // ุฅุฐุง ูุงู ุงูุนุงูู ุนูู ุจุนุฏ 500 ูุชุฑ ุฃู ุฃููุ ูุชู ุชุญุฏูุซ ุงูุญุงูุฉ
                if (distance <= 0.5) {
                    firebase.database().ref(`workRequests/${currentRequestId}`).update({
                        status: 'finished', // ุฃู ููููู ุงุณุชุฎุฏุงู "completed"
                        completedAt: Date.now()
                    }).then(() => {
                        console.log("โ 216 ุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ุฅูู finished ูุฃู ุงูุนุงูู ุงูุชุฑุจ ูู ูููุน ุงูุนูู.");
                    }).catch(error => console.error("๐จ ุฎุทุฃ ูู ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ:", error));
                }
            }
        })
        .catch(error => console.error("๐จ 217 ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงูุทูุจ:", error));
}


// ุฅุถุงูุฉ ุฏุงูุฉ getWorkerDistance ููุชุญูู ูู ุงููุณุงูุฉ ุจูู ูููุน ุงูุนุงูู ููููุน ุงูุทูุจ
function getWorkerDistance() {
    // ุชุฃูุฏ ูู ุฃู ุงููุชุบูุฑุงุช currentWorkerLocation ู jobLocation ูุนุฑููุฉ ุจุดูู ุตุญูุญ
    if (typeof currentWorkerLocation === 'undefined' || typeof jobLocation === 'undefined') {
        console.error("ุงููุชุบูุฑุงุช ุงูุฎุงุตุฉ ุจุงูููุงูุน ุบูุฑ ูุชููุฑุฉ ูุญุณุงุจ ุงููุณุงูุฉ");
        return 0;
    }
    return calculateDistance(currentWorkerLocation, jobLocation);
}

// ุฏุงูุฉ ุนุฑุถ ูุงูุฐุฉ ุงูุชุฃููุฏ ูุจู ุชูููุฐ ุงูุฅูุบุงุก
function showCancelConfirmation(callback) {
    const confirmation = confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุฅูุบุงุก ุงูุทูุจุ");
    if (confirmation) {
        callback(); // ุชูููุฐ ุงูุฅุฌุฑุงุก ุฅุฐุง ูุงูู ุงููุณุชุฎุฏู
    } else {
        console.log("ุชู ุฅูุบุงุก ุนูููุฉ ุงูุฅูุบุงุก ุจูุงุกู ุนูู ุชุฃููุฏ ุงููุณุชุฎุฏู.");
    }
}



function calculateETA(workerLocation, jobLocation, callback) {
    const directionsRequest = `https://api.mapbox.com/directions/v5/mapbox/driving/${workerLocation.lng},${workerLocation.lat};${jobLocation.lng},${jobLocation.lat}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`;
    fetch(directionsRequest)
        .then(response => response.json())
        .then(data => {
            if (!data.routes || !data.routes[0]) {
                console.error("ูู ูุชู ุงุณุชุฑุฌุงุน ุจูุงูุงุช ุงูุทุฑูู ูู API");
                return;
            }
            const durationInSeconds = data.routes[0].duration;
            const distanceInMeters = data.routes[0].distance;
            console.log("ุชู ุญุณุงุจ ETA ุจูุฌุงุญ", { duration: durationInSeconds, distance: distanceInMeters });
            callback(null, { duration: durationInSeconds, distance: distanceInMeters, route: data.routes[0].geometry });
        })
        .catch(err => {
            console.error("ุฎุทุฃ ูู ุงุณุชุฏุนุงุก API ูุญุณุงุจ ETA:", err);
            callback(err);
        });
}

function updateETADisplay(duration, distance, targetElement) {
    const minutes = Math.round(duration / 60);
    const kilometers = (distance / 1000).toFixed(2);
    targetElement.innerText = `ุงูููุช ุงูููุฏุฑ: ${minutes} ุฏูููุฉ | ุงููุณุงูุฉ: ${kilometers} ูู`;
    console.log("ุชู ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู ููููุช ุงูููุฏุฑ", { minutes, kilometers });
}


function startRealTimeETATracking(workerLocation, jobLocation) {
    const etaDisplay = document.getElementById('etaDisplay');
    if (!etaDisplay) {
        console.error("ุนูุตุฑ etaDisplay ุบูุฑ ููุฌูุฏ ูู ุงูุตูุญุฉ ูุชุญุฏูุซ ETA");
        return;
    }
    // ุฅุนุงุฏุฉ ุชุนููู ุญุงูุฉ ุงูุฅูุบุงุก ูุฅููุงู ุฃู ูุคุดุฑ ุณุงุจู
    orderCanceled = false;
    if (window.etaIntervalId) {
        clearInterval(window.etaIntervalId);
        window.etaIntervalId = null;
    }
    
    const intervalId = setInterval(() => {
        console.log("ูููุฉ orderCanceled:", orderCanceled);
        // ุฅุฐุง ูุงู ุงูุทูุจ ููุบูุ ูุชู ุฅููุงู ุงููุคูุช ูุนุฏู ุงูุชุญุฏูุซ
        if (orderCanceled) {
            clearInterval(intervalId);
            console.log("ุชู ุฅููุงู ุชุชุจุน ETA ูุฃู ุงูุทูุจ ููุบู.");
            return;
        }
        calculateETA(workerLocation, jobLocation, (err, data) => {
            if (err) {
                console.error("ุฎุทุฃ ูู ุญุณุงุจ ETA:", err);
                return;
            }
            // ุชุญุฏูุซ ุนุฑุถ ETA
            updateETADisplay(data.duration, data.distance, etaDisplay);
            
            // ุงูุชุญูู ูู ุงููุณุงูุฉ ุจูู ุงูุนุงูู ููููุน ุงูุทูุจ
            const distance = calculateDistance(workerLocation, jobLocation);
            if (distance <= 0.5 && window.fullPhone) {
                document.getElementById('userPhone').innerText = `ุฑูู ุงููุงุชู: ${window.fullPhone}`;
            }
        });
    }, 5000); // ุงูุชุญุฏูุซ ูู 15 ุซุงููุฉ
    console.log("ุชู ุจุฏุก ุชุชุจุน ETA ูู ุงูููุช ุงูุญูููู");
    return intervalId;
}


// ุฏูุงู ุงูุนุฏ ุงูุชูุงุฒูู
function formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours} ุณุงุนุฉ ${minutes} ุฏูููุฉ ${seconds} ุซุงููุฉ`;
}

function startCountdown(duration, targetElement, onComplete) {
    if (!targetElement) {
        console.error("โ๏ธ ุนูุตุฑ 'countdownTimer' ุบูุฑ ููุฌูุฏ ูู ุงูุตูุญุฉ.");
        return;
    }
    let remaining = duration;
    targetElement.innerText = formatTime(remaining);
    const countdownInterval = setInterval(() => {
        remaining -= 1000;
        if (remaining <= 0) {
            clearInterval(countdownInterval);
            targetElement.innerText = "ุงูุชูู ุงูููุช";
            console.log("ุชู ุงูุชูุงุก ุงูุนุฏ ุงูุชูุงุฒูู ุจูุฌุงุญ");
            onComplete();  // ุชูููุฐ ุงูุฅุฌุฑุงุก ุนูุฏ ุงูุชูุงุก ุงูููุช
        } else {
            targetElement.innerText = formatTime(remaining);
        }
    }, 1000);
    console.log("ุชู ุจุฏุก ุงูุนุฏ ุงูุชูุงุฒูู");
    // ุชุฎุฒูู ูุนุฑู ุงููุคูุช ูู ูุชุบูุฑ ุนุงู
    window.countdownIntervalId = countdownInterval;
    return countdownInterval;
}






// ุฅุนุฏุงุฏ Firebase Messaging ููุฅุฑุณุงู ููุท
const messaging = firebase.messaging();

// ุชุนุฑูู ุฅุฑุณุงู ุฅุดุนุงุฑ ุจูุงุกู ุนูู ูุนุฑูู ุงูุนุงูู
function sendPusherNotificationByWorker(workerId, message) {
    fetch('http://localhost:7000/send-notification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ workerId, message })
    })
    .then((response) => response.json())
    .then((data) => console.log(' 188 ุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ุจูุฌุงุญ:', data))
    .catch((error) => console.error(' 189 ูุดู ุงูุฅุฑุณุงู:', error));
}






    
    // ูุฑุฌุน ุฅูู ูุงุนุฏุฉ ุจูุงูุงุช Firebase ุญูุซ ุณูุชู ุชุฎุฒูู ุจูุงูุงุช ุงูุนูุงู
    const database = firebase.database();
    const workersRef = database.ref('workers');




// ุชุนุฑูู ุงููุชุบูุฑ ุจุดูู ุนุงู ุจุฏูู ูุญุต ูุณุจู
let workerId = null;


function updateCounterOfferUI(negotiation) {
    if (!negotiation) {
        console.error("โ ุจูุงูุงุช ุงูุชูุงูุถ ุบูุฑ ูุชููุฑุฉ.");
        return;
    }
    var counterPopup = document.getElementById("counterOfferDisplayPopup");
    if (counterPopup) {
        counterPopup.style.display = "block";
        
        // ุงุณุชุฎุฏุงู ุจูุงูุงุช ุงูุทูุจ ุงููุฎุฒูุฉ ูู ูุงูุฐุฉ ุชูุงุตูู ุงูุนูู
        let orderDescription = "ุบูุฑ ูุชููุฑ";
        if (window.currentOrderData && window.currentOrderData.description) {
            orderDescription = window.currentOrderData.description;
        }
        document.getElementById("orderDescriptionWorker").innerText = "ูุตู ุงูุทูุจ: " + orderDescription;
        
        // ุชุญุฏูุซ ุจุงูู ุจูุงูุงุช ุงูุนุฑุถ
        document.getElementById("counterFinalPrice").innerText = negotiation.proposedPrice || "ุบูุฑ ูุชููุฑ";
        document.getElementById("counterFinalMessage").innerText = negotiation.message || "ุบูุฑ ูุชููุฑ";
    }
}















// ุชุนุฑูู ูุชุบูุฑ workerId ุงูุนุงู (ูููู ุชุนุฑููู ูู ุฃุนูู ุงูููู)
let currentWorkerId = null; // ุชุนุฑูู ูุชุบููุฑ ุนุงู ูุชุฎุฒูู ูุนุฑูู ุงูุนุงูู
let currentWorkerName = null; // ุชุนุฑูู ูุชุบููุฑ ุนุงู ูุชุฎุฒูู ุงุณู ุงูุนุงูู
let activeRequestExists = false; // ูุชุญุฏูุฏ ูุง ุฅุฐุง ูุงู ููุนุงูู ุทูุจ ูุดุท ุจุงููุนู

function loginWorker() {
    const inputId = document.getElementById('workerLoginId').value;

    if (!inputId) {
        alert("ูุฑุฌู ุฅุฏุฎุงู ูุนุฑูู ุงูุนุงูู.");
        return;
    }

    // ุชุนููู ูููุฉ workerId ูุจุงุดุฑุฉู ูุถูุงู ุงุณุชุฎุฏุงููุง ูู ูุงูุฉ ุงูุงุณุชุนูุงูุงุช
    workerId = inputId;

    // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุนุฑู ููุฌูุฏูุง ุฏุงุฎู "workers"
    database.ref(`workers/${inputId}`).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const workerData = snapshot.val();
                console.log(`โ ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ: ${workerData.name}`);
                
                // ุชุนููู currentWorkerId ู currentWorkerName ุจุงูุฅุถุงูุฉ ุฅูู workerId
                currentWorkerId = inputId;
                window.currentWorkerId = inputId;
                workerId = inputId; // ุชุฃููุฏ ุชุญุฏูุซ ุงููุชุบูุฑ ุงูุนุงู workerId
                currentWorkerName = workerData.name;

                console.log("โ currentWorkerId (local):", currentWorkerId);
                console.log("โ window.currentWorkerId:", window.currentWorkerId);
                console.log("โ workerId:", workerId);
                
                // ุฅุฎูุงุก ูุงูุฐุฉ ุชุณุฌูู ุงูุฏุฎูู
                document.getElementById('loginPopup').style.display = 'none';
                
                // ุชููุฆุฉ ุฌูุณุฉ ุงูุนุงูู ุจุงุณุชุฎุฏุงู workerId
                initializeWorkerSession(workerId);
            } else {
                // ุงูุชุญูู ูู ูุฌูุฏ ุงููุนุฑู ุฏุงุฎู "availableWorkerIds"
                database.ref(`availableWorkerIds/${inputId}`).once('value')
                    .then((availableSnapshot) => {
                        if (availableSnapshot.exists() && availableSnapshot.val().used === false) {
                            console.log(`๐ ุชุฎุตูุต ุงููุนุฑูู ${inputId} ูุฅูุดุงุคู ูู workers.`);
                            
                            // ุชุญุฏูุซ ุญุงูุฉ ุงููุนุฑูู ูู availableWorkerIds ุฅูู "ูุณุชุฎุฏู"
                            database.ref(`availableWorkerIds/${inputId}`).update({ used: true, usedAt: new Date().toISOString() });
                            
                            const workerName = prompt("ุฃุฏุฎู ุงุณูู ูุงุณุชุฎุฏุงู ูุฐุง ุงููุนุฑูู:");
                            if (!workerName) {
                                alert("ูุฌุจ ุฅุฏุฎุงู ุงุณู ูุงุณุชุฎุฏุงู ูุฐุง ุงููุนุฑูู.");
                                return;
                            }
                            
                            // ุฅูุดุงุก ุณุฌู ุฌุฏูุฏ ูู "workers"
                            database.ref(`workers/${inputId}`).set({
                                name: workerName,
                                assignedAt: new Date().toISOString(),
                                location: { lng: 0, lat: 0 } // ุณูุชู ุชุญุฏูุซู ูุงุญููุง
                            }).then(() => {
                                console.log(`โ ุชู ุชุฎุตูุต ุงููุนุฑูู ${inputId} ููุนุงูู: ${workerName}`);
                                
                                // ุชุนููู currentWorkerId ู currentWorkerName ุจุงูุฅุถุงูุฉ ุฅูู workerId
                                currentWorkerId = inputId;
                                window.currentWorkerId = inputId;
                                workerId = inputId; // ุชุญุฏูุซ ุงููุชุบูุฑ ุงูุนุงู workerId
                                currentWorkerName = workerName;
                                
                                console.log("โ currentWorkerId (local):", currentWorkerId);
                                console.log("โ window.currentWorkerId:", window.currentWorkerId);
                                console.log("โ workerId:", workerId);
                                
                                // ุชุณุฌูู ุงูุฏุฎูู ุจุนุฏ ุงูุชุฎุตูุต
                                document.getElementById('loginPopup').style.display = 'none';
                                initializeWorkerSession(workerId);
                            });
                        } else {
                            console.warn("โ๏ธ ุงููุนุฑูู ุบูุฑ ุตุงูุญ ุฃู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.");
                            alert("ุงููุนุฑูู ุบูุฑ ุตุงูุญุ ูุฑุฌู ุงูุชุญูู.");
                        }
                    })
                    .catch((error) => console.error("โ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญูู ูู availableWorkerIds:", error));
            }
        })
        .catch((error) => console.error("โ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุฏุฎูู:", error));
}




// ุฏุงูุฉ ุฅุฑุณุงู ุนุฑุถ ุงูุชูุงูุถ ุจุนุฏ ุงูุชุนุฏูู
function submitNegotiation() {
  const proposedPrice = document.getElementById('proposedPrice').value;
  const negotiationMessage = document.getElementById('negotiationMessage').value;
  
  if (!proposedPrice || !negotiationMessage) {
    console.error("ุญูู ุงูุณุนุฑ ุฃู ุงูุฑุณุงูุฉ ูุงุฑุบุฉ.");
    alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู.');
    return;
  }
  
  if (!isValidNegotiationMessage(negotiationMessage)) {
    console.error("ุงูุฑุณุงูุฉ ุชุญุชูู ุนูู ุจูุงูุงุช ุชูุงุตู ูุจุงุดุฑุฉ.");
    alert('ูุง ููุณูุญ ุจุฅุฏุฎุงู ุจูุงูุงุช ุชูุงุตู ูุจุงุดุฑุฉ.');
    return;
  }
  
  const workerId = window.currentWorkerId || currentWorkerId;
  if (!workerId) {
    console.error("ูู ูุชู ุชุณุฌูู ุฏุฎูู ุงูุนุงูู. ูุง ููุฌุฏ workerId.");
    alert("ูู ูุชู ุชุณุฌูู ุฏุฎูู ุงูุนุงูู. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู.");
    return;
  } else {
    console.log("ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญุ workerId:", workerId);
  }
  
  const negotiationData = {
    workerId: workerId,
    proposedPrice: proposedPrice,
    message: negotiationMessage,
    timestamp: Date.now(),
    status: 'pending'
  };
  
  if (!window.currentNegotiationRequestId) {
    alert("โ๏ธ ูุง ููุฌุฏ ุทูุจ ุชูุงูุถ ูุดุท!");
    return;
  }
  
  // ุชุนุทูู ุงููุณุชูุน ูุจู ุนูููุฉ ุงูุฅุฑุณุงู
  allowNegotiationListener = false;
  
  firebase.database().ref(`negotiations/${currentRequestId}`).push(negotiationData)
    .then(() => {
      // ุจุนุฏ ุงูุชูุงุก ุงูุฅุฑุณุงูุ ูุนูุฏ ุชูุนูู ุงููุณุชูุน
      allowNegotiationListener = true;
      console.log("ุชู ุฅุฑุณุงู ุนุฑุถ ุงูุชูุงูุถ ุจูุฌุงุญ.");
      alert('ุชู ุฅุฑุณุงู ุนุฑุถ ุงูุชูุงูุถ ุจูุฌุงุญ!');
      closeNegotiationForm();
    })
    .catch(error => {
      console.error("ุฎุทุฃ ูู ุฅุฑุณุงู ุนุฑุถ ุงูุชูุงูุถ:", error);
      alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุฅุฑุณุงู.');
      // ุฅุนุงุฏุฉ ุชูุนูู ุงููุณุชูุน ุญุชู ูู ุญุงูุฉ ุงูุฎุทุฃ
      allowNegotiationListener = true;
    });
}


function initializeWorkerSession(workerId) {
    console.log("โ ุชู ุชุณุฌูู ุฏุฎูู ุงูุนุงูู:", workerId);
    
    // ุฅูุดุงุก ุงููุฑุงุฌุน ุจูุงุกู ุนูู ูุนุฑูู ุงูุนุงูู
    window.workerRef = database.ref(`workers/${workerId}`);
    window.workerReviewsRef = workerRef.child('reviews');

    console.log("โ workerRef:", workerRef.toString());
    console.log("โ workerReviewsRef:", workerReviewsRef.toString());
    
    // ุงุณุชุฏุนุงุก ุงูุฏูุงู ุงูุชู ุชุนุชูุฏ ุนูู ูุนุฑูู ุงูุนุงูู: ุชุญุฏูุซ ุงููููุน ูุชุฑููุฒ ุงูุฎุฑูุทุฉ
    updateLocationWithGPS(workerId);
    focusOnWorkerLocation(workerId);

    // ุชุณุฌูู ูุณุชูุน ูุชุญุฏูุซ ุงูุทูุจุงุช ููุนุงูู ุงูุญุงูู ูู ุฏุงุฎู ุนูุฏ ุงูุนุงูู
    workerRef.child('currentRequest').on('value', (snapshot) => {
        const requestData = snapshot.val();
        if (requestData) {
            console.log(`ุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ููุนุงูู ${workerId}: ${requestData.status}`);
        } else {
            console.log(`ูุง ุชูุฌุฏ ุทูุจุงุช ุญุงูููุง ููุนุงูู ${workerId}`);
        }
    });

function listenForNegotiationOffers(requestId) {
  console.log("๐ก ุจุฏุก ุงูุงุณุชูุงุน ูุนุฑูุถ ุงูุชูุงูุถ ููุทูุจ:", requestId);
  if (!requestId) {
    console.error("โ๏ธ RequestId ุบูุฑ ููุฌูุฏ!");
    return;
  }
  
  const negotiationRef = firebase.database().ref(`negotiations/${requestId}`);
  
  // ุงุณุชุฎุฏู ุญุฏุซ "value" ูุน ุชุฑุชูุจ ุญุณุจ "timestamp" ูุชุญุฏูุฏ ุฃุญุฏุซ ุนุฑุถ
  negotiationRef.orderByChild("timestamp").limitToLast(1).on("value", snapshot => {
    snapshot.forEach(childSnapshot => {
      const negotiation = childSnapshot.val();
      if (negotiation) {
        // ุฅุฐุง ูุงู ุงูุนุฑุถ ูู ุญุงูุฉ pendingุ ูููู ุจุชุญุฏูุซ ุงููุงุฌูุฉ ูุชุฎุฒูู ุงูููุชุงุญ
        if (negotiation.status === "pending") {
          console.log("๐ ุนุฑุถ ุชูุงูุถู ุฌุฏูุฏ (pending):", childSnapshot.key, negotiation);
          updateNegotiationUI(negotiation);
          currentNegotiationOfferKey = childSnapshot.key;
        } 
        // ุฅุฐุง ุชุบูุฑ ุงูุนุฑุถ ูู pending ุฅูู ุญุงูุฉ ุฃุฎุฑูุ ูููู ุจูุนุงูุฌุฉ ุงูุชุญุฏูุซ
        else {
          console.log("๐ ุชุญุฏูุซ ูู ุงูุนุฑุถ ุงูุชูุงูุถู (ุบูุฑ pending):", childSnapshot.key, negotiation);
          handleNegotiationUpdate(negotiation);
        }
      }
    });
  });
}
}






function submitCounterOffer() {
  const proposedPrice = document.getElementById('counterOfferPrice').value;
  const negotiationMessage = document.getElementById('counterOfferMessage').value;
  
  if (!proposedPrice || !negotiationMessage) {
    console.error("ุญูู ุงูุณุนุฑ ุฃู ุงูุฑุณุงูุฉ ูุงุฑุบุฉ.");
    alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู.');
    return;
  }
  
  if (!isValidNegotiationMessage(negotiationMessage)) {
    console.error("ุงูุฑุณุงูุฉ ุชุญุชูู ุนูู ุจูุงูุงุช ุชูุงุตู ูุจุงุดุฑุฉ.");
    alert('ูุง ููุณูุญ ุจุฅุฏุฎุงู ุจูุงูุงุช ุชูุงุตู ูุจุงุดุฑุฉ.');
    return;
  }
  
  const workerId = window.currentWorkerId || currentWorkerId;
  if (!workerId) {
    console.error("ูู ูุชู ุชุณุฌูู ุฏุฎูู ุงูุนุงูู. ูุง ููุฌุฏ workerId.");
    alert("ูู ูุชู ุชุณุฌูู ุฏุฎูู ุงูุนุงูู. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู.");
    return;
  }
  
  // ุชูุช ุฅุถุงูุฉ ุฎุงุตูุฉ requestId ุฅูู ุจูุงูุงุช ุงูุนุฑุถ ุงููุถุงุฏ
  const counterOfferData = {
    workerId: workerId,
    proposedPrice: proposedPrice,
    message: negotiationMessage,
    timestamp: Date.now(),
    status: 'counter',
    requestId: window.currentNegotiationRequestId  // ุงูุณุทุฑ ุงููุถุงู
  };
  
  if (!window.currentNegotiationRequestId) {
    alert("โ๏ธ ูุง ููุฌุฏ ุทูุจ ุชูุงูุถ ูุดุท!");
    return;
  }
  
  // ูููู ุชุนุทูู ุงููุณุชูุน ุฅุฐุง ูุฒู ุงูุฃูุฑ ุฃุซูุงุก ุงูุฅุฑุณุงู
  allowNegotiationListener = false;
  
  firebase.database().ref(`negotiations/${currentRequestId}`).push(counterOfferData)
    .then(() => {
      allowNegotiationListener = true;
      console.log("ุชู ุฅุฑุณุงู ุงูุนุฑุถ ุงููุถุงุฏ ุจูุฌุงุญ.");
      alert('ุชู ุฅุฑุณุงู ุงูุนุฑุถ ุงููุถุงุฏ ุจูุฌุงุญ!');
      closeCounterOfferForm(); // ุฏุงูุฉ ูุฅุบูุงู ูุงูุฐุฉ ุงูุนุฑุถ ุงููุถุงุฏ
    })
    .catch(error => {
      console.error("ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุนุฑุถ ุงููุถุงุฏ:", error);
      alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุฅุฑุณุงู.');
      allowNegotiationListener = true;
    });
}








if (currentRequestId) {
    listenForNegotiationOffers(currentRequestId);
}











// ุฏุงูุฉ ููุนุงูุฌุฉ ุชุญุฏูุซุงุช ุงูุชูุงูุถ
function handleNegotiationUpdate(negotiation) {
    if (!negotiation) return;
    if (negotiation.status === "accepted") {
        alert("โ ุชู ูุจูู ุงูุนุฑุถ!");
        // ุชุญุฏูุซ ุงููุงุฌูุฉ ุนุจุฑ ูุงูุฐุฉ ุจุฏุก ุงูุชูุงูุถ ุฃู ูุงูุฐุฉ ุงูุนุฑุถ ุญุณุจ ุงูุชุตููู
        updateNegotiationUI(negotiation);
    } else if (negotiation.status === "rejected") {
        alert("โ ุชู ุฑูุถ ุงูุนุฑุถ!");
        updateNegotiationUI(negotiation);
    } else if (negotiation.status === "counter") {
        alert("๐ ุชู ุชูุฏูู ุนุฑุถ ูุถุงุฏ.");
        // ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ ูุนุฑุถ ุงูุนุฑุถ ุงููุถุงุฏ ุงูุฐู ูุฏูู ุงููุณุชุฎุฏู
        updateCounterOfferUI(negotiation);
    }
}


// ุฅุถุงูุฉ ูุณุชูุน ููุชุงุจุนุฉ ูู ุงูุชุบููุฑุงุช ุงูุชู ุชุญุฏุซ ูู `negotiations`
function listenForNegotiationUpdates() {
    console.log("๐ก ุจุฏุก ุงูุงุณุชูุงุน ูุชุญุฏูุซุงุช ุงูุชูุงูุถ ูู `negotiations`");

    const negotiationsRef = firebase.database().ref("negotiations");

    negotiationsRef.on("value", snapshot => {
        if (!snapshot.exists()) return;

        const negotiationsData = snapshot.val();
        console.log("๐ก ุชุญุฏูุซ ูู `negotiations`:", negotiationsData);

        // ุงููุฑูุฑ ุนูู ุฌููุน ุงูุทูุจุงุช
        Object.keys(negotiationsData).forEach(requestId => {
            if (requestId !== currentRequestId) return; // ุงูุชุญูู ูู ุฃูู ุงูุทูุจ ุงูุญุงูู
            
            const negotiations = negotiationsData[requestId];

            Object.keys(negotiations).forEach(negotiationId => {
                const negotiation = negotiations[negotiationId];

                // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงูุนุฑุถ ุณุงุจููุง ูู ุญุงูุฉ "pending" ูุจู ุงูุชุบููุฑ
                const previousNegotiation = previousNegotiations[negotiationId]; // ุญูุธ ุงูููู ุงูุณุงุจูุฉ
                if (previousNegotiation && previousNegotiation.status === "pending" && negotiation.status !== "pending") {
                    console.log("๐ ุชุบูุฑุช ุญุงูุฉ ุงูุนุฑุถ:", negotiationId, "ูู pending ุฅูู", negotiation.status);
                    handleNegotiationUpdate(negotiation);
                }

                // ุชุญุฏูุซ ุงููููุฉ ุงููุฎุฒูุฉ ููุนุฑูุถ ุงูุณุงุจูุฉ
                previousNegotiations[negotiationId] = negotiation;
            });
        });
    });
}

// ุชุนุฑูู ูุชุบูุฑ ูุชุฎุฒูู ุงูููู ุงูุณุงุจูุฉ ููุนุฑูุถ ุงูุชูุงูุถูุฉ
let previousNegotiations = {};




// ุงุณุชุฏุนุงุก ุงููุณุชูุน ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener("DOMContentLoaded", function () {
    listenForNegotiationUpdates();
});













// ุฏุงูุฉ ูุชุญุฏูุซ activeWorkers ูุน ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก
function updateActiveWorkerLocation(workerId, location) {
    try {
        const activeWorkerRef = database.ref('activeWorkers/' + workerId);
        activeWorkerRef.set({
            location: location,
            active: true
        });
    } catch (error) {
        console.error("ุฎุทุฃ ุนูุฏ ุชุญุฏูุซ activeWorkers:", error);
    }
}

function updateLocationWithGPS(workerId) {
    if (navigator.geolocation) {
        // โ ุงูุญุตูู ุนูู ุงููููุน ุงูุฃููู ููุนุงูู
        navigator.geolocation.getCurrentPosition((position) => {
            const initialLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
            };
            console.log("๐90 ุงููููุน ุงูุฃููู:", initialLocation);
            updateWorkerLocation(workerId, initialLocation);
            updateActiveWorkerLocation(workerId, initialLocation);
        }, (error) => {
            console.error("๐จ 91 ุฎุทุฃ ุฃุซูุงุก ุฌูุจ ุงููููุน ุงูุฃููู:", error);
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });

        // โ ูุฑุงูุจุฉ ุงูุชุบูุฑุงุช ูู ุงููููุน ุจุดูู ูุณุชูุฑ
        navigator.geolocation.watchPosition((position) => {
            const newLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
            };
            console.log("๐ก 93 ุชุญุฏูุซ ุงููููุน ุฃุซูุงุก ุงูุญุฑูุฉ:", newLocation);
            
            // ุชุญุฏูุซ ุงููููุน ุงูุญุงูู ูู ุงูุฐุงูุฑุฉ
            window.currentWorkerLocation = newLocation;
            
            // ุชุญุฏูุซ Firebase ุจุงููููุน ุงูุฌุฏูุฏ ููุนุงูู
            updateWorkerLocation(workerId, newLocation);
            updateActiveWorkerLocation(workerId, newLocation);
            
            // ุงุณุชุฏุนุงุก ุฏุงูุฉ ูุญุต ุงููุณุงูุฉ ูุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ
            checkAndUpdateOrderStatus();
            
            // ุงุณุชุฏุนุงุก ุฏุงูุฉ ุฃุฎุฑู ููุชุญูู ูู ุฅุธูุงุฑ ุฒุฑ ุงูุฅูุบุงุก
            checkDistanceAndToggleCancelButton();
        }, (error) => {
            console.error("๐จ 197 ุฎุทุฃ ุฃุซูุงุก ุชุชุจุน ุงููููุน:", error);
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    } else {
        console.error("๐จ 198 ุงููุชุตูุญ ูุง ูุฏุนู ุชุญุฏูุฏ ุงููููุน ุงูุฌุบุฑุงูู (Geolocation).");
    }
}

// ุฅุถุงูุฉ ูุณุชูุน ูุทูุจุงุช ุงูุนูู ุงูููุฌูุฉ ููุนุงูู ุงูุญุงูู
let initialLoadDone = false;
const workerRequestsRef = database.ref('workRequests').orderByChild('workerId').equalTo(workerId);

// ุฃููุงูุ ูุณุชุฎุฏู once ูุชุญููู ุงูุจูุงูุงุช ุงูุญุงููุฉ
workerRequestsRef.once('value', snapshot => {
    // ุนูุฏ ุงูุชูุงุก ุงูุชุญููู ูุถุจุท ุงูุนูู ุฅูู true
    initialLoadDone = true;
});

// ุจุนุฏ ุฐูู ูุถูู ูุณุชูุน child_added
workerRequestsRef.on('child_added', snapshot => {
    // ุฅุฐุง ูู ููุชูู ุงูุชุญููู ุงูุฃููู ูุชุฌุงูู ุงูุญุฏุซ
    if (!initialLoadDone) return;
    
    const requestData = snapshot.val();
    console.log('ุทูุจ ุฌุฏูุฏ ููุฌู ูู:', requestData);
    alert('ูุฏูู ุทูุจ ุฌุฏูุฏ: ' + requestData.workType);
});



function checkDistanceAndToggleCancelButton() {
    // ูุธูุฑ ุฒุฑ ุงูุฅูุบุงุก ููุท ุฅุฐุง ูุงู ููุงู ุทูุจ ูุดุท (orderActive) ููู ูููุบู ุจุนุฏ
    if (!currentRequestId || !orderActive) return;
    firebase.database().ref(`workRequests/${currentRequestId}`).once('value')
        .then(snapshot => {
            const request = snapshot.val();
            // ุฅุฐุง ูุงู ุงูุทูุจ ููุบู ุฃู ูู ูุนุฏ ูู ุญุงูุฉ "pending" ููุง ุชุธูุฑ ุงูุฎูุงุฑุงุช
            if (!request || request.status !== 'pending') {
                document.getElementById('cancelJobContainer').style.display = 'none';
                console.log("๐ ุงูุทูุจ ุบูุฑ ูุชุงุญ ููุฅูุบุงุกุ ุฅุฎูุงุก ุฒุฑ ุงูุฅูุบุงุก.");
                return;
            }
            if (request && request.location) {
                const distance = calculateDistance(currentWorkerLocation, request.location);
                console.log(`ุงููุณุงูุฉ ุจูู ุงูุนุงูู ูุงูุทูุจ: ${distance.toFixed(2)} ูู`);
                if (distance <= 0.5) {
                    document.getElementById('cancelJobContainer').style.display = 'none';
                    console.log('โฑ๏ธ ุฅุฎูุงุก ุฒุฑ ุงูุฅูุบุงุก ูุฃู ุงูุนุงูู ุนูู ุจุนุฏ ุฃูู ูู 500 ูุชุฑ.');
                } else {
                    document.getElementById('cancelJobContainer').style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('โ ุฎุทุฃ ุฃุซูุงุก ุญุณุงุจ ุงููุณุงูุฉ:', error);
        });
}



document.addEventListener("DOMContentLoaded", () => {
    // ุชุฃููุฏ ุชุญููู ุงูุนูุงุตุฑ ุงููุทููุจุฉ:
    const loginButton = document.getElementById('loginWorkerButton');
    if (!loginButton) {
        console.error("๐จ ุฒุฑ ุชุณุฌูู ุงูุฏุฎูู ุบูุฑ ููุฌูุฏ ูู DOM. ุชุฃูุฏ ูู ุชุญููู ุงูุตูุญุฉ ุจุงููุงูู.");
        return;
    }
    // ุฑุจุท ุฒุฑ ุชุณุฌูู ุงูุฏุฎูู ุจุงูุฏุงูุฉ
    loginButton.addEventListener('click', loginWorker);

    // ุจุงูู ุงูููุฏ ุงูุฐู ูุชุญูู ูู ูุฌูุฏ ุนูุงุตุฑ ุฃุฎุฑู (ูุซู acceptJobButton, locateButton, styleSelector)
    const acceptJobButton = document.getElementById('acceptJobButton');
    const locateButton = document.getElementById('locateButton');
    const styleSelector = document.getElementById('styleSelector');

    if (!acceptJobButton || !locateButton || !styleSelector) {
        console.error("๐จ ุจุนุถ ุงูุนูุงุตุฑ ุบูุฑ ููุฌูุฏุฉ ูู DOM. ุชุฃูุฏ ูู ุชุญููู ุงูุตูุญุฉ ุจุงููุงูู.");
        return;
    }
});



// ูุณุชูุน ุญุฏุซ ุฒุฑ "ุฅูุบุงุก ุงูุทูุจ" ุงูุฎุงุต ุจุงูุนุงูู
// ุชุนุฑูู ููุงุชูุญ Pusher ุงูุฎุงุตุฉ ุจู
const pusherInstanceId = "2a17d881-b1a6-4a38-8cd4-de1ab8212f67";
const pusherAuthorization = "94B66644D08CBCEDEEBE73156329B8DF8F82064EC4B9D16750B88454146530FB";

// ุฏุงูุฉ ูุฅุนุงุฏุฉ ุชููุฆุฉ ูุงุฌูุฉ ุงููุณุชุฎุฏู ุจุนุฏ ุฅูุบุงุก ุงูุทูุจ
function resetJobUI() {
    // ุฅุฎูุงุก ูุงูุฐุฉ ุชูุงุตูู ุงูุทูุจ
    document.getElementById('jobDetailsPopup').style.display = 'none';
    // ุฅุฎูุงุก ุฒุฑ ุฅูุบุงุก ุงูุทูุจ
    document.getElementById('cancelJobContainer').style.display = 'none';
    
    // ุฅููุงู ุงูุนุฏ ุงูุชูุงุฒูู ุฅุฐุง ูุงู ูุนุฑูู ูุญููุธ ูู ุงููุชุบูุฑ ุงูุนุงู
    if (window.countdownIntervalId) {
        clearInterval(window.countdownIntervalId);
        window.countdownIntervalId = null;
        console.log("ุชู ุฅููุงู ุงูุนุฏ ุงูุชูุงุฒูู.");
    }
    
    // ุฅุนุงุฏุฉ ุถุจุท ูุญุชูู ุงูุนุฏ ุงูุชูุงุฒูู ุฏูู ุญุฐู ุงูุนูุตุฑ ููุณู
    const countdownTimer = document.getElementById('countdownTimer');
    if (countdownTimer) {
        countdownTimer.innerText = '';
    }
    document.getElementById('countdownPanel').style.display = 'none';  // ุฅุฎูุงุก ุงูุญุงููุฉ ุนูุฏ ุงูุฅูุบุงุก
    
    // ุฅุนุงุฏุฉ ุถุจุท ุนุฑุถ ETA ุฏูู ุญุฐู ุงูุนูุตุฑ ููุณู
    const etaDisplay = document.getElementById('etaDisplay');
    if (etaDisplay) {
        etaDisplay.innerText = '';
    }
    document.getElementById('etaPanel').style.display = 'none';  // ุฅุฎูุงุก ุงูุญุงููุฉ ุนูุฏ ุงูุฅูุบุงุก
    
    // ุฅุฒุงูุฉ ุญุงูุฉ ุงูุทูุจ ูู ุงูุชุฎุฒูู ุงููุญูู
    localStorage.removeItem('orderStatus');
    localStorage.removeItem('currentRequestId');
}






document.getElementById('cancelJobButton').addEventListener('click', function() {
    const distance = getWorkerDistance();
    if (distance < 0.5) { 
        alert("ููุฏ ุณุฌูุช ุชูุฏูู ูู ุงูููุธููุฉ ููุง ููููู ุงูุฅูุบุงุก ุงูุขู.");
        console.error("ูุญุงููุฉ ุฅูุบุงุก ุงูุทูุจ ุฃุซูุงุก ุงูุชุฑุงุจ ุงูุนุงูู ูู ุงููููุน");
        return;
    } else {
        if (!confirm("ุชูุจูู: ุงูุทูุจ ูู ูููุบู ุฅุฐุง ุฃุตุจุญุช ูุฑูุจุงู (ุฃูู ูู 500 ูุชุฑ) ูู ุงููููุน. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ")) {
            console.log("ุชู ุฅูุบุงุก ุนูููุฉ ุงูุฅูุบุงุก ุจูุงุกู ุนูู ุชุฃููุฏ ุงููุณุชุฎุฏู.");
            return;
        }
    }
    
    showCancelConfirmation(function() {
        const requestRef = firebase.database().ref(`workRequests/${currentRequestId}`);
        // ุฅุนุงุฏุฉ ุชุนููู ุงูุญุงูุฉ ูุชุณุฌูู ูุนุฑู ุงูุนุงูู ุงูุฐู ุฃูุบู ุงูุทูุจ
        requestRef.update({ 
            status: 'pending',
            canceledBy: currentWorkerId  
        })
        .then(() => {
            // ุชุณุฌูู ุณุฌู ุชุงุฑูุฎู ุฌุฏูุฏ ููุฅูุบุงุก ูุน ุงุณุชุฎุฏุงู ูููุฉ ุงูุชุฑุงุถูุฉ ุฅุฐุง currentWorkerName ุบูุฑ ูุนุฑู
            const historyRef = requestRef.child('orderHistory');
            historyRef.push({
                 type: 'canceled',
                 workerId: currentWorkerId,
                 workerName: currentWorkerName ? currentWorkerName : "ุบูุฑ ูุนุฑูู",
                 timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            alert('ุชู ุฅูุบุงุก ุงูุทูุจ. ููููู ูุจููู ูุฑุฉ ุฃุฎุฑู.');
            orderCanceled = true;
            orderActive = false;
            activeRequestExists = false;
            currentRequestId = null;
            localStorage.removeItem('orderStatus');
            localStorage.removeItem('currentRequestId');
            sendPusherNotification(window.selectedWorkerId, 'ุชู ุฅูุบุงุก ุงูุทูุจ ูู ูุจู ุงูุนุงูู.');
            console.log("ุชู ุฅูุบุงุก ุงูุทูุจ ูุชุญุฏูุซ ุงูุญุงูุฉ ูู Firebase ูุน ุชุณุฌูู ูุนุฑู ุงูุนุงูู ุงูุฐู ุฃูุบู ุงูุทูุจ.");
            if (map.getLayer('route')) {
                map.removeLayer('route');
                map.removeSource('route');
                console.log("ุชู ุฅุฒุงูุฉ ูุณุงุฑ ุงูุทูุจ ูู ุงูุฎุฑูุทุฉ.");
            }
            if (window.etaIntervalId) {
                clearInterval(window.etaIntervalId);
                window.etaIntervalId = null;
                console.log("ุชู ุฅููุงู ุชุชุจุน ETA.");
            }
            if (window.countdownIntervalId) {
                clearInterval(window.countdownIntervalId);
                window.countdownIntervalId = null;
                console.log("ุชู ุฅููุงู ุงูุนุฏ ุงูุชูุงุฒูู.");
            }
            resetJobUI();
        })
        .catch((err) => {
            console.error("ุฎุทุฃ ูู ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ:", err);
        });
    });
});


function showNotification(message) {
    // ุฅูุดุงุก ุนูุตุฑ ุงูุฅุดุนุงุฑ
    const notification = document.createElement('div');
    notification.innerText = message;
    // ุชูุณูู ุจุณูุท ููุฅุดุนุงุฑ
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.backgroundColor = '#f44336';
    notification.style.color = '#fff';
    notification.style.padding = '10px';
    notification.style.borderRadius = '5px';
    notification.style.boxShadow = '0px 2px 6px rgba(0, 0, 0, 0.3)';
    notification.style.zIndex = '10000';
    document.body.appendChild(notification);
    // ุฅุฒุงูุฉ ุงูุฅุดุนุงุฑ ุจุนุฏ 3 ุซูุงูู
    setTimeout(() => {
       notification.remove();
    }, 3000);
}


function handleShowJobDetails(jobData) {
    console.log("handleShowJobDetails: ุชู ุงูููุฑ ุนูู ุฒุฑ ุนุฑุถ ุชูุงุตูู ุงูุทูุจ", jobData);
    
    // ุงูุชุฃูุฏ ูู ุฃู ุงููุนุทู ุนุจุงุฑุฉ ุนู ูุงุฆู ูููุณ ุณูุณูุฉ ูุตูุฉ
    if (typeof jobData === 'string') {
        try {
            jobData = JSON.parse(jobData);
            console.log("handleShowJobDetails: ุชู ุชุญููู ุงูุณูุณูุฉ ุฅูู ูุงุฆู ุจูุฌุงุญ", jobData);
        } catch (e) {
            console.error("handleShowJobDetails: ูุดู ุชุญููู ุงูุณูุณูุฉ ุฅูู ูุงุฆู JSON", e);
            showNotification("ุญุฏุซ ุฎุทุฃ ูู ุจูุงูุงุช ุงูุทูุจ");
            return;
        }
    }
    
    // ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู ูุนุฏู ูุชุญ ุชูุงุตูู ุงูุทูุจ ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ูุณุฌูุงู
    if (!currentWorkerId) {
        console.error("handleShowJobDetails: ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุงูุฏุฎูู");
        // ุนุฑุถ ุฅุดุนุงุฑ ุจุฏูุงู ูู ูุชุญ ูุงูุฐุฉ ุงูุชูุงุตูู
        alert("ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู ูุนุฑุถ ุงููููุฒุงุช");
        // ูุชุญ ูุงูุฐุฉ ุชุณุฌูู ุงูุฏุฎูู ุชููุงุฆููุง
        document.getElementById('loginPopup').style.display = 'flex';
        return;
    }
    
    console.log("handleShowJobDetails: ุงููุณุชุฎุฏู ูุณุฌู ุงูุฏุฎูู ุจูุฌุงุญุ currentWorkerId =", currentWorkerId);
    // ุงุณุชุฏุนุงุก ุฏุงูุฉ ุนุฑุถ ุชูุงุตูู ุงูุทูุจ ููุท ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌูุงู ููุฏุฎูู
    showJobDetails(jobData);
}




document.addEventListener("DOMContentLoaded", function() {
    // ูุญุงููุฉ ุฌูุจ ุงููููุน ุงูุญุงูู ูููุณุชุฎุฏู ุญุชู ูุฅู ูู ูุชู ุชุณุฌูู ุงูุฏุฎูู
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                window.currentWorkerLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                console.log("ุชู ุงูุญุตูู ุนูู ุงููููุน ุงูุญุงูู ุนูุฏ ุชุญููู ุงูุตูุญุฉ:", window.currentWorkerLocation);
            },
            function(error) {
                console.error("ุฎุทุฃ ุฃุซูุงุก ุฌูุจ ุงููููุน ุนูุฏ ุชุญููู ุงูุตูุญุฉ:", error);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    } else {
        console.error("ุงููุชุตูุญ ูุง ูุฏุนู Geolocation.");
    }
});



// ูุชุบูุฑุงุช ูุชุฎุฒูู ุงููุตูููุฉ ุงูุญุงููุฉ ููุคุดุฑ ุงูุตูุฑุฉ ุงููุนุฑูุถุฉ
let modalMediaArray = [];
let modalCurrentIndex = 0;

function showJobDetails(jobData) {
    console.log("showJobDetails: ุจุฏุฃ ุนุฑุถ ุชูุงุตูู ุงูุทูุจ", jobData);

    // 1๏ธโฃ ุชุญุฏูุซ ุงูุตูุฑ ุฃูููุง ูุจู ุฃู ุจูุงูุงุช ุฃุฎุฑู
    const container = document.getElementById('jobImagesContainer');
    container.innerHTML = ""; // ูุณุญ ุงูุตูุฑ ุงูุณุงุจูุฉ

    if (jobData.media && Array.isArray(jobData.media) && jobData.media.length > 0) {
        console.log("ุฑูุงุจุท ุงูุตูุฑ ุงููุฑุณูุฉ:", jobData.media);
        modalMediaArray = jobData.media; 
        jobData.media.forEach((url, index) => {
            const img = document.createElement('img');
            img.src = url.startsWith("http") ? url : `https://yourdomain.com${url}`;
            img.alt = "ุตูุฑุฉ ุงูุนูู";
            img.style.width = "18%";
            img.style.height = "auto";
            img.style.marginRight = "2%";
            img.style.cursor = "pointer";

            img.addEventListener("click", function () {
                openImageModal(index);
            });

            container.appendChild(img);
        });

        container.style.display = 'block'; 
    } else {
        container.style.display = 'none'; 
    }

    // 2๏ธโฃ ุชุญุฏูุซ ุจุงูู ุงูุจูุงูุงุช ุจุนุฏ ุงูุตูุฑ
    document.getElementById('jobDescription').innerText = `ูุตู ุงูุนูู: ${jobData.description || "ุบูุฑ ูุชููุฑ"}`;

    const fullPhone = jobData.phone || "ุบูุฑ ูุชููุฑ";
    let maskedPhone = fullPhone.length > 5 ? fullPhone.substr(0, 5) + "*****" : fullPhone;
    document.getElementById('userPhone').innerText = `ุฑูู ุงููุงุชู: ${maskedPhone} (ุณูุธูุฑ ุงูุฑูู ุงููุงูู ุนูุฏ ุงูุงูุชุฑุงุจ 500 ูุชุฑ)`;

    document.getElementById('jobLocation').innerText = `ุงููููุน: ${jobData.region || "ุบูุฑ ูุญุฏุฏ"}`;
    document.getElementById('jobDuration').innerText = `ุงููุฏุฉ: ${jobData.time || "ุบูุฑ ูุญุฏุฏุฉ"}`;
    document.getElementById('jobBudget').innerText = `ุงููุจูุบ: ${jobData.budget || "ุบูุฑ ูุญุฏุฏ"}`;
    document.getElementById('jobDistance').innerText = `ุงููุณุงูุฉ: ${jobData.distance || "ุบูุฑ ูุนุฑููุฉ"} ูู`;
    document.getElementById('estimatedArrivalTime').innerText = `ุงูููุช ุงูููุฏุฑ: ${jobData.eta || "ุบูุฑ ูุญุฏุฏ"}`;

    // 3๏ธโฃ ุนุฑุถ ุงููุงูุฐุฉ ุจุนุฏ ุชุญุฏูุซ ุฌููุน ุงูุจูุงูุงุช
    document.getElementById('jobDetailsPopup').style.display = 'block';


    if (!window.orderData) {
        window.orderData = {};
    }
    if (jobData.requestId) {
        window.orderData[jobData.requestId] = jobData;
    } else {
        console.warn("ูู ูุชู ุชูุฑูุฑ requestId ูู ุจูุงูุงุช ุงูุทูุจ");
    }
    
    // ูุชุงุจุนุฉ ุญุณุงุจ ุงููุณุงูุฉ ูุงูููุช ุงูููุฏุฑ
    if (typeof currentWorkerLocation === 'undefined') {
        console.warn("currentWorkerLocation ุบูุฑ ูุนุฑูุ ูุญุงููุฉ ุฌูุจ ุงููููุน ุงูุขู...");
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentWorkerLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log("ุชู ุงูุญุตูู ุนูู ุงููููุน ุงูุญุงูู ูู showJobDetails:", currentWorkerLocation);
                    updateDistanceAndETA();
                },
                function(error) {
                    console.error("ุฎุทุฃ ุฃุซูุงุก ุฌูุจ ุงููููุน ูู showJobDetails:", error);
                    document.getElementById('jobDistance').innerText = "ุงููุณุงูุฉ: ุบูุฑ ูุชููุฑุฉ";
                }
            );
        }
    } else {
        updateDistanceAndETA();
    }


// ุฏุงูุฉ ููุชุญ ูุงูุฐุฉ ุนุฑุถ ุงูุตูุฑุฉ (Modal) ูุน ุชูุฑูุฑ ุงููุคุดุฑ
function openImageModal(index) {
    modalCurrentIndex = index;
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงููุตูููุฉ ูุชุนููู ุงูุตูุฑุฉ ุงูุญุงููุฉ
    if (modalMediaArray.length > 0) {
        let url = modalMediaArray[modalCurrentIndex];
        modalImg.src = url.startsWith("http") ? url : `https://yourdomain.com${url}`;
    }
    modal.style.display = 'flex';
}

// ุฏูุงู ุงูุชููู ุจูู ุงูุตูุฑ
document.getElementById('prevBtn').addEventListener("click", function(e) {
    e.stopPropagation(); // ููุน ุงูุชุดุงุฑ ุงูุญุฏุซ ูุฅุบูุงู ุงููุงูุฐุฉ
    if (modalMediaArray.length > 0) {
        modalCurrentIndex = (modalCurrentIndex - 1 + modalMediaArray.length) % modalMediaArray.length;
        updateModalImage();
    }
});

document.getElementById('nextBtn').addEventListener("click", function(e) {
    e.stopPropagation();
    if (modalMediaArray.length > 0) {
        modalCurrentIndex = (modalCurrentIndex + 1) % modalMediaArray.length;
        updateModalImage();
    }
});

// ุฏุงูุฉ ูุชุญุฏูุซ ุงูุตูุฑุฉ ูู ุงูููุฏุงู ุจูุงุกู ุนูู ุงููุคุดุฑ ุงูุญุงูู
function updateModalImage() {
    const modalImg = document.getElementById('modalImage');
    let url = modalMediaArray[modalCurrentIndex];
    modalImg.src = url.startsWith("http") ? url : `https://yourdomain.com${url}`;
}

// ุฅุบูุงู ุงููุงูุฐุฉ ุนูุฏ ุงูููุฑ ุฎุงุฑุฌ ุงูุตูุฑุฉ
document.getElementById('imageModal').addEventListener("click", function(e) {
    if (e.target.id === 'imageModal') {
        this.style.display = 'none';
    }
});







    function updateDistanceAndETA() {
        const distance = calculateDistance(currentWorkerLocation, jobData.location);
        const distanceElem = document.getElementById('jobDistance');
        if (distanceElem) {
            distanceElem.innerText = `ุงููุณุงูุฉ: ${distance.toFixed(2)} ูู`;
        }
        calculateETA(currentWorkerLocation, jobData.location, (err, data) => {
            if (err) {
                console.error("ุฎุทุฃ ูู ุญุณุงุจ ETA ุฃุซูุงุก ุนุฑุถ ุชูุงุตูู ุงูุนูู", err);
                return;
            }
            const etaElem = document.getElementById('estimatedArrivalTime');
            if (etaElem) {
                const minutes = Math.round(data.duration / 60);
                etaElem.innerText = `ุงูููุช ุงูููุฏุฑ: ${minutes} ุฏูููุฉ`;
            }
        });
    }
    
    const acceptBtn = document.getElementById('acceptJobButton');
    if (jobData.status !== 'pending') {
        acceptBtn.style.display = 'inline-block';
        acceptBtn.textContent = 'ุชู ูุจูู ุงูุทูุจ';
        acceptBtn.style.backgroundColor = 'red';
        acceptBtn.disabled = true;
    } else {
        acceptBtn.style.display = 'inline-block';
        acceptBtn.textContent = 'ูุจูู ุงูุทูุจ';
        acceptBtn.style.backgroundColor = 'green';
        acceptBtn.disabled = false;
    }
    
    window.currentOrderData = jobData;
    
    // ุนุฑุถ ุงููุงูุฐุฉ ูุงุณุชููุงู ุงูุญุณุงุจุงุช...
    document.getElementById('jobDetailsPopup').style.display = 'block';
    document.getElementById('etaPanel').style.display = 'block';
    document.getElementById('countdownPanel').style.display = 'block';
}








    // ูุณุชูุน ุญุฏุซ ุฒุฑ "ุฑูุถ ุงูุทูุจ"
    document.getElementById('rejectDirectRequest').addEventListener('click', function() {
        console.log("ุชู ุงูููุฑ ุนูู ุฒุฑ ุฑูุถ ุงูุทูุจ");
        // ูุซุงู ูุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ูู Firebase ุนูุฏ ุงูุฑูุถ
        firebase.database().ref('workRequests/' + currentRequestId).update({
            status: 'rejected'
        }).then(function() {
            console.log("ุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ุฅูู rejected ูู Firebase");
        }).catch(function(error) {
            console.error("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ:", error);
        });
        // ุฅุฎูุงุก ุงููุงูุฐุฉ ุจุนุฏ ุงูุฑูุถ
        document.getElementById('directRequestPopup').style.display = 'none';
        alert("ุชู ุฑูุถ ุงูุทูุจ.");
    });






// ูุณุชูุน ููุจูู ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ
const savedRequests = []; // ุชุฎุฒูู ุงูุทูุจุงุช ูุคูุชูุง

function processSavedRequests() {
    try {
        console.log("โก 37 ุจุฏุก ุนูููุฉ ุงูุชุญูู ูู ุงูุทูุจุงุช ุงููุญููุธุฉ...");

        // ุงูุชุญูู ูู ุฌุงูุฒูุฉ ุงูุฎุฑูุทุฉ ุจุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูููุญุฏุฉ
        if (typeof map === 'undefined' || !(map instanceof mapboxgl.Map)) {
    console.error("๐จ 115 ุงููุงุฆู map ุบูุฑ ูููุฃ ุฃู ุบูุฑ ูุนุฑูู. ุณูุชู ุฅุนุงุฏุฉ ุชููุฆุชู.");
    initializeMap(); // ุฅุนุงุฏุฉ ุงูุชููุฆุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
    return;
}

// [ุงูุณุทุฑ 35-42] ุจุงุณุชุฎุฏุงู waitUntilMapReady()
waitUntilMapReady()
    .then(() => {
        // ููุง ุชูุชุจ ุงูููุฏ ุงูุฐู ูุชุงุจุน ูุนุงูุฌุฉ ุงูุทูุจุงุช ุงููุญููุธุฉ
        // ูุซูุงู: processSavedRequests();
    })
    .catch((err) => {
        console.warn("โ๏ธ 36: ุงูุฎุฑูุทุฉ ููุณุช ุฌุงูุฒุฉ ุจุนุฏ ููุนุงูุฌุฉ ุงูุทูุจุงุช ุงููุญููุธุฉ. ุณูุชู ุชุฃุฌูููุง.", err);
        return;
    });




        console.log("โก 79 ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ. ุจุฏุก ูุนุงูุฌุฉ ุงูุทูุจุงุช ุงููุญููุธุฉ...");

        // ูุนุงูุฌุฉ ุงูุทูุจุงุช ุงููุญููุธุฉ ุฅุฐุง ูุงูุช ููุฌูุฏุฉ
        while (savedRequests.length > 0) {
            const request = savedRequests.shift();

            // ุงูุชุญูู ูู ุตุญุฉ ุจูุงูุงุช ุงูุทูุจ
            if (!request || !request.requestData || !request.requestId) {
                console.error("๐จ 41 ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ ูู ุงูุทูุจ:", request);
if (!request) {
    console.error("๐จ 155 ุงูุทูุจ ุบูุฑ ููุฌูุฏ ุฃู ุชู ุญุฐูู ูู Firebase.");
}      continue; // ุชุฌุงูุฒ ุงูุทูุจ ุฅุฐุง ูุงู ุบูุฑ ุตุญูุญ
            }

            const { requestData, requestId } = request;
            console.log(`โ๏ธ 42 ูุนุงูุฌุฉ ุงูุทูุจ ุงููุญููุธ: ${requestId}`);

            // ุงูุชุญูู ูู ุญุงูุฉ ุงูุทูุจ
            if (requestData.status === 'pending') {
                try {
                    console.log(`โ 33 ุชูุนูู ุงููููุฉ ุงูุฒูููุฉ ููุทูุจ ${requestId}.`);
                    startRequestTimeout(requestId, 10); // ุชูุนูู ุงููููุฉ ุงูุฒูููุฉ
                    showJobDetails(requestData); // ุนุฑุถ ุชูุงุตูู ุงูุทูุจ
                } catch (error) {
                    console.error(`๐จ 34 ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุทูุจ ${requestId}:`, error);
                }
            } else {
                console.warn(`โ๏ธ 35 ุงูุทูุจ ${requestId} ููุณ ูู ุญุงูุฉ 'pending'.`);
            }
        }

        console.log("โ 74 ุชูุช ูุนุงูุฌุฉ ุฌููุน ุงูุทูุจุงุช ุงููุญููุธุฉ ุจูุฌุงุญ.");
    } catch (error) {
        console.error("๐จ 75 ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุทูุจุงุช ุงููุญููุธุฉ:", error);
    }
}

// ุฏุงูุฉ ูุญูุธ ุงูุทูุจุงุช ุฅุฐุง ูู ุชูู ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ
function saveRequestForLater(requestData, requestId) {
    if (!requestData || !requestId) {
        console.error("๐จ 80 ุจูุงูุงุช ุงูุทูุจ ุบูุฑ ุตุญูุญุฉ. ูุง ูููู ุญูุธ ุงูุทูุจ:", { requestData, requestId });
        return;
    }
    console.log(`๐ 81 ุชู ุญูุธ ุงูุทูุจ ${requestId} ููุชุนุงูู ูุงุญููุง:`, requestData);
    savedRequests.push({ requestData, requestId });
}






// ุชุนุฏูู ูุณุชูุน ุงูุทูุจุงุช
const requestRef = database.ref('workRequests');
let initialRequestsLoaded = false;

// ุชุญููู ุงูุจูุงูุงุช ุงูุฃูููุฉ ูุชุนููู ุงูุนูู ุนูุฏ ุงูุงูุชูุงุก
requestRef.once('value', () => {
    initialRequestsLoaded = true;
});

requestRef.on('child_added', (snapshot) => {
    // ุชุฌุงูู ุงูุฃุญุฏุงุซ ุงูุชู ุชุฃุชู ูู ุงูุชุญููู ุงูุฃููู
    if (!initialRequestsLoaded) return;

    const requestData = snapshot.val();
    const requestId = snapshot.key;

    // ุชุนููู ุงูุทูุจ ุงูุญุงูู
    currentRequestId = requestId;
    console.log("โ ุชู ุชุนููู currentRequestId ููุทูุจ ุงูุฌุฏูุฏ:", currentRequestId);

    // ุดุฑุท ุงูุชุญูู ูู ูุฌูุฏ ุทูุจ ูุดุท ูุณุจูุงู
    if (activeRequestExists) {
        console.log("โ๏ธ ุงูุนุงูู ูุฏูู ุทูุจ ูุดุท ุจุงููุนู. ุชู ุชุฌุงูู ุงูุทูุจ ุงูุฌุฏูุฏ.");
        return;
    }

    // ุงูุชุฃูุฏ ูู ุชููุฑ ูููุน ุงูุนุงูู ูุญุณุงุจ ุงููุณุงูุฉ
    if (!window.currentWorkerLocation) {
        console.error("๐จ 210 ูููุน ุงูุนุงูู ุงูุญุงูู ุบูุฑ ูุชููุฑ.");
        return;
    }
    const distance = calculateDistance(window.currentWorkerLocation, requestData.location);
    console.log(` 211 ุงููุณุงูุฉ ุจูู ุงูุนุงูู ูุงูุทูุจ ${requestId}: ${distance.toFixed(2)} ูู`);
    if (distance > 15) {
        console.warn(`โ๏ธ ุงูุทูุจ ${requestId} ุจุนูุฏ ุนู ูุทุงู ุงูู 15 ููุ ูู ูุชู ุนุฑุถู.`);
        return;
    }

    waitUntilMapReady()
        .then(() => {
            console.log(`๐ 40 ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ ููุนุงูุฌุฉ ุงูุทูุจ ${requestId}.`);
            if (requestData.status === 'pending') {
                try {
                    console.log(`โ๏ธ 44 ุจุฏุก ูุนุงูุฌุฉ ุงูุทูุจ ${requestId}.`);
                    startRequestTimeout(requestId, 10); // ุชูุนูู ุงููููุฉ ุงูุฒูููุฉ

                    // ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู ูุจู ุนุฑุถ ุชูุงุตูู ุงูุทูุจ
                    if (currentWorkerId) {
                        showJobDetails(requestData); // ุนุฑุถ ุชูุงุตูู ุงูุทูุจ
                    } else {
                        // ุฅุฐุง ูู ููู ุงููุณุชุฎุฏู ูุณุฌูุงูุ ุนุฑุถ ุฅุดุนุงุฑ ูุชูุจูู ูุชุณุฌูู ุงูุฏุฎูู
                        alert("ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู ูุนุฑุถ ุชูุงุตูู ุงูุทูุจ");
                        document.getElementById('loginPopup').style.display = 'flex';
                    }
                } catch (error) {
                    console.error(`๐จ 72 ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุงูุทูุจ ${requestId}:`, error);
                }
            } else {
                console.warn(`โ๏ธ 73 ุงูุทูุจ ${requestId} ููุณ ูู ุญุงูุฉ 'pending'.`);
            }
        })
        .catch((err) => {
            console.warn(`โ๏ธ 39: ุงูุฎุฑูุทุฉ ููุณุช ุฌุงูุฒุฉ ุจุนุฏ. ุณูุชู ุชุฃุฌูู ุงูุชุนุงูู ูุน ุงูุทูุจ ${requestId}.`, err);
            saveRequestForLater(requestData, requestId);
            return;
        });
});










// ุฅุถุงูุฉ ุฅุนุงุฏุฉ ูุญุงููุฉ ุนูุฏ ูุดู ุชุญููู ุงูููุท
let retryCount = 0; // ุนุฏุฏ ุงููุญุงููุงุช
const maxRetries = 3; // ุงูุญุฏ ุงูุฃูุตู ูููุญุงููุงุช

function checkMapStyleLoaded() {
    if (!map) {
        console.error("๐จ 82 ุงููุงุฆู map ุบูุฑ ูููุฃ. ุชุฃูุฏ ูู ุชููุฆุชู ูุจู ุงุณุชุฏุนุงุก checkMapStyleLoaded.");
        return;
    }

    if (map.isStyleLoaded()) {
    isMapReady = true;
    console.log("๐ 157 ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ.");
    processSavedRequests(); // ูุนุงูุฌุฉ ุงูุทูุจุงุช ุงููุญููุธุฉ
} else if (retryCount < maxRetries) {
    retryCount++;
    console.warn(`โ๏ธ 48 ุงููุญุงููุฉ ุฑูู ${retryCount}: ุงูููุท ูู ูุชู ุชุญูููู. ุณูุชู ุฅุนุงุฏุฉ ุงููุญุงููุฉ (${retryCount}/${maxRetries}).`);
    setTimeout(() => {
        checkMapStyleLoaded(); // ุฅุนุงุฏุฉ ุงููุญุงููุฉ
    }, 2000); // ุชูููู ุงูุชุฃุฎูุฑ ุฅูู ุซุงููุชูู
} else {
    console.error("๐จ 49 ูุดู ุชุญููู ุงูููุท ุจุนุฏ ุนุฏุฉ ูุญุงููุงุช. ูุฑุฌู ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงูุฎุฑูุทุฉ ุฃู ุงุชุตุงู ุงูุดุจูุฉ.");
    alert("โ๏ธ 86 ุญุฏุซุช ูุดููุฉ ุฃุซูุงุก ุชุญููู ุงูููุท. ุญุงูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.");
console.error("๐จ 156 ูุดู ุชุญููู ุงูููุท ุจุนุฏ ุนุฏุฉ ูุญุงููุงุช. ุชุฃูุฏ ูู ุงุชุตุงู ุงูุดุจูุฉ.");
}

}













// ูุงุฆู ูุชุฎุฒูู ูุนุฑูุงุช ุงููุคูุช ููู ุทูุจ
const timeoutIntervals = {};

// ุฏุงูุฉ ุชุญุฏูุฏ ูููุฉ ุฒูููุฉ ููุจูู ุงูุทูุจ ุจุนุฏ ุงูุชุนุฏูู
function startRequestTimeout(requestId, timeoutMinutes = 10) {
    const timeoutTime = Date.now() + timeoutMinutes * 60 * 1000;
    const requestRef = database.ref(`workRequests/${requestId}`);

    // ุชุฎุฒูู ูุนุฑู ุงููุคูุช ูู ูุงุฆู timeoutIntervals ุจุงุณุชุฎุฏุงู requestId ูููุชุงุญ
    timeoutIntervals[requestId] = setInterval(() => {
        requestRef.once('value').then((snapshot) => {
            const requestData = snapshot.val();
            console.log(`[Timeout Checker] ุงูุชุญูู ูู ุญุงูุฉ ุงูุทูุจ ${requestId} ูู ${new Date().toLocaleTimeString()}: ${requestData.status}`);
            // ุฅุถุงูุฉ ุดุฑุท ูุนุฏู ุชุญุฏูุซ ุงูุญุงูุฉ ุฅุฐุง ูุงู acceptedBy ููุฌูุฏูุง
            if (Date.now() > timeoutTime && requestData.status === 'pending' && !requestData.acceptedBy) {
                requestRef.update({ status: 'timeout' });
                clearInterval(timeoutIntervals[requestId]);
                console.log(`ุงูุทูุจ ${requestId} ุงูุชูุช ูููุฉ ูุจููู ูุชู ุชุบููุฑ ุญุงูุชู ุฅูู timeout.`);
            }
        });
    }, 10000);
}

// ุฏุงูุฉ ูุจูู ุงูุทูุจ ุจุนุฏ ุงูุชุนุฏูู
function acceptRequest(requestId, workerId, workerName) {
    const requestRef = database.ref(`workRequests/${requestId}`);
    return requestRef.once('value')
        .then(snapshot => {
            const request = snapshot.val();
            if (!request) {
                alert('โ ุงูุทูุจ ุบูุฑ ููุฌูุฏ.');
                console.error(`โ ูุดู ุงูุนุซูุฑ ุนูู ุงูุทูุจ ${requestId}.`);
                return Promise.reject('ุงูุทูุจ ุบูุฑ ููุฌูุฏ');
            }
            if (request.status !== 'pending') {
                alert('โ๏ธ ูุง ูููู ูุจูู ุงูุทูุจ ูุฃูู ูู ูุนุฏ ูู ุญุงูุฉ ุงูุชุธุงุฑ.');
                console.error(`โ ุฑูุถ ูุจูู ุงูุทูุจ ${requestId}: ุงูุญุงูุฉ ุงูุญุงููุฉ ${request.status}`);
                return Promise.reject('ุงูุทูุจ ุบูุฑ ูุชุงุญ ูููุจูู');
            }
            return requestRef.update({
                status: 'accepted',
                acceptedBy: workerId
            });
        })
        .then(() => {
            // ุชุณุฌูู ุงููุจูู ูู ุณุฌู ุงูุชุงุฑูุฎ (ููุถุงู ุณุฌู ุฌุฏูุฏ ุฏูู ุงุณุชุจุฏุงู ุงูููู ุงูุณุงุจูุฉ)
            const activityRef = database.ref(`workRequests/${requestId}/orderHistory`);
            activityRef.push({
                type: 'accepted',
                workerId: workerId,
                workerName: workerName,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            alert('โ ุชู ูุจูู ุงูุทูุจ ุจูุฌุงุญ.');
            console.log(`๐ข ุชู ูุจูู ุงูุทูุจ ${requestId} ูู ุงูุนุงูู ${workerId} ูู ${new Date().toLocaleTimeString()}`);
            if (window.markers && window.markers[requestId]) {
                window.markers[requestId].setColor('yellow');
                console.log(`๐จ ุชู ุชุบููุฑ ููู ุงููุงุฑูุฑ ููุทูุจ ${requestId} ุฅูู ุฃุตูุฑ.`);
            }
            if (window.timeoutIntervals && window.timeoutIntervals[requestId]) {
                clearInterval(window.timeoutIntervals[requestId]);
                console.log(`โณ ุชู ุฅูุบุงุก ูุคูุช ุงูุทูุจ ${requestId} ุจุนุฏ ุงููุจูู.`);
                delete window.timeoutIntervals[requestId];
            }
            requestRef.onDisconnect().update({
                status: 'pending',
                note: 'ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุทูุจ ุจุณุจุจ ุงููุทุงุน ุงุชุตุงู ุงูุนุงูู'
            })
            .then(() => {
                console.log("โ onDisconnect ุชู ุชุนูููู ููุทูุจ:", requestId);
            })
            .catch((error) => {
                console.error("โ ุฎุทุฃ ูู ุชุนููู onDisconnect ููุทูุจ:", requestId, error);
            });
            startWorkerHeartbeat(workerId);

            // ุงูุชุนุฏููุงุช ุงูุฌุฏูุฏุฉ:
// ุฅุนุงุฏุฉ ุชุนููู ุงูุญุงูุฉ ุจุนุฏ ูุจูู ุงูุทูุจ
orderCanceled = false;
orderActive = true;
localStorage.setItem('orderStatus', 'accepted'); // ุชุญุฏูุซ ุงูุชุฎุฒูู ุงููุญูู ูุญุงูุฉ ุงูุทูุจ

// ุฅุนุงุฏุฉ ุฅุธูุงุฑ ููุญุงุช ETA ูุงูุนุฏ ุงูุชูุงุฒูู
document.getElementById('etaPanel').style.display = 'block';
document.getElementById('countdownPanel').style.display = 'block';

// ุชุญุฏูุซ ุงููููุน ุงูุญุงูู ููุนุงูู ูู ุญุงู ูุงู ููุงูู ุฏุงูุฉ ูุชุญุฏูุซ ุงููููุน
if (typeof updateLocationWithGPS === 'function' && currentWorkerId) {
    updateLocationWithGPS(currentWorkerId); // ุณูุนูู ุนูู ุชุญุฏูุซ currentWorkerLocation
}

// ุชุญุฏูุซ jobLocation ูู ุจูุงูุงุช ุงูุทูุจ (ููุชุฑุถ ุฃู requestData ูุญุชูู ุนูู ุจูุงูุงุช ุงูุทูุจ ุงูุฌุฏูุฏุฉ)
if (requestData && requestData.location) {
    jobLocation = requestData.location;
} else {
    console.error("ุจูุงูุงุช ูููุน ุงูุทูุจ ุบูุฑ ูุชููุฑุฉ.");
}

// ุงูุชุฃูุฏ ูู ุฃู ุจูุงูุงุช ุงูููุงูุน ูุชููุฑุฉ ูุจู ุจุฏุก ุชุชุจุน ETA
console.log('currentWorkerLocation:', currentWorkerLocation);
console.log('jobLocation:', jobLocation);

if (currentWorkerLocation && jobLocation) {
    // ุจุฏุก ุชุชุจุน ETA ูุน ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
    window.etaIntervalId = startRealTimeETATracking(currentWorkerLocation, jobLocation);
} else {
    console.error("ูุง ูููู ุจุฏุก ุชุชุจุน ETAุ ุชุฃูุฏ ูู ุตุญุฉ ุจูุงูุงุช ุงูููุงูุน.");
}

        })
        .catch(error => {
            console.error(`โ ูู ูุชู ูุจูู ุงูุทูุจ ${requestId}:`, error);
        });
}













    // ุฏุงูุฉ ูุฅุถุงูุฉ ุนุงูู ุฌุฏูุฏ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    function addWorker(workerId, workerName, lng, lat) {
      workersRef.child(workerId).set({
        name: workerName,
        location: {
          lng: lng,
          lat: lat
        }
      });
    }

    // ุฏุงูุฉ ูุชุฎุตูุต ูุนุฑูู ูุนุงูู ูุนูู
    function assignWorkerId(workerName, lng, lat) {
    database.ref('availableWorkerIds').orderByChild('used').equalTo(false).limitToFirst(1).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const workerId = Object.keys(snapshot.val())[0]; // ุฃูู ูุนุฑูู ุบูุฑ ูุณุชุฎุฏู

                // ุชุญุฏูุซ ุญุงูุฉ ุงููุนุฑูู ุฅูู "ูุณุชุฎุฏู"
                database.ref(`availableWorkerIds/${workerId}`).update({ used: true });

                // ุชุณุฌูู ุงูุนุงูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
                database.ref(`workers/${workerId}`).set({
                    name: workerName,
                    assignedAt: new Date().toISOString(),
                    location: { lng: lng, lat: lat }
                });

                console.log(`ุชู ุชุฎุตูุต ุงููุนุฑูู ${workerId} ููุนุงูู: ${workerName}`);
            } else {
                console.log("ูุง ุชูุฌุฏ ูุนุฑููุงุช ูุชุงุญุฉ.");
            }
        })
        .catch((error) => console.error("ุฎุทุฃ ุฃุซูุงุก ุชุฎุตูุต ุงููุนุฑูู:", error));
}

// ุฏุงูุฉ ุชุณุฌูู ุงูุฏุฎูู ุจุงุณุชุฎุฏุงู ูุนุฑูู ุงูุนุงูู
// ุชุนุฑูู ุงููุชุบูุฑ ุงูุนุงู ูู ุจุฏุงูุฉ ุงูููู
// ุชุนุฑูู ูุชุบูุฑ ุนุงู ูุชุฎุฒูู ูุนุฑู ุงูุนุงูู ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู



// ุฏุงูุฉ ุชุจุฏูู ุนุฑุถ/ุฅุฎูุงุก ููุญุฉ ุงูุทูุจุงุช
function toggleOrdersPanel() {
  const panel = document.getElementById("ordersPanel");

  if (!panel.classList.contains("show")) {
    panel.classList.add("show");
    console.log("โ ุชู ูุชุญ ููุญุฉ ุงูุทูุจุงุช.");
    fetchPendingOrders();
  } else {
    panel.classList.remove("show");
    console.log("โ ุชู ุฅุบูุงู ููุญุฉ ุงูุทูุจุงุช.");
  }
}



// ุฏุงูุฉ ูุฌูุจ ุงูุทูุจุงุช ุงููุนููุฉ ูู Firebase ูุชุญุฏูุซ ุงูููุญุฉ
function fetchPendingOrders() {
  // ุชุญุฏูุฏ ุงูุนูุตุฑ ุงูุฎุงุต ุจูุงุฆูุฉ ุงูุทูุจุงุช
  const ordersList = document.getElementById("ordersList");
  ordersList.innerHTML = ""; // ุชูุฑูุบ ุงููุญุชูู ุงููุฏูู

  firebase.database().ref("workRequests")
    .orderByChild("status").equalTo("pending")
    .once("value", function(snapshot) {
      if (!snapshot.exists()) {
        ordersList.innerHTML = "<p>ูุง ููุฌุฏ ุทูุจุงุช</p>";
        console.log("No pending orders found.");
        updateOrdersBadge(0);
        return;
      }

      let orders = [];
      snapshot.forEach(function(childSnapshot) {
        const order = childSnapshot.val();
        order.orderId = childSnapshot.key;
        orders.push(order);
      });

      // ุชุทุจูู ุงูุจุญุซ ูุงููุฑุฒ
      applySearchAndSort(orders);
    }, function(error) {
      console.error("Error fetching pending orders:", error);
    });
}

// ุฏุงูุฉ ูุชุทุจูู ุงูุจุญุซ ูุงููุฑุฒ ูุนุฑุถ ุงูุทูุจุงุช
// ุฏุงูุฉ ูุชุทุจูู ุงูุจุญุซ ูุงููุฑุฒ ูุนุฑุถ ุงูุทูุจุงุช (ุจุนุฏ ุงูุชุนุฏูู)
function applySearchAndSort(orders) {
  const searchValue = document.getElementById('orderSearch').value.toLowerCase();
  const sortBy = document.getElementById('orderSort').value;
  const threeDaysInMs = 3 * 24 * 60 * 60 * 1000; // 3 ุฃูุงู ุจุงููููู ุซุงููุฉ

  // ุชุตููุฉ ุงูุทูุจุงุช ุจูุงุกู ุนูู ุงูุจุญุซ ูุงูููุช
  let filteredOrders = orders.filter(order => {
    const matchesSearch = order.workType.toLowerCase().includes(searchValue) ||
                          (order.region && order.region.toLowerCase().includes(searchValue));
    if (!matchesSearch) return false;

    if (order.status === "pending" || order.status === "accepted") {
      return true;
    }

    if ((order.status === "finished" || order.status === "completed") && order.completedAt) {
      return (Date.now() - order.completedAt) < threeDaysInMs;
    }
    return false;
  });

  // ูุฑุฒ ุงูุทูุจุงุช ุจูุงุกู ุนูู ุงูุฎูุงุฑ ุงููุญุฏุฏ
  if (sortBy === 'timestamp') {
    filteredOrders.sort((a, b) => (b.submittedAt || b.timestamp || 0) - (a.submittedAt || a.timestamp || 0));
  } else if (sortBy === 'distance') {
    filteredOrders.sort((a, b) => {
      const distA = calculateDistance(window.currentWorkerLocation, a.location);
      const distB = calculateDistance(window.currentWorkerLocation, b.location);
      return distA - distB;
    });
  } else if (sortBy === 'status') {
    filteredOrders.sort((a, b) => a.status.localeCompare(b.status));
  }

  // ุนุฑุถ ุงูุทูุจุงุช ูู ุงูุนูุตุฑ ordersList
  const ordersList = document.getElementById("ordersList");
  ordersList.innerHTML = "";
  filteredOrders.forEach(function(order) {
    const orderItem = document.createElement("div");
    orderItem.className = "orderItem";

    // ุฅูุดุงุก ูุณู ูุนุฑุถ ุงูุตูุฑ (ุฅุฐุง ููุฌุฏุช)
    let imagesHTML = "";
    if (order.media && Array.isArray(order.media) && order.media.length > 0) {
      imagesHTML = `<div class="orderImagesContainer" style="overflow-x: auto; white-space: nowrap; margin-bottom: 10px;">`;
      order.media.forEach((url, index) => {
        const src = url.startsWith("http") ? url : `https://yourdomain.com${url}`;
        imagesHTML += `<img src="${src}" alt="ุตูุฑุฉ ุงูุทูุจ"
                        style="width: 60px; height: auto; margin-right: 5px; border-radius: 5px; cursor:pointer;"
                        data-media='${JSON.stringify(order.media)}' data-index='${index}'
                        onclick='openOrderImageModal(this)'>`;
      });
      imagesHTML += `</div>`;
    }

    // ุฃููููุงุช ูุญุงูุฉ ุงูุทูุจ
    let statusIcon = "";
    if (order.status === "pending") {
      statusIcon = '<i class="fas fa-hourglass-half" style="color:orange;"></i>';
    } else if (order.status === "accepted") {
      statusIcon = '<i class="fas fa-check-circle" style="color:green;"></i>';
    } else if (order.status === "finished" || order.status === "completed") {
      statusIcon = '<i class="fas fa-flag-checkered" style="color:blue;"></i>';
    }

    // ุญุณุงุจ ุงููุณุงูุฉ ุจูู ูููุน ุงูุนุงูู ููููุน ุงูุทูุจ
    const distance = calculateDistance(window.currentWorkerLocation, order.location).toFixed(2);

    // ุนุฑุถ ุงูุญุงูุฉ ูุน ุชุนุฏูู ุนูุฏ ุงูุทูุจ ุงูููุชูู
    const displayStatus = order.status === "pending" ? "ูู ุงูุชุธุงุฑ" :
                          (order.status === "finished" || order.status === "completed" ? "ุชู ุฅูุฌุงุฒู" : order.status);

    orderItem.innerHTML = `
      ${imagesHTML}
      <p><strong>ููุช ุงูุชูุฏูู:</strong> ${order.submittedAt ? new Date(order.submittedAt).toLocaleString() : "ุบูุฑ ูุชููุฑ"} ${statusIcon}</p>
      <p><strong>ููุน ุงูุนูู:</strong> ${order.workType || "ุบูุฑ ูุญุฏุฏ"}</p>
      <p><strong>ุงูุญุงูุฉ:</strong> ${displayStatus}</p>
      <p><strong>ุงูููุฒุงููุฉ:</strong> ${order.budget || "ุบูุฑ ูุญุฏุฏุฉ"}</p>
      <p><strong>ุงููุตู:</strong> ${order.description || "ุบูุฑ ูุชููุฑ"}</p>
      <p><strong>ุงููุณุงูุฉ:</strong> ${distance} ูู</p>
      <button onclick='handleShowJobDetails(${JSON.stringify(order).replace(/"/g, "&quot;")})'>ุนุฑุถ ุชูุงุตูู ุงูุทูุจ</button>
    `;
    ordersList.appendChild(orderItem);
  });

  updateOrdersBadge(filteredOrders.length);
}

// ุฏุงูุฉ ููุชุญ ุงูุตูุฑ ูู ูุงูุฐุฉ ุงูุนุฑุถ ูุน ุฅููุงููุฉ ุงูุชููู
function openOrderImageModal(element) {
  try {
    const mediaArray = JSON.parse(element.getAttribute("data-media"));
    const index = parseInt(element.getAttribute("data-index"), 10);

    if (!Array.isArray(mediaArray) || mediaArray.length === 0) {
      console.error("ูุง ุชูุฌุฏ ุตูุฑ ูุชุงุญุฉ ููุฐุง ุงูุทูุจ.");
      return;
    }

    modalMediaArray = mediaArray;
    modalCurrentIndex = index;

    console.log("ุชู ูุชุญ ุนุฑุถ ุงูุตูุฑ - ุงูููุฑุณ:", modalCurrentIndex, "ูุตูููุฉ ุงูุตูุฑ:", modalMediaArray);

    openImageModal(modalCurrentIndex);
  } catch (error) {
    console.error("ุฎุทุฃ ูู ุฌูุจ ุจูุงูุงุช ุงูุตูุฑ:", error);
  }
}

// ุฏุงูุฉ ููุชุญ ูุงูุฐุฉ ุนุฑุถ ุงูุตูุฑ
function openImageModal(index) {
  modalCurrentIndex = index;
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');

  if (modalMediaArray.length > 0) {
    let url = modalMediaArray[modalCurrentIndex];
    modalImg.src = url.startsWith("http") ? url : `https://yourdomain.com${url}`;
    modal.style.display = 'flex';
  }
}

// ุฏูุงู ุงูุชููู ุจูู ุงูุตูุฑ
function showPreviousImage() {
  if (modalMediaArray.length > 0) {
    modalCurrentIndex = (modalCurrentIndex - 1 + modalMediaArray.length) % modalMediaArray.length;
    updateModalImage();
  }
}

function showNextImage() {
  if (modalMediaArray.length > 0) {
    modalCurrentIndex = (modalCurrentIndex + 1) % modalMediaArray.length;
    updateModalImage();
  }
}

// ุชุญุฏูุซ ุงูุตูุฑุฉ ูู ุงููุงูุฐุฉ
function updateModalImage() {
  const modalImg = document.getElementById('modalImage');
  let url = modalMediaArray[modalCurrentIndex];
  modalImg.src = url.startsWith("http") ? url : `https://yourdomain.com${url}`;
}

// ุฅุถุงูุฉ ูุงูุฐุฉ ุงูุตูุฑ ุฅูู ุงูู HTML ุนูุฏ ุชุญููู ุงูุตูุญุฉ
document.addEventListener("DOMContentLoaded", function () {
  const modalHTML = `
    <div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:9999;">
      <button id="prevBtn" style="position:absolute; left:20px; background:transparent; border:none; font-size:2em; color:#fff; cursor:pointer;">&#10094;</button>
      <img id="modalImage" src="" alt="ุนุฑุถ ุงูุตูุฑุฉ" style="max-width:90%; max-height:90%; border: 5px solid #fff; border-radius:5px;">
      <button id="nextBtn" style="position:absolute; right:20px; background:transparent; border:none; font-size:2em; color:#fff; cursor:pointer;">&#10095;</button>
    </div>
  `;
  document.body.insertAdjacentHTML("beforeend", modalHTML);

  document.getElementById('prevBtn').addEventListener("click", showPreviousImage);
  document.getElementById('nextBtn').addEventListener("click", showNextImage);
  document.getElementById('imageModal').addEventListener("click", function (e) {
    if (e.target.id === 'imageModal') {
      this.style.display = 'none';
    }
  });
});




// ุฅุถุงูุฉ ูุณุชูุนุงุช (event listeners) ูุชุญุฏูุซ ุงููุงุฆูุฉ ุนูุฏ ุฅุฏุฎุงู ุงูุจุญุซ ุฃู ุชุบููุฑ ุงููุฑุฒ
document.getElementById('orderSearch').addEventListener('input', function() {
  fetchPendingOrders();
  console.log("๐ ุชู ุชุญุฏูุซ ุงูุจุญุซ ูู ุงูุทูุจุงุช.");
});
document.getElementById('orderSort').addEventListener('change', function() {
  fetchPendingOrders();
  console.log("๐ ุชู ุชุบููุฑ ุฎูุงุฑ ุงููุฑุฒ ูู ุงูุทูุจุงุช.");
});


// ุฏุงูุฉ ูุชุญุฏูุซ ุดุงุฑุฉ ุนุฏุฏ ุงูุทูุจุงุช ุนูู ุฒุฑ "ุนุฑุถ ุงูุทูุจุงุช"
function updateOrdersBadge(count) {
  const badge = document.getElementById("ordersBadge");
  badge.textContent = count > 0 ? count : "";
}

// ุฏุงูุฉ ููุจูู ุงูุทูุจ ูุชุญุฏูุซ ุญุงูุชู ูู Firebase
function acceptOrder(orderId) {
  firebase.database().ref("workRequests/" + orderId).update({ status: "accepted" })
    .then(function() {
      alert("ุชู ูุจูู ุงูุทูุจ");
      console.log("Order " + orderId + " accepted.");
      fetchPendingOrders(); // ุชุญุฏูุซ ุงููุงุฆูุฉ ุจุนุฏ ุงููุจูู
    })
    .catch(function(error) {
      console.error("Error accepting order:", error);
    });
}


function openNegotiationForm(requestId) {
    console.log("ูุชุญ ูุงูุฐุฉ ุงูุชูุงูุถ ููุทูุจ:", requestId);
    document.getElementById("negotiationPopup").style.display = "block";
    window.currentNegotiationRequestId = requestId; // ุญูุธ ุงููุนุฑูู ูู ูุชุบูุฑ ุนุงู
}


function closeNegotiationForm() {
    document.getElementById('negotiationPopup').style.display = 'none';
}

function isValidNegotiationMessage(message) {
    const phoneRegex = /\d{8,}/; // ููุน ุฅุฏุฎุงู ุฃุฑูุงู ุชุดุจู ุฃุฑูุงู ุงูููุงุชู
    return !phoneRegex.test(message);
}











// ุฅุฎูุงุก ููุญุฉ ุงูุทูุจุงุช ุนูุฏ ุงูููุฑ ุฎุงุฑุฌูุง
document.addEventListener("click", function(event) {
  const panel = document.getElementById("ordersPanel");
  const toggleButton = document.getElementById("toggleOrdersButton");
  if (panel.style.display === "block" && !panel.contains(event.target) && !toggleButton.contains(event.target)) {
    panel.style.display = "none";
    console.log("Orders panel hidden due to outside click.");
  }
});

// ุฑุจุท ุญุฏุซ ุงูููุฑ ุนูู ุฒุฑ "ุนุฑุถ ุงูุทูุจุงุช" ุจุงูุฏุงูุฉ
document.getElementById("toggleOrdersButton").addEventListener("click", function(event) {
  event.stopPropagation(); // ููุน ุฅุบูุงู ุงูููุญุฉ ุนูุฏ ุงูููุฑ ุฏุงุฎููุง
  toggleOrdersPanel();
});






function sendNotificationToNearbyWorkers(requestData, userLocation) {
    const radius = 15;  // ุชู ุชุนุฏูู ูุตู ุงููุทุฑ ุฅูู 15 ูู
    console.log("ุชู ุถุจุท ูุตู ุงููุทุฑ ุนูู:", radius, "ูู");
    // ูุฑุฌุน ุงูุนูุงู ูู Firebase
    const workersRef = database.ref('workers');
    workersRef.once('value', (snapshot) => {
        snapshot.forEach((workerSnapshot) => {
            const worker = workerSnapshot.val();
            if (!worker || !worker.location) {
                console.error("๐จ ุจูุงูุงุช ุงูุนุงูู ุบูุฑ ูุชููุฑุฉ ุฃู ุงููููุน ุบูุฑ ุตุงูุญ:", workerSnapshot.key);
                return;
            }
            const distance = calculateDistance(userLocation, worker.location);
            console.log(`ุงููุณุงูุฉ ููุนุงูู ${workerSnapshot.key}: ${distance.toFixed(2)} ูู`);
            console.log("ุงููููุน ุงูููุฑุณู:", userLocation, "ููููุน ุงูุนุงูู:", worker.location);
    
            if (distance <= radius) {
                console.log(`๐ข ุงูุนุงูู ${workerSnapshot.key} ุฏุงุฎู ุงููุทุงู ูุณูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ.`);
                // ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ุจุงุณุชุฎุฏุงู Pusher Beams
                sendPusherNotification(workerSnapshot.key, `ุทูุจ ${requestData.workType} ูู ููุทูุชู.`, "ุทูุจ ุฌุฏูุฏ ูุชุงุญ!");
            } else {
                console.warn(`โ๏ธ ุงูุนุงูู ${workerSnapshot.key} ุฎุงุฑุฌ ูุทุงู ุงูู 15 ูู.`);
            }
        });
    });
}







if (!window.activeListeners) {
    window.activeListeners = {}; // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงููุงุฆู ูุชุชุจุน ุงููุณุชูุนูู
}


function startTracking(workerId) {
    const workerLocationRef = database.ref(`workers/${workerId}/location`);
    if (window.activeListeners[workerId]) {
        console.warn(`โ๏ธ ุงููุณุชูุน ููุนุงูู ${workerId} ูุถุงู ุจุงููุนู.`);
        return;
    }
    
    // ุฅูุดุงุก ูุฑุฌุน ุฎุงุต ููู ุนุงูู ุจุงุณุชุฎุฏุงู workerId
    const currentWorkerRef = database.ref(`workers/${workerId}`);
    currentWorkerRef.on('value', (snapshot) => {
        const data = snapshot.val();
        const location = data && data.location;
        if (location && location.lat && location.lng) {
            console.log(`๐คทโโ๏ธุชู ุชุญุฏูุซ ูููุน ุงูุนุงูู ${workerId}:`, location);
            waitUntilMapReady()
                .then(() => {
                    updateWorkerMarker(location, workerId);
                })
                .catch((err) => {
                    console.error("โ๏ธ 2: ุงูุฎุฑูุทุฉ ุบูุฑ ูููุฃุฉ ุฃู ุงูููุท ุบูุฑ ูุญูู.", err);
                });
        } else {
            console.error(`๐จ 83 ุจูุงูุงุช ูููุน ุงูุนุงูู ${workerId} ุบูุฑ ุตุญูุญุฉ:`, location);
        }
    });
    
    window.activeListeners[workerId] = true;
}




// ุฏุงูุฉ ูุนุฑุถ ุฅุดุนุงุฑ ููุนุงูู
function showWorkerNotification(message) {
    var notificationDiv = document.getElementById("workerNotification");
    if (notificationDiv) {
        notificationDiv.innerText = message;
        notificationDiv.style.display = "block";
        // ุฅุฎูุงุก ุงูุฅุดุนุงุฑ ุจุนุฏ 5 ุซูุงูู
        setTimeout(function() {
            notificationDiv.style.display = "none";
        }, 5000);
    }
}







    // ุฏุงูุฉ ูุชุญุฏูุซ ุงูุนูุงูุฉ ุนูู ุงูุฎุฑูุทุฉ ููู ุนุงูู
    function updateWorkerMarker(location, workerId) {
    waitUntilMapReady()
        .then(() => {
            // ุงูุชุฃูุฏ ูู ุฃู ูุงุฆูุฉ ุงูุนูุงูุงุช ููุฌูุฏุฉ
            if (!window.workerMarkers) {
                window.workerMarkers = {};
            }
            try {
                // ุฅุถุงูุฉ ุฃู ุชุญุฏูุซ ุงูุนูุงูุฉ ุนูู ุงูุฎุฑูุทุฉ
                if (!window.workerMarkers[workerId]) {
                    window.workerMarkers[workerId] = new mapboxgl.Marker({ color: 'green' })
    .setLngLat([location.lng, location.lat])
    .addTo(map);

                    console.log(`โ๏ธ 17 ุชู ุฅุถุงูุฉ ุงูุนูุงูุฉ ููุนุงูู ${workerId}.`);
                } else {
                    window.workerMarkers[workerId].setLngLat([location.lng, location.lat]);
                    console.log(`โ๏ธ 15 ุชู ุชุญุฏูุซ ูููุน ุงูุนูุงูุฉ ููุนุงูู ${workerId}.`);
                }
            } catch (error) {
                console.error(`๐จ 16 ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุนูุงูุฉ ููุนุงูู ${workerId}:`, error);
            }
        })
        .catch((err) => {
            console.error("โ๏ธ 18 ูุง ูููู ุชุญุฏูุซ ุงูุนูุงูุฉ ูุฃู ุงูุฎุฑูุทุฉ ูู ุชุฌูุฒ ุจุนุฏ:", err);
        });
}









    // ุงูุชุญูู ูู ุชุญููู ููุชุจุฉ Mapbox
    if (typeof mapboxgl === 'undefined') {
        console.error("ูู ูุชู ุชุญููู ููุชุจุฉ Mapbox ุจูุฌุงุญ.");
    } else {
        console.log("ุชู ุชุญููู ููุชุจุฉ Mapbox ุจูุฌุงุญ:", mapboxgl);
    }

        // ููุชุงุญ Mapbox
        const mapboxToken = "pk.eyJ1IjoiY2hvb3NlbWUiLCJhIjoiY20wZnVpemI2MHpreTJqcjR4ZThuam9pYyJ9.F1CjHrnJ7m-VwM_LHt0Q9Q";
        mapboxgl.accessToken = mapboxToken;

        // ุฅุนุฏุงุฏ ุงูุฃููุงุท ุงููุฎุชููุฉ ููุฎุฑูุทุฉ
        const styles = {
    streets: 'mapbox://styles/mapbox/streets-v11',
    satellite: 'mapbox://styles/mapbox/satellite-v9',
    outdoors: 'mapbox://styles/mapbox/outdoors-v11',
    hybrid: 'mapbox://styles/mapbox/satellite-streets-v11',
    dark: 'mapbox://styles/mapbox/dark-v10',
    light: 'mapbox://styles/mapbox/light-v10'
};





        function initializeMap() {
    console.log("๐ 110 ุจุฏุก ุชููุฆุฉ ุงูุฎุฑูุทุฉ...");

    try {
        // ุงูุชุญูู ููุง ุฅุฐุง ูุงูุช ุงูุฎุฑูุทุฉ ูุฏ ุชู ุชููุฆุชูุง ุจุงููุนู ูููุน ุงูุชูุฑุงุฑุงุช
        if (typeof map !== 'undefined' && map instanceof mapboxgl.Map) {
            console.warn("โ๏ธ 117 ุงูุฎุฑูุทุฉ ูููุฃุฉ ุจุงููุนู. ูู ูุชู ุฅุนุงุฏุฉ ุฅูุดุงุฆูุง.");
            return;
        }

        // ุชูุฑูุบ ูุญุชูู ุงูุฎุฑูุทุฉ ูุจู ุฅุนุงุฏุฉ ุงูุชููุฆุฉ ูููุน ุงูุชูุฑุงุฑุงุช
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.innerHTML = '';
        } else {
            console.error("๐จ 118 ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุนูุตุฑ 'map'. ุชุฃูุฏ ูู ูุฌูุฏ ุงูุนูุตุฑ ูู DOM.");
            return;
        }

        // ุฅูุดุงุก ุงูุฎุฑูุทุฉ
// ุชููุฆุฉ ุงูุฎุฑูุทุฉ ูู "ุงููุถุงุก"
map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/satellite-streets-v11',
  center: [0, 0],  // ุจุฏุก ุงูุนุฑุถ ูู ูุฑูุฒ ุงูุฃุฑุถ
  zoom: 0.8,       // ุฑุคูุฉ ุงููุฑุฉ ุงูุฃุฑุถูุฉ ูู ุงููุถุงุก ุงูุจุนูุฏ
  projection: 'globe',
  maxBounds: [[-180, -85], [180, 85]], // ููุน ุงูุฎุฑูุฌ ูู ุงููุฑุฉ ุงูุฃุฑุถูุฉ
  interactive: true, // ุงูุณูุงุญ ุจุงูุชูุงุนู ุงูููุณู
  attributionControl: false // ุฅุฒุงูุฉ ุดุนุงุฑ Mapbox ูุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู
});

// ุชุญุณูู ุงูุฃุฏุงุก ุนูุฏ ุงูุชุญููู ูุฌุนู ุงูุฅุดุนุงุน ุฃุฎู
map.on('style.load', () => {
  map.setFog({
    range: [1, 8],  // ุชูููู ูุฏู ุงูุถุจุงุจ ุญุชู ูุธูุฑ ุงููุถุงุก ุจูุถูุญ
    color: 'rgba(10, 10, 25, 0.5)', // ุฌุนู ููู ุงูุบูุงู ุงูุฌูู ุฏุงูููุง ุฃูุซุฑ ููุธูุฑ ุงููุถุงุก
  });
});

// ุชูููุฐ ุชุฃุซูุฑ ุงูุชุญุฑู ุจุนุฏ ุชุญููู ุงูุฎุฑูุทุฉ ูุน ุชุฃุฎูุฑ ููุญุงูุงุฉ ุฑุคูุฉ ุงูุฃุฑุถ ูู ุงููุถุงุก
map.on('load', () => {
  waitUntilMapReady().then(() => {
    setTimeout(() => {
      map.flyTo({
        center: [13.1913, 32.8872], // ุงูุงูุชูุงู ุฅูู ุทุฑุงุจูุณ
        zoom: window.innerWidth < 768 ? 9 : 12, // ุชูุฑูุจ ุฃูู ุนูู ุงูููุงุชู
        pitch: window.innerWidth < 768 ? 30 : 60, // ุฒุงููุฉ ููู ุฃูู ุนูู ุงูุฃุฌูุฒุฉ ุงููุญูููุฉ
        bearing: 45, // ุฏูุฑุงู ูุทูู ุฃุซูุงุก ุงูุญุฑูุฉ
        speed: 0.3, // ุญุฑูุฉ ุจุทูุฆุฉ ููุญุงูุงุฉ ุงูุชููู ุงูุทุจูุนู
        curve: 2.2, // ููุญูู ุณูุณ ููุญุฑูุฉ
        easing: t => t * t // ุญุฑูุฉ ุชุฎููู ุชุฏุฑูุฌูุฉ
      });
    }, 2000); // ุชุฃุฎูุฑ ุงูุงูุชูุงู 2.5 ุซุงููุฉ ููุญุงูุงุฉ ุฑุคูุฉ ุงูุฃุฑุถ ูู ุงููุถุงุก
  });
});

// ุชุญุณูู ุชุฌุฑุจุฉ ุงูููุณ ุนูู ุงูุฃุฌูุฒุฉ ุงููุญูููุฉ
if (window.innerWidth < 768) {
  map.touchZoomRotate.enable(); // ุชูุนูู ุงูุชูุจูุฑ ูุงูุชุฏููุฑ ุจุงูููุณ
  map.doubleClickZoom.disable(); // ุชุนุทูู ุงูุชูุจูุฑ ุจุงูููุฑ ุงููุฒุฏูุฌ
}




// ุชุญุณูู ุงูุชุฃุซูุฑ ุงูุจุตุฑู ุนูุฏ ุชุญููู ุงูุฎุฑูุทุฉ
map.on('style.load', () => {
    map.setFog({}); // ุฅุถุงูุฉ ุชุฃุซูุฑ ุงูุถุจุงุจ ูุชุญุณูู ูุธูุฑ ุงููุฑุฉ ุงูุฃุฑุถูุฉ
});


        let retryCount = 0; // ุนุฏุฏ ุงููุญุงููุงุช
        const maxRetries = 3; // ุงูุญุฏ ุงูุฃูุตู ูุนุฏุฏ ุงููุญุงููุงุช

        function handleMapLoad() {
            console.log('32 ุชู ุชุญููู ุงูุฎุฑูุทุฉ ุจุงุณุชุฎุฏุงู handleMapLoad.');

            if (map.isStyleLoaded()) {
                isMapReady = true;
                console.log("๐ 3 ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ ูุงูููุท ูุญูู. ูููู ุงูุขู ุงูุชุนุงูู ูุน ุงูุทูุจุงุช ุฃู ุงูุนูุงูุงุช.");
                addMarkersToMap();
            } else if (retryCount < maxRetries) {
                console.warn(`โ๏ธ 4 ูุดู ุชุญููู ุงูููุท. ุฅุนุงุฏุฉ ุงููุญุงููุฉ (${retryCount + 1}/${maxRetries}) ุจุนุฏ 5 ุซูุงูู...`);
                retryCount++;
                setTimeout(handleMapLoad, 5000);
            } else {
                console.error("๐จ 23 ูุดู ุชุญููู ุงูููุท ุจุนุฏ ุงุณุชููุงุฏ ุงููุญุงููุงุช.");
                alert("โ๏ธ 24 ุญุฏุซุช ูุดููุฉ ุฃุซูุงุก ุชุญููู ุงูุฎุฑูุทุฉ. ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช ุฃู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ.");
            }
        }

        map.on('load', () => {
            console.log("โก109 ุชู ุงุณุชุฏุนุงุก map.on('load').");

            // ุงูุชุญูู ูู ุชุนุฑูู ุงููุชุบูุฑ isMapReady
            if (typeof isMapReady === 'undefined') {
                console.error("๐จ 76 ุงููุชุบูุฑ isMapReady ุบูุฑ ูููุฃ ุจุดูู ุตุญูุญ.");
                return;
            }

            if (map.isStyleLoaded()) {
                isMapReady = true;
                isMapInitialized = true;
                console.log("๐ 47 ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ ูุงูููุท ูุญูู.");
               
         // ููุง ูุถูู console.log ูุนุฑุถ ุงูููู ุงููุญุฏุซุฉ
        console.log("โ 158 isMapReady:", isMapReady, "isMapInitialized:", isMapInitialized);

                processSavedRequests();
            } else {
                console.warn("โ๏ธ 59 ุงูููุท ูู ูุชู ุชุญูููู ุจุงููุงูู. ุณูุชู ุฅุนุงุฏุฉ ุงููุญุงููุฉ.");
                handleMapLoad();
            }

            console.log("โ๏ธ 78 ุฌุงุฑู ุชูููุฐ ุงูุฎุทูุงุช ุงูุฃุฎูุฑุฉ ุจุนุฏ ุชุญููู ุงูุฎุฑูุทุฉ...");
        });

        map.on('error', (e) => {
            console.error("๐จ 112 ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุฎุฑูุทุฉ:", e);
        });

    } catch (error) {
        console.error("๐จ 113 ุฎุทุฃ ุฃุซูุงุก ุฅูุดุงุก ุงูุฎุฑูุทุฉ:", error);
    }
}







function ensureMapInitialized() {
    if (!isMapInitialized) {
        console.log("๐ 82 ุจุฏุก ุชููุฆุฉ ุงูุฎุฑูุทุฉ ูุฃูู ูุฑุฉ...");
        initializeMap();
        isMapInitialized = true;
    } else {
        console.log("โ 83 ุงูุฎุฑูุทุฉ ูููุฃุฉ ุจุงููุนู.");
    }
}



// ุชุนุฑูู ูุชุบูุฑุงุช ุงูุญุงูุฉ ุนุงูุฉู
let orderActive = false;  // ูุชู ุชูุนููู ุนูุฏ ูุจูู ุงูุทูุจ
let orderCanceled = false; // ูุชู ุชูุนููู ุนูุฏ ุฅูุบุงุก ุงูุทูุจ

document.addEventListener('DOMContentLoaded', () => {

    // ุงูุชุญูู ูู ุญุงูุฉ ุงูุทูุจ ุงููุฎุฒูุฉ ูู localStorage ูุงุณุชุฑุฌุงุนูุง
    const storedStatus = localStorage.getItem('orderStatus');
    const storedRequestId = localStorage.getItem('currentRequestId');
    if (storedStatus && storedRequestId && storedStatus === 'canceled_by_worker') {
        // ุถุจุท ุงูุญุงูุฉ ูุชุฌูุจ ุชุดุบูู ุงูุฏูุงู ุงูุฎุงุตุฉ ุจุงูุชุญุฏูุซ
        orderCanceled = true;
        orderActive = false;
        document.getElementById('cancelJobContainer').style.display = 'none';
        console.log("ุชู ุงุณุชุฑุฌุงุน ุญุงูุฉ ุงูุฅูุบุงุก ูู ุงูุชุฎุฒูู ุงููุญูู.");
    }
    
    console.log("โ๏ธ 120 ุชู ุชุญููู DOM ุจูุฌุงุญ. ุจุฏุก ุงูุชููุฆุฉ...");

    // ุงูุชุญูู ูู ุชุญููู Firebase ู Mapbox
    if (typeof firebase === 'undefined' || typeof mapboxgl === 'undefined') {
        console.error("๐จ 165 ูู ูุชู ุชุญููู Firebase ุฃู Mapbox. ูุฑุฌู ุงูุชุญูู ูู ุงูุฑูุงุจุท.");
        return;
    }
    
    // ุชููุฆุฉ ุงูุฎุฑูุทุฉ ุฅุฐุง ูู ุชูู ูููุฃุฉ ุจุงููุนู
    if (!isMapInitialized) {
        console.log("๐ 168 ุจุฏุก ุชููุฆุฉ ุงูุฎุฑูุทุฉ...");
        initializeMap();
        isMapInitialized = true;
    } else {
        console.log("โ 169 ุงูุฎุฑูุทุฉ ูููุฃุฉ ุจุงููุนู.");
    }

    // ุงูุชุฃูุฏ ูู ุชุญููู ุฌููุน ุงูุนูุงุตุฑ ูุจู ุฅุถุงูุฉ ุงูุฃุญุฏุงุซ
    const acceptJobButton = document.getElementById('acceptJobButton');
    const locateButton = document.getElementById('locateButton');
    const styleSelector = document.getElementById('styleSelector');
    const loginButton = document.getElementById('loginWorkerButton');

    if (!acceptJobButton || !locateButton || !styleSelector || !loginButton) {
        console.error("๐จ 170 ุจุนุถ ุงูุนูุงุตุฑ ุบูุฑ ููุฌูุฏุฉ ูู DOM. ุชุฃูุฏ ูู ุชุญููู ุงูุตูุญุฉ ุจุงููุงูู.");
        return;
    }

    styleSelector.addEventListener('change', function () {
        const selectedStyle = this.value;
        if (styles[selectedStyle]) {
            map.setStyle(styles[selectedStyle]);
            console.log(`โ๏ธ 171 ุชู ุชุบููุฑ ุงูููุท ุฅูู: ${selectedStyle}`);
        } else {
            console.error(`โ๏ธ 172 ุงูููุท "${selectedStyle}" ุบูุฑ ูุนุฑูู.`);
        }
    });

    loginButton.addEventListener('click', () => {
        const workerId = document.getElementById('workerLoginId').value;
        if (workerId) {
            console.log(`๐ต 173 ูุญุงููุฉ ุชุณุฌูู ุงูุฏุฎูู ููุนุงูู: ${workerId}`);
            loginWorker(workerId);
        } else {
            console.warn('โ๏ธ 174 ูุฑุฌู ุฅุฏุฎุงู ูุนุฑูู ุงูุนุงูู.');
            alert('โ๏ธ 175 ูุฑุฌู ุฅุฏุฎุงู ูุนุฑูู ุงูุนุงูู.');
        }
    });
});













if (!isMapInitialized) {
    console.log(" 146 ุชููุฆุฉ ุงูุฎุฑูุทุฉ ูุฃูู ูุฑุฉ.");
    initializeMap();
    isMapInitialized = true;
} else {
    console.log(" 147 ุงูุฎุฑูุทุฉ ูููุฃุฉ ุจุงููุนู.");
}



function handleOrderMarkerClick(orderData) {
    console.log("handleOrderMarkerClick: ุชู ุงูููุฑ ุนูู ุฃููููุฉ ุงูุทูุจ", orderData);
    
    // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุณุฌูุงู ููุฏุฎูู
    if (!currentWorkerId) {
        console.error("handleOrderMarkerClick: ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุงูุฏุฎูู");
        alert("ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู ูุนุฑุถ ุงููููุฒุงุช");
        // ูุชุญ ูุงูุฐุฉ ุชุณุฌูู ุงูุฏุฎูู ุชููุงุฆููุง
        document.getElementById('loginPopup').style.display = 'flex';
        return;
    }
    
    console.log("handleOrderMarkerClick: ุงููุณุชุฎุฏู ูุณุฌู ุงูุฏุฎูู ุจูุฌุงุญุ currentWorkerId =", currentWorkerId);
    
    // ุงุณุชุฏุนุงุก ุฏุงูุฉ ุนุฑุถ ุชูุงุตูู ุงูุทูุจ
    showJobDetails(orderData);
}

function addMarkersToMap() {
    const requestsRef = database.ref('workRequests');
    let initialLoadCompleted = false;
    
    // ุนูุฏ ุงูุชูุงุก ุชุญููู ุงูุจูุงูุงุช ุงูุฃูููุฉุ ูุชู ุชุนููู ุงูุนูู ุฅูู true
    requestsRef.once('value', () => {
         initialLoadCompleted = true;
    });
    
    requestsRef.on('child_added', (data) => {
        waitUntilMapReady()
            .then(() => {
                // ุงุณุชููุงู ุฅุถุงูุฉ ุงูุนูุงูุฉ ุนูู ุงูุฎุฑูุทุฉ
            })
            .catch((err) => {
                console.error("โ๏ธ 19: ุงูุฎุฑูุทุฉ ุบูุฑ ุฌุงูุฒุฉ ุฃู ุงูููุท ุบูุฑ ูุญูู. ุณูุชู ุชุฌุงูู ุฅุถุงูุฉ ุงูุนูุงูุฉ.", err);
                return;
            });
        
        const request = data.val();
        if (request && request.location && request.location.lng && request.location.lat) {
            try {
                // ุฅูุดุงุก ุงููุงุฑูุฑ ูุฅุถุงูุชู ุฅูู ุงูุฎุฑูุทุฉ
                const marker = new mapboxgl.Marker({ color: 'green' })
                    .setLngLat([request.location.lng, request.location.lat])
                    .addTo(map);
                
                // ุชุฎุฒูู ุงููุงุฑูุฑ ูู ูุงุฆู ุนุงู ูุชุณููู ุฅุฒุงูุชู ูุงุญูุงู
                if (!window.requestMarkers) {
                    window.requestMarkers = {};
                }
                window.requestMarkers[data.key] = marker;
                
                // ุฅุถุงูุฉ ูุณุชูุน ุงูููุฑ ุนูู ุงููุงุฑูุฑ ูุน ุงูุชุญูู ูู ุงูุชูุงุก ุงูุชุญููู ุงูุฃููู
                marker.getElement().addEventListener('click', () => {
                    // ุฅุฐุง ูู ููุชูู ุงูุชุญููู ุงูุฃูููุ ูุง ุชูู ุจุฃู ุฅุฌุฑุงุก
                    if (!initialLoadCompleted) return;
                    
                    currentRequestId = data.key;
                    firebase.database().ref('workRequests/' + data.key).once('value')
                        .then((snapshot) => {
                            const updatedRequest = snapshot.val();
                            console.log("๐ ุชู ุฌูุจ ุจูุงูุงุช ุงูุทูุจ ุงููุญุฏุซุฉ:", updatedRequest);
    
                            // ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุงูุฎุงุตุฉ ุจุงูุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู ูุนุฑุถ ุชูุงุตูู ุงูุทูุจ
                            handleOrderMarkerClick(updatedRequest);
                        })
                        .catch((error) => {
                            console.error("โ๏ธ ุฎุทุฃ ุฃุซูุงุก ุฌูุจ ุจูุงูุงุช ุงูุทูุจ:", error);
                            alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฌูุจ ุจูุงูุงุช ุงูุทูุจ.");
                        });
                });
    
                console.log(`ุชูุช ุฅุถุงูุฉ ุงูุทูุจ ${data.key} ุฅูู ุงูุฎุฑูุทุฉ.`);
            } catch (error) {
                console.error("๐จ ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุงูุนูุงูุฉ ุฅูู ุงูุฎุฑูุทุฉ:", error);
            }
        } else {
            console.warn("ุจูุงูุงุช ุงูุทูุจ ุบูุฑ ูุงููุฉ ุฃู ุงููููุน ุบูุฑ ุตุญูุญ:", data.key);
        }
    });
}




// NEW CODE: ูุณุชูุน ูุฅุฒุงูุฉ ุงููุงุฑูุฑ ุนูุฏ ุญุฐู ุงูุทูุจ ูู Firebase
database.ref('workRequests').on('child_removed', (snapshot) => {
    const removedRequestId = snapshot.key;
    console.log(`ุชู ุญุฐู ุงูุทูุจ ${removedRequestId} ูู Firebase.`);
    if (window.requestMarkers && window.requestMarkers[removedRequestId]) {
        window.requestMarkers[removedRequestId].remove();
        delete window.requestMarkers[removedRequestId];
        console.log(`ุชู ุฅุฒุงูุฉ ูุงุฑูุฑ ุงูุทูุจ ${removedRequestId} ูู ุงูุฎุฑูุทุฉ.`);
    } else {
        console.warn(`ูู ูุชู ุงูุนุซูุฑ ุนูู ูุงุฑูุฑ ุงูุทูุจ ${removedRequestId} ูุฅุฒุงูุชู.`);
    }
});


// ุฅุถุงูุฉ ูุณุชูุน ูุชุญุฏูุซุงุช ุนูุฏ ุงูุชูุงูุถ ูู Firebase
firebase.database().ref(`negotiations/${currentRequestId}`).on('value', (snapshot) => {
    const negotiationData = snapshot.val();
    if (negotiationData) {
        console.log("ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุชูุงูุถ:", negotiationData);
        // ูููู ุชุญุฏูุซ ูุงุฌูุฉ ุงูุนุงูู ูุซูุงู ุจุฅุธูุงุฑ ุฅุดุนุงุฑ ุฃู ุชุบููุฑ ุฒุฑ ุงูุชูุงูุถ
        updateNegotiationUI(negotiationData);
    }
});

function updateNegotiationUI(data) {
    // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุจูุงูุงุช ุงูุชูุงูุถ
    if (!data) {
         console.error("ุจูุงูุงุช ุงูุชูุงูุถ ุบูุฑ ููุฌูุฏุฉ.");
         return;
    }
    
    // ูุซุงู: ุฅุฐุง ุชุบูุฑุช ุงูุญุงูุฉ ุฅูู "counter"ุ ุนุฑุถ ุฑุณุงูุฉ ุชูุถูุญูุฉ
    if (data.status === 'counter') {
         alert("ููุฏ ูุงู ุงููุณุชุฎุฏู ุจุงูุชุฑุงุญ ุณุนุฑ ุฌุฏูุฏ.");
    }
    
    // ุชุญุฏูุซ ูุตู ุงูุทูุจ ุจุงุณุชุฎุฏุงู ุจูุงูุงุช ุงูุทูุจ ุงููุฎุฒูุฉ ุนุงููููุง
    const orderData = window.currentOrderData || {};
    const orderDescription = orderData.description ? orderData.description : "ุบูุฑ ูุชููุฑ";
    document.getElementById("orderDescriptionWorker").innerText = "ูุตู ุงูุทูุจ: " + orderDescription;
    
    // ุชุญุฏูุซ ุจุงูู ุงูุจูุงูุงุช (ุงูุณุนุฑ ูุงูุฑุณุงูุฉ)
    document.getElementById("counterFinalPrice").innerText = data.proposedPrice || "";
    document.getElementById("counterFinalMessage").innerText = data.message || "";
}



// ุฅุนุฏุงุฏ ุงูุชุญูู ูู ุงูุจุญุซ
const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    language: "ar",
    marker: true,
    mapboxgl: mapboxgl
});

if (typeof map === 'undefined') {
    console.error("ุงููุงุฆู map ุบูุฑ ูุนุฑูู. ุชุฃูุฏ ูู ุงุณุชุฏุนุงุก initializeMap ุฃููุงู.");
} else {
    map.addControl(geocoder);
}

// ุฅุนุฏุงุฏ ุงูุชุญูู ูู ุชุญุฏูุฏ ุงููููุน
const locateControl = new mapboxgl.GeolocateControl({
    positionOptions: {
        enableHighAccuracy: true
    },
    trackUserLocation: true,
    showUserHeading: true,
    fitBoundsOptions: {
        maxZoom: 18
    }
});

// ูุชุบูุฑ ููุชุญูู ูู ุฅุนุงุฏุฉ ุงูุชูุฑูุฒ
let autoCenterEnabled = false;

// ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุชุญุฏูุฏ ูููุนู" ููุนูู ุฅุนุงุฏุฉ ุงูุชูุฑูุฒ
const locateBtn = document.getElementById('locateButton');
if (!locateBtn) {
    console.error(" ๐ป 201 ุนูุตุฑ locateButton ุบูุฑ ููุฌูุฏ.");
} else {
    locateBtn.addEventListener('click', () => {
        autoCenterEnabled = true; // ุชูุนูู ุฅุนุงุฏุฉ ุงูุชูุฑูุฒ ุนูุฏ ุงูุถุบุท ุนูู ุงูุฒุฑ
        locateControl.trigger();
        console.log(" ๐ป 202 ุชู ุงูุถุบุท ุนูู ุฒุฑ ุชุญุฏูุฏ ูููุนู ูุชูุนูู ุฅุนุงุฏุฉ ุงูุชูุฑูุฒ.");
    });
}


// ุนูุฏ ุณุญุจ ุงูุฎุฑูุทุฉ ูุฏูููุงุ ูููู ุฅุนุงุฏุฉ ุงูุชูุฑูุฒ ุงูุชููุงุฆู
map.on('dragstart', () => {
    if (autoCenterEnabled) {
        console.log(" ๐ป203 ุชู ุชุนุทูู ุฅุนุงุฏุฉ ุงูุชูุฑูุฒ ุชููุงุฆููุง ุจุณุจุจ ุณุญุจ ุงูุฎุฑูุทุฉ ูุฏูููุง.");
    }
    autoCenterEnabled = false;
});

locateControl.on('geolocate', (e) => {
    console.log(" ๐ป ุชู ุชุญุฏูุฏ ุงููููุน: ", e.coords);
    if (autoCenterEnabled) {
        map.flyTo({
            center: [e.coords.longitude, e.coords.latitude],
            zoom: 18,
            speed: 0.8,       // ุชูููู ุงูุณุฑุนุฉ ููุนููุฉ ุฃูุถู
            curve: 1.5,       // ุชุนุฏูู ุงูุงูุญูุงุก ูุชุญุณูู ุงูุชูุงู ุงูุญุฑูุฉ
            easing: function(t) { return t; }  // ุฏุงูุฉ ุชุฎููู ุจุณูุทุฉ ูููู ุชุนุฏูููุง
        });
    } else {
        console.log(" ๐ป ุฅุนุงุฏุฉ ุงูุชูุฑูุฒ ูุนุทูุฉุ ุงููุณุชุฎุฏู ุชุญูู ูุฏูููุง ูู ูููุน ุงูุนุฑุถ.");
    }
});


// ุนูุฏ ุงูุญุตูู ุนูู ุงููููุน ูู locateControlุ ููุนูุฏ ุงูุชูุฑูุฒ ููุท ุฅุฐุง ูุงู autoCenterEnabled true
locateControl.on('geolocate', (e) => {
    console.log("ุชู ุชุญุฏูุฏ ุงููููุน: ", e.coords);
    if (autoCenterEnabled) {
        map.flyTo({
            center: [e.coords.longitude, e.coords.latitude],
            zoom: 18,
            speed: 0.8,
            curve: 1.5,
            easing: function(t) { return t; }
        });
    } else {
        console.log("ุฅุนุงุฏุฉ ุงูุชูุฑูุฒ ูุนุทูุฉุ ุงููุณุชุฎุฏู ุชุญูู ูุฏูููุง ูู ูููุน ุงูุนุฑุถ.");
    }
});


map.on('load', () => {
    console.log(" 28 ุชู ุชุญููู ุงูุฎุฑูุทุฉ ุจูุฌุงุญ.", { style: map.getStyle(), center: map.getCenter() });

    if (map && typeof map.isStyleLoaded === 'function' && map.isStyleLoaded()) {
        console.log("๐ 29 ูุดููุฉ isStyleLoaded ุชู ุญููุง ุจุงููุงูู! ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ ููุนูู.");
        map.flyTo({ center: [13.1913, 32.8872], zoom: 10, speed: 0.2 });
        if (isMapReady) {
            addMarkersToMap(); // ุงุณุชุฏุนุงุก ุฏุงูุฉ ุฅุถุงูุฉ ุงูุนูุงูุงุช ููุท ุฅุฐุง ูุงูุช ุงูุฎุฑูุทุฉ ุฌุงูุฒุฉ
        }
    } else {
        console.error("โ๏ธ 5 ุงูุฎุฑูุทุฉ ุบูุฑ ุฌุงูุฒุฉ ุฃู ุงูููุท ูู ูุชู ุชุญูููู.");
    }

    // ุฅุถุงูุฉ ุนูุงุตุฑ ุงูุชุญูู
    map.addControl(locateControl);
});

// NEW CODE: ูุณุชูุน ูุชุญุฏูุซ ุจูุงูุงุช ุงูุทูุจ ุนูุฏ ุญุฏูุซ ุชุบููุฑ
database.ref('workRequests').on('child_changed', (snapshot) => {
    const updatedData = snapshot.val();
    const requestKey = snapshot.key;
    console.log(`ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุทูุจ ${requestKey}:`, updatedData);
    // ูู ุญุงูุฉ ูุงู ุงููุณุชุฎุฏู ูููุฑ ุนูู ุงููุงุฑูุฑ ูุนุฑุถ ุงูุชูุงุตููุ ููููู ุชุญุฏูุซ ุงููุงูุฐุฉ ูุจุงุดุฑุฉ
    // ุฃู ุชุญุฏูุซ ูุชุบูุฑ global ูุญุชูุธ ุจุจูุงูุงุช ุงูุทูุจ
    // ูุซุงู: ุฅุฐุง ูุงู currentRequestId ูุณุงูู requestKeyุ ููููู ุฅุนุงุฏุฉ ุนุฑุถ ุงููุงูุฐุฉ:
    if (currentRequestId === requestKey) {
        showJobDetails(updatedData);
    }
});






// ุฅุถุงูุฉ ุงูุฃุฒุฑุงุฑ ููุชุจุฏูู ุจูู ุงูุฃููุงุท
document.getElementById('styleSelector').addEventListener('change', function () {
    const selectedStyle = this.value;
    if (styles[selectedStyle]) {
        if (map.isStyleLoaded()) {
            map.setStyle(styles[selectedStyle]);
            console.log(`โ๏ธ 11 ุชู ุชุบููุฑ ุงูููุท ุฅูู: ${selectedStyle}`);
        } else {
            console.warn(`โ๏ธ 12 ุงูููุท ุงูุญุงูู ูู ูุชู ุชุญูููู ุจุงููุงูู. ุงูุชุธุฑ ุญุชู ูุชู ุชุญูููู.`);
        }
    } else {
        console.error(`โ๏ธ 87 ุงูููุท "${selectedStyle}" ุบูุฑ ููุฌูุฏ.`);
    }
});



// ุฅุนุงุฏุฉ ุฅุถุงูุฉ ุทุจูุฉ ุงููุณุงุฑ ุจุนุฏ ุชุญููู ุงูููุท ุงูุฌุฏูุฏ
map.on('style.load', () => {
    if (window.currentRouteData) {
        if (!map.getSource('route')) {
            map.addLayer({
                id: 'route',
                type: 'line',
                source: {
                    type: 'geojson',
                    data: window.currentRouteData
                },
                layout: { 'line-join': 'round', 'line-cap': 'round' },
                paint: { 'line-color': '#3887be', 'line-width': 5 }
            });
            console.log("โ๏ธ ุชู ุฅุนุงุฏุฉ ุฅุถุงูุฉ ุทุจูุฉ ุงููุณุงุฑ ุจุนุฏ ุชุบููุฑ ุงูููุท.");
        }
    }
});


// ุชุนุฑูู ุงููุชุบูุฑุงุช ุงูุนุงูุฉ (ูุฌุจ ุฃู ุชูุญุฏุฏ ูู ููุงู ููุงุณุจ ูู ุงูููุฏุ ูุซู ุจุฏุงูุฉ ุงูููู)
// ุชุนุฑูู ุงููุชุบูุฑุงุช ุงูุนุงูุฉ
var currentRequestId = null;

// ูุณุชูุน ุงูุถุบุท ุนูู ุฒุฑ ูุจูู ุงูุทูุจ
const acceptJobButton = document.getElementById('acceptJobButton');

if (acceptJobButton) {
    acceptJobButton.addEventListener('click', async () => {
        // ุนุฑุถ ูุงูุฐุฉ ุงูุชุฃููุฏ ุงูุฃููู
        if (!confirm("ูู ุชุฑูุฏ ูุจูู ูุฐุง ุงูุทูุจุ")) {
            console.log("ุชู ุฅูุบุงุก ุนูููุฉ ูุจูู ุงูุทูุจ ุจูุงุกู ุนูู ุชุฃููุฏ ุงููุณุชุฎุฏู.");
            return;
        }

        console.log("ุจุฏุก ุนูููุฉ ูุจูู ุงูุทูุจ...");

        // ุงูุชุญูู ูู ุงููุชุบูุฑุงุช ุงูุฃุณุงุณูุฉ
        if (!currentRequestId) {
            console.error("ูุนุฑูู ุงูุทูุจ ุบูุฑ ูุชููุฑ. ูุฑุฌู ุงูุชุฃูุฏ ูู ูุฌูุฏ ุทูุจ ูุดุท.");
            return;
        }
        if (!currentWorkerId) {
            console.error("ูุนุฑูู ุงูุนุงูู ุบูุฑ ูุชููุฑ. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู.");
            alert("ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุจู ูุจูู ุงูุทูุจ.");
            return;
        }
        if (activeRequestExists) {
            console.log("ุชู ูุจูู ุทูุจ ุณุงุจู ุจุงููุนู. ูู ูุชู ูุจูู ุทูุจ ุฌุฏูุฏ.");
            alert("ููุฏ ููุช ุจูุจูู ุทูุจ ูุณุจูุงู. ูุง ูููู ูุจูู ุทูุจ ุฌุฏูุฏ.");
            return;
        }

        // ุชุนุทูู ุฒุฑ ุงููุจูู ูุชูุงุฏู ุงูุถุบุท ุงููุฒุฏูุฌ
        acceptJobButton.disabled = true;
        console.log("ุชู ุชุนุทูู ุฒุฑ ูุจูู ุงูุทูุจ ูุชูุงุฏู ุงูุถุบุท ุงููุฒุฏูุฌ.");

        try {
            // ุฌูุจ ุจูุงูุงุช ุงูุทูุจ ูุงูุชุญูู ูู ุญุงูุชู
            const snapshot = await firebase.database().ref('workRequests/' + currentRequestId).once('value');
            const request = snapshot.val();

            if (!request) {
                console.error("โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูุทูุจ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.");
                alert("โ ุงูุทูุจ ุบูุฑ ููุฌูุฏ.");
                acceptJobButton.disabled = false;
                return;
            }

            if (request.status !== 'pending') {
                alert("โ๏ธ ูุง ูููู ูุจูู ุงูุทูุจ ูุฃูู ูู ูุนุฏ ูู ุญุงูุฉ ุงูุชุธุงุฑ.");
                console.error("ุฑูุถ ูุจูู ุงูุทูุจ: ุงูุญุงูุฉ ุงูุญุงููุฉ " + request.status);
                acceptJobButton.disabled = false;
                return;
            }

            // ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ูู Firebase
            await firebase.database().ref('workRequests/' + currentRequestId).update({
                status: 'accepted',
                acceptedBy: currentWorkerId
            });

// ุจุนุฏ ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ูู Firebase ูุงุณุชูุงู ุงููุฌุงุญ
alert("โ ุชู ูุจูู ุงูุทูุจ ุจูุฌุงุญ.");
console.log(`๐ข ุชู ูุจูู ุงูุทูุจ ${currentRequestId} ุจูุงุณุทุฉ ุงูุนุงูู ${currentWorkerId}`);

activeRequestExists = true;

// ุฅุฎูุงุก ูุงูุฐุฉ ุชูุงุตูู ุงูุทูุจ ูุดุฑูุท ุงูุทูุจุงุช ูุนุงู
document.getElementById('jobDetailsPopup').style.display = 'none';
document.getElementById('ordersPanel').style.display = 'none';

// ูุชุงุจุนุฉ ุชูููุฐ ุงูุฏูุงู ุงูุฃุฎุฑู ูุซู ุนุฑุถ ุงููุณุงุฑ ูุชุญุฏูุซ ETA ูุบูุฑูุง...
if (currentWorkerLocation && jobLocation) {
    if (typeof showRoute === "function") {
        showRoute(currentWorkerLocation, jobLocation);
        console.log("๐ ุชู ุงุณุชุฏุนุงุก ุฏุงูุฉ showRoute ูุนุฑุถ ุงูุงุชุฌุงู ูุงููุณุงูุฉ ุนูู ุงูุฎุฑูุทุฉ.");
    } else {
        console.error("โ๏ธ ูุธููุฉ showRoute ุบูุฑ ูุนุฑูุฉ.");
    }
    startRealTimeETATracking(currentWorkerLocation, jobLocation);
} else {
    console.error("โ ุจูุงูุงุช ุงููููุน ููุนุงูู ุฃู ุงูุทูุจ ุบูุฑ ูุชููุฑุฉ.");
}


            // ุงูุชุญูู ูู ุงููุณุงูุฉ ูุชุญุฏูุซ ุฒุฑ ุงูุฅูุบุงุก
            const distance = getWorkerDistance();
            if (distance >= 0.5) {
                document.getElementById('cancelJobContainer').style.display = 'block';
                console.log("๐ ุชู ุฅุธูุงุฑ ุฒุฑ ุฅูุบุงุก ุงูุทูุจ ูุฃู ุงููุณุงูุฉ:", distance.toFixed(2), "ูู");
            } else {
                document.getElementById('cancelJobContainer').style.display = 'none';
                alert("โ๏ธ ุงูุทูุจ ูู ูููุบู ุฅุฐุง ุฃุตุจุญ ุงูุนุงูู ูุฑูุจูุง (ุฃูู ูู 500 ูุชุฑ) ูู ุงููููุน.");
                console.log("๐จ ุงูุนุงูู ูุฑูุจ ุฌุฏูุง ููุง ูููู ุฅูุบุงุก ุงูุทูุจ. ุงููุณุงูุฉ:", distance.toFixed(2), "ูู");
            }

            // ุจุฏุก ุงูุนุฏ ุงูุชูุงุฒูู ูุฅููุงุก ุงูุทูุจ ุฅุฐุง ูู ููููุฐ ุฎูุงู ูุฏุฉ ูุนููุฉ
            const countdownElement = document.getElementById('countdownTimer');
            if (countdownElement) {
                startCountdown(3 * 60 * 60 * 1000, countdownElement, () => {
                    cancelRequestDueToTimeout(currentRequestId);
                });
            } else {
                console.error("โ๏ธ ุนูุตุฑ 'countdownTimer' ุบูุฑ ููุฌูุฏ ูู ุงูุตูุญุฉ.");
            }

        } catch (error) {
            console.error("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ูุจูู ุงูุทูุจ:", error);
            alert("โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุจูู ุงูุทูุจ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.");
            acceptJobButton.disabled = false;
        }
    });
} else {
    console.error("๐จ ุงูุฒุฑ 'acceptJobButton' ุบูุฑ ููุฌูุฏ ูู DOM.");
}












// ุงูุชุฃูุฏ ูู ุฃู ุงูููุฏ ูุนูู ููุท ุฅุฐุง ุชู ุชุนุฑูู map
if (typeof map !== 'undefined' && map instanceof mapboxgl.Map) {
    map.on('load', () => {
        console.log("โก50 ุชู ุงุณุชุฏุนุงุก map.on('load').");
        checkMapStyleLoaded();
    });
} else {
    console.error("๐จ 51 ุงููุงุฆู map ุบูุฑ ูููุฃ ุฃู ุบูุฑ ูุนุฑูู.");
}


        // ุชุฃููุฏ ูุถุน ุงูุนูุงูุฉ
        document.getElementById('confirmYes').addEventListener('click', () => {
            const userLocation = map.getCenter();
            // ุฅุถุงูุฉ ุงูุนูุงูุฉ ูู ุงููููุน ุงูุญุงูู
            new mapboxgl.Marker({ color: 'green' })
    .setLngLat(userLocation)
    .addTo(map);

            // ุนุฑุถ ูุงูุฐุฉ ุฅุฏุฎุงู ุงูุงุณู ูุฑูู ุงููุงุชู
            document.getElementById('inputPopup').style.display = 'block';
            document.getElementById('confirmationPopup').style.display = 'none';
        });

        // ุฅูุบุงุก ูุถุน ุงูุนูุงูุฉ
        document.getElementById('confirmNo').addEventListener('click', () => {
            document.getElementById('confirmationPopup').style.display = 'none';
        });

        // ุฅุฑุณุงู ุงููุนูููุงุช ุงููุฏุฎูุฉ ุฅูู Firebase
        document.getElementById('submitInfo').addEventListener('click', () => {
            const name = document.getElementById('nameInput').value;
            const phone = document.getElementById('phoneInput').value;
            if (name && phone) {
                const markerData = {
                    name: name,
                    phone: phone,
                    location: {
                        lng: map.getCenter().lng,
                        lat: map.getCenter().lat
                    }
                };
                const markersRef = database.ref('markers');
                markersRef.push(markerData)
                    .then(() => {
                        alert('ุชู ุญูุธ ุงูุนูุงูุฉ ุจูุฌุงุญ.');
                        document.getElementById('inputPopup').style.display = 'none';
                        document.getElementById('nameInput').value = '';
                        document.getElementById('phoneInput').value = '';
                    })
                    .catch((error) => {
                        alert('ุญุฏุซ ุฎุทุฃ: ' + error.message);
                    });
            } else {
                alert('ูุฑุฌู ููุก ุฌููุน ุงูุญููู.');
            }
        });

        // ุฅูุบุงุก ูุงูุฐุฉ ุฅุฏุฎุงู ุงููุนูููุงุช
        document.getElementById('cancelInput').addEventListener('click', () => {
            document.getElementById('inputPopup').style.display = 'none';
        });


        // ุนุฑุถ ูุนูููุงุช ุนู ุงูุนูุงู
        document.getElementById('requestWater').addEventListener('click', () => {
            const workerInfo = document.getElementById('workerInfo');
            workerInfo.innerText = 'ุงูุนูุงู ุงููุชุงุญูู ููุง...';
            workerInfo.style.display = workerInfo.style.display === 'block' ? 'none' : 'block';
        });


        function cancelRequestDueToTimeout(requestId, workerId, workerName) {
    const requestRef = database.ref(`workRequests/${requestId}`);
    
    // ุชุญุฏูุซ ุงูุญุงูุฉ ูุน ุงูุงุญุชูุงุธ ุจุขุฎุฑ ุนุงูู ุฃูุบู ุงูุทูุจ
    requestRef.update({
        status: 'cancelled',
        canceledBy: workerId // ูุง ูุฒุงู ูุฐุง ุงูุญูู ูุญุชูุธ ุจุขุฎุฑ ุนุงูู ุฃูุบู ุงูุทูุจ
    })
    .then(() => {
        // ุชุณุฌูู ุงูุฅูุบุงุก ูู ุงูุณุฌู ุงูุชุงุฑูุฎู ููุทูุจุงุช
        const activityRef = database.ref(`workRequests/${requestId}/orderHistory`);
        activityRef.push({
            type: 'timeout',
            workerId: workerId,
            workerName: workerName,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        console.log(`๐ซ ุชู ุฅูุบุงุก ุงูุทูุจ ${requestId} ุจุณุจุจ ุงูุชูุงุก ููุช ุงููุตูู ูู ูุจู ${workerName} (${workerId}).`);
        alert("โณ ุงูุชูู ุงูููุช ุงููุณููุญ ูููุตููุ ุชู ุฅูุบุงุก ุงูุทูุจ.");

        // ุชุญุฏูุซ ุงูุญุงูุฉ ุงูุชุดุบูููุฉ
        orderCanceled = true;
        orderActive = false;
        clearInterval(window.etaIntervalId);
    })
    .catch((error) => {
        console.error(`โ ุฎุทุฃ ุฃุซูุงุก ุฅูุบุงุก ุงูุทูุจ ${requestId}:`, error);
    });
}









        



  </script>

</body>
</html>
