<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø­Ø³Ù†</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        #map { height: 100vh; width: 100%; }
        .controlButton {
            background-color: rgba(30, 144, 255, 0.8);
            border: none;
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 5px 0;
            transition: background-color 0.3s ease;
            width: 100%;
            font-size: 14px;
        }
        .controlButton:hover {
            background-color: rgba(30, 144, 255, 1);
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .iconButton {
            width: 40px;
            height: 40px;
            border: none;
            cursor: pointer;
            background: none;
            margin: 5px;
            z-index: 2;
        }
        .icon {
            font-size: 20px;
            color: #ff5722;
            transition: color 0.3s;
        }
        .icon:hover {
            color: #e64a19;
        }
        #locateButtonContainer {
            position: absolute;
            bottom: 20px; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
            right: 20px; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
            z-index: 2;
        }
        #locateButton {
            background-color: rgba(30, 144, 255, 0.8);
            border: none;
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 14px;
        }
        #locateButton:hover {
            background-color: rgba(30, 144, 255, 1);
        }
    </style>
</head>
<body>
    <h1 id="title" style="display: none;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø­Ø³Ù†</h1>
    <div id="map"></div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ -->
<div id="jobDetailsPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; border-radius:10px; padding:20px; z-index:3;">
    <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„</h2>
    <p id="jobDescription"></p>
    <p id="jobLocation"></p>
    <p id="jobDuration"></p>
    <p id="jobBudget"></p>
    <button id="acceptJobButton">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
    <button onclick="document.getElementById('jobDetailsPopup').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

    <div class="controls">
        <button id="toggleWeather" class="iconButton">
            <i class="fas fa-cloud-sun icon"></i>
        </button>
        <select id="styleSelector" class="controlButton">
            <option value="streets">Ø´ÙˆØ§Ø±Ø¹</option>
            <option value="satellite">Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©</option>
            <option value="outdoors">Ø®Ø§Ø±Ø¬ÙŠØ©</option>
            <option value="hybrid" selected>Ù‡Ø§ÙŠØ¨Ø±Ø¯</option>
            <option value="dark">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</option> <!-- Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ù‡Ù†Ø§ -->
        </select>
        <button id="requestWater" class="controlButton">Ø·Ù„Ø¨ Ù…Ø§Ø¡</button>
        <div id="weatherInfo"></div>
        <div id="workerInfo"></div>
    </div>

    <button id="readyToGoButton">Ù…Ø³ØªØ¹Ø¯ Ù„Ù„Ø§Ù†Ø·Ù„Ø§Ù‚</button>


    <div id="locateButtonContainer">
        <button id="locateButton">ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± -->
    <div id="confirmationPopup" style="display:none; position:fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 3;">
        <h2>ØªØ­Ø°ÙŠØ±</h2>
        <p>Ø³ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ ØªÙ‚Ù ÙÙŠÙ‡ Ø­Ø§Ù„ÙŠØ§. Ù‡Ù„ Ø£Ù†Øª Ù…ÙˆØ§ÙÙ‚ØŸ</p>
        <button id="confirmYes">Ù†Ø¹Ù…</button>
        <button id="confirmNo">Ù„Ø§</button>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
    <div id="inputPopup" style="display:none; position:fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 3;">
        <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h2>
        <label for="nameInput">Ø§Ø³Ù…:</label>
        <input type="text" id="nameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…">
        <label for="phoneInput">Ø±Ù‚Ù… Ù‡Ø§ØªÙ:</label>
        <input type="text" id="phoneInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <button id="submitInfo">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <button id="cancelInput">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ -->
<div id="requestPopup" style="display:none; position:fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 3;">
    <h2>Ø¥Ø¯Ø®Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
    <label for="workTypeInput">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„:</label>
    <select id="workTypeInput">
        <option value="Ø³Ø¨Ø§ÙƒØ©">Ø³Ø¨Ø§ÙƒØ©</option>
        <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
        <option value="Ù†Ù‚Ù„">Ù†Ù‚Ù„</option>
        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
    </select>
    <label for="budgetInput">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©:</label>
    <input type="text" id="budgetInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©">
    <label for="timeInput">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:</label>
    <input type="text" id="timeInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨">
    <button id="submitRequest">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    <button id="cancelRequest">Ø¥Ù„ØºØ§Ø¡</button>

    <!-- ØªØ®ØµÙŠØµ Ù…Ø¹Ø±Ù‘Ù Ù„Ø¹Ø§Ù…Ù„ -->
<div id="assignIdContainer" style="margin: 20px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0px 4px 6px rgba(0,0,0,0.1);">
    <h3>ØªØ®ØµÙŠØµ Ù…Ø¹Ø±Ù‘Ù Ù„Ø¹Ø§Ù…Ù„</h3>
    <input type="text" id="workerIdInput" placeholder="Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„" style="margin-bottom: 10px; width: 100%; padding: 8px;">
    <input type="text" id="workerNameInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„" style="margin-bottom: 10px; width: 100%; padding: 8px;">
    <button id="assignIdButton" style="padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù</button>

    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø±Ù‘Ù -->
    <div id="loginPopup" style="display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0px 4px 6px rgba(0,0,0,0.3); z-index: 10;">
        <h3>Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ù„Ø¨Ø¯Ø¡</h3>
        <input type="text" id="workerLoginId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„" style="margin-bottom: 10px; width: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        <button id="loginWorkerButton" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>

 
</div>


<!-- Ù…ÙƒØªØ¨Ø§Øª Firebase App Ùˆ Messaging -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://js.pusher.com/beams/1.0/push-notifications-cdn.js"></script>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Ù…ÙƒØªØ¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<script src="https://unpkg.com/@turf/turf"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />

<script>

    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase Ùˆ Pusher Beams
if (typeof firebase === 'undefined' || typeof PusherPushNotifications === 'undefined') {
    console.error('ğŸš¨ğŸ’­121  ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase ÙˆPusher Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§.');
} else {
    console.log('âœ…ğŸ’­ 122 ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
}

    document.addEventListener('DOMContentLoaded', function() {
           // ØªÙ‡ÙŠØ¦Ø© Firebase Auth
           const auth = firebase.auth();
        
        // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.getElementById('loginPopup').style.display = 'flex';

        document.getElementById('loginPopup').style.display = 'flex';

// ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Pusher Beams
if (typeof PusherPushNotifications === 'undefined') {
    console.error('ğŸš¨ğŸ’­ 123 Pusher Beams Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙÙŠ HTML.');
} else {
    console.log('âœ…ğŸ’­ 124 Pusher Beams ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­.');
}



// ØªÙ‡ÙŠØ¦Ø© Pusher Beams
document.addEventListener("DOMContentLoaded", () => {
    const beamsClient = new PusherPushNotifications.Client({
        instanceId: 'c9641070-f290-4aab-9239-18b096e3d8bc'
    });

    beamsClient.start()
        .then(() => beamsClient.addDeviceInterest('new-orders')) // Ø§Ù‡ØªÙ…Ø§Ù… Ø¹Ø§Ù… Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        .then(() => console.log('âœ…ğŸ’­ 125 Pusher Beams Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©'))
        .catch((err) => console.error('ğŸš¨ 127 Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', err));

    beamsClient.onNotificationOpened = (payload) => {
        alert(`Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…Ù† Pusher Beams: ${payload.notification.body}`);
    };
});

console.log("âœ…ğŸ’­ 126 Pusher Beams ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­.");




        // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Pusher Beams
        function sendPusherNotification(interest, message, title = "Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯") {
    fetch(`https://${pusherInstanceId}.pushnotifications.pusher.com/publish_api/v1/instances/${pusherInstanceId}/publishes`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${pusherAuthorization}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            interests: [interest],
            fcm: {
                notification: {
                    title: title,
                    body: message
                }
            }
        })
    })
    .then(response => response.json())
    .then(data => console.log("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­:", data))
    .catch(error => console.error("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", error));
}


         // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ inputPopup Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ù„ØºØ§Ø¡"
         document.getElementById('cancelInput').addEventListener('click', () => {
            document.getElementById('nameInput').value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù…
            document.getElementById('phoneInput').value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ
            document.getElementById('inputPopup').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
        });

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ requestPopup Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ù„ØºØ§Ø¡"
        document.getElementById('cancelRequest').addEventListener('click', () => {
            document.getElementById('workTypeInput').value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„
            document.getElementById('budgetInput').value = '';   // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©
            document.getElementById('timeInput').value = '';     // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„ÙˆÙ‚Øª
            document.getElementById('requestPopup').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
        });

// Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù‘Ù
function hideLoginPopup() {
    document.getElementById('loginPopup').style.display = 'none';
}






        });
    

        function showRoute(workerLocation, jobLocation) {
            const directionsRequest = `https://api.mapbox.com/directions/v5/mapbox/driving/${workerLocation.lng},${workerLocation.lat};${jobLocation.lng},${jobLocation.lat}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`;
        console.log(' 30 Ø·Ù„Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª:', directionsRequest);

    fetch(directionsRequest)
        .then(response => response.json())
        .then(data => {
            const route = data.routes[0].geometry;
            const routeLine = {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    geometry: route
                }
            };

            if (map.getSource('route')) {
    console.log(' 31 ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ¯Ø± route:', map.getSource('route'));
    map.getSource('route').setData(routeLine.data);
        }
          else {
                map.addLayer({
                    id: 'route',
                    type: 'line',
                    source: routeLine,
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#3887be', 'line-width': 5 }
                });
            }
        })
        .catch(console.error);
}



function updateWorkerLocation(workerId, newLocation) {
    const workerRef = database.ref(`workers/${workerId}/location`);
    
    workerRef.once('value').then((snapshot) => {
        const currentLocation = snapshot.val();
        
        if (!currentLocation || currentLocation.lat !== newLocation.lat || currentLocation.lng !== newLocation.lng) {
            workerRef.set(newLocation)
                .then(() => console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Firebase:", newLocation))
                .catch((error) => console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹:", error));
        } else {
            console.log("ğŸ”„ 88 Ù„Ù… ÙŠØªØºÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªØ­Ø¯ÙŠØ« Firebase.");
        }
    }).catch((error) => {
        console.error("âŒ 89 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Firebase:", error);
    });
}

function updateLocationWithGPS(workerId) {
    if (navigator.geolocation) {
        navigator.geolocation.watchPosition((position) => {
            const newLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
            };

            console.log("ğŸ“¡ 90 ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… GPS:", newLocation);
            updateWorkerLocation(workerId, newLocation);

        }, (error) => {
            console.error("ğŸš¨ 91 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", error);
        }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
    } else {
        console.error("ğŸš¨ 92 Ù…ÙŠØ²Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.");
    }
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
updateLocationWithGPS('worker_123'); // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ

let isMapReady = false; // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©.
console.log("âš™ï¸ 56 ØªÙ… ØªØ¹Ø±ÙŠÙ isMapReady ÙˆÙ‚ÙŠÙ…ØªÙ‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ:", isMapReady);

/**
 * Ø¯Ø§Ù„Ø© ØªØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….
 * @returns {boolean} Ù‡Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ØŸ
 */
let mapReadyLogged = false; // Ù…ØªØºÙŠØ± Ù„ØªØ¹Ù‚Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©

function isMapReadyToUse() {
    if (typeof map === 'undefined') {
        console.error("ğŸš¨ 60 [Ø®Ø·Ø£] Ø§Ù„ÙƒØ§Ø¦Ù† 'map' ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù Ø¨Ø¹Ø¯. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦ØªÙ‡.");
        initializeMap(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
        return false;
    }

    if (!(map instanceof mapboxgl.Map)) {
        console.error("ğŸš¨ 61 [Ø®Ø·Ø£] Ø§Ù„ÙƒØ§Ø¦Ù† 'map' Ù„ÙŠØ³ Ù…Ø«ÙŠÙ„Ø§Ù‹ Ù„Ù€ Mapbox. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦ØªÙ‡.");
        initializeMap(); // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        return false;
    }

    if (!map.isStyleLoaded()) {
        console.warn("âš ï¸ 62 [ØªØ­Ø°ÙŠØ±] Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯.");
        return false;
    }

 
    if (typeof isMapReady === 'undefined' || !isMapReady) {
        console.warn("âš ï¸ 63 [ØªØ­Ø°ÙŠØ±] Ø­Ø§Ù„Ø© isMapReady ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø© Ø£Ùˆ ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");
        return false;
    }

    if (!mapReadyLogged) {
        console.log("âœ… 114 [Ù†Ø¬Ø§Ø­] Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„! ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§.");
        mapReadyLogged = true; // Ù…Ù†Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    }


    return true;
}

let map; // ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„.
console.log("âš™ï¸ 57 ØªÙ… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± map ÙˆÙ‡Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹:", map);

let isMapInitialized = false; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.
console.log("âš™ï¸ 58 ØªÙ… ØªØ¹Ø±ÙŠÙ isMapInitialized ÙˆÙ‚ÙŠÙ…ØªÙ‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ:", isMapInitialized);


/**
 * Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
 * @returns {boolean} Ù‡Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
 */







// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Ø¨Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØµØ­ÙŠØ­Ø©
const firebaseConfig = {
    apiKey: "AIzaSyAQ2FQL0DvbPx4YnJrrAmal2o-yaH_KP_s",
    authDomain: "adlo-44d1b.firebaseapp.com",
    databaseURL: "https://adlo-44d1b-default-rtdb.firebaseio.com",
    projectId: "adlo-44d1b",
    storageBucket: "adlo-44d1b.firebasestorage.app",
    messagingSenderId: "96260637269",
    appId: "1:96260637269:web:e3bc37ab2b41038c254adc",
    measurementId: "G-R0SGBWC3CJ"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    console.log("âœ… 94 Firebase ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­.");
} else {
    console.warn("âš ï¸ 95 Firebase ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ù„Ù† ÙŠØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
}



// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Messaging Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙ‚Ø·
const messaging = firebase.messaging();

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase Ø£Ùˆ Pusher
function sendPusherNotification(workerId, message) {
    fetch('http://localhost:7000/send-notification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ workerId, message })
    })
    .then((response) => response.json())
    .then((data) => console.log('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­:', data))
    .catch((error) => console.error('ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', error));
}






    
    // Ù…Ø±Ø¬Ø¹ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø­ÙŠØ« Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„
    const database = firebase.database();
    const workersRef = database.ref('workers');

    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù‘ÙØ§Øª
function generateWorkerIds(batchSize) {
    for (let i = 0; i < batchSize; i++) {
        const workerId = `worker_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
        database.ref(`availableWorkerIds/${workerId}`).set({ used: false });
    }
    console.log(`${batchSize} Ù…Ø¹Ø±Ù‘ÙØ§Øª ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­.`);
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù‘ÙØ§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
generateWorkerIds(5000); // Ù…Ø«Ø§Ù„: Ø¥Ù†Ø´Ø§Ø¡ 5000 Ù…Ø¹Ø±Ù‘Ù



// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹
const workerId = "worker_123"; // Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø§Ù…Ù„ (ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ù…Ø¹Ø±Ù Ø­Ù‚ÙŠÙ‚ÙŠ)
const workerRef = database.ref(`workers/${workerId}`);

database.ref(`workers/${workerId}/reviews`).on('child_added', (snapshot) => {
    const review = snapshot.val();
    console.log(`ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}:`, review);
});





// Ù…Ø³ØªÙ…Ø¹ Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
const savedRequests = []; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§

function processSavedRequests() {
    try {
        console.log("âš¡ 37 Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...");

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
        if (typeof map === 'undefined' || !(map instanceof mapboxgl.Map)) {
    console.error("ğŸš¨ 115 Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ù‡ÙŠØ£ Ø£Ùˆ ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦ØªÙ‡.");
    initializeMap(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    return;
}

const mapReady = isMapReadyToUse();
if (!mapReady) {
    console.warn("âš ï¸ 36 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙŠØ³Øª Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©. Ø³ÙŠØªÙ… ØªØ£Ø¬ÙŠÙ„Ù‡Ø§.");
    return;
}



        console.log("âš¡ 79 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©. Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...");

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        while (savedRequests.length > 0) {
            const request = savedRequests.shift();

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
            if (!request || !request.requestData || !request.requestId) {
                console.error("ğŸš¨ 41 Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ø·Ù„Ø¨:", request);
                continue; // ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­
            }

            const { requestData, requestId } = request;
            console.log(`âš™ï¸ 42 Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸: ${requestId}`);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
            if (requestData.status === 'pending') {
                try {
                    console.log(`âŒ› 33 ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ø·Ù„Ø¨ ${requestId}.`);
                    startRequestTimeout(requestId, 10); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
                    showJobDetails(requestData); // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
                } catch (error) {
                    console.error(`ğŸš¨ 34 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}:`, error);
                }
            } else {
                console.warn(`âš ï¸ 35 Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù„ÙŠØ³ ÙÙŠ Ø­Ø§Ù„Ø© 'pending'.`);
            }
        }

        console.log("âœ… 74 ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­.");
    } catch (error) {
        console.error("ğŸš¨ 75 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:", error);
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©
function saveRequestForLater(requestData, requestId) {
    if (!requestData || !requestId) {
        console.error("ğŸš¨ 80 Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨:", { requestData, requestId });
        return;
    }
    console.log(`ğŸ“‹ 81 ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§:`, requestData);
    savedRequests.push({ requestData, requestId });
}



// ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
const requestRef = database.ref('workRequests');
requestRef.on('child_added', (snapshot) => {
    const requestData = snapshot.val();
    const requestId = snapshot.key;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (!requestData || !requestId) {
        console.error("ğŸš¨ 38 Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", { requestData, requestId });
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¹Ø±ÙŠÙ isMapReady
    if (typeof map === 'undefined' || !(map instanceof mapboxgl.Map)) {
        console.error("ğŸš¨ 77 Ø§Ù„Ù…ØªØºÙŠØ± isMapReady ØºÙŠØ± Ù…Ù‡ÙŠØ£. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø±ÙŠÙÙ‡ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
        return;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const mapReady = isMapReadyToUse();
if (!mapReady) {
    console.warn(`âš ï¸ 39 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙŠØ³Øª Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯. Ø³ÙŠØªÙ… ØªØ£Ø¬ÙŠÙ„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨ ${requestId}.`);
    saveRequestForLater(requestData, requestId); // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§
    return;
}


    console.log(`ğŸ‰ 40 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}.`);

    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ø­Ø§Ù„Ø© "pending"
    if (requestData.status === 'pending') {
        try {
            console.log(`âš™ï¸ 44 Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}.`);
            startRequestTimeout(requestId, 10); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
            showJobDetails(requestData); // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
        } catch (error) {
            console.error(`ğŸš¨ 72 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}:`, error);
        }
    } else {
        console.warn(`âš ï¸ 73 Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù„ÙŠØ³ ÙÙŠ Ø­Ø§Ù„Ø© 'pending'.`);
    }
});



// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©
function saveRequestForLater(requestData, requestId) {
    if (!requestData || !requestId) {
        console.error("ğŸš¨ 45 Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨:", { requestData, requestId });
        return;
    }
    console.log(`ğŸ“‹ 46 ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§:`, requestData);
    savedRequests.push({ requestData, requestId });
}

// Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·
let retryCount = 0; // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
const maxRetries = 3; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª

function checkMapStyleLoaded() {
    if (!map) {
        console.error("ğŸš¨ 82 Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ù‡ÙŠØ£. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦ØªÙ‡ Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ checkMapStyleLoaded.");
        return;
    }

    if (map.isStyleLoaded()) {
    isMapReady = true;
    console.log("ğŸ‰ 47 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©.");
    processSavedRequests(); // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
} else if (retryCount < maxRetries) {
    retryCount++;
    console.warn(`âš ï¸ 48 Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ù‚Ù… ${retryCount}: Ø§Ù„Ù†Ù…Ø· Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© (${retryCount}/${maxRetries}).`);
    setTimeout(() => {
        checkMapStyleLoaded(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
    }, 2000); // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ£Ø®ÙŠØ± Ø¥Ù„Ù‰ Ø«Ø§Ù†ÙŠØªÙŠÙ†
} else {
    console.error("ğŸš¨ 49 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§ØªØµØ§Ù„ Ø§Ù„Ø´Ø¨ÙƒØ©.");
    alert("âš ï¸ 86 Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·. Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
}

}













// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„


// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù‡Ù„Ø© Ø²Ù…Ù†ÙŠØ© Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
function startRequestTimeout(requestId, timeoutMinutes = 10) {
    const timeoutTime = Date.now() + timeoutMinutes * 60 * 1000; // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø¥Ù„Ù‰ Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
    const requestRef = database.ref(`workRequests/${requestId}`);

    const timeoutChecker = setInterval(() => {
        requestRef.once('value').then((snapshot) => {
            const requestData = snapshot.val();
            if (Date.now() > timeoutTime && requestData.status === 'pending') {
                // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø© ÙˆÙ…Ø§ Ø²Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹Ù„Ù‚Ù‹Ø§
                requestRef.update({ status: 'timeout' });
                clearInterval(timeoutChecker); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª
                console.log(`Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ù‚Ø¨ÙˆÙ„Ù‡.`);
            }
        });
    }, 10000); // ØªØ­Ù‚Ù‚ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†Ù
}


    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function addWorker(workerId, workerName, lng, lat) {
      workersRef.child(workerId).set({
        name: workerName,
        location: {
          lng: lng,
          lat: lat
        }
      });
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ®ØµÙŠØµ Ù…Ø¹Ø±Ù‘Ù Ù„Ø¹Ø§Ù…Ù„ Ù…Ø¹ÙŠÙ†
    function assignWorkerId(workerName, lng, lat) {
    database.ref('availableWorkerIds').orderByChild('used').equalTo(false).limitToFirst(1).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const workerId = Object.keys(snapshot.val())[0]; // Ø£ÙˆÙ„ Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…

                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø¥Ù„Ù‰ "Ù…Ø³ØªØ®Ø¯Ù…"
                database.ref(`availableWorkerIds/${workerId}`).update({ used: true });

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                database.ref(`workers/${workerId}`).set({
                    name: workerName,
                    assignedAt: new Date().toISOString(),
                    location: { lng: lng, lat: lat }
                });

                console.log(`ØªÙ… ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ${workerId} Ù„Ù„Ø¹Ø§Ù…Ù„: ${workerName}`);
            } else {
                console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù‘ÙØ§Øª Ù…ØªØ§Ø­Ø©.");
            }
        })
        .catch((error) => console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:", error));
}

// Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„
function loginWorker(workerId) {
    database.ref(`workers/${workerId}`).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const workerData = snapshot.val();
                console.log(`âœ… 96 ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${workerData.name}`);

                // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                document.getElementById('loginPopup').style.display = 'none';

                // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                focusOnWorkerLocation(workerId);
            } else {
                console.warn("âš ï¸ 97 Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                alert(" 100 Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± ØµØ§Ù„Ø­ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚.");
            }
        })
        .catch((error) => console.error("âŒ 98 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error));
}




    function sendNotificationToNearbyWorkers(requestData, userLocation) {
    const radius = 10;  // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª

    // Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ ÙÙŠ Firebase
    const workersRef = database.ref('workers');
    workersRef.once('value', (snapshot) => {
        snapshot.forEach((workerSnapshot) => {
            const worker = workerSnapshot.val();
            const distance = calculateDistance(userLocation, worker.location); // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©

            if (distance <= radius) {
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Pusher Beams
                if (distance <= radius) {
    sendPusherNotification(workerSnapshot.key, `Ø·Ù„Ø¨ ${requestData.workType} ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ.`, "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­!");
}

            }
        });
    });
}





if (!window.activeListeners) {
    window.activeListeners = {};
}

if (!window.activeListeners) {
    window.activeListeners = {}; // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒØ§Ø¦Ù† Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
}


function startTracking(workerId) {
    const workerRef = database.ref(`workers/${workerId}/location`);

    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¹Ø§Ù…Ù„ ØºÙŠØ± Ù…ÙƒØ±Ø±
    if (window.activeListeners[workerId]) {
        console.log(`âš ï¸ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId} Ù…Ø¶Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„.`);
        return;
    }

    workerRef.on('value', (snapshot) => {
        const location = snapshot.val();
        if (location && location.lat && location.lng) {
            console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId}:`, location);

// ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
const mapReady = isMapReadyToUse();
if (mapReady) {
    updateWorkerMarker(location, workerId);
} else {
    console.error("âš ï¸ 2 Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø© Ø£Ùˆ Ø§Ù„Ù†Ù…Ø· ØºÙŠØ± Ù…Ø­Ù…Ù„. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
}

} else {
    console.error(`ğŸš¨ 83 Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId} ØºÙŠØ± ØµØ­ÙŠØ­Ø©:`, location);
}
});


    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
    window.activeListeners[workerId] = true;
}






workerRef.child('currentRequest').on('value', (snapshot) => {
    const requestData = snapshot.val();
    if (requestData) {
        console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}:`, requestData);
    } else {
        console.warn(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId}. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.`);
    }
});


    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙƒÙ„ Ø¹Ø§Ù…Ù„
    function updateWorkerMarker(location, workerId) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (!window.workerMarkers) {
        window.workerMarkers = {};
    }

    // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù†Ù…Ø·
    const mapReady = isMapReadyToUse();
if (!mapReady) {
    console.error("âš ï¸ 18 Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø£Ùˆ Ø§Ù„Ù†Ù…Ø· ØºÙŠØ± Ù…Ø­Ù…Ù„. Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø©.");
    return;
}



    try {
        // Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        if (!window.workerMarkers[workerId]) {
            window.workerMarkers[workerId] = new mapboxgl.Marker()
                .setLngLat([location.lng, location.lat])
                .addTo(map);
            console.log(`âœ”ï¸ 17 ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}.`);
        } else {
            window.workerMarkers[workerId].setLngLat([location.lng, location.lat]);
            console.log(`âœ”ï¸ 15 ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}.`);
        }
    } catch (error) {
        console.error(`ğŸš¨ 16 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}:`, error);
    }
}




    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ startTracking Ù„ÙƒÙ„ Ø¹Ø§Ù…Ù„ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ«Ù‡
    workersRef.on('child_added', (snapshot) => {
    const workerId = snapshot.key; // Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø§Ù…Ù„
    startTracking(workerId);

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    const workerRef = database.ref(`workers/${workerId}`);
    workerRef.child('currentRequest').on('value', (snapshot) => {
        const requestData = snapshot.val();
        if (requestData) {
            console.log(` 84 ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}: ${requestData.status}`);
        } else {
            console.log(`85 Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§ Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}`);
        }
    });
});

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Mapbox
    if (typeof mapboxgl === 'undefined') {
        console.error("Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Mapbox Ø¨Ù†Ø¬Ø§Ø­.");
    } else {
        console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Mapbox Ø¨Ù†Ø¬Ø§Ø­:", mapboxgl);
    }

        // Ù…ÙØªØ§Ø­ Mapbox
        const mapboxToken = "pk.eyJ1IjoiY2hvb3NlbWUiLCJhIjoiY20wZnVpemI2MHpreTJqcjR4ZThuam9pYyJ9.F1CjHrnJ7m-VwM_LHt0Q9Q";
        mapboxgl.accessToken = mapboxToken;

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø©
        const styles = {
            streets: 'mapbox://styles/mapbox/streets-v11',
            satellite: 'mapbox://styles/mapbox/satellite-v9',
            outdoors: 'mapbox://styles/mapbox/outdoors-v11',
            hybrid: 'mapbox://styles/mapbox/satellite-streets-v11',
            dark: 'mapbox://styles/mapbox/dark-v10' // Ø¥Ø¶Ø§ÙØ© Ù†Ù…Ø· Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
        };




        function initializeMap() {
    console.log("ğŸ”„ 110 Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©...");

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¯ ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
        if (typeof map !== 'undefined' && map instanceof mapboxgl.Map) {
            console.warn("âš ï¸ 117 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„. Ù„Ù† ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§.");
            return;
        }

        // ØªÙØ±ÙŠØº Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.innerHTML = '';
        } else {
            console.error("ğŸš¨ 118 Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± 'map'. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ DOM.");
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        map = new mapboxgl.Map({
            container: 'map',
            style: styles.hybrid,
            center: [13.1913, 32.8872],
            zoom: 2
        });

        let retryCount = 0; // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
        const maxRetries = 3; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª

        function handleMapLoad() {
            console.log('32 ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… handleMapLoad.');

            if (map.isStyleLoaded()) {
                isMapReady = true;
                console.log("ğŸ‰ 3 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© ÙˆØ§Ù„Ù†Ù…Ø· Ù…Ø­Ù…Ù„. ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª.");
                addMarkersToMap();
            } else if (retryCount < maxRetries) {
                console.warn(`âš ï¸ 4 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© (${retryCount + 1}/${maxRetries}) Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù...`);
                retryCount++;
                setTimeout(handleMapLoad, 5000);
            } else {
                console.error("ğŸš¨ 23 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ†ÙØ§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª.");
                alert("âš ï¸ 24 Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
            }
        }

        map.on('load', () => {
            console.log("âš¡109 ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ map.on('load').");

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± isMapReady
            if (typeof isMapReady === 'undefined') {
                console.error("ğŸš¨ 76 Ø§Ù„Ù…ØªØºÙŠØ± isMapReady ØºÙŠØ± Ù…Ù‡ÙŠØ£ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
                return;
            }

            if (map.isStyleLoaded()) {
                isMapReady = true;
                isMapInitialized = true;
                console.log("ğŸ‰ 47 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© ÙˆØ§Ù„Ù†Ù…Ø· Ù…Ø­Ù…Ù„.");
                processSavedRequests();
            } else {
                console.warn("âš ï¸ 59 Ø§Ù„Ù†Ù…Ø· Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
                handleMapLoad();
            }

            console.log("âš™ï¸ 78 Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...");
        });

        map.on('error', (e) => {
            console.error("ğŸš¨ 112 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", e);
        });

    } catch (error) {
        console.error("ğŸš¨ 113 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", error);
    }
}







function ensureMapInitialized() {
    if (!isMapInitialized) {
        console.log("ğŸ”„ 82 Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©...");
        initializeMap();
        isMapInitialized = true;
    } else {
        console.log("âœ… 83 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
    }
}


document.addEventListener('DOMContentLoaded', () => {
    console.log("âœ”ï¸ 120 ØªÙ… ØªØ­Ù…ÙŠÙ„ DOM Ø¨Ù†Ø¬Ø§Ø­. Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...");

    // 1ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Mapbox
    if (typeof mapboxgl === 'undefined' || !mapboxgl.supported()) {
        console.error("ğŸš¨ 27 Ù…ÙƒØªØ¨Ø© Mapbox ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© Ø£Ùˆ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
        return;
    }
    console.log("âœ”ï¸ 26 Ù…ÙƒØªØ¨Ø© Mapbox Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….");

    // 2ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ `initializeMap()`
    if (!isMapInitialized) {
        console.log("ğŸ”„ 9 Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©...");
        initializeMap();
        isMapInitialized = true;
    } else {
        console.log("âœ… 104 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
    }

    // 3ï¸âƒ£ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø« Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
    const loginButton = document.getElementById('loginWorkerButton');
    if (loginButton) {
        if (!loginButton.dataset.listenerAdded) {
            loginButton.addEventListener('click', () => {
                const workerId = document.getElementById('workerLoginId').value;
                if (workerId) {
                    console.log(`ğŸ”µ99 Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¹Ø§Ù…Ù„: ${workerId}`);
                    loginWorker(workerId);
                } else {
                    console.warn('âš ï¸ 105 ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„.');
                    alert('âš ï¸ 106 ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„.');
                }
            });

            // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø£Ù† Ø§Ù„Ù…Ø³ØªÙ…Ø¹ ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡
            loginButton.dataset.listenerAdded = "true";
            console.log("âœ… 107 ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.");
        } else {
            console.warn("âš ï¸ 108 Ù…Ø³ØªÙ…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¶Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„. Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        }
    } else {
        console.error("ğŸš¨ 119 Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DOM.");
    }
});



    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø²Ø± Ù‡Ù†Ø§
    const acceptJobButton = document.getElementById('acceptJobButton');
    if (acceptJobButton) {
        acceptJobButton.addEventListener('click', () => {
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            if (!isMapReady) {
                console.error("âš ï¸ 52 Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù‚Ø¨Ù„ Ø£Ù† ØªØµØ¨Ø­ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©.");
                return;
            }

            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø¨ÙˆÙ„: Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
            alert(' 53 ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            document.getElementById(' 54 jobDetailsPopup').style.display = 'none';

            // Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø±: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ù‚ÙŠÙ… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
            const workerLocation = { lng: 13.1913, lat: 32.8872 }; // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„
            const jobLocation = { lng: 13.2, lat: 32.9 }; // Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„
            showRoute(workerLocation, jobLocation);
        });
    } else {
        console.error("ğŸš¨ 55 Ø§Ù„Ø²Ø± 'acceptJobButton' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DOM.");
    }
;






if (!isMapInitialized) {
    console.log("ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©.");
    initializeMap();
    isMapInitialized = true;
} else {
    console.log("Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
}





function addMarkersToMap() {
    const requestsRef = database.ref('workRequests');
    requestsRef.on('child_added', (data) => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
        const mapReady = isMapReadyToUse();
if (!mapReady) {
    console.error("âš ï¸ 19 Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø£Ùˆ Ø§Ù„Ù†Ù…Ø· ØºÙŠØ± Ù…Ø­Ù…Ù„. Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø©.");
    return;
}



        const request = data.val();
        if (request && request.location && request.location.lng && request.location.lat) {
            try {
                new mapboxgl.Marker()
                    .setLngLat([request.location.lng, request.location.lat])
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <h3>${request.workType}</h3>
                        <p>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${request.budget}</p>
                        <p>Ø§Ù„ÙˆÙ‚Øª: ${request.time}</p>
                    `))
                    .addTo(map);
                console.log(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ ${data.key} Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.`);
            } catch (error) {
                console.error("ğŸš¨ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", error);
            }
        } else {
            console.warn("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ­ÙŠØ­:", data.key);
        }
    });
}




// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨Ø­Ø«
const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    language: "ar",
    marker: true,
    mapboxgl: mapboxgl
});

if (typeof map === 'undefined') {
    console.error("Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ initializeMap Ø£ÙˆÙ„Ø§Ù‹.");
} else {
    map.addControl(geocoder);
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
const locateControl = new mapboxgl.GeolocateControl({
    positionOptions: {
        enableHighAccuracy: true
    },
    trackUserLocation: true,
    showUserHeading: true,
    fitBoundsOptions: {
        maxZoom: 15
    }
});

map.on('load', () => {
    console.log(" 28 ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ø¬Ø§Ø­.", { style: map.getStyle(), center: map.getCenter() });

    if (map && typeof map.isStyleLoaded === 'function' && map.isStyleLoaded()) {
        console.log("ğŸ‰ 29 Ù…Ø´ÙƒÙ„Ø© isStyleLoaded ØªÙ… Ø­Ù„Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„! Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ù…Ù„.");
        map.flyTo({ center: [13.1913, 32.8872], zoom: 10, speed: 0.2 });
        if (isMapReady) {
            addMarkersToMap(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©
        }
    } else {
        console.error("âš ï¸ 5 Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø£Ùˆ Ø§Ù„Ù†Ù…Ø· Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡.");
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
    map.addControl(locateControl);
});







        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù†Ù…Ø§Ø·
// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·
document.getElementById('styleSelector').addEventListener('change', function () {
    const selectedStyle = this.value;

    if (styles[selectedStyle]) {
        // ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ ØªØºÙŠÙŠØ±Ù‡
        if (map.isStyleLoaded()) {
            map.setStyle(styles[selectedStyle]);
            console.log(`âœ”ï¸ 11 ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø· Ø¥Ù„Ù‰: ${selectedStyle}`);
        } else {
            console.warn(`âš ï¸ 12 Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡.`);
        }
    } else {
        console.error(`âš ï¸ 87 Ø§Ù„Ù†Ù…Ø· "${selectedStyle}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.`);
    }
});


        // ØªÙØ¹ÙŠÙ„ Ø®Ø§ØµÙŠØ© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        document.getElementById('locateButton').addEventListener('click', () => {
            locateControl.trigger();
        });

        document.getElementById('assignIdButton').addEventListener('click', () => {
  const workerId = document.getElementById('workerIdInput').value;
  const workerName = document.getElementById('workerNameInput').value;
  const userLocation = map.getCenter();

  if (workerId && workerName) {
    fetch('/assign-id', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        workerId: workerId,
        workerName: workerName,
        location: { lng: userLocation.lng, lat: userLocation.lat },
      }),
    })
      .then((response) => {
        if (response.ok) {
          alert('ØªÙ… ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø¨Ù†Ø¬Ø§Ø­!');
        } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù.');
        }
      })
      .catch((error) => console.error('Error:', error));
  } else {
    alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
  }
});

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… ØªØ¹Ø±ÙŠÙ map
if (typeof map !== 'undefined' && map instanceof mapboxgl.Map) {
    map.on('load', () => {
        console.log("âš¡50 ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ map.on('load').");
        checkMapStyleLoaded();
    });
} else {
    console.error("ğŸš¨ 51 Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ù‡ÙŠØ£ Ø£Ùˆ ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù.");
}


        // ØªØ£ÙƒÙŠØ¯ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        document.getElementById('confirmYes').addEventListener('click', () => {
            const userLocation = map.getCenter();
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            new mapboxgl.Marker()
                .setLngLat(userLocation)
                .addTo(map);
            // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
            document.getElementById('inputPopup').style.display = 'block';
            document.getElementById('confirmationPopup').style.display = 'none';
        });

        // Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        document.getElementById('confirmNo').addEventListener('click', () => {
            document.getElementById('confirmationPopup').style.display = 'none';
        });

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ø¥Ù„Ù‰ Firebase
        document.getElementById('submitInfo').addEventListener('click', () => {
            const name = document.getElementById('nameInput').value;
            const phone = document.getElementById('phoneInput').value;
            if (name && phone) {
                const markerData = {
                    name: name,
                    phone: phone,
                    location: {
                        lng: map.getCenter().lng,
                        lat: map.getCenter().lat
                    }
                };
                const markersRef = database.ref('markers');
                markersRef.push(markerData)
                    .then(() => {
                        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­.');
                        document.getElementById('inputPopup').style.display = 'none';
                        document.getElementById('nameInput').value = '';
                        document.getElementById('phoneInput').value = '';
                    })
                    .catch((error) => {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
                    });
            } else {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
            }
        });

        // Ø¥Ù„ØºØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        document.getElementById('cancelInput').addEventListener('click', () => {
            document.getElementById('inputPopup').style.display = 'none';
        });


        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¹Ù…Ø§Ù„
        document.getElementById('requestWater').addEventListener('click', () => {
            const workerInfo = document.getElementById('workerInfo');
            workerInfo.innerText = 'Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† Ù‡Ù†Ø§...';
            workerInfo.style.display = workerInfo.style.display === 'block' ? 'none' : 'block';
        });

        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„
function showJobDetails(jobData) {
    document.getElementById('jobDescription').innerText = `ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„: ${jobData.workType}`;
    document.getElementById('jobLocation').innerText = `Ø§Ù„Ù…ÙˆÙ‚Ø¹: (${jobData.location.lat}, ${jobData.location.lng})`;
    document.getElementById('jobDuration').innerText = `Ø§Ù„Ù…Ø¯Ø©: ${jobData.time}`;
    document.getElementById('jobBudget').innerText = `Ø§Ù„Ù…Ø¨Ù„Øº: ${jobData.budget}`;
    document.getElementById('jobDetailsPopup').style.display = 'block';
}




        
    </script>

<!-- Ø²Ø± Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<button id="testNotification">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>

<script>
  // ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„ØµÙØ­Ø©
  document.getElementById('testNotification').addEventListener('click', () => {
      fetch('/send-notification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: 'Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø´Ø¹Ø§Ø±!' })
      })
      .then(res => res.json())
      .then(data => console.log('Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', data))
      .catch(err => console.error('ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', err));
  });
</script>


</body>
</html>
