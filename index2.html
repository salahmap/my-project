<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø­Ø³Ù†</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        #map { height: 100vh; width: 100%; }
        .controlButton {
            background-color: rgba(30, 144, 255, 0.8);
            border: none;
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 5px 0;
            transition: background-color 0.3s ease;
            width: 100%;
            font-size: 14px;
        }
        .controlButton:hover {
            background-color: rgb(49, 255, 30);
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .iconButton {
  width: 40px;
  height: 40px;
  border: none;
  cursor: pointer;
  background: none;
  margin: 5px;
  z-index: 2;
  border-radius: 50%; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø²Ø± Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ø±ÙŠ ÙˆØ±Ù‚ÙŠÙ‚ */
}

/* ØªÙ†Ø³ÙŠÙ‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ ØªØ£Ø«ÙŠØ± Ø§Ù†ØªÙ‚Ø§Ù„ÙŠ */
#ordersPanel {
  position: absolute;
  top: 60px;
  right: 10px;
  width: 300px;
  max-height: 70vh;
  background-color: rgba(255, 255, 255, 0.95);
  border: 1px solid #ccc;
  border-radius: 8px;
  overflow-y: auto;
  padding: 10px;
  display: none;
  z-index: 10;
  transition: transform 0.3s ease, opacity 0.3s ease;
  transform: translateX(100%);
  opacity: 0;
}

/* ğŸ”¥ Ø§Ù„ÙØ¦Ø© Ø§Ù„ØªÙŠ Ø³ØªÙØ¶Ø§Ù Ø¹Ù†Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù„ÙˆØ­Ø© */
#ordersPanel.show {
  display: block;
  transform: translateX(0);
  opacity: 1;
}


.orderItem {
  border-bottom: 1px solid #ddd;
  padding: 8px;
  margin-bottom: 5px;
}
.orderItem p {
  margin: 5px 0;
}
.orderItem button {
  background-color: #28a745;
  border: none;
  padding: 5px 10px;
  border-radius: 5px;
  color: white;
  cursor: pointer;
}

/* Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ÙˆØ³Ø§Ø¦Ø· CSS Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ØªØ¬Ø§ÙˆØ¨ */
@media (max-width: 600px) {
  #ordersPanel {
    width: 90%;
    right: 5%;
  }
}

        .icon {
            font-size: 20px;
            color: #ff5722;
            transition: color 0.3s;
        }
        .icon:hover {
            color: #e64a19;
        }
        #locateButtonContainer {
            position: absolute;
            bottom: 20px; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
            right: 20px; /* Ù…Ø³Ø§ÙØ© Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† */
            z-index: 2;
        }
        #locateButton {
            background-color: rgba(30, 144, 255, 0.8);
            border: none;
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 14px;
        }
        #locateButton:hover {
            background-color: rgb(49, 255, 30);
        }
        #etaPanel p {
    display: inline-block;
    margin: 0 10px;
    font-size: 16px;
}


#etaPanel,
#countdownPanel {
    display: none;
}


.mapboxgl-ctrl-geocoder {
  width: 200px !important;  
  height: 35px !important;  
  border-radius: 5px;        
  font-size: 14px;           
  display: flex;             
  align-items: center;       
  justify-content: center;   
  position: relative; /* ØªØ£ÙƒØ¯ Ù…Ù† Ø¶Ø¨Ø· Ø§Ù„Ù…ÙˆØ¶Ø¹ */
  z-index: 10; /* ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« ÙÙˆÙ‚ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø®Ø±Ù‰ */
}

/* Ø¬Ø¹Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ø­Ø« ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
.mapboxgl-ctrl-geocoder .suggestions {
  position: absolute !important;
  z-index: 9999 !important; /* Ø±ÙØ¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙˆÙ‚ Ø£ÙŠ Ø¹Ù†ØµØ± Ø¢Ø®Ø± */
  background-color: white; /* Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙˆØ¶ÙˆØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
  border: 1px solid #ccc;
  border-radius: 5px;
  box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}
.mapboxgl-ctrl-geocoder .mapboxgl-ctrl-geocoder--icon {
  display: none !important; /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª (X ÙˆØ§Ù„Ø¯Ø§Ø¦Ø±Ø©) */
}

.pulse-marker {
  width: 100px;
  height: 100px;
  background: transparent; /* Ø®Ù„ÙÙŠØ© Ø´ÙØ§ÙØ© */
  border: none;
  position: absolute;
  transform: translate(-50%, -50%);
}

.pulse-marker::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 100%;
  height: 100%;
  background: rgba(30,144,255,0.2);
  border: 2px solid rgba(30,144,255,0.5);
  border-radius: 50%;
  transform: translate(-50%, -50%) scale(1);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(1.5);
    opacity: 0;
  }
}

  /* Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù„Ù†Ø§ÙØ°Ø© Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„ÙƒÙˆÙƒÙŠØ² */
  #cookieConsentPopup {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #FFC107;
      color: #000;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      z-index: 10000;
      text-align: center;
  }
  #cookieConsentPopup button {
      margin-top: 10px;
      padding: 5px 10px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
  }

  /* ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø®Ø§Øµ Ø¨ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ */
.mapboxgl-user-location-heading {
    position: absolute;
    /* ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ù‚ÙŠÙ… top Ùˆ left Ù„Ø¬Ø¹Ù„ Ø§Ù„Ø³Ù‡Ù… Ø£Ù‚Ø±Ø¨ Ø£Ùˆ Ø£Ø¨Ø¹Ø¯ Ù…Ù† Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© */
    top: 100%; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙŠØ¬Ø¹Ù„ Ø§Ù„Ø³Ù‡Ù… Ø£Ù‚Ø±Ø¨ Ø¥Ù„Ù‰ Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© */
    left: 50%;
    /* ØªØ¹Ø¯ÙŠÙ„ transform Ù„Ø¶Ø¨Ø· Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© ÙˆØ§Ù„Ø­Ø¬Ù… */
    transform: translate(-50%, -50%) rotate(0deg) scale(1.2);
    /* scale(1.2) ÙŠØ²ÙŠØ¯ Ø­Ø¬Ù… Ø§Ù„Ø³Ù‡Ù… Ø¨Ù†Ø³Ø¨Ø© 20%ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚ÙŠÙ…Ø© Ø­Ø³Ø¨ Ø±ØºØ¨ØªÙƒ */
    
    /* ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ù‹Ø§ ØªØ­Ø¯ÙŠØ¯ Ø¹Ø±Ø¶ ÙˆØ§Ø±ØªÙØ§Ø¹ Ø«Ø§Ø¨ØªÙŠÙ† Ù„Ù„Ø³Ù‡Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù†ØµØ±Ù‹Ø§ Ù‚Ø§Ø¨Ù„Ù‹Ø§ Ù„Ø°Ù„Ùƒ */
    width: 20px;
    height: 20px;
}
    </style>
</head>
<body>

<!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© (Modal) Ø§Ù„Ø¹Ø§Ù…Ø© -->
<div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:9999;">
    <button id="prevBtn" style="position:absolute; left:20px; background:transparent; border:none; font-size:2em; color:#fff; cursor:pointer;">&#10094;</button>
    <img id="modalImage" src="" alt="Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©" style="max-width:90%; max-height:90%; border: 5px solid #fff; border-radius:5px;">
    <button id="nextBtn" style="position:absolute; right:20px; background:transparent; border:none; font-size:2em; color:#fff; cursor:pointer;">&#10095;</button>
</div>

<div id="cookieConsentPopup" style="display:none;">
    <p>ÙŠØ³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨ØªÙƒ. Ù‡Ù„ ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ØŸ</p>
    <button id="acceptCookie">Ù…ÙˆØ§ÙÙ‚</button>
  </div>

    <h1 id="title" style="display: none;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø­Ø³Ù†</h1>
    <div id="map"></div>

<!-- Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù…Ø¹ Ø­Ø¯ÙˆØ¯ ÙˆØ§Ø¶Ø­Ø© -->
<div id="jobDetailsPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
 background:white; border-radius:10px; padding:20px; z-index:1100; 
 border: 3px solid #000000; /* Ø­Ø¯ Ø£Ø²Ø±Ù‚ ÙˆØ§Ø¶Ø­ */
 box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2); /* Ø¸Ù„ Ø®ÙÙŠÙ Ù„Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ù†Ø§ÙØ°Ø© */">
    
    <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„</h2>

    <!-- Ø¹Ù†ØµØ± Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø£ØµØ¨Ø­ Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ -->
    <div id="jobImagesContainer" style="max-width: 100%; overflow-x: auto; white-space: nowrap; padding: 10px;">
        <img src="image1.jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„" style="width: 18%; height: auto; margin-right: 2%;">
        <img src="image2.jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„" style="width: 18%; height: auto; margin-right: 2%;">
        <img src="image3.jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„" style="width: 18%; height: auto; margin-right: 2%;">
        <img src="image4.jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„" style="width: 18%; height: auto; margin-right: 2%;">
        <img src="image5.jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„" style="width: 18%; height: auto; margin-right: 2%;">
    </div>
    
    
    <p id="jobDescription"></p>
    <p id="userPhone"></p>
<!-- Ø¹Ù†ØµØ± Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ -->
<p id="jobLocation">Ø§Ù„Ù…ÙˆÙ‚Ø¹: Ø´Ø¹Ø¨ÙŠØ© Ø§Ù„Ø¬ÙØ§Ø±Ø© Ù„ÙŠØ¨ÙŠØ§</p>
    <p id="jobDuration"></p>
    <p id="jobBudget"></p>
    <p id="jobDistance"></p>
    <p id="estimatedArrivalTime"></p>
    

    <!-- Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø© -->
    <div id="jobNotes" style="margin-top: 10px; padding: 10px; border-top: 1px solid #ccc; font-size: 14px; color: #555;">
        <p><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ø§Ù…Ø©:</strong></p>
        <p>- ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙˆØ§Ù„Ø±ÙØ¶ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
        <p>- Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨ Ø¥Ù„Ù‰ Ø£Ù‚Ù„ Ù…Ù† 500 Ù…ØªØ± Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨ØŒ Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨.</p>
        <p>- Ø¥Ø°Ø§ Ù„Ù… ÙŠØ±Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ© ØªØªØ¶Ù…Ù† Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø£Ùˆ Ø¥Ø¨Ù„Ø§Øº Ø§Ù„ÙØ±Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±.</p>
        <p>Ù†Ù„ØªØ²Ù… Ø¨Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø³ÙŠØ± Ø§Ù„Ø¹Ù…Ù„ Ø¨ÙƒÙØ§Ø¡Ø©.</p>
    </div>

    
    <!-- Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ø¹Ø±Ø¶ Ø®Ø±ÙŠØ·Ø© Ù…ØµØºØ±Ø© -->
    <div id="miniMap" style="width:100%; height:auto; margin-top:10px;"></div>

    <button id="acceptJobButton">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
    <button class="controlButton negotiateButton" 
        data-request-id="${currentRequestId}" 
        onclick="openNegotiationForm(this.dataset.requestId)">
    ØªÙØ§ÙˆØ¶
    </button>
    <button onclick="document.getElementById('jobDetailsPopup').style.display='none'">
    Ø¥ØºÙ„Ø§Ù‚
    </button>
    
</div>





<div id="negotiationPopup" style="display:none; position: fixed; top:50%; left:50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; z-index: 1100;">
    <h2>Ø¹Ø±Ø¶ ØªÙØ§ÙˆØ¶ÙŠ</h2>
    <label for="proposedPrice">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­:</label>
    <input type="number" id="proposedPrice" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø±">
    <label for="negotiationMessage">Ø±Ø³Ø§Ù„Ø© (Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©):</label>
    <textarea id="negotiationMessage" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø³Ø§Ù„ØªÙƒ"></textarea>
    <button onclick="submitNegotiation()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶</button>
    <button onclick="closeNegotiationForm()">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ø¹Ù…Ø§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
<div id="counterOfferDisplayPopup" style="display:none; position: fixed; top:50%; left:50%; transform: translate(-50%, -50%); background:white; padding:20px; border-radius:10px; z-index:1100;">
    <h2>Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯ Ø§Ù„Ø°ÙŠ Ù‚Ø¯Ù…Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
    <!-- Ø¹Ù†ØµØ± Ø¹Ø±Ø¶ ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨ -->
    <p id="orderDescriptionWorker">ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨: </p>
    <p>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: <span id="counterFinalPrice"></span></p>
    <p>Ø§Ù„Ø±Ø³Ø§Ù„Ø©: <span id="counterFinalMessage"></span></p>
    <button onclick="acceptCounterOffer()">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶</button>
    <button onclick="rejectCounterOffer()">Ø±ÙØ¶ Ø§Ù„Ø¹Ø±Ø¶</button>
</div>



  

<!-- Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† Ù…ÙˆØ¬ÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div id="cancelJobContainer" style="display:none; position: fixed; bottom: 20px; left: 20px; z-index: 1000;">
    <button id="cancelJobButton" class="controlButton" style="background-color: #d9534f;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨</button>
    
</div>



<div class="controls">
    <!-- Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Ø´Ø§Ø±Ø© Ø¥Ø´Ø¹Ø§Ø± -->
    <button id="toggleOrdersButton" class="controlButton">
      Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª <span id="ordersBadge"></span>
    </button>
    <button id="toggleWeather" class="iconButton">
      <i class="fas fa-cloud-sun icon"></i>
    </button>
    <select id="styleSelector" class="controlButton">
      <option value="streets">Ø´ÙˆØ§Ø±Ø¹</option>
      <option value="satellite">Ø§Ù„Ø£Ù‚Ù…Ø§Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©</option>
      <option value="outdoors">Ø®Ø§Ø±Ø¬ÙŠØ©</option>
      <option value="hybrid" selected>Ù‡Ø§ÙŠØ¨Ø±Ø¯</option>
      <option value="dark">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</option>
      <option value="light">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­</option>
    </select>
    <button id="requestWater" class="controlButton">Ø·Ù„Ø¨ Ù…Ø§Ø¡</button>
    <div id="weatherInfo"></div>
    <div id="workerInfo"></div>
  </div>
  
<!-- Ù„ÙˆØ­Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
<div id="ordersPanel" style="position: absolute; top: 10px; right: 10px; width: 300px; height: 400px; z-index: 1000; border: 1px solid #ccc; border-radius: 5px; background: #fff; overflow: hidden;">
    <!-- Ø±Ø£Ø³ Ø§Ù„Ù†Ø§ÙØ°Ø© -->
    <div class="ordersHeader" style="height: 60px; padding: 10px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; background: #fff;">
      <div>
        <input type="text" id="orderSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨..." style="width:60%; padding:5px; border:1px solid #ccc; border-radius:5px;" />
        <select id="orderSort" style="width:35%; padding:5px; border:1px solid #ccc; border-radius:5px;">
          <option value="timestamp">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
          <option value="distance">Ø§Ù„Ø£Ù‚Ø±Ø¨</option>
          <option value="status">Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</option>
        </select>
      </div>
      <span id="closeOrdersPanel" onclick="toggleOrdersPanel()" style="cursor:pointer; font-size: 20px; color: #d9534f;">
        <i class="fas fa-times"></i>
      </span>
    </div>
    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    <div id="ordersList" style="height: calc(100% - 60px); overflow-y: auto; padding: 10px;">
      <!-- Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
    </div>
  </div>
  


  
  
  
  




    <div id="locateButtonContainer">
        <button id="locateButton">ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    </div>

<!-- Ø­Ø§ÙˆÙŠØ© Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ETA ØªØ¨Ù‚Ù‰ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ -->
<div id="etaPanel" style="position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); background: white; padding: 10px; border-radius: 5px; z-index: 4;">
    <p id="etaDisplay"></p>
</div>

<!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ØªØ¸Ù‡Ø± ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø¨Ø­Ø¬Ù… Ø®Ø· Ø£ØµØºØ± -->
<div id="countdownPanel" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #fff; padding: 5px 8px; border-radius: 5px; z-index: 4; font-size: 12px;">
    <p id="countdownTimer"></p>
</div>

    
    

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ­Ø°ÙŠØ± -->
    <div id="confirmationPopup" style="display:none; position:fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 3;">
        <h2>ØªØ­Ø°ÙŠØ±</h2>
        <p>Ø³ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ ØªÙ‚Ù ÙÙŠÙ‡ Ø­Ø§Ù„ÙŠØ§. Ù‡Ù„ Ø£Ù†Øª Ù…ÙˆØ§ÙÙ‚ØŸ</p>
        <button id="confirmYes">Ù†Ø¹Ù…</button>
        <button id="confirmNo">Ù„Ø§</button>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
    <div id="inputPopup" style="display:none; position:fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 3;">
        <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</h2>
        <label for="nameInput">Ø§Ø³Ù…:</label>
        <input type="text" id="nameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…">
        <label for="phoneInput">Ø±Ù‚Ù… Ù‡Ø§ØªÙ:</label>
        <input type="text" id="phoneInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <button id="submitInfo">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <button id="cancelInput">Ø¥Ù„ØºØ§Ø¡</button>
    </div>



    <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø±Ù‘Ù -->
    <div id="loginPopup" style="display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0px 4px 6px rgba(0,0,0,0.3); z-index: 10;">
        <h3>Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ù„Ø¨Ø¯Ø¡</h3>
        <input type="text" id="workerLoginId" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„" style="margin-bottom: 10px; width: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
        <button id="loginWorkerButton" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ù…Ø§Ù„ -->
<div id="directRequestPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 10px; padding: 20px; z-index: 10;">
    <h2 id="directRequestTitle">Ø·Ù„Ø¨ Ù…Ø¨Ø§Ø´Ø±: Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
    <p id="directRequestMessage">Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†ØŸ</p>
    <button id="acceptDirectRequest">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
    <button id="rejectDirectRequest">Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</button>
</div>

<!-- Ù…Ù†Ø·Ù‚Ø© Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¹Ø§Ù…Ù„ -->
<div id="workerNotification" style="display:none; position:fixed; top:20px; right:20px; background:#FFC107; padding:10px 20px; border-radius:5px; z-index:1000; font-weight:bold;"></div>

<!-- Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ù†Ø¬Ø² -->
<div id="finishedOrderPopup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:yellow; padding:20px; border:2px solid #000; border-radius:10px; z-index:2000; text-align:center;">
    <p id="finishedOrderPhone" style="font-size:18px; margin-bottom:20px;"></p>
    <button onclick="callOrderPhone()" style="padding:10px 20px; font-size:16px; margin-right:10px; cursor:pointer;">Ø§ØªØµØ§Ù„</button>
    <button onclick="closeFinishedPopup()" style="padding:10px 20px; font-size:16px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
</div>




<!-- Ù…ÙƒØªØ¨Ø§Øª Firebase App Ùˆ Messaging -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://js.pusher.com/beams/1.0/push-notifications-cdn.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Ù…ÙƒØªØ¨Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
<!-- Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥ØµØ¯Ø§Ø± 5.1.6 Ù…Ù† Ù…ÙƒØªØ¨Ø© turf -->
<script src="https://unpkg.com/@turf/turf@5.1.6/turf.min.js"></script>
<!-- Ù…Ù„Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ -->
<script src="path/to/your-script.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>

<script>

    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase Ùˆ Pusher Beams
if (typeof firebase === 'undefined' || typeof PusherPushNotifications === 'undefined') {
    console.error('ğŸš¨ğŸ’­ 123  ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase ÙˆPusher Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§.');
} else {
    console.log('âœ…ğŸ’­ 124 ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.');
if (!firebase || !PusherPushNotifications) {
    console.error('ğŸš¨ 149 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Firebase Ø£Ùˆ Pusher Beams.');
}
}
    document.addEventListener('DOMContentLoaded', function() {
           // ØªÙ‡ÙŠØ¦Ø© Firebase Auth
           const auth = firebase.auth();
        
        // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    document.getElementById('loginPopup').style.display = 'flex';






// Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ù„ ÙˆÙ…ÙØ³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ù„Ù…Ø³ Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„ØµÙˆØ± Ø£ÙÙ‚ÙŠÙ‹Ø§
let touchStartX = 0;
let touchEndX = 0;
const swipeThreshold = 50; // Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠÙƒØ³Ù„Ø§Øª Ù„ØªØ­Ø¯ÙŠØ¯ Ø£Ù† Ø§Ù„Ø­Ø±ÙƒØ© Ø³Ø­Ø¨

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
const imagesContainer = document.getElementById('jobImagesContainer');
if (imagesContainer) {
  imagesContainer.addEventListener('touchstart', function(event) {
    touchStartX = event.changedTouches[0].screenX;
  }, false);

  imagesContainer.addEventListener('touchend', function(event) {
    touchEndX = event.changedTouches[0].screenX;
    handleGesture();
  }, false);
}

// Ø¯Ø§Ù„Ø© ØªØ­Ù„ÙŠÙ„ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø³Ø­Ø¨ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
function handleGesture() {
  if (touchEndX < touchStartX - swipeThreshold) {
    // Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø±: Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
    openNextImage();
  }
  if (touchEndX > touchStartX + swipeThreshold) {
    // Ø³Ø­Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ†: Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    openPrevImage();
  }
}

// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„: ØªÙ‚ÙˆÙ… Ø¨Ù…Ø­Ø§ÙƒØ§Ø© Ù†Ù‚Ø± Ø²Ø± Ø§Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø±Ø¶ (Modal)
function openNextImage() {
  document.getElementById('nextBtn').click();
}

function openPrevImage() {
  document.getElementById('prevBtn').click();
}







// ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Pusher Beams
if (typeof PusherPushNotifications === 'undefined') {
    console.error('ğŸš¨ğŸ’­ 137 Pusher Beams Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¶Ù…ÙŠÙ† Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙÙŠ HTML.');
} else {
    console.log('âœ…ğŸ’­ 141 Pusher Beams ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­.');
}

function initBeams() {
    console.log("ğŸš€ 142 DOMContentLoaded ØªÙ… ØªÙ†ÙÙŠØ°Ù‡ Ø¨Ù†Ø¬Ø§Ø­.");
    
    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Beams Client
    const beamsClient = new PusherPushNotifications.Client({
    instanceId: '2a17d881-b1a6-4a38-8cd4-de1ab8212f67',
  });
    
    console.log("ğŸ“ 140 Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Beams.");
    
    navigator.serviceWorker.register('http://localhost:20000/service-worker.js')
        .then((registration) => {
            console.log("ğŸ“ 143 ØªÙ… ØªØ³Ø¬ÙŠÙ„ Service Worker Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Beams:", registration);
            return beamsClient.start({ serviceWorkerRegistration: registration });
        })
        .then(() => {
            console.log('ğŸ› ï¸ 136 ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ start() Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠØªÙ… Ø§Ù„Ø¢Ù† ØªÙ†ÙÙŠØ° addDeviceInterest.');
            beamsClient.addDeviceInterest('debug-new-orderss')
  .then(() => console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ debug-new-orderss'))
  .catch(err => console.error('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø²:', err));
        })
        .then(() => {
            console.log('âœ…ğŸ’­ 125 Pusher Beams Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
        })
        .catch((err) => {
            console.error('ğŸš¨ 127 Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:', err);
            alert(`âš ï¸ 150 Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Service Worker: ${err.message}`);
console.error('ğŸš¨ 151 ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:', err);
        });
    
    beamsClient.onNotificationOpened = (payload) => {
        alert(`Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…Ù† Pusher Beams: ${payload.notification.body}`);
    };
}

// ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ†ÙÙŠØ° Ø§Ù„ÙƒÙˆØ¯ Ø³ÙˆØ§Ø¡ Ø­Ø¯Ø« DOMContentLoaded Ø£Ù… Ù„Ø§
if (document.readyState === 'loading') {
    document.addEventListener("DOMContentLoaded", initBeams);
} else {
    initBeams();
}

console.log("âœ…ğŸ’­ 126 Pusher Beams ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­.");

if (typeof PusherPushNotifications === 'undefined') {
    console.error('ğŸš¨ 134 Ù…ÙƒØªØ¨Ø© Pusher Beams ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¶Ù…ÙŠÙ†Ù‡Ø§ ÙÙŠ Ø§Ù„ØµÙØ­Ø©.');
} else {
    console.log('âœ… 135 Ù…ÙƒØªØ¨Ø© Pusher Beams ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­.');
}

// ØªØ³Ø¬ÙŠÙ„ Service Worker Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø°Ù„Ùƒ Ù…Ø·Ù„ÙˆØ¨Ù‹Ø§ Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ø±Ø©)
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
    .then(registration => {
        console.log('âœ…ğŸ˜˜ğŸ’• 128 Service Worker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­:', registration.scope);
    })
    .catch(error => {
        console.error('ğŸš¨ 129 ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:', error);
    });
} else {
    console.warn('âš ï¸ 130 Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Service Worker.');
}


// ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
const pusherInstanceId = 'c9641070-f290-4aab-9239-18b096e3d8bc';
const pusherAuthorization = 'CORRECT_PUSHER_BEAMS_SECRET'; // Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØµØ­ÙŠØ­

// ØªØ¹Ø±ÙŠÙ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Pusher Beams
function sendPusherNotification(interest, message, title = "Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯") {
    console.log("ğŸ”¹ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰:", interest, "Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", message); // Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    
    fetch(`https://${pusherInstanceId}.pushnotifications.pusher.com/publish_api/v1/instances/${pusherInstanceId}/publishes`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${pusherAuthorization}`,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            interests: [interest],
            fcm: {
                notification: {
                    title: title,
                    body: message
                }
            }
        })
    })
    .then(response => {
        if (!response.ok) {
            console.warn(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± Ù†Ø§Ø¬Ø­Ø© - Ø§Ù„ÙƒÙˆØ¯: ${response.status}`);
            return {};
        }
        return response.json();
    })
    .then(data => console.log("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­:", data))
    .catch(error => console.error("âš ï¸ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", error));
}

// ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØªØ§Ø­Ø© Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ `window`
window.sendPusherNotification = sendPusherNotification;













         // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ inputPopup Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ù„ØºØ§Ø¡"
         document.getElementById('cancelInput').addEventListener('click', () => {
            document.getElementById('nameInput').value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù…
            document.getElementById('phoneInput').value = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ù‚Ù„ Ø§Ù„Ù‡Ø§ØªÙ
            document.getElementById('inputPopup').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
        });



// Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù‘Ù
function hideLoginPopup() {
    document.getElementById('loginPopup').style.display = 'none';
}
});
    



// Ø¯Ø§Ù„Ø© Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© turf Ù…Ø¹ Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø± (5000 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)
function ensureTurf(callback, timeout = 5000) {
    const startTime = Date.now();
    function check() {
        if (typeof turf !== "undefined") {
            console.log("âœ… Ù…ÙƒØªØ¨Ø© turf Ù…ØªÙˆÙØ±Ø©.");
            callback();
        } else {
            const elapsed = Date.now() - startTime;
            if (elapsed > timeout) {
                console.error("âŒ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© turf Ø¨Ø¹Ø¯ " + timeout + " Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©.");
            } else {
                console.warn("â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© turf... (ØªÙ… Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± " + elapsed + " Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)");
                setTimeout(check, 100);
            }
        }
    }
    check();
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„
function updateRouteLayer(route) {
    console.log("ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...");
    window.currentRouteData = {
        type: 'Feature',
        geometry: route
    };
    if (map.getSource('route')) {
        console.log("â„¹ï¸ ØªØ­Ø¯ÙŠØ« Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ.");
        map.getSource('route').setData(window.currentRouteData);
    } else {
        console.log("â„¹ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ø¨Ù‚Ø© Ù…Ø³Ø§Ø± Ø¬Ø¯ÙŠØ¯Ø©.");
        map.addLayer({
            id: 'route',
            type: 'line',
            source: {
                type: 'geojson',
                data: window.currentRouteData
            },
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': '#3887be', 'line-width': 5 }
        });
    }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªÙØ¹Ø±Ø¶ Ø¹Ù†Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø±
function getRouteCompletionMessage(remainingDistanceKm) {
    if (remainingDistanceKm > 1) {
        return "Ø§Ù‚ØªØ±Ø¨ Ø£ÙƒØ«Ø±ØŒ ÙˆØ³ÙŠÙƒØªÙ…Ù„ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨.";
    } else if (remainingDistanceKm > 0.5) {
        return "Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø§Ù„ÙˆØµÙˆÙ„Ø› ØªØ§Ø¨Ø¹ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø·Ø±ÙŠÙ‚.";
    } else {
        return "ØªØ§Ø¨Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…ØŒ ÙØ§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø³ÙŠÙÙƒÙ…Ù„ Ø§Ù„Ø·Ø±ÙŠÙ‚.";
    }
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø´Ø±ÙˆØ· ØªØ¹Ø¯ÙŠÙ„ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙˆØªØ³Ø¬ÙŠÙ„ ÙƒØ§ÙØ© Ø§Ù„Ø®Ø·ÙˆØ§Øª
function showRoute(workerLocation, jobLocation) {
    console.log("ğŸš€ Ø¨Ø¯Ø¡ Ø¯Ø§Ù„Ø© showRoute...");
    const directionsRequest = `https://api.mapbox.com/directions/v5/mapbox/driving/${workerLocation.lng},${workerLocation.lat};${jobLocation.lng},${jobLocation.lat}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`;
    console.log("ğŸ”— Ø±Ø§Ø¨Ø· Ø·Ù„Ø¨ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª:", directionsRequest);

    fetch(directionsRequest)
        .then(response => {
            console.log("ğŸ“¥ ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† API.");
            return response.json();
        })
        .then(data => {
            if (!data.routes || !data.routes[0]) {
                console.error("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù…Ù† API.");
                return;
            }
            const route = data.routes[0].geometry;
            console.log("âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø± ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§:", route);

            const distanceKM = calculateDistance(workerLocation, jobLocation);
            const distance = distanceKM * 1000;
            console.log(`ğŸ“ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©: ${distance.toFixed(2)} Ù…ØªØ± (${distanceKM.toFixed(2)} ÙƒÙ…)`);

            let offset = 0;
            if (distance > 900) {
                offset = 800;
                console.log("â„¹ï¸ Ø§Ù„Ù…Ø³Ø§ÙØ© > 900 Ù…ØªØ±ØŒ Ø³ÙŠØªÙ… Ù‚Øµ Ø§Ù„Ù…Ø³Ø§Ø± Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ 800 Ù…ØªØ±.");
            } else if (distance > 500) {
                offset = 400;
                console.log("â„¹ï¸ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† 500 Ùˆ900 Ù…ØªØ±ØŒ Ø³ÙŠØªÙ… Ù‚Øµ Ø§Ù„Ù…Ø³Ø§Ø± Ù„ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ 400 Ù…ØªØ±.");
            } else {
                offset = 0;
                console.log("â„¹ï¸ Ø§Ù„Ù…Ø³Ø§ÙØ© â‰¤ 500 Ù…ØªØ±ØŒ Ø³ÙŠØªÙ… Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
            }
            
            if (offset > 0) {
                console.log("ğŸ” Ø³ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© turf Ù…Ø¹ offset =", offset);
                ensureTurf(function() {
                    try {
                        const routeLine = turf.lineString(route.coordinates);
                        const totalLength = turf.length(routeLine, { units: 'kilometers' });
                        const stopDistance = totalLength - (offset / 1000);
                        const clampedStopDistance = stopDistance > 0 ? stopDistance : 0;
                        const newEndPoint = turf.along(routeLine, clampedStopDistance, { units: 'kilometers' });
                        const slicedRoute = turf.lineSlice(route.coordinates[0], newEndPoint, routeLine);
                        console.log("âœ… Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø³Ø§Ø±:", newEndPoint.geometry.coordinates);
                        updateRouteLayer(slicedRoute.geometry);
                        console.log("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹ Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø³Ø§Ø±.");

                        // Ø¥Ù†Ø´Ø§Ø¡ Popup Ø«Ø§Ø¨Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø±
                        const message = getRouteCompletionMessage(clampedStopDistance);
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Popup Ø³Ø§Ø¨Ù‚ Ù‚Ù… Ø¨Ø¥Ø²Ø§Ù„ØªÙ‡ Ø£ÙˆÙ„Ø§Ù‹
                        if (window.routeTextPopup) {
                            window.routeTextPopup.remove();
                        }
                        window.routeTextPopup = new mapboxgl.Popup({
                                closeButton: false,
                                closeOnClick: false,
                                offset: 25
                            })
                            .setLngLat(newEndPoint.geometry.coordinates)
                            .setHTML(`<div style="font-size:14px; color:#ff5722; font-weight:bold;">${message}</div>`)
                            .addTo(map);
                    } catch (error) {
                        console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø³Ø§Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… turf:", error);
                    }
                });
            } else {
                console.log("â„¹ï¸ Ù„Ø§ ÙŠÙ„Ø²Ù… ØªØ¹Ø¯ÙŠÙ„ Ù†Ù‚Ø·Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©ØŒ Ø³ÙŠØªÙ… Ø±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø± ÙƒÙ…Ø§ Ù‡Ùˆ.");
                updateRouteLayer(route);
                // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Popup Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                if (window.routeTextPopup) {
                    window.routeTextPopup.remove();
                    window.routeTextPopup = null;
                }
            }
        })
        .catch(error => {
            console.error("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ø£Ùˆ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        });
}






// Ø¯Ø§Ù„Ø© Ø±ÙØ¶ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯: ØªÙ‚ÙˆÙ… Ø¨Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
function rejectCounterOffer() {
    document.getElementById("counterOfferDisplayPopup").style.display = "none";
}

// Ø¯Ø§Ù„Ø© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯: ØªÙ‚ÙˆÙ… Ø¨Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù†Ø§ÙØ°Ø© "ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„"
function acceptCounterOffer() {
    // Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø²Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„
    var acceptButton = document.getElementById("acceptJobButton");
    if (acceptButton) {
        acceptButton.click();  // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
    } else {
        alert("Ø²Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
    }
    // Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶ØŒ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯
    document.getElementById("counterOfferDisplayPopup").style.display = "none";
}


function updateWorkerLocation(workerId, newLocation) {
    const workerLocationRef = database.ref(`workers/${workerId}/location`);
    
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ø§Ù…Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… workerRef
    database.ref(`workers/${workerId}`).once('value').then((snapshot) => {
        const workerData = snapshot.val();
        const currentLocation = workerData && workerData.location;
        
        if (!currentLocation || currentLocation.lat !== newLocation.lat || currentLocation.lng !== newLocation.lng) {
            workerLocationRef.set(newLocation)
            .then(() => console.log("âœ… 148 ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Firebase:", newLocation))
            .catch((error) => console.error("âŒ 153 Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Firebase:", error));
        } else {
            console.log("ğŸ”„ 88 Ù„Ù… ÙŠØªØºÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ØªØ­Ø¯ÙŠØ« Firebase.");
        }
    }).catch((error) => {
        console.error("âŒ 89 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Firebase:", error);
    });
}


// [Ø§Ù„Ø³Ø·Ø± 180] ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… GPS Ù„ØªØ­Ø³ÙŠÙ† Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©






let isMapReady = false; // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©.
console.log("âš™ï¸ 56 ØªÙ… ØªØ¹Ø±ÙŠÙ isMapReady ÙˆÙ‚ÙŠÙ…ØªÙ‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ:", isMapReady);

/**
 * Ø¯Ø§Ù„Ø© ØªØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….
 * @returns {boolean} Ù‡Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ØŸ
 */
let mapReadyLogged = false; // Ù…ØªØºÙŠØ± Ù„ØªØ¹Ù‚Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©

function isMapReadyToUse() {
    if (typeof map === 'undefined') {
        console.error("ğŸš¨ 60 [Ø®Ø·Ø£] Ø§Ù„ÙƒØ§Ø¦Ù† 'map' ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù Ø¨Ø¹Ø¯. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦ØªÙ‡.");
        initializeMap(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
        return false;
    }

    if (!(map instanceof mapboxgl.Map)) {
        console.error("ğŸš¨ 61 [Ø®Ø·Ø£] Ø§Ù„ÙƒØ§Ø¦Ù† 'map' Ù„ÙŠØ³ Ù…Ø«ÙŠÙ„Ø§Ù‹ Ù„Ù€ Mapbox. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦ØªÙ‡.");
        initializeMap(); // Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        return false;
    }

    if (!map.isStyleLoaded()) {
        console.warn("âš ï¸ 62 [ØªØ­Ø°ÙŠØ±] Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯.");
        return false;
    }

 
    if (typeof isMapReady === 'undefined' || !isMapReady) {
        console.warn("âš ï¸ 63 [ØªØ­Ø°ÙŠØ±] Ø­Ø§Ù„Ø© isMapReady ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø© Ø£Ùˆ ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");
        return false;
    }

    if (!mapReadyLogged) {
        console.log("âœ… 114 [Ù†Ø¬Ø§Ø­] Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„! ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø§.");
        mapReadyLogged = true; // Ù…Ù†Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    }


    return true;
}


// Ø¯Ø§Ù„Ø© ØªÙ†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ù†Ù…Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
function waitUntilMapReady() {
    return new Promise((resolve, reject) => {
        if (map && map.isStyleLoaded()) {
            console.log("â„¹ï¸: 176 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
            resolve();
        } else {
            // Ø§Ù†ØªØ¸Ø§Ø± Ø­Ø¯Ø« ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· (ÙŠØ¹Ù…Ù„ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
            map.once('style.load', () => {
                console.log("â„¹ï¸: 177 ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· â€“ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ø§Ù„Ø¢Ù†.");
                resolve();
            });
            // ØªØ¹ÙŠÙŠÙ† Ù…Ù‡Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø± (Ù…Ø«Ù„Ø§Ù‹ 15 Ø«Ø§Ù†ÙŠØ©)
            setTimeout(() => {
                if (!map.isStyleLoaded()) {
                    console.error("ğŸš¨:178  Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·.");
                    reject(new Error(" 179 Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·."));
                }
            }, 15000);
        }
    });
}


let map; // ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„.
console.log("âš™ï¸ 57 ØªÙ… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± map ÙˆÙ‡Ùˆ Ø­Ø§Ù„ÙŠØ§Ù‹:", map);

let isMapInitialized = false; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.
console.log("âš™ï¸ 58 ØªÙ… ØªØ¹Ø±ÙŠÙ isMapInitialized ÙˆÙ‚ÙŠÙ…ØªÙ‡ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‡ÙŠ:", isMapInitialized);


/**
 * Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©
 * @returns {boolean} Ù‡Ù„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
 */







// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Ø¨Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØµØ­ÙŠØ­Ø©
const firebaseConfig = {
    apiKey: "AIzaSyAQ2FQL0DvbPx4YnJrrAmal2o-yaH_KP_s",
    authDomain: "adlo-44d1b.firebaseapp.com",
    databaseURL: "https://adlo-44d1b-default-rtdb.firebaseio.com",
    projectId: "adlo-44d1b",
    storageBucket: "adlo-44d1b.firebasestorage.app",
    messagingSenderId: "96260637269",
    appId: "1:96260637269:web:e3bc37ab2b41038c254adc",
    measurementId: "G-R0SGBWC3CJ"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    console.log("âœ… 94 Firebase ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ø¨Ù†Ø¬Ø§Ø­.");
} else {
    console.warn("âš ï¸ 95 Firebase ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ù„Ù† ÙŠØªÙ… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
}



function focusOnWorkerLocation(workerId) {
  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ…Ø±ÙŠØ± Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„ 547
  if (!workerId) {
    console.error("ğŸš¨ 190 Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„.");
    return;
  }
  console.log(`ğŸ” 191 Ø¨Ø¯Ø¡ ØªÙ†ÙÙŠØ° focusOnWorkerLocation Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}`);

  // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Firebase
  database.ref(`workers/${workerId}/location`).once('value')
    .then((snapshot) => {
      const location = snapshot.val();
      console.log("ğŸ“¡ 193 ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase:", location);

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØµØ­ØªÙ‡Ø§
      if (location && location.lat && location.lng) {
        console.log(`ğŸ“ 194 Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„: ${location.lng}, ${location.lat}`);

        // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªÙƒÙˆÙ† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
        waitUntilMapReady().then(() => {
  console.log(`ğŸ—ºï¸ Ø³ÙŠØªÙ… ØªØ±ÙƒÙŠØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId}`);
  map.flyTo({
    center: [location.lng, location.lat],
    zoom: 15,
    speed: 0.8,       // ØªØ¨Ø§Ø·Ø¤ Ø§Ù„Ø­Ø±ÙƒØ© Ù„Ù†Ø¹ÙˆÙ…Ø© Ø£ÙØ¶Ù„
    curve: 1.8,       // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ù†Ø­Ù†Ø§Ø¡ Ù„Ù…Ù†Ø­Ù†Ù‰ Ø£ÙƒØ«Ø± Ø³Ù„Ø§Ø³Ø©
    easing: function(t) { return t; }  // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„ØªØ£Ø«ÙŠØ± ØªØ®ÙÙŠÙ Ù…Ø®ØªÙ„Ù
  });
}).catch(err => {
  console.error("ğŸš¨ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", err);
});

      } else {
        console.error(`ğŸš¨ 199 Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId} ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.`);
      }
    })
    .catch((error) => {
      console.error(`ğŸš¨ 200 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId}:`, error);
    });
}





// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù…ÙˆÙ‚Ø¹ÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØµÙŠØºØ© Haversine (ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ø³Ø·Ø± 265)
function calculateDistance(loc1, loc2) {
    if (!loc1 || !loc2) {
        console.error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©");
        return 0;
    }
    const lat1 = parseFloat(loc1.lat);
    const lng1 = parseFloat(loc1.lng);
    const lat2 = parseFloat(loc2.lat);
    const lng2 = parseFloat(loc2.lng);
    const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙŠÙ„ÙˆÙ…ØªØ±Ø§Øª
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    const distance = R * c;
    console.log(`Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹ÙŠÙ†: ${distance.toFixed(2)} ÙƒÙ…`);
    return distance;
}






// âœ… Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¥Ø°Ø§ Ø§Ù‚ØªØ±Ø¨ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„
function checkAndUpdateOrderStatus() {
    console.log("ğŸ“¢ 215 Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ checkAndUpdateOrderStatus() âœ…");

    if (!currentRequestId) {
        console.warn("âš ï¸ 218 Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù†Ø´Ø· Ø­Ø§Ù„ÙŠÙ‹Ø§ Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡.");
        return;
    }
    
    firebase.database().ref(`workRequests/${currentRequestId}`).on("value", snapshot => {
        const order = snapshot.val();
        if (!order || !order.location) {
            console.error("ğŸš¨ 213 Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
            return;
        }

        if (order.status === "accepted") {
            if (!window.currentWorkerLocation) {
                console.error("ğŸš¨ 214 Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ØºÙŠØ± Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯ØŒ Ù„Ù† ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨.");
                return;
            }
            
            const distance = calculateDistance(window.currentWorkerLocation, order.location);
            console.log(`ğŸ“¡ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨: ${distance.toFixed(2)} ÙƒÙ…`);

            if (distance <= 0.5 && order.status !== "finished") {
                firebase.database().ref(`workRequests/${currentRequestId}`).update({
                    status: 'finished',
                    completedAt: Date.now()
                }).then(() => {
                    console.log("âœ… 216 ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ finished Ù„Ø£Ù† Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù‚ØªØ±Ø¨ Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„.");
                    if (order.phone) {
                        showFinishedOrderPopup(order.phone);
                    }
                    // Ø¬Ø¯ÙˆÙ„Ø© Ø¥Ø²Ø§Ù„Ø© Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙˆØ§Ù„ETA ÙˆØ¥Ø²Ø§Ù„Ø© Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø¹Ø¯ 30 Ø¯Ù‚ÙŠÙ‚Ø©
                    console.log("â„¹ï¸ Ø¨Ø¯Ø¡ Ø¬Ø¯ÙˆÙ„Ø© Ø¥Ø²Ø§Ù„Ø© Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙˆØ§Ù„ETA ÙˆØ¥Ø²Ø§Ù„Ø© Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø¹Ø¯ 30 Ø¯Ù‚ÙŠÙ‚Ø©.");
                    setTimeout(() => {
                        try {
                            const countdownPanel = document.getElementById('countdownPanel');
                            if (countdownPanel) {
                                countdownPanel.style.display = 'none';
                                console.log("âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ.");
                            } else {
                                console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ.");
                            }
                            const etaPanel = document.getElementById('etaPanel');
                            if (etaPanel) {
                                etaPanel.style.display = 'none';
                                console.log("âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© ETA.");
                            } else {
                                console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© ETA.");
                            }
                            if (map && map.getLayer('route')) {
                                map.removeLayer('route');
                                map.removeSource('route');
                                console.log("âœ… ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
                            } else {
                                console.warn("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± ÙÙŠ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
                            }
                        } catch (e) {
                            console.error("ğŸš¨ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„Ø© Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±:", e);
                        }
                    }, 1800000); // 1800000 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© = 30 Ø¯Ù‚ÙŠÙ‚Ø©
                }).catch(error => console.error("ğŸš¨ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:", error));
            }
        }
    });
}

checkAndUpdateOrderStatus();


function showFinishedOrderPopup(phone) {
    document.getElementById('finishedOrderPhone').innerText = "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: " + phone;
    document.getElementById('finishedOrderPopup').style.display = 'block';
}

function closeFinishedPopup() {
    document.getElementById('finishedOrderPopup').style.display = 'none';
}

function callOrderPhone() {
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ¥Ø¬Ø±Ø§Ø¡ Ù…ÙƒØ§Ù„Ù…Ø© (Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… tel:)
    var phoneText = document.getElementById('finishedOrderPhone').innerText;
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ù‚Ù… (Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†)
    var phone = phoneText.split(":")[1].trim();
    // ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‡Ø§ØªÙ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹)
    window.location.href = "tel:" + phone;
}


// Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© getWorkerDistance Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆÙ…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨
function getWorkerDistance() {
    // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª currentWorkerLocation Ùˆ jobLocation Ù…Ø¹Ø±Ù‘ÙØ© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
    if (typeof currentWorkerLocation === 'undefined' || typeof jobLocation === 'undefined') {
        console.error("Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©");
        return 0;
    }
    return calculateDistance(currentWorkerLocation, jobLocation);
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ù„ØºØ§Ø¡
function showCancelConfirmation(callback) {
    const confirmation = confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ØŸ");
    if (confirmation) {
        callback(); // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¥Ø°Ø§ ÙˆØ§ÙÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    } else {
        console.log("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
    }
}



function calculateETA(workerLocation, jobLocation, callback) {
    const directionsRequest = `https://api.mapbox.com/directions/v5/mapbox/driving/${workerLocation.lng},${workerLocation.lat};${jobLocation.lng},${jobLocation.lat}?steps=true&geometries=geojson&access_token=${mapboxgl.accessToken}`;
    fetch(directionsRequest)
        .then(response => response.json())
        .then(data => {
            if (!data.routes || !data.routes[0]) {
                console.error("Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø±ÙŠÙ‚ Ù…Ù† API");
                return;
            }
            const durationInSeconds = data.routes[0].duration;
            const distanceInMeters = data.routes[0].distance;
            console.log("ØªÙ… Ø­Ø³Ø§Ø¨ ETA Ø¨Ù†Ø¬Ø§Ø­", { duration: durationInSeconds, distance: distanceInMeters });
            callback(null, { duration: durationInSeconds, distance: distanceInMeters, route: data.routes[0].geometry });
        })
        .catch(err => {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù„Ø­Ø³Ø§Ø¨ ETA:", err);
            callback(err);
        });
}

function updateETADisplay(duration, distance, targetElement) {
    const minutes = Math.round(duration / 60);
    const kilometers = (distance / 1000).toFixed(2);
    targetElement.innerText = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±: ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© | Ø§Ù„Ù…Ø³Ø§ÙØ©: ${kilometers} ÙƒÙ…`;
    console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±", { minutes, kilometers });
}


function startRealTimeETATracking(workerLocation, jobLocation) {
    const etaDisplay = document.getElementById('etaDisplay');
    if (!etaDisplay) {
        console.error("Ø¹Ù†ØµØ± etaDisplay ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ­Ø¯ÙŠØ« ETA");
        return;
    }
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø£ÙŠ Ù…Ø¤Ø´Ø± Ø³Ø§Ø¨Ù‚
    orderCanceled = false;
    if (window.etaIntervalId) {
        clearInterval(window.etaIntervalId);
        window.etaIntervalId = null;
    }
    
    const intervalId = setInterval(() => {
        console.log("Ù‚ÙŠÙ…Ø© orderCanceled:", orderCanceled);
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…Ù„ØºÙ‰ØŒ ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª ÙˆØ¹Ø¯Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«
        if (orderCanceled) {
            clearInterval(intervalId);
            console.log("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ ETA Ù„Ø£Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…Ù„ØºÙ‰.");
            return;
        }
        calculateETA(workerLocation, jobLocation, (err, data) => {
            if (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ ETA:", err);
                return;
            }
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ ETA
            updateETADisplay(data.duration, data.distance, etaDisplay);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆÙ…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨
            const distance = calculateDistance(workerLocation, jobLocation);
            if (distance <= 0.5 && window.fullPhone) {
                document.getElementById('userPhone').innerText = `Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${window.fullPhone}`;
            }
        });
    }, 5000); // Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
    console.log("ØªÙ… Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ ETA ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ");
    return intervalId;
}


// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
function formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours} Ø³Ø§Ø¹Ø© ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© ${seconds} Ø«Ø§Ù†ÙŠØ©`;
}

function startCountdown(duration, targetElement, onComplete) {
    if (!targetElement) {
        console.error("âš ï¸ Ø¹Ù†ØµØ± 'countdownTimer' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©.");
        return;
    }
    let remaining = duration;
    targetElement.innerText = formatTime(remaining);
    const countdownInterval = setInterval(() => {
        remaining -= 1000;
        if (remaining <= 0) {
            clearInterval(countdownInterval);
            targetElement.innerText = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª";
            console.log("ØªÙ… Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­");
            onComplete();  // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª
        } else {
            targetElement.innerText = formatTime(remaining);
        }
    }, 1000);
    console.log("ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ");
    // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙŠ Ù…ØªØºÙŠØ± Ø¹Ø§Ù…
    window.countdownIntervalId = countdownInterval;
    return countdownInterval;
}






// Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Messaging Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙ‚Ø·
const messaging = firebase.messaging();

// ØªØ¹Ø±ÙŠÙ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„
function sendPusherNotificationByWorker(workerId, message) {
    fetch('http://localhost:7000/send-notification', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ workerId, message })
    })
    .then((response) => response.json())
    .then((data) => console.log(' 188 ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­:', data))
    .catch((error) => console.error(' 189 ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', error));
}






    
    // Ù…Ø±Ø¬Ø¹ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø­ÙŠØ« Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„
    const database = firebase.database();
    const workersRef = database.ref('workers');




// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… Ø¨Ø¯ÙˆÙ† ÙØ­Øµ Ù…Ø³Ø¨Ù‚
let workerId = null;


function updateCounterOfferUI(negotiation) {
    if (!negotiation) {
        console.error("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ§ÙˆØ¶ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.");
        return;
    }
    var counterPopup = document.getElementById("counterOfferDisplayPopup");
    if (counterPopup) {
        counterPopup.style.display = "block";
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„
        let orderDescription = "ØºÙŠØ± Ù…ØªÙˆÙØ±";
        if (window.currentOrderData && window.currentOrderData.description) {
            orderDescription = window.currentOrderData.description;
        }
        document.getElementById("orderDescriptionWorker").innerText = "ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨: " + orderDescription;
        
        // ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ù‚ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶
        document.getElementById("counterFinalPrice").innerText = negotiation.proposedPrice || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
        document.getElementById("counterFinalMessage").innerText = negotiation.message || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
    }
}















// ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± workerId Ø§Ù„Ø¹Ø§Ù… (ÙŠÙ…ÙƒÙ† ØªØ¹Ø±ÙŠÙÙ‡ ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù)
let currentWorkerId = null; // ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠÙ‘Ø± Ø¹Ø§Ù… Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„
let currentWorkerName = null; // ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠÙ‘Ø± Ø¹Ø§Ù… Ù„ØªØ®Ø²ÙŠÙ† Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„
let activeRequestExists = false; // Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ø¹Ø§Ù…Ù„ Ø·Ù„Ø¨ Ù†Ø´Ø· Ø¨Ø§Ù„ÙØ¹Ù„

function loginWorker() {
    const inputId = document.getElementById('workerLoginId').value;

    if (!inputId) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„.");
        return;
    }

    // ØªØ¹ÙŠÙŠÙ† Ù‚ÙŠÙ…Ø© workerId Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ ÙƒØ§ÙØ© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª
    workerId = inputId;

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø¹Ø±Ù Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¯Ø§Ø®Ù„ "workers"
    database.ref(`workers/${inputId}`).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const workerData = snapshot.val();
                console.log(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­: ${workerData.name}`);
                
                // ØªØ¹ÙŠÙŠÙ† currentWorkerId Ùˆ currentWorkerName Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ workerId
                currentWorkerId = inputId;
                window.currentWorkerId = inputId;
                workerId = inputId; // ØªØ£ÙƒÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… workerId
                currentWorkerName = workerData.name;

                console.log("âœ… currentWorkerId (local):", currentWorkerId);
                console.log("âœ… window.currentWorkerId:", window.currentWorkerId);
                console.log("âœ… workerId:", workerId);
                
                // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                document.getElementById('loginPopup').style.display = 'none';
                
                // ØªÙ‡ÙŠØ¦Ø© Ø¬Ù„Ø³Ø© Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… workerId
                initializeWorkerSession(workerId);
            } else {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¹Ø±Ù Ø¯Ø§Ø®Ù„ "availableWorkerIds"
                database.ref(`availableWorkerIds/${inputId}`).once('value')
                    .then((availableSnapshot) => {
                        if (availableSnapshot.exists() && availableSnapshot.val().used === false) {
                            console.log(`ğŸ”„ ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ${inputId} ÙˆØ¥Ù†Ø´Ø§Ø¤Ù‡ ÙÙŠ workers.`);
                            
                            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ÙÙŠ availableWorkerIds Ø¥Ù„Ù‰ "Ù…Ø³ØªØ®Ø¯Ù…"
                            database.ref(`availableWorkerIds/${inputId}`).update({ used: true, usedAt: new Date().toISOString() });
                            
                            const workerName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:");
                            if (!workerName) {
                                alert("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù.");
                                return;
                            }
                            
                            // Ø¥Ø¶Ø§ÙØ© prompt Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
                            const workerPhone = prompt("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:");
                            if (!workerPhone) {
                                alert("ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.");
                                return;
                            }
                            
                            // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ ÙÙŠ "workers" Ù…Ø¹ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
                            database.ref(`workers/${inputId}`).set({
                                name: workerName,
                                phone: workerPhone, // Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø¶Ø§Ù
                                assignedAt: new Date().toISOString(),
                                location: { lng: 0, lat: 0 } // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§
                            }).then(() => {
                                console.log(`âœ… ØªÙ… ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ${inputId} Ù„Ù„Ø¹Ø§Ù…Ù„: ${workerName}`);
                                
                                // ØªØ¹ÙŠÙŠÙ† currentWorkerId Ùˆ currentWorkerName Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ workerId
                                currentWorkerId = inputId;
                                window.currentWorkerId = inputId;
                                workerId = inputId; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… workerId
                                currentWorkerName = workerName;
                                
                                console.log("âœ… currentWorkerId (local):", currentWorkerId);
                                console.log("âœ… window.currentWorkerId:", window.currentWorkerId);
                                console.log("âœ… workerId:", workerId);
                                
                                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ®ØµÙŠØµ
                                document.getElementById('loginPopup').style.display = 'none';
                                initializeWorkerSession(workerId);
                            });
                        } else {
                            console.warn("âš ï¸ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                            alert("Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± ØµØ§Ù„Ø­ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚.");
                        }
                    })
                    .catch((error) => console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† availableWorkerIds:", error));
            }
        })
        .catch((error) => console.error("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error));
}





// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ÙˆØ¶ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function submitNegotiation() {
  const proposedPrice = document.getElementById('proposedPrice').value;
  const negotiationMessage = document.getElementById('negotiationMessage').value;
  
  if (!proposedPrice || !negotiationMessage) {
    console.error("Ø­Ù‚Ù„ Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©.");
    alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
    return;
  }
  
  if (!isValidNegotiationMessage(negotiationMessage)) {
    console.error("Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©.");
    alert('Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©.');
    return;
  }
  
  const workerId = window.currentWorkerId || currentWorkerId;
  if (!workerId) {
    console.error("Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„. Ù„Ø§ ÙŠÙˆØ¬Ø¯ workerId.");
    alert("Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  } else {
    console.log("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ØŒ workerId:", workerId);
  }
  
  const negotiationData = {
    workerId: workerId,
    proposedPrice: proposedPrice,
    message: negotiationMessage,
    timestamp: Date.now(),
    status: 'pending'
  };
  
  if (!window.currentNegotiationRequestId) {
    alert("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ ØªÙØ§ÙˆØ¶ Ù†Ø´Ø·!");
    return;
  }
  
  // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ù‚Ø¨Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  allowNegotiationListener = false;
  
  firebase.database().ref(`negotiations/${currentRequestId}`).push(negotiationData)
    .then(() => {
      // Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ù†Ø¹ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹
      allowNegotiationListener = true;
      console.log("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ÙˆØ¶ Ø¨Ù†Ø¬Ø§Ø­.");
      alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ÙˆØ¶ Ø¨Ù†Ø¬Ø§Ø­!');
      closeNegotiationForm();
    })
    .catch(error => {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ÙˆØ¶:", error);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.');
      // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø­ØªÙ‰ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
      allowNegotiationListener = true;
    });
}


function initializeWorkerSession(workerId) {
    console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„:", workerId);
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„
    window.workerRef = database.ref(`workers/${workerId}`);
    window.workerReviewsRef = workerRef.child('reviews');

    console.log("âœ… workerRef:", workerRef.toString());
    console.log("âœ… workerReviewsRef:", workerReviewsRef.toString());
    
    // Ø¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø© Ø§Ù„Ù€ presence Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù„Ø¹Ø§Ù…Ù„
    const connectedRef = firebase.database().ref(".info/connected");
    connectedRef.on("value", snapshot => {
      if (snapshot.val() === true) {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨ØµÙŠØºØ© Ø±Ù‚Ù…ÙŠØ© ÙˆØ³Ù„Ø³Ù„Ø© Ù…Ù‚Ø±ÙˆØ¡Ø©
        const now = Date.now();
        const formattedTime = new Date(now).toLocaleString();
        // Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¥Ù„Ù‰ Ù†Ø´Ø· Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø¢Ø®Ø± ÙˆÙ‚Øª Ø§ØªØµØ§Ù„ (Ø±Ù‚Ù…ÙŠ ÙˆÙ…Ù‚Ø±ÙˆØ¡)
        workerRef.update({
          active: true,
          lastActive: now,
          lastActiveFormatted: formattedTime
        });
        // Ø¹Ù†Ø¯ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ (Ù…Ø«Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­)ØŒ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ØºÙŠØ± Ù†Ø´Ø· Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
        workerRef.onDisconnect().update({
          active: false,
          lastActive: Date.now(),
          lastActiveFormatted: new Date().toLocaleString()
        });
        console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¥Ù„Ù‰ Ù†Ø´Ø· ÙˆØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ onDisconnect Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹.");
        
        // Ù‚Ø±Ø§Ø¡Ø© Ù‚ÙŠÙ…Ø© lastActiveFormatted Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙˆØ¹Ø±Ø¶Ù‡Ø§ Ø¨ØµÙŠØºØ© Ø³Ù‡Ù„Ø©
        workerRef.child('lastActiveFormatted').once('value').then(lastActiveSnap => {
          const lastActiveVal = lastActiveSnap.val();
          console.log(`Ø¢Ø®Ø± Ù†Ø´Ø§Ø· ØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡: ${lastActiveVal}`);
        });
      }
    });
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙŠ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØªØ±ÙƒÙŠØ² Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    updateLocationWithGPS(workerId);
    focusOnWorkerLocation(workerId);
    
    // ØªÙØ¹ÙŠÙ„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¯ÙˆÙ† Ø§Ù„Ø­Ø§Ø¬Ø© Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
    if (locateControl && locateControl.trigger) {
        locateControl.trigger();
        console.log("ØªÙ… ØªÙØ¹ÙŠÙ„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
    }
    
    // ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø¹Ù‚Ø¯ Ø§Ù„Ø¹Ø§Ù…Ù„
    workerRef.child('currentRequest').on('value', (snapshot) => {
        const requestData = snapshot.val();
        if (requestData) {
            console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}: ${requestData.status}`);
        } else {
            console.log(`Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠÙ‹Ø§ Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}`);
        }
    });

    function listenForNegotiationOffers(requestId) {
        console.log("ğŸ“¡ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙØ§ÙˆØ¶ Ù„Ù„Ø·Ù„Ø¨:", requestId);
        if (!requestId) {
            console.error("âš ï¸ RequestId ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
            return;
        }
        
        const negotiationRef = firebase.database().ref(`negotiations/${requestId}`);
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø¯Ø« "value" Ù…Ø¹ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ "timestamp" Ù„ØªØ­Ø¯ÙŠØ¯ Ø£Ø­Ø¯Ø« Ø¹Ø±Ø¶
        negotiationRef.orderByChild("timestamp").limitToLast(1).on("value", snapshot => {
            snapshot.forEach(childSnapshot => {
                const negotiation = childSnapshot.val();
                if (negotiation) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø­Ø§Ù„Ø© pendingØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙØªØ§Ø­
                    if (negotiation.status === "pending") {
                        console.log("ğŸ”” Ø¹Ø±Ø¶ ØªÙØ§ÙˆØ¶ÙŠ Ø¬Ø¯ÙŠØ¯ (pending):", childSnapshot.key, negotiation);
                        updateNegotiationUI(negotiation);
                        currentNegotiationOfferKey = childSnapshot.key;
                    } 
                    // Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† pending Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© Ø£Ø®Ø±Ù‰ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«
                    else {
                        console.log("ğŸ”„ ØªØ­Ø¯ÙŠØ« ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ÙˆØ¶ÙŠ (ØºÙŠØ± pending):", childSnapshot.key, negotiation);
                        handleNegotiationUpdate(negotiation);
                    }
                }
            });
        });
    }
}









function submitCounterOffer() {
  const proposedPrice = document.getElementById('counterOfferPrice').value;
  const negotiationMessage = document.getElementById('counterOfferMessage').value;
  
  if (!proposedPrice || !negotiationMessage) {
    console.error("Ø­Ù‚Ù„ Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©.");
    alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
    return;
  }
  
  if (!isValidNegotiationMessage(negotiationMessage)) {
    console.error("Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©.");
    alert('Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©.');
    return;
  }
  
  const workerId = window.currentWorkerId || currentWorkerId;
  if (!workerId) {
    console.error("Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„. Ù„Ø§ ÙŠÙˆØ¬Ø¯ workerId.");
    alert("Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }
  
  // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© requestId Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯
  const counterOfferData = {
    workerId: workerId,
    proposedPrice: proposedPrice,
    message: negotiationMessage,
    timestamp: Date.now(),
    status: 'counter',
    requestId: window.currentNegotiationRequestId  // Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ø¶Ø§Ù
  };
  
  if (!window.currentNegotiationRequestId) {
    alert("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ ØªÙØ§ÙˆØ¶ Ù†Ø´Ø·!");
    return;
  }
  
  // ÙŠÙ…ÙƒÙ† ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  allowNegotiationListener = false;
  
  firebase.database().ref(`negotiations/${currentRequestId}`).push(counterOfferData)
    .then(() => {
      allowNegotiationListener = true;
      console.log("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.");
      alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
      closeCounterOfferForm(); // Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯
    })
    .catch(error => {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯:", error);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.');
      allowNegotiationListener = true;
    });
}








if (currentRequestId) {
    listenForNegotiationOffers(currentRequestId);
}











// Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªÙØ§ÙˆØ¶
function handleNegotiationUpdate(negotiation) {
    if (!negotiation) return;
    if (negotiation.status === "accepted") {
        alert("âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶!");
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø¨Ø± Ù†Ø§ÙØ°Ø© Ø¨Ø¯Ø¡ Ø§Ù„ØªÙØ§ÙˆØ¶ Ø£Ùˆ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ…ÙŠÙ…
        updateNegotiationUI(negotiation);
    } else if (negotiation.status === "rejected") {
        alert("âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¹Ø±Ø¶!");
        updateNegotiationUI(negotiation);
    } else if (negotiation.status === "counter") {
        alert("ğŸ”„ ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø¹Ø±Ø¶ Ù…Ø¶Ø§Ø¯.");
        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¶Ø§Ø¯ Ø§Ù„Ø°ÙŠ Ù‚Ø¯Ù…Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        updateCounterOfferUI(negotiation);
    }
}


// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙƒÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ØªÙŠ ØªØ­Ø¯Ø« ÙÙŠ `negotiations`
function listenForNegotiationUpdates() {
    console.log("ğŸ“¡ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ØªÙØ§ÙˆØ¶ ÙÙŠ `negotiations`");

    const negotiationsRef = firebase.database().ref("negotiations");

    negotiationsRef.on("value", snapshot => {
        if (!snapshot.exists()) return;

        const negotiationsData = snapshot.val();
        console.log("ğŸ“¡ ØªØ­Ø¯ÙŠØ« ÙÙŠ `negotiations`:", negotiationsData);

        Object.keys(negotiationsData).forEach(requestId => {
            if (requestId !== currentRequestId) return;
            
            const negotiations = negotiationsData[requestId];

            Object.keys(negotiations).forEach(negotiationId => {
                const negotiation = negotiations[negotiationId];

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ø±Ø¶ ÙŠØ®Øµ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø·
                if (negotiation.workerId !== currentWorkerId) return;

                const previousNegotiation = previousNegotiations[negotiationId];
                if (previousNegotiation && previousNegotiation.status === "pending" && negotiation.status !== "pending") {
                    console.log("ğŸ”„ ØªØºÙŠØ±Øª Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶:", negotiationId, "Ù…Ù† pending Ø¥Ù„Ù‰", negotiation.status);
                    handleNegotiationUpdate(negotiation);
                }

                previousNegotiations[negotiationId] = negotiation;
            });
        });
    });
}


// ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ØªÙØ§ÙˆØ¶ÙŠØ©
let previousNegotiations = {};




// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", function () {
    listenForNegotiationUpdates();
});













// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« activeWorkers Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
function updateActiveWorkerLocation(workerId, location) {
    try {
        const activeWorkerRef = database.ref('activeWorkers/' + workerId);
        activeWorkerRef.set({
            location: location,
            active: true
        });
    } catch (error) {
        console.error("Ø®Ø·Ø£ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« activeWorkers:", error);
    }
}

function updateLocationWithGPS(workerId) {
    if (navigator.geolocation) {
        // âœ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„ÙŠ Ù„Ù„Ø¹Ø§Ù…Ù„
        navigator.geolocation.getCurrentPosition((position) => {
            const initialLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
            };
            console.log("ğŸ“90 Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„ÙŠ:", initialLocation);
            updateWorkerLocation(workerId, initialLocation);
            updateActiveWorkerLocation(workerId, initialLocation);
        }, (error) => {
            console.error("ğŸš¨ 91 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„ÙŠ:", error);
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });

        // âœ… Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø´ÙƒÙ„ Ù…Ø³ØªÙ…Ø±
        navigator.geolocation.watchPosition((position) => {
            const newLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
            };
            console.log("ğŸ“¡ 93 ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ©:", newLocation);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            window.currentWorkerLocation = newLocation;
            
            // ØªØ­Ø¯ÙŠØ« Firebase Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¹Ø§Ù…Ù„
            updateWorkerLocation(workerId, newLocation);
            updateActiveWorkerLocation(workerId, newLocation);
            
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
            checkAndUpdateOrderStatus();
            
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
            checkDistanceAndToggleCancelButton();
        }, (error) => {
            console.error("ğŸš¨ 197 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹:", error);
        }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
    } else {
        console.error("ğŸš¨ 198 Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Geolocation).");
    }
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…ÙˆØ¬Ù‡Ø© Ù„Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
let initialLoadDone = false;
const workerRequestsRef = database.ref('workRequests').orderByChild('workerId').equalTo(workerId);

// Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù†Ø³ØªØ®Ø¯Ù… once Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
workerRequestsRef.once('value', snapshot => {
    // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù†Ø¶Ø¨Ø· Ø§Ù„Ø¹Ù„Ù… Ø¥Ù„Ù‰ true
    initialLoadDone = true;
});

workerRequestsRef.on('child_added', snapshot => {
    if (!initialLoadDone) return;
    
    const requestData = snapshot.val();
    console.log('Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…ÙˆØ¬Ù‡ Ù„Ùƒ:', requestData);
    // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
    alert('Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯: ' + requestData.workType);
    // ÙŠÙ…ÙƒÙ† ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ù†Ù‚Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹
});






function checkDistanceAndToggleCancelButton() {
    // ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø·Ù„Ø¨ Ù†Ø´Ø· (orderActive) ÙˆÙ„Ù… ÙŠÙÙ„ØºÙ Ø¨Ø¹Ø¯
    if (!currentRequestId || !orderActive) return;
    firebase.database().ref(`workRequests/${currentRequestId}`).once('value')
        .then(snapshot => {
            const request = snapshot.val();
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…Ù„ØºÙ‰ Ø£Ùˆ Ù„Ù… ÙŠØ¹Ø¯ ÙÙŠ Ø­Ø§Ù„Ø© "pending" ÙÙ„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            if (!request || request.status !== 'pending') {
                document.getElementById('cancelJobContainer').style.display = 'none';
                console.log("ğŸ”’ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ø¥Ù„ØºØ§Ø¡ØŒ Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡.");
                return;
            }
            if (request && request.location) {
                const distance = calculateDistance(currentWorkerLocation, request.location);
                console.log(`Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆØ§Ù„Ø·Ù„Ø¨: ${distance.toFixed(2)} ÙƒÙ…`);
                if (distance <= 0.5) {
                    document.getElementById('cancelJobContainer').style.display = 'none';
                    console.log('â±ï¸ Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù„Ø£Ù† Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¹Ù„Ù‰ Ø¨Ø¹Ø¯ Ø£Ù‚Ù„ Ù…Ù† 500 Ù…ØªØ±.');
                } else {
                    document.getElementById('cancelJobContainer').style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©:', error);
        });
}



document.addEventListener("DOMContentLoaded", () => {
    // ØªØ£ÙƒÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
    const loginButton = document.getElementById('loginWorkerButton');
    if (!loginButton) {
        console.error("ğŸš¨ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DOM. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.");
        return;
    }
    // Ø±Ø¨Ø· Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
    loginButton.addEventListener('click', loginWorker);

    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ÙŠØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø§ØµØ± Ø£Ø®Ø±Ù‰ (Ù…Ø«Ù„ acceptJobButton, locateButton, styleSelector)
    const acceptJobButton = document.getElementById('acceptJobButton');
    const locateButton = document.getElementById('locateButton');
    const styleSelector = document.getElementById('styleSelector');

    if (!acceptJobButton || !locateButton || !styleSelector) {
        console.error("ğŸš¨ Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ DOM. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.");
        return;
    }
});




// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
function resetJobUI() {
    // Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
    document.getElementById('jobDetailsPopup').style.display = 'none';
    // Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
    document.getElementById('cancelJobContainer').style.display = 'none';
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡
    if (window.countdownIntervalId) {
        clearInterval(window.countdownIntervalId);
        window.countdownIntervalId = null;
        console.log("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ.");
    }
    const countdownTimer = document.getElementById('countdownTimer');
    if (countdownTimer) {
        countdownTimer.innerText = '';
    }
    document.getElementById('countdownPanel').style.display = 'none';
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø¹Ø±Ø¶ ETA ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù‡
    const etaDisplay = document.getElementById('etaDisplay');
    if (etaDisplay) {
        etaDisplay.innerText = '';
    }
    document.getElementById('etaPanel').style.display = 'none';
    
    // Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    localStorage.removeItem('orderStatus');
    
    // Ø¥Ø²Ø§Ù„Ø© Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (map.getLayer('route')) {
        map.removeLayer('route');
        map.removeSource('route');
        console.log("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù…Ø³Ø§Ø± Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
    }
    
    // Ø¥Ø²Ø§Ù„Ø© Ù†Øµ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø± (Popup) Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    if (window.routeTextPopup && typeof window.routeTextPopup.remove === 'function') {
        window.routeTextPopup.remove();
        window.routeTextPopup = null;
        console.log("ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù†Øµ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø±.");
    } else {
        console.log("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Popup Ù„Ø¥Ø²Ø§Ù„ØªÙ‡ Ø¨Ø§Ù„Ù…ØªØºÙŠØ± window.routeTextPopup.");
    }
    
    // Ø®Ø·ÙˆØ© Ø¥Ø¶Ø§ÙÙŠØ©: Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠØ© Ø¹Ù†Ø§ØµØ± Popup Ù‚Ø¯ ØªÙƒÙˆÙ† Ø¨Ù‚ÙŠØª ÙÙŠ DOM
    const popups = document.getElementsByClassName('mapboxgl-popup');
    while (popups.length > 0) {
        popups[0].remove();
    }
    console.log("ØªÙ… Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù€ Popup Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
    activeRequestExists = false;
}

// Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨"
document.getElementById('cancelJobButton').addEventListener('click', function() {
    const distance = getWorkerDistance();
    if (distance < 0.5) { 
        alert("Ù„Ù‚Ø¯ Ø³Ø¬Ù„Øª ØªÙ‚Ø¯Ù…Ùƒ ÙÙŠ Ø§Ù„Ù…Ù†Ø¸ÙˆÙ…Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¢Ù†.");
        console.error("Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù‚ØªØ±Ø§Ø¨ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹");
        return;
    } else {
        if (!confirm("ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø·Ù„Ø¨ Ù„Ù† ÙŠÙÙ„ØºÙ‰ Ø¥Ø°Ø§ Ø£ØµØ¨Ø­Øª Ù‚Ø±ÙŠØ¨Ø§Ù‹ (Ø£Ù‚Ù„ Ù…Ù† 500 Ù…ØªØ±) Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) {
            console.log("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
            return;
        }
    }
    
    showCancelConfirmation(function() {
        const requestRef = firebase.database().ref(`workRequests/${currentRequestId}`);
        const workerId = window.currentWorkerId || currentWorkerId;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ canceled_by_worker Ù…Ø¹ ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        requestRef.update({ 
            status: 'canceled_by_worker',
            canceled_by: workerId,
            canceledAt: Date.now()
        })
        .then(() => {
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø©
            window.sendPusherNotification(window.selectedWorkerId, 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø§Ù…Ù„.');
            // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ pending Ù„ØªÙØ¹ÙŠÙ„Ù‡Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹
            return requestRef.update({ status: 'pending' });
        })
        .then(() => {
            alert('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨.');
            resetJobUI(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„Ù†Øµ
            
            // Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ ETA ÙˆØ§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
            if (window.etaIntervalId) {
                clearInterval(window.etaIntervalId);
                window.etaIntervalId = null;
                console.log("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ ETA.");
            }
            if (window.countdownIntervalId) {
                clearInterval(window.countdownIntervalId);
                window.countdownIntervalId = null;
                console.log("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ.");
            }
        })
        .catch((err) => {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:", err);
        });
    });
});






function showNotification(message) {
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    const notification = document.createElement('div');
    notification.innerText = message;
    // ØªÙ†Ø³ÙŠÙ‚ Ø¨Ø³ÙŠØ· Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±
    notification.style.position = 'fixed';
    notification.style.top = '20px';
    notification.style.right = '20px';
    notification.style.backgroundColor = '#f44336';
    notification.style.color = '#fff';
    notification.style.padding = '10px';
    notification.style.borderRadius = '5px';
    notification.style.boxShadow = '0px 2px 6px rgba(0, 0, 0, 0.3)';
    notification.style.zIndex = '10000';
    document.body.appendChild(notification);
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù
    setTimeout(() => {
       notification.remove();
    }, 3000);
}


function handleShowJobDetails(jobData) {
    console.log("handleShowJobDetails: ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨", jobData);
    
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¹Ø·Ù‰ Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† ÙƒØ§Ø¦Ù† ÙˆÙ„ÙŠØ³ Ø³Ù„Ø³Ù„Ø© Ù†ØµÙŠØ©
    if (typeof jobData === 'string') {
        try {
            jobData = JSON.parse(jobData);
            console.log("handleShowJobDetails: ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† Ø¨Ù†Ø¬Ø§Ø­", jobData);
        } catch (e) {
            console.error("handleShowJobDetails: ÙØ´Ù„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù† JSON", e);
            showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨");
            return;
        }
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¹Ø¯Ù… ÙØªØ­ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹
    if (!currentWorkerId) {
        console.error("handleShowJobDetails: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª");
        // ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        document.getElementById('loginPopup').style.display = 'flex';
        return;
    }
    
    console.log("handleShowJobDetails: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ØŒ currentWorkerId =", currentWorkerId);
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ Ù„Ù„Ø¯Ø®ÙˆÙ„
    showJobDetails(jobData);
}




document.addEventListener("DOMContentLoaded", function() {
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­ØªÙ‰ ÙˆØ¥Ù† Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                window.currentWorkerLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                console.log("ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©:", window.currentWorkerLocation);
            },
            function(error) {
                console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©:", error);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );
    } else {
        console.error("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Geolocation.");
    }
});

// Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ± ÙˆÙ…Ø¤Ø´Ø± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
let modalMediaArray = [];
let modalCurrentIndex = 0;

// Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© (Modal) Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶
function openImageModal(index) {
  modalCurrentIndex = index;
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  if (modalMediaArray.length > 0) {
    let url = modalMediaArray[modalCurrentIndex];
    modalImg.src = url.startsWith("http") ? url : "https://yourdomain.com" + url;
  }
  modal.style.display = 'flex';
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ¥Ø¶Ø§ÙØ© Ù…ÙŠØ²Ø© Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
function showJobDetails(jobData) {
  console.log("showJobDetails: Ø¨Ø¯Ø£ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨", jobData);

  // Ø¹Ø±Ø¶ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙˆØ± (jobData.media)
  if (jobData.media && Array.isArray(jobData.media) && jobData.media.length > 0) {
    const imagesContainer = document.getElementById('jobImagesContainer');
    imagesContainer.innerHTML = ""; // Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    modalMediaArray = jobData.media; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ØµÙÙˆÙØ© Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© (Modal)
    jobData.media.forEach(function(url, index) {
      const img = document.createElement('img');
      img.src = url.startsWith("http") ? url : "https://yourdomain.com" + url;
      img.alt = "ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„";
      img.style.width = "18%";
      img.style.height = "auto";
      img.style.marginRight = "2%";
      img.style.cursor = "pointer";
      img.addEventListener("click", function () {
        openImageModal(index);
      });
      imagesContainer.appendChild(img);
    });
    imagesContainer.style.display = 'block';
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù†ØµØ± Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙØ±Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ø£Ø®ÙÙÙ‡
    const singleImage = document.getElementById('jobImage');
    if (singleImage) {
      singleImage.style.display = 'none';
    }
  } else if (jobData.imageUrl) {
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù…ØµÙÙˆÙØ© ØµÙˆØ±ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ÙØ±Ø¯Ø©
    const singleImage = document.getElementById('jobImage');
    singleImage.src = jobData.imageUrl;
    singleImage.style.display = 'block';
    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø¥Ù† ÙˆÙØ¬Ø¯
    const imagesContainer = document.getElementById('jobImagesContainer');
    if (imagesContainer) {
      imagesContainer.style.display = 'none';
    }
    modalMediaArray = []; // ØªÙØ±ÙŠØº Ø§Ù„Ù…ØµÙÙˆÙØ©
  } else {
    // Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£ÙŠ ØµÙˆØ±
    const imagesContainer = document.getElementById('jobImagesContainer');
    const singleImage = document.getElementById('jobImage');
    if (imagesContainer) imagesContainer.style.display = 'none';
    if (singleImage) singleImage.style.display = 'none';
    modalMediaArray = [];
  }

  // Ø¨Ø§Ù‚ÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ
  document.getElementById('jobDescription').innerText = `ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„: ${jobData.description || jobData.workType}`;
  const fullPhone = jobData.phone || "ØºÙŠØ± Ù…ØªÙˆÙØ±";
  window.fullPhone = fullPhone;
  let maskedPhone = fullPhone;
  if (fullPhone !== "ØºÙŠØ± Ù…ØªÙˆÙØ±" && fullPhone.length > 5) {
    maskedPhone = fullPhone.substr(0, 5) + "*****";
  }
  document.getElementById('userPhone').innerText = `Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: ${maskedPhone} (Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø¨ 500 Ù…ØªØ±)`;

  document.getElementById('jobLocation').innerText = jobData.region 
    ? `Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${jobData.region}` 
    : `Ø§Ù„Ù…ÙˆÙ‚Ø¹: (${jobData.location.lat}, ${jobData.location.lng})`;
  document.getElementById('jobDuration').innerText = `Ø§Ù„Ù…Ø¯Ø©: ${jobData.time}`;
  document.getElementById('jobBudget').innerText = `Ø§Ù„Ù…Ø¨Ù„Øº: ${jobData.budget}`;

  window.jobLocation = jobData.location;

  // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø¨Ø§Ù„ÙØ¹Ù„
  if (!window.orderData) {
    window.orderData = {};
  }
  if (jobData.requestId) {
    window.orderData[jobData.requestId] = jobData;
  } else {
    console.warn("Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± requestId ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨");
  }

  // Ø¯Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø± (ETA)
  function updateDistanceAndETA() {
    const distance = calculateDistance(currentWorkerLocation, jobData.location);
    const distanceElem = document.getElementById('jobDistance');
    if (distanceElem) {
      distanceElem.innerText = `Ø§Ù„Ù…Ø³Ø§ÙØ©: ${distance.toFixed(2)} ÙƒÙ…`;
    }
    calculateETA(currentWorkerLocation, jobData.location, function(err, data) {
      if (err) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ ETA Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„", err);
        return;
      }
      const etaElem = document.getElementById('estimatedArrivalTime');
      if (etaElem) {
        const minutes = Math.round(data.duration / 60);
        etaElem.innerText = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±: ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
      }
    });
  }

  // Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±
  if (typeof currentWorkerLocation === 'undefined') {
    console.warn("currentWorkerLocation ØºÙŠØ± Ù…Ø¹Ø±ÙØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¢Ù†...");
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          currentWorkerLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          console.log("ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ showJobDetails:", currentWorkerLocation);
          updateDistanceAndETA();
        },
        function(error) {
          console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ showJobDetails:", error);
          document.getElementById('jobDistance').innerText = "Ø§Ù„Ù…Ø³Ø§ÙØ©: ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©";
        }
      );
    }
  } else {
    updateDistanceAndETA();
  }

  // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
  const acceptBtn = document.getElementById('acceptJobButton');
  if (jobData.status !== 'pending') {
    acceptBtn.style.display = 'inline-block';
    acceptBtn.textContent = 'ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨';
    acceptBtn.style.backgroundColor = 'red';
    acceptBtn.disabled = true;
  } else {
    acceptBtn.style.display = 'inline-block';
    acceptBtn.textContent = 'Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨';
    acceptBtn.style.backgroundColor = 'green';
    acceptBtn.disabled = false;
  }

  window.currentOrderData = jobData;

  // Ø¹Ø±Ø¶ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ø±Ø¶
  document.getElementById('jobDetailsPopup').style.display = 'block';
  document.getElementById('etaPanel').style.display = 'block';
  document.getElementById('countdownPanel').style.display = 'block';
}








    // Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ø²Ø± "Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨"
    document.getElementById('rejectDirectRequest').addEventListener('click', function() {
        console.log("ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨");
        // Ù…Ø«Ø§Ù„ Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firebase Ø¹Ù†Ø¯ Ø§Ù„Ø±ÙØ¶
        firebase.database().ref('workRequests/' + currentRequestId).update({
            status: 'rejected'
        }).then(function() {
            console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ rejected ÙÙŠ Firebase");
        }).catch(function(error) {
            console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:", error);
        });
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙØ¶
        document.getElementById('directRequestPopup').style.display = 'none';
        alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨.");
    });






// Ù…Ø³ØªÙ…Ø¹ Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
const savedRequests = []; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§

function processSavedRequests() {
    try {
        console.log("âš¡ 37 Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...");

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
        if (typeof map === 'undefined' || !(map instanceof mapboxgl.Map)) {
    console.error("ğŸš¨ 115 Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ù‡ÙŠØ£ Ø£Ùˆ ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦ØªÙ‡.");
    initializeMap(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    return;
}

// [Ø§Ù„Ø³Ø·Ø± 35-42] Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… waitUntilMapReady()
waitUntilMapReady()
    .then(() => {
        // Ù‡Ù†Ø§ ØªÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ ÙŠØªØ§Ø¨Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        // Ù…Ø«Ù„Ø§Ù‹: processSavedRequests();
    })
    .catch((err) => {
        console.warn("âš ï¸ 36: Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙŠØ³Øª Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©. Ø³ÙŠØªÙ… ØªØ£Ø¬ÙŠÙ„Ù‡Ø§.", err);
        return;
    });




        console.log("âš¡ 79 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©. Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...");

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        while (savedRequests.length > 0) {
            const request = savedRequests.shift();

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨
            if (!request || !request.requestData || !request.requestId) {
                console.error("ğŸš¨ 41 Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ø·Ù„Ø¨:", request);
if (!request) {
    console.error("ğŸš¨ 155 Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Firebase.");
}      continue; // ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± ØµØ­ÙŠØ­
            }

            const { requestData, requestId } = request;
            console.log(`âš™ï¸ 42 Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø­ÙÙˆØ¸: ${requestId}`);

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
            if (requestData.status === 'pending') {
                try {
                    console.log(`âŒ› 33 ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ù„Ù„Ø·Ù„Ø¨ ${requestId}.`);
                    startRequestTimeout(requestId, 10); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
                    showJobDetails(requestData); // Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
                } catch (error) {
                    console.error(`ğŸš¨ 34 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}:`, error);
                }
            } else {
                console.warn(`âš ï¸ 35 Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù„ÙŠØ³ ÙÙŠ Ø­Ø§Ù„Ø© 'pending'.`);
            }
        }

        console.log("âœ… 74 ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­.");
    } catch (error) {
        console.error("ğŸš¨ 75 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:", error);
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©
function saveRequestForLater(requestData, requestId) {
    if (!requestData || !requestId) {
        console.error("ğŸš¨ 80 Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨:", { requestData, requestId });
        return;
    }
    console.log(`ğŸ“‹ 81 ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù„Ø§Ø­Ù‚Ù‹Ø§:`, requestData);
    savedRequests.push({ requestData, requestId });
}






// ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
const requestRef = database.ref('workRequests');
let initialRequestsLoaded = false;

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù„Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
requestRef.once('value', () => {
    initialRequestsLoaded = true;
});
requestRef.on('child_added', (snapshot) => {
    if (!initialRequestsLoaded) return;
    
    const requestData = snapshot.val();
    const requestId = snapshot.key;
    
    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
    currentRequestId = requestId;
    console.log("âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† currentRequestId Ù„Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", currentRequestId);

    // Ø´Ø±Ø· Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ù†Ø´Ø· Ù…Ø³Ø¨Ù‚Ø§Ù‹
    if (activeRequestExists) {
        console.log("âš ï¸ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù„Ø¯ÙŠÙ‡ Ø·Ù„Ø¨ Ù†Ø´Ø· Ø¨Ø§Ù„ÙØ¹Ù„. ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯.");
        return;
    }

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆÙØ± Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
    if (!window.currentWorkerLocation) {
        console.error("ğŸš¨ 210 Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ØºÙŠØ± Ù…ØªÙˆÙØ±.");
        return;
    }
    const distance = calculateDistance(window.currentWorkerLocation, requestData.location);
    console.log(` 211 Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆØ§Ù„Ø·Ù„Ø¨ ${requestId}: ${distance.toFixed(2)} ÙƒÙ…`);
    if (distance > 15) {
        console.warn(`âš ï¸ Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ø¨Ø¹ÙŠØ¯ Ø¹Ù† Ù†Ø·Ø§Ù‚ Ø§Ù„Ù€ 15 ÙƒÙ…ØŒ Ù„Ù† ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡.`);
        return;
    }

    waitUntilMapReady()
        .then(() => {
            console.log(`ğŸ‰ 40 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}.`);
            if (requestData.status === 'pending') {
                try {
                    console.log(`âš™ï¸ 44 Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}.`);
                    startRequestTimeout(requestId, 10); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù„Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©

                    // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ showJobDetails Ù†Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Ù‹ ÙÙ‚Ø·
                    alert("Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯: " + requestData.workType);
                    // ÙŠÙ…ÙƒÙ† ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø¹Ù†Ø¯ ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…

                } catch (error) {
                    console.error(`ğŸš¨ 72 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId}:`, error);
                }
            } else {
                console.warn(`âš ï¸ 73 Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù„ÙŠØ³ ÙÙŠ Ø­Ø§Ù„Ø© 'pending'.`);
            }
        })
        .catch((err) => {
            console.warn(`âš ï¸ 39: Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙŠØ³Øª Ø¬Ø§Ù‡Ø²Ø© Ø¨Ø¹Ø¯. Ø³ÙŠØªÙ… ØªØ£Ø¬ÙŠÙ„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨ ${requestId}.`, err);
            saveRequestForLater(requestData, requestId);
            return;
        });
});











// Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·
let retryCount = 0; // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
const maxRetries = 3; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª

function checkMapStyleLoaded() {
    if (!map) {
        console.error("ğŸš¨ 82 Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ù‡ÙŠØ£. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦ØªÙ‡ Ù‚Ø¨Ù„ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ checkMapStyleLoaded.");
        return;
    }

    if (map.isStyleLoaded()) {
    isMapReady = true;
    console.log("ğŸ‰ 157 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©.");
    processSavedRequests(); // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
} else if (retryCount < maxRetries) {
    retryCount++;
    console.warn(`âš ï¸ 48 Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø±Ù‚Ù… ${retryCount}: Ø§Ù„Ù†Ù…Ø· Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© (${retryCount}/${maxRetries}).`);
    setTimeout(() => {
        checkMapStyleLoaded(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
    }, 2000); // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªØ£Ø®ÙŠØ± Ø¥Ù„Ù‰ Ø«Ø§Ù†ÙŠØªÙŠÙ†
} else {
    console.error("ğŸš¨ 49 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§ØªØµØ§Ù„ Ø§Ù„Ø´Ø¨ÙƒØ©.");
    alert("âš ï¸ 86 Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·. Ø­Ø§ÙˆÙ„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
console.error("ğŸš¨ 156 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø´Ø¨ÙƒØ©.");
}

}













// ÙƒØ§Ø¦Ù† Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚Øª Ù„ÙƒÙ„ Ø·Ù„Ø¨
const timeoutIntervals = {};

// Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ¯ Ù…Ù‡Ù„Ø© Ø²Ù…Ù†ÙŠØ© Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function startRequestTimeout(requestId, timeoutMinutes = 10) {
    const timeoutTime = Date.now() + timeoutMinutes * 60 * 1000;
    const requestRef = database.ref(`workRequests/${requestId}`);

    // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙŠ ÙƒØ§Ø¦Ù† timeoutIntervals Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… requestId ÙƒÙ…ÙØªØ§Ø­
    timeoutIntervals[requestId] = setInterval(() => {
        requestRef.once('value').then((snapshot) => {
            const requestData = snapshot.val();
            console.log(`[Timeout Checker] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ${requestId} ÙÙŠ ${new Date().toLocaleTimeString()}: ${requestData.status}`);
            // Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· Ù„Ø¹Ø¯Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† acceptedBy Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
            if (Date.now() > timeoutTime && requestData.status === 'pending' && !requestData.acceptedBy) {
                requestRef.update({ status: 'timeout' });
                clearInterval(timeoutIntervals[requestId]);
                console.log(`Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ù‚Ø¨ÙˆÙ„Ù‡ ÙˆØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„ØªÙ‡ Ø¥Ù„Ù‰ timeout.`);
            }
        });
    }, 10000);
}

// Ø¯Ø§Ù„Ø© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function acceptRequest(requestId, workerId, workerName) {
    const requestRef = database.ref(`workRequests/${requestId}`);
    return requestRef.once('value')
        .then(snapshot => {
            const request = snapshot.val();
            if (!request) {
                alert('âŒ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.');
                console.error(`âŒ ÙØ´Ù„ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ${requestId}.`);
                return Promise.reject('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            }
            if (request.status !== 'pending') {
                alert('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø£Ù†Ù‡ Ù„Ù… ÙŠØ¹Ø¯ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±.');
                console.error(`âŒ Ø±ÙØ¶ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ${requestId}: Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ${request.status}`);
                return Promise.reject('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ù‚Ø¨ÙˆÙ„');
            }
            return requestRef.update({
                status: 'accepted',
                acceptedBy: workerId
            });
        })
        .then(() => {
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠÙØ¶Ø§Ù Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ø¯ÙˆÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
            const activityRef = database.ref(`workRequests/${requestId}/orderHistory`);
            activityRef.push({
                type: 'accepted',
                workerId: workerId,
                workerName: workerName,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            alert('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.');
            console.log(`ğŸ“¢ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ù…Ù† Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId} ÙÙŠ ${new Date().toLocaleTimeString()}`);
            if (window.markers && window.markers[requestId]) {
                window.markers[requestId].setColor('yellow');
                console.log(`ğŸ¨ ØªÙ… ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ù„Ù„Ø·Ù„Ø¨ ${requestId} Ø¥Ù„Ù‰ Ø£ØµÙØ±.`);
            }
            if (window.timeoutIntervals && window.timeoutIntervals[requestId]) {
                clearInterval(window.timeoutIntervals[requestId]);
                console.log(`â³ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ù…Ø¤Ù‚Øª Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„.`);
                delete window.timeoutIntervals[requestId];
            }
            requestRef.onDisconnect().update({
                status: 'pending',
                note: 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø³Ø¨Ø¨ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§ØªØµØ§Ù„ Ø§Ù„Ø¹Ø§Ù…Ù„'
            })
            .then(() => {
                console.log("âœ… onDisconnect ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡ Ù„Ù„Ø·Ù„Ø¨:", requestId);
            })
            .catch((error) => {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹ÙŠÙŠÙ† onDisconnect Ù„Ù„Ø·Ù„Ø¨:", requestId, error);
            });
            startWorkerHeartbeat(workerId);

            // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
// Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
orderCanceled = false;
orderActive = true;
localStorage.setItem('orderStatus', 'accepted'); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨

// Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø§Øª ETA ÙˆØ§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
document.getElementById('etaPanel').style.display = 'block';
document.getElementById('countdownPanel').style.display = 'block';

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¹Ø§Ù…Ù„ ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù‡Ù†Ø§Ù„Ùƒ Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹
if (typeof updateLocationWithGPS === 'function' && currentWorkerId) {
    updateLocationWithGPS(currentWorkerId); // Ø³ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« currentWorkerLocation
}

// ØªØ­Ø¯ÙŠØ« jobLocation Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (ÙŠÙØªØ±Ø¶ Ø£Ù† requestData ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
if (requestData && requestData.location) {
    jobLocation = requestData.location;
} else {
    console.error("Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.");
}

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ù…ØªÙˆÙØ±Ø© Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ ETA
console.log('currentWorkerLocation:', currentWorkerLocation);
console.log('jobLocation:', jobLocation);

if (currentWorkerLocation && jobLocation) {
    // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ ETA Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
    window.etaIntervalId = startRealTimeETATracking(currentWorkerLocation, jobLocation);
} else {
    console.error("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ ETAØ› ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹.");
}

        })
        .catch(error => {
            console.error(`âŒ Ù„Ù… ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ${requestId}:`, error);
        });
}













    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function addWorker(workerId, workerName, lng, lat) {
      workersRef.child(workerId).set({
        name: workerName,
        location: {
          lng: lng,
          lat: lat
        }
      });
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ®ØµÙŠØµ Ù…Ø¹Ø±Ù‘Ù Ù„Ø¹Ø§Ù…Ù„ Ù…Ø¹ÙŠÙ†
    function assignWorkerId(workerName, lng, lat) {
    database.ref('availableWorkerIds').orderByChild('used').equalTo(false).limitToFirst(1).once('value')
        .then((snapshot) => {
            if (snapshot.exists()) {
                const workerId = Object.keys(snapshot.val())[0]; // Ø£ÙˆÙ„ Ù…Ø¹Ø±Ù‘Ù ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…

                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø±Ù‘Ù Ø¥Ù„Ù‰ "Ù…Ø³ØªØ®Ø¯Ù…"
                database.ref(`availableWorkerIds/${workerId}`).update({ used: true });

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                database.ref(`workers/${workerId}`).set({
                    name: workerName,
                    assignedAt: new Date().toISOString(),
                    location: { lng: lng, lat: lat }
                });

                console.log(`ØªÙ… ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ${workerId} Ù„Ù„Ø¹Ø§Ù…Ù„: ${workerName}`);
            } else {
                console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù‘ÙØ§Øª Ù…ØªØ§Ø­Ø©.");
            }
        })
        .catch((error) => console.error("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ®ØµÙŠØµ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:", error));
}

// Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„
// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
// ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø¹Ø§Ù… Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„



// Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
function toggleOrdersPanel() {
  const panel = document.getElementById("ordersPanel");

  if (!panel.classList.contains("show")) {
    panel.classList.add("show");
    console.log("âœ… ØªÙ… ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª.");
    fetchPendingOrders();
  } else {
    panel.classList.remove("show");
    console.log("âŒ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª.");
  }
}



// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù…Ù† Firebase ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø©
function fetchPendingOrders() {
  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
  const ordersList = document.getElementById("ordersList");
  ordersList.innerHTML = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…

  firebase.database().ref("workRequests")
    .orderByChild("status").equalTo("pending")
    .once("value", function(snapshot) {
      if (!snapshot.exists()) {
        ordersList.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>";
        console.log("No pending orders found.");
        updateOrdersBadge(0);
        return;
      }

      let orders = [];
      snapshot.forEach(function(childSnapshot) {
        const order = childSnapshot.val();
        order.orderId = childSnapshot.key;
        orders.push(order);
      });

      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙØ±Ø²
      applySearchAndSort(orders);
    }, function(error) {
      console.error("Error fetching pending orders:", error);
    });
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙØ±Ø² ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
// Ø¯Ø§Ù„Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙØ±Ø² ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
function applySearchAndSort(orders) {
  const searchValue = document.getElementById('orderSearch').value.toLowerCase();
  const sortBy = document.getElementById('orderSort').value;
  const threeDaysInMs = 3 * 24 * 60 * 60 * 1000; // 3 Ø£ÙŠØ§Ù… Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©

  // ØªØµÙÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙˆÙ‚Øª
  let filteredOrders = orders.filter(order => {
    // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ Ø£Ùˆ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©
    const matchesSearch = order.workType.toLowerCase().includes(searchValue) ||
                          (order.region && order.region.toLowerCase().includes(searchValue));
    if (!matchesSearch) return false;

    // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø£Ùˆ Ù…Ù‚Ø¨ÙˆÙ„Ø©
    if (order.status === "pending" || order.status === "accepted") {
      return true;
    }
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…ÙƒØªÙ…Ù„ØŒ ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡ Ø¥Ø°Ø§ Ù…Ø¶Ù‰ Ø¹Ù„ÙŠÙ‡ Ø£Ù‚Ù„ Ù…Ù† 3 Ø£ÙŠØ§Ù…
    if ((order.status === "finished" || order.status === "completed") && order.completedAt) {
      return (Date.now() - order.completedAt) < threeDaysInMs;
    }
    return false;
  });

  // ÙØ±Ø² Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
  if (sortBy === 'timestamp') {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… submittedAt Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯ØŒ Ø£Ùˆ fallback Ø¥Ù„Ù‰ timestamp
    filteredOrders.sort((a, b) => (b.submittedAt || b.timestamp || 0) - (a.submittedAt || a.timestamp || 0));
  } else if (sortBy === 'distance') {
    filteredOrders.sort((a, b) => {
      const distA = calculateDistance(window.currentWorkerLocation, a.location);
      const distB = calculateDistance(window.currentWorkerLocation, b.location);
      return distA - distB;
    });
  } else if (sortBy === 'status') {
    filteredOrders.sort((a, b) => a.status.localeCompare(b.status));
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ù†ØµØ± ordersList
  const ordersList = document.getElementById("ordersList");
  ordersList.innerHTML = "";
  filteredOrders.forEach(function(order) {
    const orderItem = document.createElement("div");
    orderItem.className = "orderItem";

    // Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
    let statusIcon = "";
    if (order.status === "pending") {
      statusIcon = '<i class="fas fa-hourglass-half" style="color:orange;"></i>';
    } else if (order.status === "accepted") {
      statusIcon = '<i class="fas fa-check-circle" style="color:green;"></i>';
    } else if (order.status === "finished" || order.status === "completed") {
      statusIcon = '<i class="fas fa-flag-checkered" style="color:blue;"></i>';
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ÙˆÙ…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ù„Ø¨
    const distance = calculateDistance(window.currentWorkerLocation, order.location).toFixed(2);

    // Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…ÙƒØªÙ…Ù„
    const displayStatus = order.status === "pending" ? "ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø±" :
                          (order.status === "finished" || order.status === "completed" ? "ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡" : order.status);

                          orderItem.innerHTML = `
  <p><strong>ÙˆÙ‚Øª Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…:</strong> ${order.submittedAt ? new Date(order.submittedAt).toLocaleString() : "ØºÙŠØ± Ù…ØªÙˆÙØ±"} ${statusIcon}</p>
  <p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„:</strong> ${order.workType || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</p>
  <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${displayStatus}</p>
  <p><strong>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:</strong> ${order.budget || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©"}</p>
  <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${order.description || "ØºÙŠØ± Ù…ØªÙˆÙØ±"}</p>
  <p><strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> ${distance} ÙƒÙ…</p>
  ${order.media && Array.isArray(order.media) && order.media.length > 0 ?
    `<div class="orderImagesContainer" style="max-width:100%; overflow-x:auto; white-space:nowrap; padding:5px;">
       ${order.media.map((url, index) => `<img src="${url.startsWith("http") ? url : "https://yourdomain.com" + url}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ù„Ø¨" style="width:18%; height:auto; margin-right:2%; cursor:pointer;" data-media='${JSON.stringify(order.media)}' data-index="${index}" onclick="openOrderImageModal(this)">`).join('')}
     </div>` : ""}
  <button onclick='handleShowJobDetails(${JSON.stringify(order).replace(/"/g, "&quot;")})'>Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
`;


    ordersList.appendChild(orderItem);
  });

  updateOrdersBadge(filteredOrders.length);
}

// Ø¯Ø§Ù„Ø© Ù„ÙØªØ­ Ø§Ù„ØµÙˆØ± ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªÙ†Ù‚Ù„
function openOrderImageModal(element) {
  try {
    const mediaArray = JSON.parse(element.getAttribute("data-media"));
    const index = parseInt(element.getAttribute("data-index"), 10);

    if (!Array.isArray(mediaArray) || mediaArray.length === 0) {
      console.error("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨.");
      return;
    }

    modalMediaArray = mediaArray;
    modalCurrentIndex = index;

    console.log("ØªÙ… ÙØªØ­ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± - Ø§Ù„ÙÙ‡Ø±Ø³:", modalCurrentIndex, "Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙˆØ±:", modalMediaArray);

    openImageModal(modalCurrentIndex);
  } catch (error) {
    console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±:", error);
  }
}

document.addEventListener("DOMContentLoaded", function() {
  // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
  document.querySelectorAll('.orderImagesContainer').forEach(container => {
    let touchStartX = 0;
    let touchEndX = 0;
    const swipeThreshold = 50; // Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠÙƒØ³Ù„Ø§Øª Ù„ØªØ­Ø¯ÙŠØ¯ Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ø­Ø¨

    container.addEventListener('touchstart', function(event) {
      touchStartX = event.changedTouches[0].screenX;
    }, false);

    container.addEventListener('touchend', function(event) {
      touchEndX = event.changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;
      if (diff > swipeThreshold) {
        // Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø±: Ø­Ø±Ùƒ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù„Ù„ÙŠÙ…ÙŠÙ†
        container.scrollLeft += 100;
      } else if (diff < -swipeThreshold) {
        // Ø³Ø­Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ†: Ø­Ø±Ùƒ Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù„Ù„ÙŠØ³Ø§Ø±
        container.scrollLeft -= 100;
      }
    }, false);
  });
});



// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙˆØ±
function showPreviousImage() {
  if (modalMediaArray.length > 0) {
    modalCurrentIndex = (modalCurrentIndex - 1 + modalMediaArray.length) % modalMediaArray.length;
    updateModalImage();
  }
}

function showNextImage() {
  if (modalMediaArray.length > 0) {
    modalCurrentIndex = (modalCurrentIndex + 1) % modalMediaArray.length;
    updateModalImage();
  }
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
function updateModalImage() {
  const modalImg = document.getElementById('modalImage');
  let url = modalMediaArray[modalCurrentIndex];
  modalImg.src = url.startsWith("http") ? url : `https://yourdomain.com${url}`;
}

// Ø¥Ø¶Ø§ÙØ© Ù†Ø§ÙØ°Ø© Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ Ø§Ù„Ù€ HTML Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", function () {
  const modalHTML = `
    <div id="imageModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:9999;">
      <button id="prevBtn" style="position:absolute; left:20px; background:transparent; border:none; font-size:2em; color:#fff; cursor:pointer;">&#10094;</button>
      <img id="modalImage" src="" alt="Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©" style="max-width:90%; max-height:90%; border: 5px solid #fff; border-radius:5px;">
      <button id="nextBtn" style="position:absolute; right:20px; background:transparent; border:none; font-size:2em; color:#fff; cursor:pointer;">&#10095;</button>
    </div>
  `;
  document.body.insertAdjacentHTML("beforeend", modalHTML);

  document.getElementById('prevBtn').addEventListener("click", showPreviousImage);
  document.getElementById('nextBtn').addEventListener("click", showNextImage);
  document.getElementById('imageModal').addEventListener("click", function (e) {
    if (e.target.id === 'imageModal') {
      this.style.display = 'none';
    }
  });
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª (event listeners) Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ø²
document.getElementById('orderSearch').addEventListener('input', function() {
  fetchPendingOrders();
  console.log("ğŸ” ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.");
});
document.getElementById('orderSort').addEventListener('change', function() {
  fetchPendingOrders();
  console.log("ğŸ“Š ØªÙ… ØªØºÙŠÙŠØ± Ø®ÙŠØ§Ø± Ø§Ù„ÙØ±Ø² ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª.");
});


// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø±Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¹Ù„Ù‰ Ø²Ø± "Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª"
function updateOrdersBadge(count) {
  const badge = document.getElementById("ordersBadge");
  badge.textContent = count > 0 ? count : "";
}

// Ø¯Ø§Ù„Ø© Ù„Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡ ÙÙŠ Firebase
function acceptOrder(orderId) {
  firebase.database().ref("workRequests/" + orderId).update({ status: "accepted" })
    .then(function() {
      alert("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨");
      console.log("Order " + orderId + " accepted.");
      fetchPendingOrders(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„
    })
    .catch(function(error) {
      console.error("Error accepting order:", error);
    });
}


function openNegotiationForm(requestId) {
    console.log("ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ÙˆØ¶ Ù„Ù„Ø·Ù„Ø¨:", requestId);
    document.getElementById("negotiationPopup").style.display = "block";
    window.currentNegotiationRequestId = requestId; // Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù ÙÙŠ Ù…ØªØºÙŠØ± Ø¹Ø§Ù…
}


function closeNegotiationForm() {
    document.getElementById('negotiationPopup').style.display = 'none';
}

function isValidNegotiationMessage(message) {
    const phoneRegex = /\d{8,}/; // Ù…Ù†Ø¹ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ØªØ´Ø¨Ù‡ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ
    return !phoneRegex.test(message);
}











// Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener("click", function(event) {
  const panel = document.getElementById("ordersPanel");
  const toggleButton = document.getElementById("toggleOrdersButton");
  if (panel.style.display === "block" && !panel.contains(event.target) && !toggleButton.contains(event.target)) {
    panel.style.display = "none";
    console.log("Orders panel hidden due to outside click.");
  }
});

// Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª" Ø¨Ø§Ù„Ø¯Ø§Ù„Ø©
document.getElementById("toggleOrdersButton").addEventListener("click", function(event) {
  event.stopPropagation(); // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù„ÙˆØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¯Ø§Ø®Ù„Ù‡Ø§
  toggleOrdersPanel();
});






function sendNotificationToNearbyWorkers(requestData, userLocation) {
    const radius = 15;  // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± Ø¥Ù„Ù‰ 15 ÙƒÙ…
    console.log("ØªÙ… Ø¶Ø¨Ø· Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± Ø¹Ù„Ù‰:", radius, "ÙƒÙ…");
    // Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¹Ù…Ø§Ù„ ÙÙŠ Firebase
    const workersRef = database.ref('workers');
    workersRef.once('value', (snapshot) => {
        snapshot.forEach((workerSnapshot) => {
            const worker = workerSnapshot.val();
            if (!worker || !worker.location) {
                console.error("ğŸš¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ§Ù„Ø­:", workerSnapshot.key);
                return;
            }
            const distance = calculateDistance(userLocation, worker.location);
            console.log(`Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerSnapshot.key}: ${distance.toFixed(2)} ÙƒÙ…`);
            console.log("Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…ÙØ±Ø³Ù„:", userLocation, "ÙˆÙ…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„:", worker.location);
    
            if (distance <= radius) {
                console.log(`ğŸ“¢ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerSnapshot.key} Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ ÙˆØ³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±.`);
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Pusher Beams
                sendPusherNotification(workerSnapshot.key, `Ø·Ù„Ø¨ ${requestData.workType} ÙÙŠ Ù…Ù†Ø·Ù‚ØªÙƒ.`, "Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­!");
            } else {
                console.warn(`âš ï¸ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerSnapshot.key} Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„Ù€ 15 ÙƒÙ….`);
            }
        });
    });
}







if (!window.activeListeners) {
    window.activeListeners = {}; // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙƒØ§Ø¦Ù† Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ†
}


function startTracking(workerId) {
    const workerLocationRef = database.ref(`workers/${workerId}/location`);
    if (window.activeListeners[workerId]) {
        console.warn(`âš ï¸ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId} Ù…Ø¶Ø§Ù Ø¨Ø§Ù„ÙØ¹Ù„.`);
        return;
    }
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¬Ø¹ Ø®Ø§Øµ Ù„ÙƒÙ„ Ø¹Ø§Ù…Ù„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… workerId
    const currentWorkerRef = database.ref(`workers/${workerId}`);
    currentWorkerRef.on('value', (snapshot) => {
        const data = snapshot.val();
        const location = data && data.location;
        if (location && location.lat && location.lng) {
            console.log(`ğŸ¤·â€â™‚ï¸ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId}:`, location);
            waitUntilMapReady()
                .then(() => {
                    updateWorkerMarker(location, workerId);
                })
                .catch((err) => {
                    console.error("âš ï¸ 2: Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ù…Ù‡ÙŠØ£Ø© Ø£Ùˆ Ø§Ù„Ù†Ù…Ø· ØºÙŠØ± Ù…Ø­Ù…Ù„.", err);
                });
        } else {
            console.error(`ğŸš¨ 83 Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„ ${workerId} ØºÙŠØ± ØµØ­ÙŠØ­Ø©:`, location);
        }
    });
    
    window.activeListeners[workerId] = true;
}




// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¹Ø§Ù…Ù„
function showWorkerNotification(message) {
    var notificationDiv = document.getElementById("workerNotification");
    if (notificationDiv) {
        notificationDiv.innerText = message;
        notificationDiv.style.display = "block";
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
        setTimeout(function() {
            notificationDiv.style.display = "none";
        }, 5000);
    }
}







    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ÙƒÙ„ Ø¹Ø§Ù…Ù„
    function updateWorkerMarker(location, workerId) {
    waitUntilMapReady()
        .then(() => {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (!window.workerMarkers) {
                window.workerMarkers = {};
            }
            try {
                // Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                if (!window.workerMarkers[workerId]) {
                    window.workerMarkers[workerId] = new mapboxgl.Marker({ color: 'green' })
    .setLngLat([location.lng, location.lat])
    .addTo(map);

                    console.log(`âœ”ï¸ 17 ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}.`);
                } else {
                    window.workerMarkers[workerId].setLngLat([location.lng, location.lat]);
                    console.log(`âœ”ï¸ 15 ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}.`);
                }
            } catch (error) {
                console.error(`ğŸš¨ 16 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø¹Ø§Ù…Ù„ ${workerId}:`, error);
            }
        })
        .catch((err) => {
            console.error("âš ï¸ 18 Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù… ØªØ¬Ù‡Ø² Ø¨Ø¹Ø¯:", err);
        });
}









    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Mapbox
    if (typeof mapboxgl === 'undefined') {
        console.error("Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Mapbox Ø¨Ù†Ø¬Ø§Ø­.");
    } else {
        console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Mapbox Ø¨Ù†Ø¬Ø§Ø­:", mapboxgl);
    }

        // Ù…ÙØªØ§Ø­ Mapbox
        const mapboxToken = "pk.eyJ1IjoiY2hvb3NlbWUiLCJhIjoiY20wZnVpemI2MHpreTJqcjR4ZThuam9pYyJ9.F1CjHrnJ7m-VwM_LHt0Q9Q";
        mapboxgl.accessToken = mapboxToken;

        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ø®Ø±ÙŠØ·Ø©
        const styles = {
    streets: 'mapbox://styles/mapbox/streets-v11',
    satellite: 'mapbox://styles/mapbox/satellite-v9',
    outdoors: 'mapbox://styles/mapbox/outdoors-v11',
    hybrid: 'mapbox://styles/mapbox/satellite-streets-v11',
    dark: 'mapbox://styles/mapbox/dark-v10',
    light: 'mapbox://styles/mapbox/light-v10'
};





        function initializeMap() {
    console.log("ğŸ”„ 110 Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©...");

    try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¯ ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
        if (typeof map !== 'undefined' && map instanceof mapboxgl.Map) {
            console.warn("âš ï¸ 117 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„. Ù„Ù† ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§.");
            return;
        }

        // ØªÙØ±ÙŠØº Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            mapContainer.innerHTML = '';
        } else {
            console.error("ğŸš¨ 118 Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± 'map'. ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ DOM.");
            return;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù† "Ø§Ù„ÙØ¶Ø§Ø¡"
map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/satellite-streets-v11',
  center: [0, 0],  // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ù† Ù…Ø±ÙƒØ² Ø§Ù„Ø£Ø±Ø¶
  zoom: 0.8,       // Ø±Ø¤ÙŠØ© Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ© Ù…Ù† Ø§Ù„ÙØ¶Ø§Ø¡ Ø§Ù„Ø¨Ø¹ÙŠØ¯
  projection: 'globe',
  maxBounds: [[-180, -85], [180, 85]], // Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©
  interactive: true, // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù„Ù…Ø³ÙŠ
  attributionControl: false // Ø¥Ø²Ø§Ù„Ø© Ø´Ø¹Ø§Ø± Mapbox Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
});

// ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¬Ø¹Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø¹ Ø£Ø®Ù
map.on('style.load', () => {
  map.setFog({
    range: [1, 8],  // ØªÙ‚Ù„ÙŠÙ„ Ù…Ø¯Ù‰ Ø§Ù„Ø¶Ø¨Ø§Ø¨ Ø­ØªÙ‰ ÙŠØ¸Ù‡Ø± Ø§Ù„ÙØ¶Ø§Ø¡ Ø¨ÙˆØ¶ÙˆØ­
    color: 'rgba(10, 10, 25, 0.5)', // Ø¬Ø¹Ù„ Ù„ÙˆÙ† Ø§Ù„ØºÙ„Ø§Ù Ø§Ù„Ø¬ÙˆÙŠ Ø¯Ø§ÙƒÙ†Ù‹Ø§ Ø£ÙƒØ«Ø± Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„ÙØ¶Ø§Ø¡
  });
});

// ØªÙ†ÙÙŠØ° ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ­Ø±Ùƒ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø¹ ØªØ£Ø®ÙŠØ± Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø±Ø¤ÙŠØ© Ø§Ù„Ø£Ø±Ø¶ Ù…Ù† Ø§Ù„ÙØ¶Ø§Ø¡
map.on('load', () => {
  waitUntilMapReady().then(() => {
    setTimeout(() => {
      map.flyTo({
        center: [13.1913, 32.8872], // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø·Ø±Ø§Ø¨Ù„Ø³
        zoom: window.innerWidth < 768 ? 9 : 12, // ØªÙ‚Ø±ÙŠØ¨ Ø£Ù‚Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ
        pitch: window.innerWidth < 768 ? 30 : 60, // Ø²Ø§ÙˆÙŠØ© Ù…ÙŠÙ„ Ø£Ù‚Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
        bearing: 45, // Ø¯ÙˆØ±Ø§Ù† Ù„Ø·ÙŠÙ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø±ÙƒØ©
        speed: 0.3, // Ø­Ø±ÙƒØ© Ø¨Ø·ÙŠØ¦Ø© Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ
        curve: 2.2, // Ù…Ù†Ø­Ù†Ù‰ Ø³Ù„Ø³ Ù„Ù„Ø­Ø±ÙƒØ©
        easing: t => t * t // Ø­Ø±ÙƒØ© ØªØ®ÙÙŠÙ ØªØ¯Ø±ÙŠØ¬ÙŠØ©
      });
    }, 2000); // ØªØ£Ø®ÙŠØ± Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ 2.5 Ø«Ø§Ù†ÙŠØ© Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø±Ø¤ÙŠØ© Ø§Ù„Ø£Ø±Ø¶ Ù…Ù† Ø§Ù„ÙØ¶Ø§Ø¡
  });
});

// ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù„Ù…Ø³ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
if (window.innerWidth < 768) {
  map.touchZoomRotate.enable(); // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙƒØ¨ÙŠØ± ÙˆØ§Ù„ØªØ¯ÙˆÙŠØ± Ø¨Ø§Ù„Ù„Ù…Ø³
  map.doubleClickZoom.disable(); // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¨Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
}




// ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
map.on('style.load', () => {
    map.setFog({}); // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¶Ø¨Ø§Ø¨ Ù„ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø¶ÙŠØ©
});


        let retryCount = 0; // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
        const maxRetries = 3; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª

        function handleMapLoad() {
            console.log('32 ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… handleMapLoad.');

            if (map.isStyleLoaded()) {
                isMapReady = true;
                console.log("ğŸ‰ 3 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© ÙˆØ§Ù„Ù†Ù…Ø· Ù…Ø­Ù…Ù„. ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¢Ù† Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£Ùˆ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª.");
                addMarkersToMap();
            } else if (retryCount < maxRetries) {
                console.warn(`âš ï¸ 4 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø·. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© (${retryCount + 1}/${maxRetries}) Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù...`);
                retryCount++;
                setTimeout(handleMapLoad, 5000);
            } else {
                console.error("ğŸš¨ 23 ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø¨Ø¹Ø¯ Ø§Ø³ØªÙ†ÙØ§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª.");
                alert("âš ï¸ 24 Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
            }
        }

        map.on('load', () => {
            console.log("âš¡109 ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ map.on('load').");

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± isMapReady
            if (typeof isMapReady === 'undefined') {
                console.error("ğŸš¨ 76 Ø§Ù„Ù…ØªØºÙŠØ± isMapReady ØºÙŠØ± Ù…Ù‡ÙŠØ£ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.");
                return;
            }

            if (map.isStyleLoaded()) {
                isMapReady = true;
                isMapInitialized = true;
                console.log("ğŸ‰ 47 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© ÙˆØ§Ù„Ù†Ù…Ø· Ù…Ø­Ù…Ù„.");
               
         // Ù‡Ù†Ø§ Ù†Ø¶ÙŠÙ console.log Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        console.log("âœ… 158 isMapReady:", isMapReady, "isMapInitialized:", isMapInitialized);

                processSavedRequests();
            } else {
                console.warn("âš ï¸ 59 Ø§Ù„Ù†Ù…Ø· Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
                handleMapLoad();
            }

            console.log("âš™ï¸ 78 Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...");
        });

        map.on('error', (e) => {
            console.error("ğŸš¨ 112 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", e);
        });

    } catch (error) {
        console.error("ğŸš¨ 113 Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:", error);
    }
}







function ensureMapInitialized() {
    if (!isMapInitialized) {
        console.log("ğŸ”„ 82 Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©...");
        initializeMap();
        isMapInitialized = true;
    } else {
        console.log("âœ… 83 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
    }
}



// ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø©Ù‹
let orderActive = false;  // ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
let orderCanceled = false; // ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¹Ù†Ø¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨

document.addEventListener('DOMContentLoaded', () => {

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ localStorage ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§
    const storedStatus = localStorage.getItem('orderStatus');
    const storedRequestId = localStorage.getItem('currentRequestId');
    if (storedStatus && storedRequestId && storedStatus === 'canceled_by_worker') {
        // Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØªØ¬Ù†Ø¨ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«
        orderCanceled = true;
        orderActive = false;
        document.getElementById('cancelJobContainer').style.display = 'none';
        console.log("ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù„ØºØ§Ø¡ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ.");
    }
    
    console.log("âœ”ï¸ 120 ØªÙ… ØªØ­Ù…ÙŠÙ„ DOM Ø¨Ù†Ø¬Ø§Ø­. Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...");

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Firebase Ùˆ Mapbox
    if (typeof firebase === 'undefined' || typeof mapboxgl === 'undefined') {
        console.error("ğŸš¨ 165 Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Firebase Ø£Ùˆ Mapbox. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ÙˆØ§Ø¨Ø·.");
        return;
    }
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„
    if (!isMapInitialized) {
        console.log("ğŸ”„ 168 Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø©...");
        initializeMap();
        isMapInitialized = true;
    } else {
        console.log("âœ… 169 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
    }

    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
    const acceptJobButton = document.getElementById('acceptJobButton');
    const locateButton = document.getElementById('locateButton');
    const styleSelector = document.getElementById('styleSelector');
    const loginButton = document.getElementById('loginWorkerButton');

    if (!acceptJobButton || !locateButton || !styleSelector || !loginButton) {
        console.error("ğŸš¨ 170 Ø¨Ø¹Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ DOM. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.");
        return;
    }

    styleSelector.addEventListener('change', function () {
        const selectedStyle = this.value;
        if (styles[selectedStyle]) {
            map.setStyle(styles[selectedStyle]);
            console.log(`âœ”ï¸ 171 ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø· Ø¥Ù„Ù‰: ${selectedStyle}`);
        } else {
            console.error(`âš ï¸ 172 Ø§Ù„Ù†Ù…Ø· "${selectedStyle}" ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ.`);
        }
    });

    loginButton.addEventListener('click', () => {
        const workerId = document.getElementById('workerLoginId').value;
        if (workerId) {
            console.log(`ğŸ”µ 173 Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¹Ø§Ù…Ù„: ${workerId}`);
            loginWorker(workerId);
        } else {
            console.warn('âš ï¸ 174 ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„.');
            alert('âš ï¸ 175 ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„.');
        }
    });
});













if (!isMapInitialized) {
    console.log(" 146 ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©.");
    initializeMap();
    isMapInitialized = true;
} else {
    console.log(" 147 Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ù‡ÙŠØ£Ø© Ø¨Ø§Ù„ÙØ¹Ù„.");
}



function handleOrderMarkerClick(orderData) {
    console.log("handleOrderMarkerClick: ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø·Ù„Ø¨", orderData);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ Ù„Ù„Ø¯Ø®ÙˆÙ„
    if (!currentWorkerId) {
        console.error("handleOrderMarkerClick: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª");
        // ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
        document.getElementById('loginPopup').style.display = 'flex';
        return;
    }
    
    console.log("handleOrderMarkerClick: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ØŒ currentWorkerId =", currentWorkerId);
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
    showJobDetails(orderData);
}

function hexToRGBA(hex, alpha) {
  const bigint = parseInt(hex.substring(1), 16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}

// Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„ Ù„Ù…Ø³Ø§ÙØ© Ù…Ø¹ÙŠÙ†Ø© (1000 Ù…ØªØ±) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙƒØ¨ÙŠØ±
function calculatePixelRadius(meters, latitude, zoom) {
  const metersPerPixel = 156543.03392 * Math.cos(latitude * Math.PI / 180) / Math.pow(2, zoom);
  return meters / metersPerPixel;
}

function addMarkersToMap() {
  const requestsRef = database.ref('workRequests');
  let initialLoadCompleted = false;
  const threshold = 12; // Ø¹ØªØ¨Ø© Ø§Ù„ØªÙƒØ¨ÙŠØ± Ù„ØªØ«Ø¨ÙŠØª Ø­Ø¬Ù… Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø²ÙˆÙ… Ø§Ù„Ø¨Ø¹ÙŠØ¯

  // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
  requestsRef.once('value', () => {
    initialLoadCompleted = true;
  });

  requestsRef.on('child_added', (data) => {
    waitUntilMapReady()
      .then(() => {
        const request = data.val();
        const key = data.key;

        if (request && request.location && request.location.lng && request.location.lat) {
          try {
            function getMarkerColor(status) {
              if (status === 'pending') return '#1E90FF';
              else if (status === 'accepted' || status === 'in_progress') return '#FFC107';
              else if (status === 'finished' || status === 'completed') return '#28a745';
              else if (status === 'error' || status === 'failed') return '#DC3545';
              return '#1E90FF';
            }

            const offset = 300 / (111320 * Math.cos(request.location.lat * Math.PI / 180));
            const shiftedCoordinates = [request.location.lng + offset, request.location.lat];

            const geojson = {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: shiftedCoordinates
              }
            };

            const sourceId = 'request-circle-' + key;
            const layerId = 'request-circle-layer-' + key;

            if (!map.getSource(sourceId)) {
              map.addSource(sourceId, {
                type: 'geojson',
                data: geojson
              });

              map.addLayer({
                id: layerId,
                type: 'circle',
                source: sourceId,
                paint: {
                  'circle-radius': 0,
                  'circle-color': hexToRGBA(getMarkerColor(request.status), 0.2),
                  'circle-stroke-color': hexToRGBA(getMarkerColor(request.status), 0.5),
                  'circle-stroke-width': 2
                }
              });
            }

            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø·
            if (!window.requestMarkers) {
              window.requestMarkers = {};
            }
            window.requestMarkers[key] = {
              sourceId: sourceId,
              layerId: layerId,
              lat: request.location.lat,
              geojson: geojson,
              status: request.status
            };

            const pulseEl = document.createElement('div');
            pulseEl.classList.add('pulse-marker');
            pulseEl.style.width = '100px';
            pulseEl.style.height = '100px';
            pulseEl.style.background = 'transparent';
            pulseEl.style.border = 'none';
            pulseEl.style.position = 'absolute';
            pulseEl.style.transform = 'translate(-50%, -50%)';

            const pulseMarker = new mapboxgl.Marker({
              element: pulseEl,
              anchor: 'center',
              interactive: false
            }).setLngLat(shiftedCoordinates)
              .addTo(map);

            window.requestMarkers[key].pulseMarker = pulseMarker;

            map.on('click', layerId, (e) => {
              if (!initialLoadCompleted) return;
              currentRequestId = key;
              firebase.database().ref('workRequests/' + key).once('value')
                .then((snapshot) => {
                  const updatedRequest = snapshot.val();
                  handleOrderMarkerClick(updatedRequest);
                })
                .catch((error) => {
                  console.error('âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨:', error);
                  alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨.');
                });
            });

            // ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ù… Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§
            updateMarkerSize(key);

            firebase.database().ref(`workRequests/${key}/status`).on('value', (snapshot) => {
              const updatedStatus = snapshot.val();
              if (window.requestMarkers[key]) {
                map.setPaintProperty(window.requestMarkers[key].layerId, 'circle-color', hexToRGBA(getMarkerColor(updatedStatus), 0.2));
                map.setPaintProperty(window.requestMarkers[key].layerId, 'circle-stroke-color', hexToRGBA(getMarkerColor(updatedStatus), 0.5));
              }
            });
          } catch (error) {
            console.error('ğŸš¨ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:', error);
          }
        } else {
          console.warn('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± ØµØ­ÙŠØ­:', key);
        }
      })
      .catch((err) => {
        console.error('âš ï¸ 19: Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø£Ùˆ Ø§Ù„Ù†Ù…Ø· ØºÙŠØ± Ù…Ø­Ù…Ù„. Ù„Ù† ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©.', err);
        return;
      });
  });
}

function updateMarkerSize(key) {
  const threshold = 12;
  const marker = window.requestMarkers[key];
  if (marker) {
    const currentZoom = map.getZoom();
    const effectiveZoom = currentZoom < threshold ? threshold : currentZoom;
    const pixelRadius = calculatePixelRadius(1000, marker.lat, effectiveZoom);
    // ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ù… Ø§Ù„Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©
    map.setPaintProperty(marker.layerId, 'circle-radius', pixelRadius);
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ù… Ø¹Ù†ØµØ± Ø§Ù„Ù†Ø¨Ø¶Ø© Ø¨Ø­ÙŠØ« ØªÙƒÙˆÙ† Ù†Ø³Ø¨Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
    if (marker.pulseMarker) {
      const pulseEl = marker.pulseMarker.getElement();
      // ØªØ­Ø¯ÙŠØ¯ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¨Ø¶Ø© (Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ù†Ø¬Ø¹Ù„ Ø§Ù„Ù‚Ø·Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù†Ø¨Ø¶Ø© Ø­ÙˆØ§Ù„ÙŠ 2.2 Ø¶Ø¹Ù Ù†ØµÙ Ø§Ù„Ù‚Ø·Ø± Ù„Ù„Ø¯Ø§Ø¦Ø±Ø©)
      const newDiameter = pixelRadius * 2.2; 
      pulseEl.style.width = newDiameter + 'px';
      pulseEl.style.height = newDiameter + 'px';
      pulseEl.style.transform = 'translate(-50%, -50%)';
    }
  }
}


map.on('zoom', function() {
  const threshold = 12;
  for (let key in window.requestMarkers) {
    if (window.requestMarkers.hasOwnProperty(key)) {
      updateMarkerSize(key);
    }
  }
});

// Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†Ù…Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù†Ø³ØªØ®Ø¯Ù… Ø­Ø¯Ø« "style.load" Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ§Ø¯Ø± ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª
map.on('style.load', function() {
  if (window.requestMarkers) {
    Object.keys(window.requestMarkers).forEach(key => {
      const marker = window.requestMarkers[key];
      if (!map.getSource(marker.sourceId)) {
        map.addSource(marker.sourceId, {
          type: 'geojson',
          data: marker.geojson
        });
      }
      if (!map.getLayer(marker.layerId)) {
        map.addLayer({
          id: marker.layerId,
          type: 'circle',
          source: marker.sourceId,
          paint: {
            'circle-radius': calculatePixelRadius(1000, marker.lat, map.getZoom()),
            'circle-color': hexToRGBA((function(status) {
              if (status === 'pending') return '#1E90FF';
              else if (status === 'accepted' || status === 'in_progress') return '#FFC107';
              else if (status === 'finished' || status === 'completed') return '#28a745';
              else if (status === 'error' || status === 'failed') return '#DC3545';
              return '#1E90FF';
            })(marker.status), 0.2),
            'circle-stroke-color': hexToRGBA((function(status) {
              if (status === 'pending') return '#1E90FF';
              else if (status === 'accepted' || status === 'in_progress') return '#FFC107';
              else if (status === 'finished' || status === 'completed') return '#28a745';
              else if (status === 'error' || status === 'failed') return '#DC3545';
              return '#1E90FF';
            })(marker.status), 0.5),
            'circle-stroke-width': 2
          }
        });
      }
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¬Ù… Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©
      updateMarkerSize(key);
    });
  }
});










// NEW CODE: Ù…Ø³ØªÙ…Ø¹ Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø§Ø±ÙƒØ± Ø¹Ù†Ø¯ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Firebase
database.ref('workRequests').on('child_removed', (snapshot) => {
    const removedRequestId = snapshot.key;
    console.log(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ ${removedRequestId} Ù…Ù† Firebase.`);
    if (window.requestMarkers && window.requestMarkers[removedRequestId]) {
        window.requestMarkers[removedRequestId].remove();
        delete window.requestMarkers[removedRequestId];
        console.log(`ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø·Ù„Ø¨ ${removedRequestId} Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©.`);
    } else {
        console.warn(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø·Ù„Ø¨ ${removedRequestId} Ù„Ø¥Ø²Ø§Ù„ØªÙ‡.`);
    }
});


// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¹Ù‚Ø¯ Ø§Ù„ØªÙØ§ÙˆØ¶ ÙÙŠ Firebase
firebase.database().ref(`negotiations/${currentRequestId}`).on('value', (snapshot) => {
    const negotiationData = snapshot.val();
    if (negotiationData) {
        console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ§ÙˆØ¶:", negotiationData);
        // ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø§Ù…Ù„ Ù…Ø«Ù„Ø§Ù‹ Ø¨Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø£Ùˆ ØªØºÙŠÙŠØ± Ø²Ø± Ø§Ù„ØªÙØ§ÙˆØ¶
        updateNegotiationUI(negotiationData);
    }
});

function updateNegotiationUI(data) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ§ÙˆØ¶
    if (!data) {
         console.error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ§ÙˆØ¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
         return;
    }
    
    // Ù…Ø«Ø§Ù„: Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ "counter"ØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©
    if (data.status === 'counter') {
         alert("Ù„Ù‚Ø¯ Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø¹Ø± Ø¬Ø¯ÙŠØ¯.");
    }
    
    // ØªØ­Ø¯ÙŠØ« ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§
    const orderData = window.currentOrderData || {};
    const orderDescription = orderData.description ? orderData.description : "ØºÙŠØ± Ù…ØªÙˆÙØ±";
    document.getElementById("orderDescriptionWorker").innerText = "ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨: " + orderDescription;
    
    // ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©)
    document.getElementById("counterFinalPrice").innerText = data.proposedPrice || "";
    document.getElementById("counterFinalMessage").innerText = data.message || "";
}



// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨Ø­Ø«
const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    language: "ar",
    marker: true,
    mapboxgl: mapboxgl
});

if (typeof map === 'undefined') {
    console.error("Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ initializeMap Ø£ÙˆÙ„Ø§Ù‹.");
} else {
    map.addControl(geocoder);
}

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
const locateControl = new mapboxgl.GeolocateControl({
    positionOptions: {
        enableHighAccuracy: true
    },
    trackUserLocation: true,
    showUserHeading: true,
    fitBoundsOptions: {
        maxZoom: 18
    }
});

map.addControl(locateControl);


// Ù…ØªØºÙŠØ± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ²
let autoCenterEnabled = false;

// Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ" Ù†ÙØ¹Ù‘Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ²
const locateBtn = document.getElementById('locateButton');
if (!locateBtn) {
    console.error(" ğŸ”» 201 Ø¹Ù†ØµØ± locateButton ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
} else {
    locateBtn.addEventListener('click', () => {
        autoCenterEnabled = true; // ØªÙØ¹ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ² Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
        locateControl.trigger();
        console.log(" ğŸ”» 202 ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ ÙˆØªÙØ¹ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ².");
    });
}


// Ø¹Ù†Ø¯ Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§ØŒ Ù†ÙˆÙ‚Ù Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
map.on('dragstart', () => {
    if (autoCenterEnabled) {
        console.log(" ğŸ”»203 ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ² ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø³Ø¨Ø¨ Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§.");
    }
    autoCenterEnabled = false;
});

locateControl.on('geolocate', (e) => {
    console.log(" ğŸ”» ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ", e.coords);
    if (autoCenterEnabled) {
        map.flyTo({
            center: [e.coords.longitude, e.coords.latitude],
            zoom: 18,
            speed: 0.8,       // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø³Ø±Ø¹Ø© Ù„Ù†Ø¹ÙˆÙ…Ø© Ø£ÙØ¶Ù„
            curve: 1.5,       // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ù†Ø­Ù†Ø§Ø¡ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø­Ø±ÙƒØ©
            easing: function(t) { return t; }  // Ø¯Ø§Ù„Ø© ØªØ®ÙÙŠÙ Ø¨Ø³ÙŠØ·Ø© ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§
        });
    } else {
        console.log(" ğŸ”» Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ² Ù…Ø¹Ø·Ù„Ø©Ø› Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ­ÙƒÙ… ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø±Ø¶.");
    }
});


// Ø¹Ù†Ø¯ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† locateControlØŒ Ù†ÙØ¹ÙŠØ¯ Ø§Ù„ØªÙ…Ø±ÙƒØ² ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† autoCenterEnabled true
locateControl.on('geolocate', (e) => {
    console.log("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ", e.coords);
    if (autoCenterEnabled) {
        map.flyTo({
            center: [e.coords.longitude, e.coords.latitude],
            zoom: 18,
            speed: 0.8,
            curve: 1.5,
            easing: function(t) { return t; }
        });
    } else {
        console.log("Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙƒØ² Ù…Ø¹Ø·Ù„Ø©Ø› Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ­ÙƒÙ… ÙŠØ¯ÙˆÙŠÙ‹Ø§ ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø±Ø¶.");
    }
});


map.on('load', () => {
    console.log(" 28 ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ù†Ø¬Ø§Ø­.", { style: map.getStyle(), center: map.getCenter() });

    if (map && typeof map.isStyleLoaded === 'function' && map.isStyleLoaded()) {
        console.log("ğŸ‰ 29 Ù…Ø´ÙƒÙ„Ø© isStyleLoaded ØªÙ… Ø­Ù„Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„! Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ù…Ù„.");
        map.flyTo({ center: [13.1913, 32.8872], zoom: 10, speed: 0.2 });
        if (isMapReady) {
            addMarkersToMap(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¬Ø§Ù‡Ø²Ø©
        }
    } else {
        console.error("âš ï¸ 5 Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø© Ø£Ùˆ Ø§Ù„Ù†Ù…Ø· Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡.");
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
    map.addControl(locateControl);
});

// NEW CODE: Ù…Ø³ØªÙ…Ø¹ Ù„ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø¹Ù†Ø¯ Ø­Ø¯ÙˆØ« ØªØºÙŠÙŠØ±
database.ref('workRequests').on('child_changed', (snapshot) => {
    const updatedData = snapshot.val();
    const requestKey = snapshot.key;
    console.log(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ${requestKey}:`, updatedData);
    // ÙØªØ­ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙŠØªÙ… ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙŠØ®Øµ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙƒØ§Ù† "acceptedBy" ÙŠØ·Ø§Ø¨Ù‚ currentWorkerId
    if (currentRequestId === requestKey && updatedData.acceptedBy === currentWorkerId) {
        showJobDetails(updatedData);
    }
});







// Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒÙˆÙƒÙŠØ²
function setCookie(name, value, days) {
    let expires = "";
    if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "") + expires + "; path=/";
    console.log(`âœ”ï¸ ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙˆÙƒÙŠØ²: ${name} = ${value} Ù„Ù…Ø¯Ø© ${days} ÙŠÙˆÙ…`);
}

function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) {
            console.log(`âœ”ï¸ ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙƒÙˆÙƒÙŠØ²: ${name} = ${c.substring(nameEQ.length)}`);
            return c.substring(nameEQ.length);
        }
    }
    console.warn(`âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆÙƒÙŠØ²: ${name}`);
    return null;
}

// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ù…Ù† Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ index2.html
document.addEventListener("DOMContentLoaded", function () {
    const savedStyle = getCookie("mapStyle_index2"); // ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„ÙƒÙˆÙƒÙŠØ²
    if (savedStyle && styles[savedStyle]) {
        document.getElementById('styleSelector').value = savedStyle;
        if (map.isStyleLoaded()) {
            map.setStyle(styles[savedStyle]);
            console.log(`âœ”ï¸ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ù…Ù† Ø§Ù„ÙƒÙˆÙƒÙŠØ² (index2): ${savedStyle}`);
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ù†Ù…Ø· Ù…Ø­Ù…Ù„Ø§Ù‹ Ø¨Ø¹Ø¯ØŒ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø¯Ø« "style.load"
            map.once("style.load", () => {
                map.setStyle(styles[savedStyle]);
                console.log(`âœ”ï¸ ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ù…Ù† Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· (index2): ${savedStyle}`);
            });
        }
    }
});

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„ØªÙØ¶ÙŠÙ„ ÙÙŠ Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ index2.html
document.getElementById('styleSelector').addEventListener('change', function () {
    const selectedStyle = this.value;
    if (styles[selectedStyle]) {
        if (map.isStyleLoaded()) {
            map.setStyle(styles[selectedStyle]);
            setCookie("mapStyle_index2", selectedStyle, 30); // ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„ÙƒÙˆÙƒÙŠØ²
            console.log(`âœ”ï¸ ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø· Ø¥Ù„Ù‰: ${selectedStyle} ÙˆØ­ÙÙØ¸ ÙÙŠ ÙƒÙˆÙƒÙŠØ² index2`);
        } else {
            console.warn(`âš ï¸ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡.`);
        }
    } else {
        console.error(`âš ï¸ Ø§Ù„Ù†Ù…Ø· "${selectedStyle}" ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.`);
    }
});





// Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯
map.on('style.load', () => {
    if (window.currentRouteData) {
        if (!map.getSource('route')) {
            map.addLayer({
                id: 'route',
                type: 'line',
                source: {
                    type: 'geojson',
                    data: window.currentRouteData
                },
                layout: { 'line-join': 'round', 'line-cap': 'round' },
                paint: { 'line-color': '#3887be', 'line-width': 5 }
            });
            console.log("âœ”ï¸ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø·.");
        }
    }
});


// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (ÙŠØ¬Ø¨ Ø£Ù† ØªÙØ­Ø¯Ø¯ ÙÙŠ Ù…ÙƒØ§Ù† Ù…Ù†Ø§Ø³Ø¨ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ØŒ Ù…Ø«Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù)
// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
var currentRequestId = null;

// Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨
const acceptJobButton = document.getElementById('acceptJobButton');

if (acceptJobButton) {
    acceptJobButton.addEventListener('click', async () => {
        // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„Ù‰
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚Ø¨ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) {
            console.log("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
            return;
        }

        console.log("Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨...");

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        if (!currentRequestId) {
            console.error("Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨ Ù†Ø´Ø·.");
            return;
        }
        if (!currentWorkerId) {
            console.error("Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ø¹Ø§Ù…Ù„ ØºÙŠØ± Ù…ØªÙˆÙØ±. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
            alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨.");
            return;
        }
        if (activeRequestExists) {
            console.log("ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø³Ø§Ø¨Ù‚ Ø¨Ø§Ù„ÙØ¹Ù„. Ù„Ù† ÙŠØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.");
            alert("Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯.");
            return;
        }

        // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
        acceptJobButton.disabled = true;
        console.log("ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬.");

        try {
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„ØªÙ‡
            const snapshot = await firebase.database().ref('workRequests/' + currentRequestId).once('value');
            const request = snapshot.val();

            if (!request) {
                console.error("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
                alert("âŒ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
                acceptJobButton.disabled = false;
                return;
            }

            if (request.status !== 'pending') {
                alert("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø£Ù†Ù‡ Ù„Ù… ÙŠØ¹Ø¯ ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±.");
                console.error("Ø±ÙØ¶ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨: Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© " + request.status);
                acceptJobButton.disabled = false;
                return;
            }

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firebase
            await firebase.database().ref('workRequests/' + currentRequestId).update({
                status: 'accepted',
                acceptedBy: currentWorkerId
            });

// Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firebase ÙˆØ§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù†Ø¬Ø§Ø­
alert("âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.");
console.log(`ğŸ“¢ ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ ${currentRequestId} Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¹Ø§Ù…Ù„ ${currentWorkerId}`);

activeRequestExists = true;

// Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ´Ø±ÙŠØ· Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ø§Ù‹
document.getElementById('jobDetailsPopup').style.display = 'none';
document.getElementById('ordersPanel').style.display = 'none';

// Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ø«Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØªØ­Ø¯ÙŠØ« ETA ÙˆØºÙŠØ±Ù‡Ø§...
if (currentWorkerLocation && jobLocation) {
    if (typeof showRoute === "function") {
        showRoute(currentWorkerLocation, jobLocation);
        console.log("ğŸš— ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© showRoute Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ÙˆØ§Ù„Ù…Ø³Ø§ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©.");
    } else {
        console.error("âš ï¸ ÙˆØ¸ÙŠÙØ© showRoute ØºÙŠØ± Ù…Ø¹Ø±ÙØ©.");
    }
    startRealTimeETATracking(currentWorkerLocation, jobLocation);
} else {
    console.error("âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø¹Ø§Ù…Ù„ Ø£Ùˆ Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©.");
}


            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
            const distance = getWorkerDistance();
            if (distance >= 0.5) {
                document.getElementById('cancelJobContainer').style.display = 'block';
                console.log("ğŸ“ ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø£Ù† Ø§Ù„Ù…Ø³Ø§ÙØ©:", distance.toFixed(2), "ÙƒÙ…");
            } else {
                document.getElementById('cancelJobContainer').style.display = 'none';
                alert("âš ï¸ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù† ÙŠÙÙ„ØºÙ‰ Ø¥Ø°Ø§ Ø£ØµØ¨Ø­ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù‚Ø±ÙŠØ¨Ù‹Ø§ (Ø£Ù‚Ù„ Ù…Ù† 500 Ù…ØªØ±) Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
                console.log("ğŸš¨ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù‚Ø±ÙŠØ¨ Ø¬Ø¯Ù‹Ø§ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨. Ø§Ù„Ù…Ø³Ø§ÙØ©:", distance.toFixed(2), "ÙƒÙ…");
            }

            // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙ†ÙØ° Ø®Ù„Ø§Ù„ Ù…Ø¯Ø© Ù…Ø¹ÙŠÙ†Ø©
            const countdownElement = document.getElementById('countdownTimer');
            if (countdownElement) {
                startCountdown(3 * 60 * 60 * 1000, countdownElement, () => {
                    cancelRequestDueToTimeout(currentRequestId);
                });
            } else {
                console.error("âš ï¸ Ø¹Ù†ØµØ± 'countdownTimer' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©.");
            }

        } catch (error) {
            console.error("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨:", error);
            alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            acceptJobButton.disabled = false;
        }
    });
} else {
    console.error("ğŸš¨ Ø§Ù„Ø²Ø± 'acceptJobButton' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DOM.");
}












// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¹Ù…Ù„ ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… ØªØ¹Ø±ÙŠÙ map
if (typeof map !== 'undefined' && map instanceof mapboxgl.Map) {
    map.on('load', () => {
        console.log("âš¡50 ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ map.on('load').");
        checkMapStyleLoaded();
    });
} else {
    console.error("ğŸš¨ 51 Ø§Ù„ÙƒØ§Ø¦Ù† map ØºÙŠØ± Ù…Ù‡ÙŠØ£ Ø£Ùˆ ØºÙŠØ± Ù…Ø¹Ø±Ù‘Ù.");
}


        // ØªØ£ÙƒÙŠØ¯ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        document.getElementById('confirmYes').addEventListener('click', () => {
            const userLocation = map.getCenter();
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù„Ø§Ù…Ø© ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            new mapboxgl.Marker({ color: 'green' })
    .setLngLat(userLocation)
    .addTo(map);

            // Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
            document.getElementById('inputPopup').style.display = 'block';
            document.getElementById('confirmationPopup').style.display = 'none';
        });

        // Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©
        document.getElementById('confirmNo').addEventListener('click', () => {
            document.getElementById('confirmationPopup').style.display = 'none';
        });

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ø¥Ù„Ù‰ Firebase
        document.getElementById('submitInfo').addEventListener('click', () => {
            const name = document.getElementById('nameInput').value;
            const phone = document.getElementById('phoneInput').value;
            if (name && phone) {
                const markerData = {
                    name: name,
                    phone: phone,
                    location: {
                        lng: map.getCenter().lng,
                        lat: map.getCenter().lat
                    }
                };
                const markersRef = database.ref('markers');
                markersRef.push(markerData)
                    .then(() => {
                        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­.');
                        document.getElementById('inputPopup').style.display = 'none';
                        document.getElementById('nameInput').value = '';
                        document.getElementById('phoneInput').value = '';
                    })
                    .catch((error) => {
                        alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
                    });
            } else {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
            }
        });

        // Ø¥Ù„ØºØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        document.getElementById('cancelInput').addEventListener('click', () => {
            document.getElementById('inputPopup').style.display = 'none';
        });


        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¹Ù…Ø§Ù„
        document.getElementById('requestWater').addEventListener('click', () => {
            const workerInfo = document.getElementById('workerInfo');
            workerInfo.innerText = 'Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† Ù‡Ù†Ø§...';
            workerInfo.style.display = workerInfo.style.display === 'block' ? 'none' : 'block';
        });


        function cancelRequestDueToTimeout(requestId, workerId, workerName) {
    const requestRef = database.ref(`workRequests/${requestId}`);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø¹ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± Ø¹Ø§Ù…Ù„ Ø£Ù„ØºÙ‰ Ø§Ù„Ø·Ù„Ø¨
    requestRef.update({
        status: 'cancelled',
        canceledBy: workerId // Ù„Ø§ ÙŠØ²Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ÙŠØ­ØªÙØ¸ Ø¨Ø¢Ø®Ø± Ø¹Ø§Ù…Ù„ Ø£Ù„ØºÙ‰ Ø§Ù„Ø·Ù„Ø¨
    })
    .then(() => {
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª
        const activityRef = database.ref(`workRequests/${requestId}/orderHistory`);
        activityRef.push({
            type: 'timeout',
            workerId: workerId,
            workerName: workerName,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });

        console.log(`ğŸš« ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ${requestId} Ø¨Ø³Ø¨Ø¨ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙˆÙ‚Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù† Ù‚Ø¨Ù„ ${workerName} (${workerId}).`);
        alert("â³ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù„ÙˆØµÙˆÙ„ØŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨.");

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©
        orderCanceled = true;
        orderActive = false;
        clearInterval(window.etaIntervalId);
    })
    .catch((error) => {
        console.error(`âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ${requestId}:`, error);
    });
}









        



  </script>

</body>
</html>
