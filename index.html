<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق الخريطة المحسن</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }
        #map { height: 100vh; width: 100%; }
        .controlButton {
            background-color: rgba(30, 144, 255, 0.8);
            border: none;
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin: 5px 0;
            transition: background-color 0.3s ease;
            width: 100%;
            font-size: 14px;
        }
        .controlButton:hover {
            background-color: rgba(30, 144, 255, 1);
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .iconButton {
            width: 40px;
            height: 40px;
            border: none;
            cursor: pointer;
            background: none;
            margin: 5px;
            z-index: 2;
        }
        .icon {
            font-size: 20px;
            color: #ff5722;
            transition: color 0.3s;
        }
        .icon:hover {
            color: #e64a19;
        }
        #locateButtonContainer {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 2;
        }
        #locateButton {
            background-color: rgba(30, 144, 255, 0.8);
            border: none;
            border-radius: 10px;
            padding: 10px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 14px;
        }
        #locateButton:hover {
            background-color: rgba(30, 144, 255, 1);
        }
        .marker-popup {
            text-align: center;
        }
    </style>
</head>
<body>
    <h1 id="title" style="display: none;">تطبيق الخريطة المحسن</h1>
    <div id="map"></div>

    <div class="controls">
        <button id="toggleWeather" class="iconButton">
            <i class="fas fa-cloud-sun icon"></i>
        </button>
        <select id="styleSelector" class="controlButton">
            <option value="streets">شوارع</option>
            <option value="satellite">الأقمار الصناعية</option>
            <option value="outdoors">خارجية</option>
            <option value="hybrid" selected>هايبرد</option>
            <option value="dark">الوضع الليلي</option> <!-- إضافة الوضع الليلي هنا -->
        </select>
        <button id="requestWater" class="controlButton">طلب ماء</button>
        <button id="toggle3D" class="controlButton">3D</button>
        <button id="addMarker" class="controlButton">وضع علامة عامة</button> <!-- زر وضع علامة عامة -->
        <div id="weatherInfo"></div>
        <div id="workerInfo"></div>
        <div id="mosqueInfo"></div>
    </div>

    <div id="locateButtonContainer">
        <button id="locateButton">تحديد موقعي</button>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css" rel="stylesheet" />

    <script>
        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "ce6cae3c0977e051e1924a4ac1ece1aa",
            authDomain: "adlo-44d1b.firebaseapp.com",
            databaseURL: "https://adlo-44d1b-default-rtdb.firebaseio.com/",
            projectId: "adlo-44d1b",
            storageBucket: "adlo-44d1b.appspot.com",
            messagingSenderId: "96260637269",
            appId: "1:96260637269:web:e3bc37ab2b41038c254adc",
            measurementId: "G-R0SGBWC3CJ"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // مفتاح Mapbox
        const mapboxToken = "pk.eyJ1IjoiY2hvb3NlbWUiLCJhIjoiY20wZnVpemI2MHpreTJqcjR4ZThuam9pYyJ9.F1CjHrnJ7m-VwM_LHt0Q9Q";
        mapboxgl.accessToken = mapboxToken;

        // إعداد الأنماط المختلفة للخريطة
        const styles = {
            streets: 'mapbox://styles/mapbox/streets-v11',
            satellite: 'mapbox://styles/mapbox/satellite-v9',
            outdoors: 'mapbox://styles/mapbox/outdoors-v11',
            hybrid: 'mapbox://styles/mapbox/satellite-streets-v11',
            dark: 'mapbox://styles/mapbox/dark-v10' // إضافة نمط الوضع الليلي
        };

        // إنشاء الخريطة مع زوم منخفض جدًا كأنك ترى الأرض من الفضاء
        const map = new mapboxgl.Map({
            container: 'map', 
            style: styles.hybrid, 
            center: [13.1913, 32.8872], // إحداثيات طرابلس
            zoom: 2 // زوم 2 لعرض العالم من بعيد
        });

        // بعد تحميل الخريطة، قم بالتحرك تدريجيًا نحو طرابلس مع تكبير الزوم
        map.on('load', function () {
            map.flyTo({
                center: [13.1913, 32.8872], // موقع طرابلس
                zoom: 12, // زوم مقرب إلى طرابلس
                speed: 0.8, // سرعة التحرك
                curve: 1, // منحنى الحركة لجعلها سلسة
                easing: function (t) {
                    return t * (2 - t); // دالة الحركة لتخفيف السرعة بسلاسة
                }
            });
        });

        let markerElement;
        let isTracking = false; // متغير لتتبع الحالة
        let watchId; // لتخزين معرف مراقبة الموقع
        const workerMarkers = []; // مصفوفة لتخزين علامات العمال

        // تتبع الموقع اللحظي للمستخدم
        document.getElementById('locateButton').addEventListener('click', function () {
            if (navigator.geolocation) {
                if (isTracking) {
                    map.flyTo({
                        center: [markerElement.getLngLat().lng, markerElement.getLngLat().lat], 
                        zoom: 14
                    });
                    return; // إذا كانت العملية نشطة، أعد التوجيه فقط
                }
                watchId = navigator.geolocation.watchPosition(function (position) {
                    const lng = position.coords.longitude;
                    const lat = position.coords.latitude;

                    // إذا كانت العلامة موجودة، حدث موقعها، وإلا أنشئ واحدة جديدة
                    if (!markerElement) {
                        markerElement = new mapboxgl.Marker({ color: "red" })
                            .setLngLat([lng, lat])
                            .addTo(map);
                    } else {
                        markerElement.setLngLat([lng, lat]);
                    }

                    map.flyTo({
                        center: [lng, lat],
                        zoom: 14
                    });

                    isTracking = true; // تعيين الحالة إلى تتبع
                }, function (error) {
                    console.error("خطأ في الحصول على الموقع:", error);
                });
            } else {
                console.error("الموقع غير مدعوم في هذا المتصفح");
            }
        });

        // عند تغيير نوع الخريطة، قم بتحديث الخريطة بالنمط المختار
        const styleSelector = document.getElementById('styleSelector');
        styleSelector.addEventListener('change', function () {
            const selectedStyle = styleSelector.value;
            map.setStyle(styles[selectedStyle]);
        });

        // وظيفة البحث عن عمال قريبين
        function findNearbyWorkers() {
            const currentLocation = markerElement.getLngLat();

            workerMarkers.forEach(function (marker) {
                const workerLocation = marker.getLngLat();
                const distance = turf.distance(
                    [currentLocation.lng, currentLocation.lat],
                    [workerLocation.lng, workerLocation.lat]
                );
                if (distance <= 1.5) { // 1.5 كم
                    alert("يوجد عامل بالقرب منك!");
                }
            });
        }

        // تتبع الطقس عند الضغط على زر الطقس
        let weatherVisible = false;
        const weatherElement = document.getElementById('weatherInfo');
        const toggleWeatherButton = document.getElementById('toggleWeather');

        toggleWeatherButton.addEventListener('click', function () {
            weatherVisible = !weatherVisible;
            if (weatherVisible) {
                weatherElement.style.display = 'block';
                fetchWeatherData();
            } else {
                weatherElement.style.display = 'none';
            }
        });

        // جلب بيانات الطقس
        function fetchWeatherData() {
            fetch("https://api.open-meteo.com/v1/forecast?latitude=32.8872&longitude=13.1913&current_weather=true&timezone=auto")
                .then(response => response.json())
                .then(data => {
                    const weatherInfo = `
                        <p>الطقس الحالي:</p>
                        <p>درجة الحرارة: ${data.current_weather.temperature}°C</p>
                        <p>سرعة الرياح: ${data.current_weather.windspeed} كم/سا</p>
                    `;
                    weatherElement.innerHTML = weatherInfo;
                })
                .catch(error => console.error("خطأ في جلب بيانات الطقس:", error));
        }

        // طلب الماء
        const requestWaterButton = document.getElementById('requestWater');
        requestWaterButton.addEventListener('click', function () {
            alert('تم إرسال طلب الماء إلى جميع العمال في الجوار');
        });

        // تفعيل العرض الثلاثي الأبعاد
        const toggle3DButton = document.getElementById('toggle3D');
        let is3DEnabled = false;
        toggle3DButton.addEventListener('click', function () {
            const layers = map.getStyle().layers;
            is3DEnabled = !is3DEnabled;

            for (const layer of layers) {
                if (layer.type === 'fill-extrusion') {
                    map.setLayoutProperty(layer.id, 'visibility', is3DEnabled ? 'visible' : 'none');
                }
            }
        });

        // إضافة عامل
        function addWorkerMarker(lng, lat) {
            const marker = new mapboxgl.Marker({ color: "green" })
                .setLngLat([lng, lat])
                .addTo(map);

            workerMarkers.push(marker);
        }

        // إضافة زر وضع علامة عامة
        const addMarkerButton = document.getElementById('addMarker');
        addMarkerButton.addEventListener('click', function () {
            const markerType = prompt('اختر نوع العلامة: 1. جمع تبرعات لمسجد، 2. مكان جمع تبرعات، 3. مكان عائلة محتاجة');
            if (!markerType) return;

            const lng = markerElement.getLngLat().lng;
            const lat = markerElement.getLngLat().lat;

            if (markerType === '1') {
                addMarkerWithIcon(lng, lat, 'icon-mosque', 'جمع تبرعات لمسجد');
            } else if (markerType === '2') {
                addMarkerWithIcon(lng, lat, 'icon-donation', 'مكان جمع تبرعات');
            } else if (markerType === '3') {
                addMarkerWithIcon(lng, lat, 'icon-family', 'مكان عائلة محتاجة');
            }
        });

        // إضافة العلامة إلى الخريطة مع الأيقونة المناسبة
        function addMarkerWithIcon(lng, lat, iconClass, description) {
            const el = document.createElement('div');
            el.className = iconClass;
            el.style.width = '30px';
            el.style.height = '30px';

            new mapboxgl.Marker(el)
                .setLngLat([lng, lat])
                .setPopup(new mapboxgl.Popup().setHTML(`<h3>${description}</h3>`))
                .addTo(map);
        }

        // إضافة علامة في Firebase
        function addMarkerToFirebase(lng, lat, description) {
            const newMarkerRef = database.ref('markers').push();
            newMarkerRef.set({
                lng,
                lat,
                description
            });
        }

        // جلب العلامات من Firebase
        function fetchMarkersFromFirebase() {
            database.ref('markers').once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    addMarkerWithIcon(data.lng, data.lat, 'icon-mosque', data.description);
                });
            });
        }

        // جلب العلامات عند تحميل الصفحة
        fetchMarkersFromFirebase();
    </script>
</body>
</html>
