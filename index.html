let isTracking = false; // متغير لتتبع الحالة
let watchId; // لتخزين معرف مراقبة الموقع
let marker; // المتغير الخاص بالمؤشر
let map; // المتغير الخاص بالخريطة

// إعداد الخريطة
mapboxgl.accessToken = 'YOUR_MAPBOX_ACCESS_TOKEN'; // استبدل هذا برمز الوصول الخاص بك
map = new mapboxgl.Map({
    container: 'map', // ID عنصر الخريطة
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [0, 0], // الإحداثيات الأولية
    zoom: 14 // مستوى التكبير الابتدائي
});

// إضافة زر لتحديد الموقع
const locateButton = document.getElementById('locateButton');
locateButton.addEventListener('click', function () {
    if (navigator.geolocation) {
        if (isTracking) {
            navigator.geolocation.clearWatch(watchId); // إيقاف المراقبة إذا كانت نشطة
            isTracking = false;
            if (marker) marker.remove(); // إزالة العلامة عند إيقاف المراقبة
            this.innerHTML = '<i class="fas fa-location-arrow icon"></i> تحديد الموقع'; // تغيير نص الزر
        } else {
            watchId = navigator.geolocation.watchPosition(position => {
                const { latitude, longitude } = position.coords;

                // إذا لم يكن هناك مؤشر، أنشئه
                if (!marker) {
                    const markerElement = document.createElement('div');
                    markerElement.className = 'blue-marker'; // استخدام فئة CSS للمؤشر الأزرق
                    marker = new mapboxgl.Marker(markerElement, {
                        anchor: 'center' // تحديد نقطة تثبيت المؤشر في المركز
                    }).setLngLat([longitude, latitude]).addTo(map);
                } else {
                    marker.setLngLat([longitude, latitude]); // تحديث موقع العلامة
                }

                // مركز الخريطة إلى موقع المستخدم
                map.setCenter([longitude, latitude]);
            });

            // تحديث نص الزر
            isTracking = true;
            this.innerHTML = '<i class="fas fa-stop icon"></i> إيقاف تحديد الموقع'; // تغيير نص الزر
        }
    } else {
        alert('جهازك لا يدعم تحديد الموقع الجغرافي');
    }
});

// إيقاف تحديد الموقع عند تحريك الخريطة
map.on('move', () => {
    if (isTracking) {
        navigator.geolocation.clearWatch(watchId); // إيقاف المراقبة
        isTracking = false; // تغيير حالة التتبع
        if (marker) marker.remove(); // إزالة المؤشر
        locateButton.innerHTML = '<i class="fas fa-location-arrow icon"></i> تحديد الموقع'; // تغيير نص الزر
    }
});

// إعادة مركز المؤشر إلى الخريطة عند الضغط على زر تحديد الموقع
locateButton.addEventListener('click', () => {
    if (isTracking && marker) {
        const { lng, lat } = marker.getLngLat();
        map.setCenter([lng, lat]); // إعادة المركز إلى المؤشر
    }
});

// CSS للمؤشر الأزرق
const style = document.createElement('style');
style.innerHTML = `
    .blue-marker {
        background-color: blue; /* اللون الأزرق */
        width: 30px; /* عرض المؤشر */
        height: 30px; /* ارتفاع المؤشر */
        border-radius: 50%; /* الشكل الدائري */
        position: relative; /* إعداد النسق النسبي */
    }
    .blue-marker::after {
        content: ''; /* محتوى فارغ */
        position: absolute;
        top: -10px; /* موضع الضوء */
        left: 50%;
        transform: translateX(-50%);
        width: 8px; /* عرض الضوء */
        height: 8px; /* ارتفاع الضوء */
        background-color: yellow; /* لون الضوء */
        border-radius: 50%; /* شكل دائري للضوء */
        box-shadow: 0 0 10px yellow; /* تأثير ضوئي */
    }
`;
document.head.appendChild(style);
